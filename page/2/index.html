<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/page/2/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-page/4/index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/page/4/index/" class="article-date">
  <time datetime="2020-10-15T03:18:44.740Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/page/4/index/">page/4/index</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/page/4/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-01-20-RecyclerView常见问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/20/2019-01-20-RecyclerView%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2019-01-19T16:00:00.000Z" itemprop="datePublished">2019-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/20/2019-01-20-RecyclerView%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/">RecyclerView常见问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="RecyclerView设置了数据不显示"><a href="#RecyclerView设置了数据不显示" class="headerlink" title="RecyclerView设置了数据不显示"></a>RecyclerView设置了数据不显示</h2><p>当我们调用RecyclerView控件时，如果没有给它设置LayoutManager或者Adapter时 RecyclerView就不知道item布局到底要怎样显示(RecyclerVeiw中没有某认的显示方式)或者Adapter数据怎样填充在item上.<br>它就会报 <code>RecyclerView: No layout manager attached; skipping layout</code>或者<code>RecyclerView: No adapter attached; skipping layout</code><br>具体实例(LayoutManager)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mRv &#x3D; findViewById(R.id.mRv);</span><br><span class="line">&#x2F;&#x2F;我们注释了这两行代码</span><br><span class="line">&#x2F;&#x2F;mRv.setLayoutManager(new LinearLayoutManager(this, LinearLayoutManager.VERTICAL, true));</span><br><span class="line">    mAdapter &#x3D; new Adapter();</span><br><span class="line">&#x2F;&#x2F;mRv.setAdapter(mAdapter);</span><br></pre></td></tr></table></figure>
<h2 id="RecyclerView多次滚动后数据出现混乱"><a href="#RecyclerView多次滚动后数据出现混乱" class="headerlink" title="RecyclerView多次滚动后数据出现混乱"></a>RecyclerView多次滚动后数据出现混乱</h2><p>续…</p>
<h2 id="获取当前item展示的位置"><a href="#获取当前item展示的位置" class="headerlink" title="获取当前item展示的位置"></a>获取当前item展示的位置</h2><p>有些时候我们需要当某个item滚动到顶部时，显示搜索框这样的需求.<br>可以通过在Adapter中的onBindViewHolder方法中获取当前界面中的item。<br>getLayoutPosition和getAdapterPosition。</p>
<h2 id="异常-IndexOutOfBoundsException-Inconsistency-detected-Invalid-item-position-5-offset-5-state-9"><a href="#异常-IndexOutOfBoundsException-Inconsistency-detected-Invalid-item-position-5-offset-5-state-9" class="headerlink" title="异常:IndexOutOfBoundsException: Inconsistency detected. Invalid item position 5(offset:5).state:9"></a>异常:IndexOutOfBoundsException: Inconsistency detected. Invalid item position 5(offset:5).state:9</h2><p>产生这个异常的原因是Adapter数据源已经改变但是没有通知到RecyclerView.<br>解决的方法：当Adapter数据源改变时，立即调用Adapter.notifyXXX方法来刷新RecyclerView.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override public void onClick(View v) &#123;</span><br><span class="line">    mAdapter.removeMessage(5);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   public void removeMessage(int position) &#123;</span><br><span class="line">    if (stringList !&#x3D; null &amp;&amp; stringList.size() &gt; 0) &#123;</span><br><span class="line">      stringList.remove(position);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;notifyItemRemoved(position);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="控制RecyclerView滑动的速度和item移动的位置"><a href="#控制RecyclerView滑动的速度和item移动的位置" class="headerlink" title="控制RecyclerView滑动的速度和item移动的位置"></a>控制RecyclerView滑动的速度和item移动的位置</h2><p>通常我们指定某个item移动通过调用RecyclerView的smoothScrollToPosition方法即可完成.<br>RecyclerView源码:    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void smoothScrollToPosition(int position) &#123;</span><br><span class="line">    if(!this.mLayoutFrozen) &#123;</span><br><span class="line">      if(this.mLayout &#x3D;&#x3D; null) &#123;</span><br><span class="line">        Log.e(&quot;RecyclerView&quot;, &quot;Cannot smooth scroll without a LayoutManager set. Call setLayoutManager with a non-null argument.&quot;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.mLayout.smoothScrollToPosition(this, this.mState, position);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>通过源码看出最终还是调用了LayoutManager的smoothScrollToPosition方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void smoothScrollToPosition(RecyclerView recyclerView, State state, int position) &#123;</span><br><span class="line">    LinearSmoothScroller linearSmoothScroller &#x3D; new LinearSmoothScroller(recyclerView.getContext());</span><br><span class="line">    linearSmoothScroller.setTargetPosition(position);</span><br><span class="line">    this.startSmoothScroll(linearSmoothScroller);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在这里获取到LinearSmoothScroller的对象,然后调用setTargetPosition设置item到指定位置，最后执行滑动操作startSmoothScroll.<br>因此我们只要自定义RecyclerView的LayoutManager类,然后重写smoothScrollToPosition方法.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public class ScrollSpeedLinearLayoutManger extends LinearLayoutManager &#123;</span><br><span class="line">  public ScrollSpeedLinearLayoutManger(Context context) &#123;</span><br><span class="line">    super(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ScrollSpeedLinearLayoutManger(Context context, int orientation, boolean reverseLayout) &#123;</span><br><span class="line">    super(context, orientation, reverseLayout);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ScrollSpeedLinearLayoutManger(Context context, AttributeSet attrs,</span><br><span class="line">      int defStyleAttr,</span><br><span class="line">      int defStyleRes) &#123;</span><br><span class="line">    super(context, attrs, defStyleAttr, defStyleRes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void smoothScrollToPosition(RecyclerView recyclerView, RecyclerView.State state,</span><br><span class="line">      int position) &#123;</span><br><span class="line">    Log.e(&quot;linksu&quot;,</span><br><span class="line">        &quot;smoothScrollToPosition(ScrollSpeedLinearLayoutManger.java:62)&quot;);</span><br><span class="line">    RecyclerView.SmoothScroller smoothScroller &#x3D;</span><br><span class="line">        new CenterSmoothScroller(recyclerView.getContext());</span><br><span class="line">    smoothScroller.setTargetPosition(position);</span><br><span class="line">    startSmoothScroll(smoothScroller);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private class CenterSmoothScroller extends LinearSmoothScroller &#123;</span><br><span class="line"></span><br><span class="line">    CenterSmoothScroller(Context context) &#123;</span><br><span class="line">      super(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public PointF computeScrollVectorForPosition(int targetPosition) &#123;</span><br><span class="line">      return ScrollSpeedLinearLayoutManger.this.computeScrollVectorForPosition(targetPosition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 控制滑动的位置</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public int calculateDtToFit(int viewStart, int viewEnd, int boxStart, int boxEnd,</span><br><span class="line">        int snapPreference) &#123;</span><br><span class="line">      &#x2F;&#x2F;return (boxStart + (boxEnd - boxStart) &#x2F; 2) - (viewStart + (viewEnd - viewStart) &#x2F; 2);</span><br><span class="line">      return (boxStart + (boxEnd - boxStart)) - (viewStart + (viewEnd - viewStart));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 控制滑动的速度</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override protected float calculateSpeedPerPixel(DisplayMetrics displayMetrics) &#123;</span><br><span class="line">      return 1.5f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected int getVerticalSnapPreference() &#123;</span><br><span class="line">      return SNAP_TO_START;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/01/20/2019-01-20-RecyclerView%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" data-id="ck8tr9s6u000nn29khajj17s2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-01-4-Activity中Windowd的创建过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/04/2019-01-4-Activity%E4%B8%ADWindowd%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2019-01-03T16:00:00.000Z" itemprop="datePublished">2019-01-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/04/2019-01-4-Activity%E4%B8%ADWindowd%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/">Activity中Window的创建过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="从setContentView了解Window的创建过程"><a href="#从setContentView了解Window的创建过程" class="headerlink" title="从setContentView了解Window的创建过程."></a>从setContentView了解Window的创建过程.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Set the activity content from a layout resource.  The resource will be</span><br><span class="line"> * inflated, adding all top-level views to the activity.</span><br><span class="line"> *</span><br><span class="line"> * @param layoutResID Resource ID to be inflated.</span><br><span class="line"> *</span><br><span class="line"> * @see #setContentView(android.view.View)</span><br><span class="line"> * @see #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void setContentView(@LayoutRes int layoutResID) &#123;</span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> public Window getWindow() &#123;</span><br><span class="line">    return mWindow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而getWindow的实例就是在Activity#Attach中创建的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">final void attach(Context context, ActivityThread aThread,</span><br><span class="line">            Instrumentation instr, IBinder token, int ident,</span><br><span class="line">            Application application, Intent intent, ActivityInfo info,</span><br><span class="line">            CharSequence title, Activity parent, String id,</span><br><span class="line">            NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="line">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">            Window window, ActivityConfigCallback activityConfigCallback) &#123;</span><br><span class="line">        attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">        mFragments.attachHost(null &#x2F;*parent*&#x2F;);</span><br><span class="line">        &#x2F;&#x2F;在这里创建PhoneWindow的实例，PhoneWindow继承了Window</span><br><span class="line">        mWindow &#x3D; new PhoneWindow(this, window, activityConfigCallback);</span><br><span class="line">        mWindow.setWindowControllerCallback(this);</span><br><span class="line">        mWindow.setCallback(this);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(this);</span><br><span class="line">        mWindow.getLayoutInflater().setPrivateFactory(this);</span><br><span class="line">        if (info.softInputMode !&#x3D; WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">            mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        if (info.uiOptions !&#x3D; 0) &#123;</span><br><span class="line">            mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        mUiThread &#x3D; Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        mMainThread &#x3D; aThread;</span><br><span class="line">        mInstrumentation &#x3D; instr;</span><br><span class="line">        mToken &#x3D; token;</span><br><span class="line">        mIdent &#x3D; ident;</span><br><span class="line">        mApplication &#x3D; application;</span><br><span class="line">        mIntent &#x3D; intent;</span><br><span class="line">        mReferrer &#x3D; referrer;</span><br><span class="line">        mComponent &#x3D; intent.getComponent();</span><br><span class="line">        mActivityInfo &#x3D; info;</span><br><span class="line">        mTitle &#x3D; title;</span><br><span class="line">        mParent &#x3D; parent;</span><br><span class="line">        mEmbeddedID &#x3D; id;</span><br><span class="line">        mLastNonConfigurationInstances &#x3D; lastNonConfigurationInstances;</span><br><span class="line">        if (voiceInteractor !&#x3D; null) &#123;</span><br><span class="line">            if (lastNonConfigurationInstances !&#x3D; null) &#123;</span><br><span class="line">                mVoiceInteractor &#x3D; lastNonConfigurationInstances.voiceInteractor;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mVoiceInteractor &#x3D; new VoiceInteractor(voiceInteractor, this, this,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) !&#x3D; 0);</span><br><span class="line">        if (mParent !&#x3D; null) &#123;</span><br><span class="line">            mWindow.setContainer(mParent.getWindow());</span><br><span class="line">        &#125;</span><br><span class="line">        mWindowManager &#x3D; mWindow.getWindowManager();</span><br><span class="line">        mCurrentConfig &#x3D; config;</span><br><span class="line"></span><br><span class="line">        mWindow.setColorMode(info.colorMode);</span><br><span class="line"></span><br><span class="line">        setAutofillCompatibilityEnabled(application.isAutofillCompatibilityEnabled());</span><br><span class="line">        enableAutofillCompatibilityIfNeeded();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Activity#attach是在ActivityThread中的performLaunchActivity被调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">       </span><br><span class="line">               activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">                       r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                       r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                       r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line"></span><br><span class="line">               if (customIntent !&#x3D; null) &#123;</span><br><span class="line">                   activity.mIntent &#x3D; customIntent;</span><br><span class="line">               &#125;</span><br><span class="line">               r.lastNonConfigurationInstances &#x3D; null;</span><br><span class="line">               checkAndBlockForNetworkAccess();</span><br><span class="line">               activity.mStartedActivity &#x3D; false;</span><br><span class="line">               int theme &#x3D; r.activityInfo.getThemeResource();</span><br><span class="line">               if (theme !&#x3D; 0) &#123;</span><br><span class="line">                   activity.setTheme(theme);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               activity.mCalled &#x3D; false;</span><br><span class="line">               if (r.isPersistable()) &#123;</span><br><span class="line">                   mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">               &#125;</span><br><span class="line">               if (!activity.mCalled) &#123;</span><br><span class="line">                   throw new SuperNotCalledException(</span><br><span class="line">                       &quot;Activity &quot; + r.intent.getComponent().toShortString() +</span><br><span class="line">                       &quot; did not call through to super.onCreate()&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">               r.activity &#x3D; activity;</span><br><span class="line">           &#125;</span><br><span class="line">           r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">           mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">       &#125; catch (SuperNotCalledException e) &#123;</span><br><span class="line">           throw e;</span><br><span class="line"></span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           if (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">               throw new RuntimeException(</span><br><span class="line">                   &quot;Unable to start activity &quot; + component</span><br><span class="line">                   + &quot;: &quot; + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return activity;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PhoneWindow的setContentView"><a href="#PhoneWindow的setContentView" class="headerlink" title="PhoneWindow的setContentView"></a>PhoneWindow的setContentView</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</span><br><span class="line">      &#x2F;&#x2F; Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span><br><span class="line">      &#x2F;&#x2F; decor, when theme attributes and the like are crystalized. Do not check the feature</span><br><span class="line">      &#x2F;&#x2F; before this happens.</span><br><span class="line">      if (mContentParent &#x3D;&#x3D; null) &#123;</span><br><span class="line">          installDecor();</span><br><span class="line">      &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">          mContentParent.removeAllViews();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">          view.setLayoutParams(params);</span><br><span class="line">          final Scene newScene &#x3D; new Scene(mContentParent, view);</span><br><span class="line">          transitionTo(newScene);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          mContentParent.addView(view, params);</span><br><span class="line">      &#125;</span><br><span class="line">      mContentParent.requestApplyInsets();</span><br><span class="line">      final Callback cb &#x3D; getCallback();</span><br><span class="line">      if (cb !&#x3D; null &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">          cb.onContentChanged();</span><br><span class="line">      &#125;</span><br><span class="line">      mContentParentExplicitlySet &#x3D; true;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>mContentParent是DecorView的直接子View，它是Decor的内容栏，它有指定的id：android.id.content,通过setContentView(layoutId)我们就可以将一个View挂载到mContentParent上。<br>首先判断mContentParent是否为null，当该值为空时就调用installDecor()，加载一个DecorView，同时创建一个mContentParent。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    private void installDecor() &#123;</span><br><span class="line">        mForceDecorInstall &#x3D; false;</span><br><span class="line">        if (mDecor &#x3D;&#x3D; null) &#123;</span><br><span class="line">            mDecor &#x3D; generateDecor(-1);</span><br><span class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">            mDecor.setIsRootNamespace(true);</span><br><span class="line">            if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures !&#x3D; 0) &#123;</span><br><span class="line">                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mDecor.setWindow(this);</span><br><span class="line">        &#125;</span><br><span class="line">        if (mContentParent &#x3D;&#x3D; null) &#123;</span><br><span class="line">            mContentParent &#x3D; generateLayout(mDecor);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span><br><span class="line">            mDecor.makeOptionalFitsSystemWindows();</span><br><span class="line"></span><br><span class="line">            final DecorContentParent decorContentParent &#x3D; (DecorContentParent) mDecor.findViewById(</span><br><span class="line">                    R.id.decor_content_parent);</span><br><span class="line"></span><br><span class="line">            if (decorContentParent !&#x3D; null) &#123;</span><br><span class="line">                mDecorContentParent &#x3D; decorContentParent;</span><br><span class="line">                mDecorContentParent.setWindowCallback(getCallback());</span><br><span class="line">                if (mDecorContentParent.getTitle() &#x3D;&#x3D; null) &#123;</span><br><span class="line">                    mDecorContentParent.setWindowTitle(mTitle);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                final int localFeatures &#x3D; getLocalFeatures();</span><br><span class="line">                for (int i &#x3D; 0; i &lt; FEATURE_MAX; i++) &#123;</span><br><span class="line">                    if ((localFeatures &amp; (1 &lt;&lt; i)) !&#x3D; 0) &#123;</span><br><span class="line">                        mDecorContentParent.initFeature(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mDecorContentParent.setUiOptions(mUiOptions);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</span><br><span class="line">    ...</span><br><span class="line">    View in &#x3D; mLayoutInflater.inflate(layoutResource, null);</span><br><span class="line">    decor.addView(in, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DecorView装载内容栏。<br>最终调用 mContentParent.addView(view, params);将layoutID布局设置到mContetParent</p>
<h2 id="往Widow中添加DecorView"><a href="#往Widow中添加DecorView" class="headerlink" title="往Widow中添加DecorView"></a>往Widow中添加DecorView</h2><p>ActivityThread#handleResumeActivity，在handleResumeActivity内部调用Window.addView方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">if (r.window &#x3D;&#x3D; null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            r.window &#x3D; r.activity.getWindow();</span><br><span class="line">            View decor &#x3D; r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            ViewManager wm &#x3D; a.getWindowManager();</span><br><span class="line">            WindowManager.LayoutParams l &#x3D; r.window.getAttributes();</span><br><span class="line">            a.mDecor &#x3D; decor;</span><br><span class="line">            l.type &#x3D; WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |&#x3D; forwardBit;</span><br><span class="line">            if (r.mPreserveWindow) &#123;</span><br><span class="line">                a.mWindowAdded &#x3D; true;</span><br><span class="line">                r.mPreserveWindow &#x3D; false;</span><br><span class="line">                &#x2F;&#x2F; Normally the ViewRoot sets up callbacks with the Activity</span><br><span class="line">                &#x2F;&#x2F; in addView-&gt;ViewRootImpl#setView. If we are instead reusing</span><br><span class="line">                &#x2F;&#x2F; the decor view we have to notify the view root that the</span><br><span class="line">                &#x2F;&#x2F; callbacks may have changed.</span><br><span class="line">                ViewRootImpl impl &#x3D; decor.getViewRootImpl();</span><br><span class="line">                if (impl !&#x3D; null) &#123;</span><br><span class="line">                    impl.notifyChildRebuilt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (a.mVisibleFromClient) &#123;</span><br><span class="line">                if (!a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded &#x3D; true;</span><br><span class="line">                    wm.addView(decor, l);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; The activity will get a callback for this &#123;@link LayoutParams&#125; change</span><br><span class="line">                    &#x2F;&#x2F; earlier. However, at that time the decor will not be set (this is set</span><br><span class="line">                    &#x2F;&#x2F; in this method), so no action will be taken. This call ensures the</span><br><span class="line">                    &#x2F;&#x2F; callback occurs with the decor set.</span><br><span class="line">                    a.onWindowAttributesChanged(l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; If the window has already been added, but during resume</span><br><span class="line">            &#x2F;&#x2F; we started another activity, then don&#39;t yet make the</span><br><span class="line">            &#x2F;&#x2F; window visible.</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>最终我们的视图通过WindowManagerService添加到了Window中</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/01/04/2019-01-4-Activity%E4%B8%ADWindowd%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" data-id="ck8tr9s6w000rn29k29ni7yyx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-01-03-syncTask的工作过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/03/2019-01-03-syncTask%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2019-01-02T16:00:00.000Z" itemprop="datePublished">2019-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/03/2019-01-03-syncTask%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/">AsyncTask的工作过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="AsyncTask的基础用法"><a href="#AsyncTask的基础用法" class="headerlink" title="AsyncTask的基础用法"></a>AsyncTask的基础用法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAsyncTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Void</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPreExecute();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Integer <span class="title">doInBackground</span><span class="params">(String... strings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.valueOf(strings[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Void... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onProgressUpdate(values);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Integer integer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPostExecute(integer);</span><br><span class="line">    Log.e(<span class="string">"TAG"</span>, <span class="string">"integer:"</span> + integer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AsyncTask的实现原理"><a href="#AsyncTask的实现原理" class="headerlink" title="AsyncTask的实现原理"></a>AsyncTask的实现原理</h2><p>在上面的代码中想要启动AsyncTask只需要调用如下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execute = <span class="keyword">new</span> SimpleAsyncTask().execute(NONE, NONE1, NONE2);</span><br></pre></td></tr></table></figure>
<p>可以看到创建的AsyncTask对象最终调用的是execute方法,所以启动一个异步任务的工作开始就是在execute中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里execute又调用了executeOnExecuteor方法，这个方法中有两个参数sDefaultExecutor这个是android中的一个线程池，params是我们传进来的可变参数.<br>接下来看一下executeOnExecuteor的执行过程.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></span><br><span class="line"><span class="function"><span class="params">        Params... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task is already running."</span>);</span><br><span class="line">            <span class="keyword">case</span> FINISHED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></span><br><span class="line">                        + <span class="string">" the task has already been executed "</span></span><br><span class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mStatus = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    onPreExecute();</span><br><span class="line"></span><br><span class="line">    mWorker.mParams = params;</span><br><span class="line">    exec.execute(mFuture);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先执行了AsyncTask中的方法onPreExecute(在这里还是主线程)。<br>然后把我们传入的参数params给mWorker的mParams.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</span><br><span class="line">       Params[] mParams;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到Worker实现了Callable方法,它将运行在子线程中.<br>然后执行了exec.execute(mFuture).而exec就是之前的sDefaultExecutor线程池.同时传入了一个mFuture.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;Result&gt; mFuture;</span><br><span class="line">mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            postResultIfNotInvoked(get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            android.util.Log.w(LOG_TAG, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</span><br><span class="line">                        e.getCause());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</span><br><span class="line">            postResultIfNotInvoked(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>FutureTask主要是用来实现多线程的操作.</p>
<p>sDefaultExecutor的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</span><br><span class="line">    Runnable mActive;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">        mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    scheduleNext();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</span><br><span class="line">            scheduleNext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            THREAD_POOL_EXECUTOR.execute(mActive);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在sDefaultExecutor中的run方法中执行了r.run()。而这个r就是mFuture.同时这个run方法中执行Callable的call方法.而这个call就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker)</span><br></pre></td></tr></table></figure>
<p>中的mWorker中的方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">           mTaskInvoked.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">           Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">                <span class="comment">//noinspection unchecked</span></span><br><span class="line">            Result result = doInBackground(mParams);</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">            <span class="keyword">return</span> postResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>在这个方法中看到执行了doInBackground方法(子线程中执行).最后返回时一个postResult.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,  </span><br><span class="line">    <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result))</span><br><span class="line">    message.sendToTarget();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到将最终的结果result构造到了Handler中也就是将最终的执行结果从子线程中发送到主线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(Looper.getMainLooper());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_POST_RESULT:</span><br><span class="line">                    <span class="comment">// There is only one result</span></span><br><span class="line">                    result.mTask.finish(result.mData[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</span><br><span class="line">                    result.mTask.onProgressUpdate(result.mData)                      </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在InternalHandler通过消息执行同时可以看到当InternalHandler接收的消息是MESSAGE_POST_PROGRESS时执行的就是onProgressUpdate。<br>最终执行finish。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">        onCancelled(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onPostExecute(result);</span><br><span class="line">    &#125;</span><br><span class="line">    mStatus = Status.FINISHED</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最终将处理的结果result传给了onPostExecute方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/01/03/2019-01-03-syncTask%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-id="ck8tr9s6r000hn29k8b915592" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-01-02-Okhttp异步请求源码解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/02/2019-01-02-Okhttp%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2019-01-01T16:00:00.000Z" itemprop="datePublished">2019-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/02/2019-01-02-Okhttp%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Okhttp异步请求源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="异步请求示例"><a href="#异步请求示例" class="headerlink" title="异步请求示例"></a>异步请求示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client &#x3D; new OkHttpClient();</span><br><span class="line">    client.newCall(request).enqueue(new Callback() &#123;</span><br><span class="line">      @Override public void onFailure(Call call, IOException e) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      @Override public void onResponse(Call call, Response response) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Okhttp源码分析"><a href="#Okhttp源码分析" class="headerlink" title="Okhttp源码分析"></a>Okhttp源码分析</h2><p>从代码中可以知道我们的OkhttpClient首先是执行newCall这个方法，它返回的是一个Call.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Prepares the &#123;@code request&#125; to be executed at some point in the future.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Override public Call newCall(Request request) &#123;</span><br><span class="line">    return RealCall.newRealCall(this, request, false &#x2F;* for web socket *&#x2F;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里又把请求给了RealCall，然后接着执行newRealCall.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) &#123;</span><br><span class="line">   &#x2F;&#x2F; Safely publish the Call instance to the EventListener.</span><br><span class="line">   RealCall call &#x3D; new RealCall(client, originalRequest, forWebSocket);</span><br><span class="line">   call.eventListener &#x3D; client.eventListenerFactory().create(call);</span><br><span class="line">   return call;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>创建了call对象.然后调用RealCall中的enqueue方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override public void enqueue(Callback responseCallback) &#123;</span><br><span class="line">   synchronized (this) &#123;</span><br><span class="line">     if (executed) throw new IllegalStateException(&quot;Already Executed&quot;);</span><br><span class="line">     executed &#x3D; true;</span><br><span class="line">   &#125;</span><br><span class="line">   captureCallStackTrace();</span><br><span class="line">   eventListener.callStart(this);</span><br><span class="line">   client.dispatcher().enqueue(new AsyncCall(responseCallback));</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在enqueue中又调用了dispatcher方法。dispatcher是一个调度器.<br>dispatcher里面创建了线程池供请求调用。<br>它的异步请求方法是enqueue.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">synchronized void enqueue(AsyncCall call) &#123;</span><br><span class="line">   if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">     runningAsyncCalls.add(call);</span><br><span class="line">     executorService().execute(call);</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     readyAsyncCalls.add(call);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里先判断当前运行的线程是否已经超过了64个，或者正在运行的主机数量是否已经超过了5个。如果没有超过就将当前的异步请求添加到runningAsyncCalls中同时加入线程池。否则就添加到readyAsyncCalls。</p>
<h2 id="AsyncCall"><a href="#AsyncCall" class="headerlink" title="AsyncCall"></a>AsyncCall</h2><p>AsyncCall是RealCall的内部类,上面的代码中将异步请求添加到线程池中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">final class RealCall implements Call &#123;</span><br><span class="line">final class AsyncCall extends NamedRunnable &#123;</span><br><span class="line">     ......   </span><br><span class="line">    @Override protected void execute() &#123;</span><br><span class="line">      boolean signalledCallback &#x3D; false;</span><br><span class="line">      timeout.enter();</span><br><span class="line">      try &#123;</span><br><span class="line">        Response response &#x3D; getResponseWithInterceptorChain();</span><br><span class="line">        if (retryAndFollowUpInterceptor.isCanceled()) &#123;</span><br><span class="line">          signalledCallback &#x3D; true;</span><br><span class="line">          responseCallback.onFailure(RealCall.this, new IOException(&quot;Canceled&quot;));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          signalledCallback &#x3D; true;</span><br><span class="line">          responseCallback.onResponse(RealCall.this, response);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        e &#x3D; timeoutExit(e);</span><br><span class="line">        if (signalledCallback) &#123;</span><br><span class="line">          &#x2F;&#x2F; Do not signal the callback twice!</span><br><span class="line">          Platform.get().log(INFO, &quot;Callback failure for &quot; + toLoggableString(), e);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          eventListener.callFailed(RealCall.this, e);</span><br><span class="line">          responseCallback.onFailure(RealCall.this, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        client.dispatcher().finished(this);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过getResponseWithInterceptorChain获取到请求的结果，将结果发送给responseCallback的onFailure和onResponse方法，这样我们就可以处理请求结果了.<br>在最后调用finidhed将这个请求结束掉.</p>
<h2 id="InterceptorChain"><a href="#InterceptorChain" class="headerlink" title="InterceptorChain"></a>InterceptorChain</h2><p>在上面的代码中通过getResponseWithInterceptorChain获取请求的结果.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Response getResponseWithInterceptorChain() throws IOException &#123;</span><br><span class="line">  &#x2F;&#x2F; Build a full stack of interceptors.</span><br><span class="line">  List&lt;Interceptor&gt; interceptors &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">  interceptors.addAll(client.interceptors());</span><br><span class="line">  interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">  interceptors.add(new BridgeInterceptor(client.cookieJar()));</span><br><span class="line">  interceptors.add(new CacheInterceptor(client.internalCache()));</span><br><span class="line">  interceptors.add(new ConnectInterceptor(client));</span><br><span class="line">  if (!forWebSocket) &#123;</span><br><span class="line">    interceptors.addAll(client.networkInterceptors());</span><br><span class="line">  &#125;</span><br><span class="line">  interceptors.add(new CallServerInterceptor(forWebSocket));</span><br><span class="line"></span><br><span class="line">  Interceptor.Chain chain &#x3D; new RealInterceptorChain(interceptors, null, null, null, 0,</span><br><span class="line">      originalRequest, this, eventListener, client.connectTimeoutMillis(),</span><br><span class="line">      client.readTimeoutMillis(), client.writeTimeoutMillis());</span><br><span class="line"></span><br><span class="line">  return chain.proceed(originalRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来通过RealInterceptorChain调用proceed方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span><br><span class="line">     RealConnection connection) throws IOException &#123;</span><br><span class="line">   if (index &gt;&#x3D; interceptors.size()) throw new AssertionError();</span><br><span class="line"></span><br><span class="line">   calls++;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; If we already have a stream, confirm that the incoming request will use it.</span><br><span class="line">   if (this.httpCodec !&#x3D; null &amp;&amp; !this.connection.supportsUrl(request.url())) &#123;</span><br><span class="line">     throw new IllegalStateException(&quot;network interceptor &quot; + interceptors.get(index - 1)</span><br><span class="line">         + &quot; must retain the same host and port&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; If we already have a stream, confirm that this is the only call to chain.proceed().</span><br><span class="line">   if (this.httpCodec !&#x3D; null &amp;&amp; calls &gt; 1) &#123;</span><br><span class="line">     throw new IllegalStateException(&quot;network interceptor &quot; + interceptors.get(index - 1)</span><br><span class="line">         + &quot; must call proceed() exactly once&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Call the next interceptor in the chain.</span><br><span class="line">   RealInterceptorChain next &#x3D; new RealInterceptorChain(interceptors, streamAllocation, httpCodec,</span><br><span class="line">       connection, index + 1, request, call, eventListener, connectTimeout, readTimeout,</span><br><span class="line">       writeTimeout);</span><br><span class="line">   Interceptor interceptor &#x3D; interceptors.get(index);</span><br><span class="line">   Response response &#x3D; interceptor.intercept(next);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Confirm that the next interceptor made its required call to chain.proceed().</span><br><span class="line">   if (httpCodec !&#x3D; null &amp;&amp; index + 1 &lt; interceptors.size() &amp;&amp; next.calls !&#x3D; 1) &#123;</span><br><span class="line">     throw new IllegalStateException(&quot;network interceptor &quot; + interceptor</span><br><span class="line">         + &quot; must call proceed() exactly once&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Confirm that the intercepted response isn&#39;t null.</span><br><span class="line">   if (response &#x3D;&#x3D; null) &#123;</span><br><span class="line">     throw new NullPointerException(&quot;interceptor &quot; + interceptor + &quot; returned null&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   if (response.body() &#x3D;&#x3D; null) &#123;</span><br><span class="line">     throw new IllegalStateException(</span><br><span class="line">         &quot;interceptor &quot; + interceptor + &quot; returned a response with no body&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return response;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在这里一步步遍历拦截器，最终返回请求结果.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/01/02/2019-01-02-Okhttp%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" data-id="ck8tr9s6s000jn29k7gbs02vj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-31-BroadCastReceiver的工作过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/31/2018-12-31-BroadCastReceiver%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2018-12-30T16:00:00.000Z" itemprop="datePublished">2018-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/31/2018-12-31-BroadCastReceiver%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/">BroadCastReceiver的工作过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="广播的注册过程"><a href="#广播的注册过程" class="headerlink" title="广播的注册过程"></a>广播的注册过程</h2><p>Android广播的动态注册过程都会调用registerRecivier.<br>而registerReceiver方法是在ContextWrapper中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Intent registerReceiver(</span><br><span class="line">    BroadcastReceiver receiver, IntentFilter filter) &#123;</span><br><span class="line">    return mBase.registerReceiver(receiver, filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里mBase是一个ContenxtImpl，所以广播的动态注册又到了ContextImpl中。在ContextImpl中有很多的重载方法，但是都会执行registerReceiverInternal方法.</p>
<figure class="highlight plain"><figcaption><span>Intent registerReceiverInternal(BroadcastReceiver receiver, int userId,</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    IntentFilter filter, String broadcastPermission,</span><br><span class="line">    Handler scheduler, Context context) &#123;</span><br><span class="line">IIntentReceiver rd &#x3D; null;</span><br><span class="line">if (receiver !&#x3D; null) &#123;</span><br><span class="line">    if (mPackageInfo !&#x3D; null &amp;&amp; context !&#x3D; null) &#123;&#x2F;&#x2F;1</span><br><span class="line">        if (scheduler &#x3D;&#x3D; null) &#123;</span><br><span class="line">            scheduler &#x3D; mMainThread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        rd &#x3D; mPackageInfo.getReceiverDispatcher(</span><br><span class="line">            receiver, context, scheduler,</span><br><span class="line">            mMainThread.getInstrumentation(), true);&#x2F;&#x2F;2</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (scheduler &#x3D;&#x3D; null) &#123;</span><br><span class="line">            scheduler &#x3D; mMainThread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        rd &#x3D; new LoadedApk.ReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler, null, true).getIIntentReceiver();&#x2F;&#x2F;3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">try &#123;</span><br><span class="line">    final Intent intent &#x3D; ActivityManagerNative.getDefault().registerReceiver(</span><br><span class="line">            mMainThread.getApplicationThread(), mBasePackageName,</span><br><span class="line">            rd, filter, broadcastPermission, userId);&#x2F;&#x2F;4</span><br><span class="line">    if (intent !&#x3D; null) &#123;</span><br><span class="line">        intent.setExtrasClassLoader(getClassLoader());</span><br><span class="line">        intent.prepareToEnterProcess();</span><br><span class="line">    &#125;</span><br><span class="line">    return intent;</span><br><span class="line">&#125; catch (RemoteException e) &#123;</span><br><span class="line">    throw e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面中有一行关键的代码.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">final Intent intent &#x3D; ActivityManagerNative.getDefault().registerReceiver(</span><br><span class="line">                  mMainThread.getApplicationThread(), mBasePackageName,</span><br><span class="line">                  rd, filter, broadcastPermission, userId);</span><br></pre></td></tr></table></figure>
<p>在这里都知道是一个AMS，它最终执行的就是AMS中的registerReceiver.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> public Intent registerReceiver(IApplicationThread caller, String callerPackage,</span><br><span class="line">            IIntentReceiver receiver, IntentFilter filter, String permission, int userId) &#123;</span><br><span class="line">...</span><br><span class="line"> synchronized(this) &#123;</span><br><span class="line">  ...</span><br><span class="line">            Iterator&lt;String&gt; actions &#x3D; filter.actionsIterator();&#x2F;&#x2F;1</span><br><span class="line">  ...</span><br><span class="line">            &#x2F;&#x2F; Collect stickies of users</span><br><span class="line">            int[] userIds &#x3D; &#123; UserHandle.USER_ALL, UserHandle.getUserId(callingUid) &#125;;</span><br><span class="line">            while (actions.hasNext()) &#123;</span><br><span class="line">                String action &#x3D; actions.next();</span><br><span class="line">                for (int id : userIds) &#123;</span><br><span class="line">                    ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies &#x3D; mStickyBroadcasts.get(id);</span><br><span class="line">                    if (stickies !&#x3D; null) &#123;</span><br><span class="line">                        ArrayList&lt;Intent&gt; intents &#x3D; stickies.get(action);</span><br><span class="line">                        if (intents !&#x3D; null) &#123;</span><br><span class="line">                            if (stickyIntents &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                stickyIntents &#x3D; new ArrayList&lt;Intent&gt;();</span><br><span class="line">                            &#125;</span><br><span class="line">                            stickyIntents.addAll(intents);&#x2F;&#x2F;2</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  ArrayList&lt;Intent&gt; allSticky &#x3D; null;	</span><br><span class="line">        if (stickyIntents !&#x3D; null) &#123;</span><br><span class="line">            final ContentResolver resolver &#x3D; mContext.getContentResolver();</span><br><span class="line">            for (int i &#x3D; 0, N &#x3D; stickyIntents.size(); i &lt; N; i++) &#123;</span><br><span class="line">                Intent intent &#x3D; stickyIntents.get(i);</span><br><span class="line">                if (filter.match(resolver, intent, true, TAG) &gt;&#x3D; 0) &#123;</span><br><span class="line">                    if (allSticky &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        allSticky &#x3D; new ArrayList&lt;Intent&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    allSticky.add(intent);&#x2F;&#x2F;3</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> ...       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">synchronized (this) &#123;</span><br><span class="line">          ...</span><br><span class="line">            ReceiverList rl &#x3D; mRegisteredReceivers.get(receiver.asBinder());&#x2F;&#x2F;1</span><br><span class="line">            if (rl &#x3D;&#x3D; null) &#123;</span><br><span class="line">                rl &#x3D; new ReceiverList(this, callerApp, callingPid, callingUid,</span><br><span class="line">                        userId, receiver);&#x2F;&#x2F;2</span><br><span class="line">                if (rl.app !&#x3D; null) &#123;</span><br><span class="line">                    rl.app.receivers.add(rl);</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            BroadcastFilter bf &#x3D; new BroadcastFilter(filter, rl, callerPackage,</span><br><span class="line">                    permission, callingUid, userId);&#x2F;&#x2F;3</span><br><span class="line">            rl.add(bf);&#x2F;&#x2F;4</span><br><span class="line">            if (!bf.debugCheck()) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;&#x3D;&#x3D;&gt; For Dynamic broadcast&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            mReceiverResolver.addFilter(bf);&#x2F;&#x2F;5</span><br><span class="line">            ...</span><br><span class="line">            return sticky;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>第一步通过filter得到action的列表.第二步根据actions列表和useId得到所有粘性广播的intent，并传入stickyIntents，第三过将所有的粘性广播传入所有的allSticky。<br>同时将BroadcastFilter添加到mReceiverResolver.这样当AMS接收到广播时就可以从mReceiverResolver中找到对应的广播接收者了。</p>
<h2 id="广播的发送和接收过程"><a href="#广播的发送和接收过程" class="headerlink" title="广播的发送和接收过程"></a>广播的发送和接收过程</h2><p>发送无序广播需要发送sendBroadcast方法.这个方法的实现就是在ContenxtWrapper中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public void sendBroadcast(Intent intent) &#123;</span><br><span class="line">      mBase.sendBroadcast(intent);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>接着又执行到了ContextImpl中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public void sendBroadcast(Intent intent) &#123;</span><br><span class="line">      warnIfCallingFromSystemProcess();</span><br><span class="line">      String resolvedType &#x3D; intent.resolveTypeIfNeeded(getContentResolver());</span><br><span class="line">      try &#123;</span><br><span class="line">          intent.prepareToLeaveProcess(this);</span><br><span class="line">          ActivityManagerNative.getDefault().broadcastIntent(</span><br><span class="line">                  mMainThread.getApplicationThread(), intent, resolvedType, null,</span><br><span class="line">                  Activity.RESULT_OK, null, null, null, AppOpsManager.OP_NONE, null, false, false,</span><br><span class="line">                  getUserId());&#x2F;&#x2F;1</span><br><span class="line">      &#125; catch (RemoteException e) &#123;</span><br><span class="line">          throw e.rethrowFromSystemServer();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最终又会调用AMS中的broadcastIntent。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public final int broadcastIntent(IApplicationThread caller,</span><br><span class="line">          Intent intent, String resolvedType, IIntentReceiver resultTo,</span><br><span class="line">          int resultCode, String resultData, Bundle resultExtras,</span><br><span class="line">          String[] requiredPermissions, int appOp, Bundle bOptions,</span><br><span class="line">          boolean serialized, boolean sticky, int userId) &#123;</span><br><span class="line">      enforceNotIsolatedCaller(&quot;broadcastIntent&quot;);</span><br><span class="line">      synchronized(this) &#123;</span><br><span class="line">          intent &#x3D; verifyBroadcastLocked(intent);&#x2F;&#x2F;1</span><br><span class="line">        ...</span><br><span class="line">          &#x2F;**</span><br><span class="line">          * 2</span><br><span class="line">          *&#x2F;</span><br><span class="line">          int res &#x3D; broadcastIntentLocked(callerApp,</span><br><span class="line">                  callerApp !&#x3D; null ? callerApp.info.packageName : null,</span><br><span class="line">                  intent, resolvedType, resultTo, resultCode, resultData, resultExtras,</span><br><span class="line">                  requiredPermissions, appOp, bOptions, serialized, sticky,</span><br><span class="line">                  callingPid, callingUid, userId);</span><br><span class="line">          Binder.restoreCallingIdentity(origId);</span><br><span class="line">          return res;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中首先执行verifyBroadcastLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">final Intent verifyBroadcastLocked(Intent intent) &#123;</span><br><span class="line">       &#x2F;&#x2F; Refuse possible leaked file descriptors</span><br><span class="line">       if (intent !&#x3D; null &amp;&amp; intent.hasFileDescriptors() &#x3D;&#x3D; true) &#123;&#x2F;&#x2F;1</span><br><span class="line">           throw new IllegalArgumentException(&quot;File descriptors passed in Intent&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       int flags &#x3D; intent.getFlags();&#x2F;&#x2F;2</span><br><span class="line">       if (!mProcessesReady) &#123;</span><br><span class="line">           if ((flags&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT) !&#x3D; 0) &#123;&#x2F;&#x2F;3</span><br><span class="line">           &#125; else if ((flags&amp;Intent.FLAG_RECEIVER_REGISTERED_ONLY) &#x3D;&#x3D; 0) &#123;&#x2F;&#x2F;4</span><br><span class="line">               Slog.e(TAG, &quot;Attempt to launch receivers of broadcast intent &quot; + intent</span><br><span class="line">                       + &quot; before boot completion&quot;);</span><br><span class="line">               throw new IllegalStateException(&quot;Cannot broadcast before boot completed&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       if ((flags&amp;Intent.FLAG_RECEIVER_BOOT_UPGRADE) !&#x3D; 0) &#123;</span><br><span class="line">           throw new IllegalArgumentException(</span><br><span class="line">                   &quot;Can&#39;t use FLAG_RECEIVER_BOOT_UPGRADE here&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       return intent;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个主要是验证广播是否合法,然后调用AMS中的broadcastIntentLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">final int broadcastIntentLocked(ProcessRecord callerApp,</span><br><span class="line">            String callerPackage, Intent intent, String resolvedType,</span><br><span class="line">            IIntentReceiver resultTo, int resultCode, String resultData,</span><br><span class="line">            Bundle resultExtras, String[] requiredPermissions, int appOp, Bundle bOptions,</span><br><span class="line">            boolean ordered, boolean sticky, int callingPid, int callingUid, int userId) &#123;</span><br><span class="line">  ...</span><br><span class="line">       if ((receivers !&#x3D; null &amp;&amp; receivers.size() &gt; 0)</span><br><span class="line">                || resultTo !&#x3D; null) &#123;</span><br><span class="line">            BroadcastQueue queue &#x3D; broadcastQueueForIntent(intent);</span><br><span class="line">            &#x2F;**</span><br><span class="line">            * 1</span><br><span class="line">            *&#x2F;</span><br><span class="line">            BroadcastRecord r &#x3D; new BroadcastRecord(queue, intent, callerApp,</span><br><span class="line">                    callerPackage, callingPid, callingUid, resolvedType,</span><br><span class="line">                    requiredPermissions, appOp, brOptions, receivers, resultTo, resultCode,</span><br><span class="line">                    resultData, resultExtras, ordered, sticky, false, userId);</span><br><span class="line">     ...               </span><br><span class="line"></span><br><span class="line">            boolean replaced &#x3D; replacePending &amp;&amp; queue.replaceOrderedBroadcastLocked(r);</span><br><span class="line">            if (!replaced) &#123;</span><br><span class="line">                queue.enqueueOrderedBroadcastLocked(r);</span><br><span class="line">                queue.scheduleBroadcastsLocked();&#x2F;&#x2F;2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">        return ActivityManager.BROADCAST_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用scheduleBroadcastsLocked.</p>
<h2 id="AMS到BroadcastReceiver的调用过程"><a href="#AMS到BroadcastReceiver的调用过程" class="headerlink" title="AMS到BroadcastReceiver的调用过程."></a>AMS到BroadcastReceiver的调用过程.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleBroadcastsLocked() &#123;</span><br><span class="line">...</span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, this));&#x2F;&#x2F;1</span><br><span class="line">    mBroadcastsScheduled &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个mHandler就是BroadcastHandler。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private final class BroadcastHandler extends Handler &#123;</span><br><span class="line">    public BroadcastHandler(Looper looper) &#123;</span><br><span class="line">        super(looper, null, true);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void handleMessage(Message msg) &#123;</span><br><span class="line">        switch (msg.what) &#123;</span><br><span class="line">            case BROADCAST_INTENT_MSG: &#123;</span><br><span class="line">                if (DEBUG_BROADCAST) Slog.v(</span><br><span class="line">                        TAG_BROADCAST, &quot;Received BROADCAST_INTENT_MSG&quot;);</span><br><span class="line">                processNextBroadcast(true);</span><br><span class="line">            &#125; break;</span><br><span class="line">       ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在BROADCAST_INTENT_MSG中又调用了processNextBroadcast方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">final void processNextBroadcast(boolean fromMsg) &#123;</span><br><span class="line">...</span><br><span class="line">          if (fromMsg) &#123;</span><br><span class="line">              mBroadcastsScheduled &#x3D; false;&#x2F;&#x2F;1</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F; First, deliver any non-serialized broadcasts right away.</span><br><span class="line">          while (mParallelBroadcasts.size() &gt; 0) &#123;&#x2F;&#x2F;2</span><br><span class="line">              r &#x3D; mParallelBroadcasts.remove(0);&#x2F;&#x2F;3</span><br><span class="line">             ...</span><br><span class="line">              for (int i&#x3D;0; i&lt;N; i++) &#123;</span><br><span class="line">                Object target &#x3D; r.receivers.get(i);</span><br><span class="line">                if (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">                          &quot;Delivering non-ordered on [&quot; + mQueueName + &quot;] to registered &quot;</span><br><span class="line">                          + target + &quot;: &quot; + r);</span><br><span class="line">                deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, false, i);&#x2F;&#x2F;4</span><br><span class="line">              &#125;</span><br><span class="line">         ...</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将广播发送给对应的广播接收者deliverToRegisteredReceiverLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void deliverToRegisteredReceiverLocked(BroadcastRecord r,</span><br><span class="line">        BroadcastFilter filter, boolean ordered, int index) &#123;</span><br><span class="line">...</span><br><span class="line">   try &#123;</span><br><span class="line">            if (DEBUG_BROADCAST_LIGHT) Slog.i(TAG_BROADCAST,</span><br><span class="line">                    &quot;Delivering to &quot; + filter + &quot; : &quot; + r);</span><br><span class="line">            if (filter.receiverList.app !&#x3D; null &amp;&amp; filter.receiverList.app.inFullBackup) &#123;</span><br><span class="line">             ...   </span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                performReceiveLocked(filter.receiverList.app, filter.receiverList.receiver,</span><br><span class="line">                        new Intent(r.intent), r.resultCode, r.resultData,</span><br><span class="line">                        r.resultExtras, r.ordered, r.initialSticky, r.userId);&#x2F;&#x2F;1</span><br><span class="line">            &#125;</span><br><span class="line">            if (ordered) &#123;</span><br><span class="line">                r.state &#x3D; BroadcastRecord.CALL_DONE_RECEIVE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line"> ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些代码主要是检查权限.如果通过了权限的检查就会执行performReceiveLocked方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void performReceiveLocked(ProcessRecord app, IIntentReceiver receiver,</span><br><span class="line">          Intent intent, int resultCode, String data, Bundle extras,</span><br><span class="line">          boolean ordered, boolean sticky, int sendingUser) throws RemoteException &#123;</span><br><span class="line">      &#x2F;&#x2F; Send the intent to the receiver asynchronously using one-way binder calls.</span><br><span class="line">      if (app !&#x3D; null) &#123;&#x2F;&#x2F;1</span><br><span class="line">          if (app.thread !&#x3D; null) &#123;&#x2F;&#x2F;2</span><br><span class="line">              &#x2F;&#x2F; If we have an app thread, do the call through that so it is</span><br><span class="line">              &#x2F;&#x2F; correctly ordered with other one-way calls.</span><br><span class="line">              try &#123;</span><br><span class="line">                  app.thread.scheduleRegisteredReceiver(receiver, intent, resultCode,</span><br><span class="line">                          data, extras, ordered, sticky, sendingUser, app.repProcState);&#x2F;&#x2F;3          </span><br><span class="line">              &#125; </span><br><span class="line">          &#125; </span><br><span class="line">          ...</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          receiver.performReceive(intent, resultCode, data, extras, ordered,</span><br><span class="line">                  sticky, sendingUser);&#x2F;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里先检查当前进程是否存在并运行，这里的app.thread表示ApplicationThread.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleRegisteredReceiver(IIntentReceiver receiver, Intent intent,</span><br><span class="line">         int resultCode, String dataStr, Bundle extras, boolean ordered,</span><br><span class="line">         boolean sticky, int sendingUser, int processState) throws RemoteException &#123;</span><br><span class="line">     updateProcessState(processState, false);</span><br><span class="line">     receiver.performReceive(intent, resultCode, dataStr, extras, ordered,</span><br><span class="line">             sticky, sendingUser);&#x2F;&#x2F;1</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> static final class ReceiverDispatcher &#123;</span><br><span class="line">        final static class InnerReceiver extends IIntentReceiver.Stub &#123;</span><br><span class="line">        ...</span><br><span class="line">            InnerReceiver(LoadedApk.ReceiverDispatcher rd, boolean strong) &#123;</span><br><span class="line">                mDispatcher &#x3D; new WeakReference&lt;LoadedApk.ReceiverDispatcher&gt;(rd);</span><br><span class="line">                mStrongRef &#x3D; strong ? rd : null;</span><br><span class="line">            &#125;</span><br><span class="line">            @Override</span><br><span class="line">            public void performReceive(Intent intent, int resultCode, String data,</span><br><span class="line">                    Bundle extras, boolean ordered, boolean sticky, int sendingUser) &#123;</span><br><span class="line">                final LoadedApk.ReceiverDispatcher rd;</span><br><span class="line">                ...</span><br><span class="line">                if (rd !&#x3D; null) &#123;</span><br><span class="line">                    rd.performReceive(intent, resultCode, data, extras,</span><br><span class="line">                            ordered, sticky, sendingUser);&#x2F;&#x2F;1</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">             ...</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后又继续调用了performReceive方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void performReceive(Intent intent, int resultCode, String data,</span><br><span class="line">              Bundle extras, boolean ordered, boolean sticky, int sendingUser) &#123;</span><br><span class="line">          final Args args &#x3D; new Args(intent, resultCode, data, extras, ordered,</span><br><span class="line">                  sticky, sendingUser);&#x2F;&#x2F;1</span><br><span class="line">          ...</span><br><span class="line">          if (intent &#x3D;&#x3D; null || !mActivityThread.post(args)) &#123;&#x2F;&#x2F;2</span><br><span class="line">              if (mRegistered &amp;&amp; ordered) &#123;</span><br><span class="line">                  IActivityManager mgr &#x3D; ActivityManagerNative.getDefault();</span><br><span class="line">                  if (ActivityThread.DEBUG_BROADCAST) Slog.i(ActivityThread.TAG,</span><br><span class="line">                          &quot;Finishing sync broadcast to &quot; + mReceiver);</span><br><span class="line">                  args.sendFinished(mgr);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>在这里首先将广播的intent对象封装成Args对象,同时在mActivityThread.post(args)中将args的运行执行在主进程中。<br>又因为args继承了Runnable方法,所有最终消息就在run方法中被执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">  ...</span><br><span class="line">     try &#123;</span><br><span class="line">         ClassLoader cl &#x3D;  mReceiver.getClass().getClassLoader();</span><br><span class="line">         intent.setExtrasClassLoader(cl);</span><br><span class="line">         intent.prepareToEnterProcess();</span><br><span class="line">         setExtrasClassLoader(cl);</span><br><span class="line">         receiver.setPendingResult(this);</span><br><span class="line">         receiver.onReceive(mContext, intent);&#x2F;&#x2F;1</span><br><span class="line">     &#125; catch (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">     &#125;</span><br><span class="line">    ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>最终广播的onReceive就被执行了,这样就接收到了intent发送的消息。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/31/2018-12-31-BroadCastReceiver%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-id="ck8tr9s6t000ln29khu52fu74" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-29-Service的绑定过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/29/2018-12-29-Service%E7%9A%84%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2018-12-28T16:00:00.000Z" itemprop="datePublished">2018-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/29/2018-12-29-Service%E7%9A%84%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">Service的绑定过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Service的绑定过程和启动过程相同都是在ContextWrapper中调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class ContextWrapper extends Context &#123;</span><br><span class="line">    Context mBase;</span><br><span class="line">...</span><br><span class="line">  @Override</span><br><span class="line">    public ComponentName bindService(Intent service) &#123;</span><br><span class="line">        return mBase.bindService(service);</span><br><span class="line">    &#125;</span><br><span class="line">...    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在bindService中调用bindServiceCommon。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public boolean bindService(Intent service, ServiceConnection conn,</span><br><span class="line">           int flags) &#123;</span><br><span class="line">       warnIfCallingFromSystemProcess();</span><br><span class="line">       return bindServiceCommon(service, conn, flags, mMainThread.getHandler(),</span><br><span class="line">               Process.myUserHandle());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在这里又return bindServiceCommon.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, Handler</span><br><span class="line">        handler, UserHandle user) &#123;</span><br><span class="line">    IServiceConnection sd;</span><br><span class="line">    if (conn &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;connection is null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mPackageInfo !&#x3D; null) &#123;</span><br><span class="line">        sd &#x3D; mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);&#x2F;&#x2F;1</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Not supported in system context&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    validateServiceIntent(service);</span><br><span class="line">    try &#123;</span><br><span class="line">     ...</span><br><span class="line">     &#x2F;**</span><br><span class="line">     * 2</span><br><span class="line">     *&#x2F;</span><br><span class="line">        int res &#x3D; ActivityManagerNative.getDefault().bindService(</span><br><span class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()),</span><br><span class="line">            sd, flags, getOpPackageName(), user.getIdentifier());</span><br><span class="line">      ...</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        throw e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags)的作用是将ServiceConnect封装成IServiceConnection的sd对象.<br>最终会调用AMS的bindService.<br>AMS#bindService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  public int bindService(IApplicationThread caller, IBinder token, Intent service,</span><br><span class="line">            String resolvedType, IServiceConnection connection, int flags, String callingPackage,</span><br><span class="line">            int userId) throws TransactionTooLargeException &#123;</span><br><span class="line">        enforceNotIsolatedCaller(&quot;bindService&quot;);</span><br><span class="line">...</span><br><span class="line">        synchronized(this) &#123;</span><br><span class="line">            return mServices.bindServiceLocked(caller, token, service,</span><br><span class="line">                    resolvedType, connection, flags, callingPackage, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>bindService最后会调用bindServiceLocked方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service,</span><br><span class="line">            String resolvedType, final IServiceConnection connection, int flags,</span><br><span class="line">            String callingPackage, final int userId) throws TransactionTooLargeException &#123;</span><br><span class="line"> ...</span><br><span class="line"> if ((flags&amp;Context.BIND_AUTO_CREATE) !&#x3D; 0) &#123;</span><br><span class="line">                s.lastActivity &#x3D; SystemClock.uptimeMillis();</span><br><span class="line">                &#x2F;**</span><br><span class="line">                *  1</span><br><span class="line">                *&#x2F;</span><br><span class="line">                if (bringUpServiceLocked(s, service.getFlags(), callerFg, false,</span><br><span class="line">                        permissionsReviewRequired) !&#x3D; null) &#123;</span><br><span class="line">                    return 0;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ...</span><br><span class="line">            if (s.app !&#x3D; null &amp;&amp; b.intent.received) &#123;&#x2F;&#x2F;2</span><br><span class="line">                try &#123;</span><br><span class="line">                    c.conn.connected(s.name, b.intent.binder);&#x2F;&#x2F;3</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                ...</span><br><span class="line">                &#125;</span><br><span class="line">                if (b.intent.apps.size() &#x3D;&#x3D; 1 &amp;&amp; b.intent.doRebind) &#123;&#x2F;&#x2F;4</span><br><span class="line">                    requestServiceBindingLocked(s, b.intent, callerFg, true);&#x2F;&#x2F;5</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (!b.intent.requested) &#123;&#x2F;&#x2F;6</span><br><span class="line">                requestServiceBindingLocked(s, b.intent, callerFg, false);&#x2F;&#x2F;7</span><br><span class="line">            &#125;</span><br><span class="line">            getServiceMap(s.userId).ensureNotStartingBackground(s);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">        return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这行代码中通过bringUpServiceLocked最终会调用realStartServiceLocked来启动一个Service.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  if (bringUpServiceLocked(s, service.getFlags(), callerFg, false,</span><br><span class="line">            permissionsReviewRequired) !&#x3D; null) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行requestServiceBindingLocked方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i,</span><br><span class="line">        boolean execInFg, boolean rebind) throws TransactionTooLargeException &#123;</span><br><span class="line">   ...</span><br><span class="line">    if ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; 0) &#123;&#x2F;&#x2F;1</span><br><span class="line">        try &#123;</span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, &quot;bind&quot;);</span><br><span class="line">            r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">            r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</span><br><span class="line">                    r.app.repProcState);&#x2F;&#x2F;2</span><br><span class="line">           ...</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先发送一个是否绑定Service的请求,r.app.thread的类型为IApplicationThread,t它是ActivityThread的内部类ApplictionThread.最后它执行了scheduleBindService.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final void scheduleBindService(IBinder token, Intent intent,</span><br><span class="line">               boolean rebind, int processState) &#123;</span><br><span class="line">           updateProcessState(processState, false);</span><br><span class="line">           BindServiceData s &#x3D; new BindServiceData();</span><br><span class="line">           s.token &#x3D; token;</span><br><span class="line">           s.intent &#x3D; intent;</span><br><span class="line">           s.rebind &#x3D; rebind;</span><br><span class="line">           if (DEBUG_SERVICE)</span><br><span class="line">               Slog.v(TAG, &quot;scheduleBindService token&#x3D;&quot; + token + &quot; intent&#x3D;&quot; + intent + &quot; uid&#x3D;&quot;</span><br><span class="line">                       + Binder.getCallingUid() + &quot; pid&#x3D;&quot; + Binder.getCallingPid());</span><br><span class="line">           sendMessage(H.BIND_SERVICE, s);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>在这里发送一个sendMessage消息给H。ActivityThread的内部类H接收到这个消息.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Message msg) &#123;</span><br><span class="line">          if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));</span><br><span class="line">          switch (msg.what) &#123;</span><br><span class="line">          ...</span><br><span class="line">              case BIND_SERVICE:</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceBind&quot;);</span><br><span class="line">                    handleBindService((BindServiceData)msg.obj);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    break;</span><br><span class="line">          ...</span><br><span class="line">           &#125;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">     ...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleBindService执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void handleBindService(BindServiceData data) &#123;</span><br><span class="line">        Service s &#x3D; mServices.get(data.token);&#x2F;&#x2F;1</span><br><span class="line">        if (DEBUG_SERVICE)</span><br><span class="line">            Slog.v(TAG, &quot;handleBindService s&#x3D;&quot; + s + &quot; rebind&#x3D;&quot; + data.rebind);</span><br><span class="line">        if (s !&#x3D; null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">                data.intent.prepareToEnterProcess();</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (!data.rebind) &#123;&#x2F;&#x2F;2</span><br><span class="line">                        IBinder binder &#x3D; s.onBind(data.intent);&#x2F;&#x2F;3</span><br><span class="line">                        ActivityManagerNative.getDefault().publishService(</span><br><span class="line">                                data.token, data.intent, binder);&#x2F;&#x2F;4</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        s.onRebind(data.intent);&#x2F;&#x2F;5</span><br><span class="line">                        ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                                data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ensureJitEnabled();</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先取出要绑定的Service。<br><code>Service s = mServices.get(data.token);//1</code><br>这里判断data.bind是否已经绑定过，显然这里是返回false，然后执行s.onBind方法进行绑定和AMS的publishService方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void publishService(IBinder token, Intent intent, IBinder service) &#123;</span><br><span class="line">  ...</span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line">        if (!(token instanceof ServiceRecord)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Invalid service token&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        mServices.publishServiceLocked((ServiceRecord)token, intent, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用Active#publishServiceLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void publishServiceLocked(ServiceRecord r, Intent intent, IBinder service) &#123;</span><br><span class="line">       final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">       try &#123;</span><br><span class="line">          ...</span><br><span class="line">                   for (int conni&#x3D;r.connections.size()-1; conni&gt;&#x3D;0; conni--) &#123;</span><br><span class="line">                       ArrayList&lt;ConnectionRecord&gt; clist &#x3D; r.connections.valueAt(conni);</span><br><span class="line">                       for (int i&#x3D;0; i&lt;clist.size(); i++) &#123;</span><br><span class="line">                        ...</span><br><span class="line">                           try &#123;</span><br><span class="line">                               c.conn.connected(r.name, service);&#x2F;&#x2F;1</span><br><span class="line">                           &#125; catch (Exception e) &#123;</span><br><span class="line">                            ...</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), false);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           Binder.restoreCallingIdentity(origId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>c.conn的具体实现是ServiceDispatcher.InnerConnection。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">static final class ServiceDispatcher &#123;</span><br><span class="line">     ...</span><br><span class="line">        private static class InnerConnection extends IServiceConnection.Stub &#123;</span><br><span class="line">            final WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</span><br><span class="line">            InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</span><br><span class="line">                mDispatcher &#x3D; new WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</span><br><span class="line">            &#125;</span><br><span class="line">            public void connected(ComponentName name, IBinder service) throws RemoteException &#123;</span><br><span class="line">                LoadedApk.ServiceDispatcher sd &#x3D; mDispatcher.get();</span><br><span class="line">                if (sd !&#x3D; null) &#123;</span><br><span class="line">                    sd.connected(name, service);&#x2F;&#x2F;1</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在connected方法中调用了LoadedApk.ServiceDispatcher的connected</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void connected(ComponentName name, IBinder service) &#123;</span><br><span class="line">            if (mActivityThread !&#x3D; null) &#123;</span><br><span class="line">                mActivityThread.post(new RunConnection(name, service, 0));&#x2F;&#x2F;1</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                doConnected(name, service);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>mActivityThread实际上指向的是一个H。通过Post方法将RunConnection方法运行在主线程中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private final class RunConnection implements Runnable &#123;</span><br><span class="line">        RunConnection(ComponentName name, IBinder service, int command) &#123;</span><br><span class="line">            mName &#x3D; name;</span><br><span class="line">            mService &#x3D; service;</span><br><span class="line">            mCommand &#x3D; command;</span><br><span class="line">        &#125;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            if (mCommand &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                doConnected(mName, mService);</span><br><span class="line">            &#125; else if (mCommand &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                doDeath(mName, mService);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        final ComponentName mName;</span><br><span class="line">        final IBinder mService;</span><br><span class="line">        final int mCommand;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<pre><code>然后调用doConnected方法.</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void doConnected(ComponentName name, IBinder service) &#123;</span><br><span class="line">  ...</span><br><span class="line">    &#x2F;&#x2F; If there was an old service, it is not disconnected.</span><br><span class="line">    if (old !&#x3D; null) &#123;</span><br><span class="line">        mConnection.onServiceDisconnected(name);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; If there is a new service, it is now connected.</span><br><span class="line">    if (service !&#x3D; null) &#123;</span><br><span class="line">        mConnection.onServiceConnected(name, service);&#x2F;&#x2F;1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在客户端中实现ServiceConnection接口的实现类的onServiceConnected和onServiceDisconected方法就会执行.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/29/2018-12-29-Service%E7%9A%84%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="ck8tr9s6p000dn29k0fuifaw5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-28-Service的启动过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/28/2018-12-28-Service%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2018-12-27T16:00:00.000Z" itemprop="datePublished">2018-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/28/2018-12-28-Service%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">Service的启动过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android开发中我们通常要启动一个Service一般都会执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startService(new Intent());</span><br></pre></td></tr></table></figure>
<p>这段代码的逻辑在Contextwrapper中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class ContextWrapper extends Context &#123;</span><br><span class="line">    Context mBase;</span><br><span class="line">...</span><br><span class="line">  @Override</span><br><span class="line">    public ComponentName startService(Intent service) &#123;</span><br><span class="line">        return mBase.startService(service);</span><br><span class="line">    &#125;</span><br><span class="line">...    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在startService中程序返回执行了mBase.startService.而mBase是一个Context上下文对象，在ActivityThread中启动Activity会调用performLaunchActivity和创建上下文对象.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">  ...</span><br><span class="line">            if (activity !&#x3D; null) &#123;</span><br><span class="line">                Context appContext &#x3D; createBaseContextForActivity(r, activity);&#x2F;&#x2F;1</span><br><span class="line">         ...</span><br><span class="line">                &#125;</span><br><span class="line">                activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window);</span><br><span class="line">                ...</span><br><span class="line">        &#125;</span><br><span class="line">        return activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在performLaunchActivity中会执行createBaseContextForActivity。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private Context createBaseContextForActivity(ActivityClientRecord r, final Activity activity) &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    ContextImpl appContext &#x3D; ContextImpl.createActivityContext(</span><br><span class="line">            this, r.packageInfo, r.token, displayId, r.overrideConfig);</span><br><span class="line">    appContext.setOuterContext(activity);</span><br><span class="line">    Context baseContext &#x3D; appContext;</span><br><span class="line">    ...</span><br><span class="line">    return baseContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里创建ContextImpl对象并返回。然后调用Activity#attach方法将上下文对象和appContext关联起来。那么最终启动Service就进入了ContextImpl中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line">public ComponentName startService(Intent service) &#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    return startServiceCommon(service, mUser);</span><br><span class="line">&#125;</span><br><span class="line"> private ComponentName startServiceCommon(Intent service, UserHandle user) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            validateServiceIntent(service);</span><br><span class="line">            service.prepareToLeaveProcess(this);</span><br><span class="line">            &#x2F;**</span><br><span class="line">            * 1</span><br><span class="line">            *&#x2F;</span><br><span class="line">            ComponentName cn &#x3D; ActivityManagerNative.getDefault().startService(</span><br><span class="line">                mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line">                            getContentResolver()), getOpPackageName(), user.getIdentifier());</span><br><span class="line">      ...</span><br><span class="line">            return cn;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>startService最终返回了startServiceCommon。<br>在startServiceCommon中有一个重要的代码ActivityManagerNative.getDefault()这个是一个AMS最终Service的启动又交给了AMS来处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line">public ComponentName startService(IApplicationThread caller, Intent service,</span><br><span class="line">        String resolvedType, String callingPackage, int userId)</span><br><span class="line">        throws TransactionTooLargeException &#123;</span><br><span class="line"> ...</span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line"> ...</span><br><span class="line">        ComponentName res &#x3D; mServices.startServiceLocked(caller, service,</span><br><span class="line">                resolvedType, callingPid, callingUid, callingPackage, userId);&#x2F;&#x2F;1</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在里继续调用mServices.startServiceLocked，mServices的类型是ActiveServices。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType,</span><br><span class="line">            int callingPid, int callingUid, String callingPackage, final int userId)</span><br><span class="line">            throws TransactionTooLargeException &#123;</span><br><span class="line">      ...</span><br><span class="line">        return startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ComponentName startServiceInnerLocked(ServiceMap smap, Intent service, ServiceRecord r,</span><br><span class="line">            boolean callerFg, boolean addToStarting) throws TransactionTooLargeException &#123;</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line">        String error &#x3D; bringUpServiceLocked(r, service.getFlags(), callerFg, false, false);</span><br><span class="line">     ...</span><br><span class="line">        return r.name;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在startServiceInnerLocked中又调用了bringUpServiceLocked</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> private String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg,</span><br><span class="line">            boolean whileRestarting, boolean permissionsReviewRequired)</span><br><span class="line">            throws TransactionTooLargeException &#123;</span><br><span class="line">...</span><br><span class="line">  final String procName &#x3D; r.processName;&#x2F;&#x2F;1</span><br><span class="line">  ProcessRecord app;</span><br><span class="line">  if (!isolated) &#123;</span><br><span class="line">            app &#x3D; mAm.getProcessRecordLocked(procName, r.appInfo.uid, false);&#x2F;&#x2F;2</span><br><span class="line">            if (DEBUG_MU) Slog.v(TAG_MU, &quot;bringUpServiceLocked: appInfo.uid&#x3D;&quot; + r.appInfo.uid</span><br><span class="line">                        + &quot; app&#x3D;&quot; + app);</span><br><span class="line">            if (app !&#x3D; null &amp;&amp; app.thread !&#x3D; null) &#123;&#x2F;&#x2F;3</span><br><span class="line">                try &#123;</span><br><span class="line">                    app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</span><br><span class="line">                    realStartServiceLocked(r, app, execInFg);&#x2F;&#x2F;4</span><br><span class="line">                    return null;</span><br><span class="line">                &#125; catch (TransactionTooLargeException e) &#123;</span><br><span class="line">                    throw e;</span><br><span class="line">                &#125; catch (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, &quot;Exception when starting service &quot; + r.shortName, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            app &#x3D; r.isolatedProc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> if (app &#x3D;&#x3D; null &amp;&amp; !permissionsReviewRequired) &#123;&#x2F;&#x2F;5</span><br><span class="line">            if ((app&#x3D;mAm.startProcessLocked(procName, r.appInfo, true, intentFlags,</span><br><span class="line">                    &quot;service&quot;, r.name, false, isolated, false)) &#x3D;&#x3D; null) &#123;&#x2F;&#x2F;6</span><br><span class="line">              ...</span><br><span class="line">            &#125;</span><br><span class="line">            if (isolated) &#123;</span><br><span class="line">                r.isolatedProc &#x3D; app;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> ...     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是判断当前运行的Service进程是否存在如果不存在就执行mAm.startProcessLocked，如果存在就执行realStartServiceLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private final void realStartServiceLocked(ServiceRecord r,</span><br><span class="line">        ProcessRecord app, boolean execInFg) throws RemoteException &#123;</span><br><span class="line">   ...</span><br><span class="line">    try &#123;</span><br><span class="line">       ...</span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line">        r.postNotification();</span><br><span class="line">        created &#x3D; true;</span><br><span class="line">    &#125; catch (DeadObjectException e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中app.thread是一个IApplicationThread类型，它的实现类是ActivityThread的内部类ApplicationThread。然后ApplicationThread调用scheduleCreateService方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void scheduleCreateService(IBinder token,</span><br><span class="line">           ServiceInfo info, CompatibilityInfo compatInfo, int processState) &#123;</span><br><span class="line">       updateProcessState(processState, false);</span><br><span class="line">       CreateServiceData s &#x3D; new CreateServiceData();</span><br><span class="line">       s.token &#x3D; token;</span><br><span class="line">       s.info &#x3D; info;</span><br><span class="line">       s.compatInfo &#x3D; compatInfo;</span><br><span class="line">       sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>H是ActivityThread的内部类，继承了Handler.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Message msg) &#123;</span><br><span class="line">            if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));</span><br><span class="line">            switch (msg.what) &#123;</span><br><span class="line">            ...</span><br><span class="line">               case CREATE_SERVICE:</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (&quot;serviceCreate: &quot; + String.valueOf(msg.obj)));</span><br><span class="line">                    handleCreateService((CreateServiceData)msg.obj);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    break;</span><br><span class="line">            ...</span><br><span class="line">             &#125;</span><br><span class="line">          ...</span><br><span class="line">          &#125;</span><br><span class="line">       ...   </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后又执行了handleCreateService。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void handleCreateService(CreateServiceData data) &#123;</span><br><span class="line">       unscheduleGcIdler();</span><br><span class="line">       LoadedApk packageInfo &#x3D; getPackageInfoNoCheck(</span><br><span class="line">               data.info.applicationInfo, data.compatInfo);&#x2F;&#x2F;1</span><br><span class="line">       Service service &#x3D; null;</span><br><span class="line">       try &#123;</span><br><span class="line">           java.lang.ClassLoader cl &#x3D; packageInfo.getClassLoader();&#x2F;&#x2F;2</span><br><span class="line">           service &#x3D; (Service) cl.loadClass(data.info.name).newInstance();&#x2F;&#x2F;3</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">          ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       try &#123;</span><br><span class="line">           if (localLOGV) Slog.v(TAG, &quot;Creating service &quot; + data.info.name);</span><br><span class="line"></span><br><span class="line">           ContextImpl context &#x3D; ContextImpl.createAppContext(this, packageInfo);&#x2F;&#x2F;4</span><br><span class="line">           context.setOuterContext(service);</span><br><span class="line"></span><br><span class="line">           Application app &#x3D; packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line">           service.attach(context, this, data.info.name, data.token, app,</span><br><span class="line">                   ActivityManagerNative.getDefault());&#x2F;&#x2F;5</span><br><span class="line">           service.onCreate();&#x2F;&#x2F;6</span><br><span class="line">           mServices.put(data.token, service);&#x2F;&#x2F;7</span><br><span class="line">        ...</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在这里首先通过类加载器创建了一个Service对象,然后调用attach来初始化Service.<br>接下来继续执行service.onCreate()执行启动这个Service.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/28/2018-12-28-Service%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="ck8tr9s6q000fn29kfcyab8or" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-27-Android应用程序启动过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/27/2018-12-27-Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2018-12-26T16:00:00.000Z" itemprop="datePublished">2018-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/2018-12-27-Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">Android应用程序启动过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android手机中我们的桌面就是一个Launcher程序应用，当我们将一个App安装到手机上时就会在Launcher应用中将这个App的应用图标显示出来，当我们点击这个图标时，Launcher就将这个对应的图标应用启动起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">* Default launcher application.</span><br><span class="line">*&#x2F;</span><br><span class="line">public final class Launcher extends Activity</span><br><span class="line">		implements View.OnClickListener, OnLongClickListener, LauncherModel.Callbacks, AllAppsView.Watcher &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	&#x2F;**</span><br><span class="line">	* Launches the intent referred by the clicked shortcut.</span><br><span class="line">	*</span><br><span class="line">	* @param v The view representing the clicked shortcut.</span><br><span class="line">	*&#x2F;</span><br><span class="line">	public void onClick(View v) &#123;</span><br><span class="line">		Object tag &#x3D; v.getTag();</span><br><span class="line">		if (tag instanceof ShortcutInfo) &#123;</span><br><span class="line">			&#x2F;&#x2F; Open shortcut</span><br><span class="line">			final Intent intent &#x3D; ((ShortcutInfo) tag).intent;</span><br><span class="line">			int[] pos &#x3D; new int[2];</span><br><span class="line">			v.getLocationOnScreen(pos);</span><br><span class="line">			intent.setSourceBounds(new Rect(pos[0], pos[1],</span><br><span class="line">				pos[0] + v.getWidth(), pos[1] + v.getHeight()));</span><br><span class="line">			startActivitySafely(intent, tag);</span><br><span class="line">		&#125; else if (tag instanceof FolderInfo) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; else if (v &#x3D;&#x3D; mHandleView) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	void startActivitySafely(Intent intent, Object tag) &#123;</span><br><span class="line">		intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">		try &#123;</span><br><span class="line">			startActivity(intent);</span><br><span class="line">		&#125; catch (ActivityNotFoundException e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; catch (SecurityException e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码中可以知道Launcher其实也是一个Activity，当我们执行点击操作就会执行onClick方法，然后就会执行startActivitySafely，这里主要是：</p>
<ol>
<li>给待启动的程序的Intent设置一个新的Task</li>
<li>调用Activity的startActivity启动这个应用的主Activity</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Activity extends ContextThemeWrapper</span><br><span class="line">		implements LayoutInflater.Factory,</span><br><span class="line">		Window.Callback, KeyEvent.Callback,</span><br><span class="line">		OnCreateContextMenuListener, ComponentCallbacks &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	@Override</span><br><span class="line">	public void startActivity(Intent intent) &#123;</span><br><span class="line">		startActivityForResult(intent, -1);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>执行了startActivity之后就会接着执行startActivityForResult方法，这里传入-1表示不需要返回结果。<br>然后执行Activity#startActivityForResult</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class Activity extends ContextThemeWrapper</span><br><span class="line">		implements LayoutInflater.Factory,</span><br><span class="line">		Window.Callback, KeyEvent.Callback,</span><br><span class="line">		OnCreateContextMenuListener, ComponentCallbacks &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public void startActivityForResult(Intent intent, int requestCode) &#123;</span><br><span class="line">		if (mParent &#x3D;&#x3D; null) &#123;</span><br><span class="line">			Instrumentation.ActivityResult ar &#x3D;</span><br><span class="line">				mInstrumentation.execStartActivity(</span><br><span class="line">				this, mMainThread.getApplicationThread(), mToken, this,</span><br><span class="line">				intent, requestCode);</span><br><span class="line">			......</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里mMainThread.getApplicationThread表示ApplicationThread。而mMainThread它的类型是ActivityThread，所以ApplicationThread是ActivityThread的内部类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class Instrumentation &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public ActivityResult execStartActivity(</span><br><span class="line">	Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">	Intent intent, int requestCode) &#123;</span><br><span class="line">		IApplicationThread whoThread &#x3D; (IApplicationThread) contextThread;</span><br><span class="line">		if (mActivityMonitors !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		try &#123;</span><br><span class="line">			int result &#x3D; ActivityManagerNative.getDefault()</span><br><span class="line">				.startActivity(whoThread, intent,</span><br><span class="line">				intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">				null, 0, token, target !&#x3D; null ? target.mEmbeddedID : null,</span><br><span class="line">				requestCode, false, false);</span><br><span class="line">			......</span><br><span class="line">		&#125; catch (RemoteException e) &#123;</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的ActiviyManagerNative.getDefault返回的是ActivityManagerService接口，即ActivityManagerProxy接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class ActivityManagerProxy implements IActivityManager</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public int startActivity(IApplicationThread caller, Intent intent,</span><br><span class="line">			String resolvedType, Uri[] grantedUriPermissions, int grantedMode,</span><br><span class="line">			IBinder resultTo, String resultWho,</span><br><span class="line">			int requestCode, boolean onlyIfNeeded,</span><br><span class="line">			boolean debug) throws RemoteException &#123;</span><br><span class="line">		Parcel data &#x3D; Parcel.obtain();</span><br><span class="line">		Parcel reply &#x3D; Parcel.obtain();</span><br><span class="line">		data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">		data.writeStrongBinder(caller !&#x3D; null ? caller.asBinder() : null);</span><br><span class="line">		intent.writeToParcel(data, 0);</span><br><span class="line">		data.writeString(resolvedType);</span><br><span class="line">		data.writeTypedArray(grantedUriPermissions, 0);</span><br><span class="line">		data.writeInt(grantedMode);</span><br><span class="line">		data.writeStrongBinder(resultTo);</span><br><span class="line">		data.writeString(resultWho);</span><br><span class="line">		data.writeInt(requestCode);</span><br><span class="line">		data.writeInt(onlyIfNeeded ? 1 : 0);</span><br><span class="line">		data.writeInt(debug ? 1 : 0);</span><br><span class="line">		mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0);</span><br><span class="line">		reply.readException();</span><br><span class="line">		int result &#x3D; reply.readInt();</span><br><span class="line">		reply.recycle();</span><br><span class="line">		data.recycle();</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过ActivityManagerService的Binder程序进入到ActivityManagerService方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public final int startActivity(IApplicationThread caller,</span><br><span class="line">			Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">			int grantedMode, IBinder resultTo,</span><br><span class="line">			String resultWho, int requestCode, boolean onlyIfNeeded,</span><br><span class="line">			boolean debug) &#123;</span><br><span class="line">		return mMainStack.startActivityMayWait(caller, intent, resolvedType,</span><br><span class="line">			grantedUriPermissions, grantedMode, resultTo, resultWho,</span><br><span class="line">			requestCode, onlyIfNeeded, debug, null, null);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将startActivity交给了成员变量mMainStack.<br>ActivityStack#startActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final int startActivityMayWait(IApplicationThread caller,</span><br><span class="line">			Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">			int grantedMode, IBinder resultTo,</span><br><span class="line">			String resultWho, int requestCode, boolean onlyIfNeeded,</span><br><span class="line">			boolean debug, WaitResult outResult, Configuration config) &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		boolean componentSpecified &#x3D; intent.getComponent() !&#x3D; null;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Don&#39;t modify the client&#39;s object!</span><br><span class="line">		intent &#x3D; new Intent(intent);</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Collect information about the target of the Intent.</span><br><span class="line">		ActivityInfo aInfo;</span><br><span class="line">		try &#123;</span><br><span class="line">			ResolveInfo rInfo &#x3D;</span><br><span class="line">				AppGlobals.getPackageManager().resolveIntent(</span><br><span class="line">				intent, resolvedType,</span><br><span class="line">				PackageManager.MATCH_DEFAULT_ONLY</span><br><span class="line">				| ActivityManagerService.STOCK_PM_FLAGS);</span><br><span class="line">			aInfo &#x3D; rInfo !&#x3D; null ? rInfo.activityInfo : null;</span><br><span class="line">		&#125; catch (RemoteException e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (aInfo !&#x3D; null) &#123;</span><br><span class="line">			&#x2F;&#x2F; Store the found target back into the intent, because now that</span><br><span class="line">			&#x2F;&#x2F; we have it we never want to do this again.  For example, if the</span><br><span class="line">			&#x2F;&#x2F; user navigates back to this point in the history, we should</span><br><span class="line">			&#x2F;&#x2F; always restart the exact same activity.</span><br><span class="line">			intent.setComponent(new ComponentName(</span><br><span class="line">				aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		synchronized (mService) &#123;</span><br><span class="line">			int callingPid;</span><br><span class="line">			int callingUid;</span><br><span class="line">			if (caller &#x3D;&#x3D; null) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				callingPid &#x3D; callingUid &#x3D; -1;</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			mConfigWillChange &#x3D; config !&#x3D; null</span><br><span class="line">				&amp;&amp; mService.mConfiguration.diff(config) !&#x3D; 0;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			if (mMainStack &amp;&amp; aInfo !&#x3D; null &amp;&amp;</span><br><span class="line">				(aInfo.applicationInfo.flags&amp;ApplicationInfo.FLAG_CANT_SAVE_STATE) !&#x3D; 0) &#123;</span><br><span class="line">				  </span><br><span class="line">		              ......</span><br><span class="line"> </span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			int res &#x3D; startActivityLocked(caller, intent, resolvedType,</span><br><span class="line">				grantedUriPermissions, grantedMode, aInfo,</span><br><span class="line">				resultTo, resultWho, requestCode, callingPid, callingUid,</span><br><span class="line">				onlyIfNeeded, componentSpecified);</span><br><span class="line"> </span><br><span class="line">			if (mConfigWillChange &amp;&amp; mMainStack) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			if (outResult !&#x3D; null) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			return res;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里解析我们程序的Intent参数之后，接下来就Activity的启动交给了startActivityLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final int startActivityLocked(IApplicationThread caller,</span><br><span class="line">		    Intent intent, String resolvedType,</span><br><span class="line">		    Uri[] grantedUriPermissions,</span><br><span class="line">		    int grantedMode, ActivityInfo aInfo, IBinder resultTo,</span><br><span class="line">	            String resultWho, int requestCode,</span><br><span class="line">		    int callingPid, int callingUid, boolean onlyIfNeeded,</span><br><span class="line">		    boolean componentSpecified) &#123;</span><br><span class="line">	        int err &#x3D; START_SUCCESS;</span><br><span class="line"> </span><br><span class="line">		ProcessRecord callerApp &#x3D; null;</span><br><span class="line">		if (caller !&#x3D; null) &#123;</span><br><span class="line">			callerApp &#x3D; mService.getRecordForAppLocked(caller);</span><br><span class="line">			if (callerApp !&#x3D; null) &#123;</span><br><span class="line">				callingPid &#x3D; callerApp.pid;</span><br><span class="line">				callingUid &#x3D; callerApp.info.uid;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		ActivityRecord sourceRecord &#x3D; null;</span><br><span class="line">		ActivityRecord resultRecord &#x3D; null;</span><br><span class="line">		if (resultTo !&#x3D; null) &#123;</span><br><span class="line">			int index &#x3D; indexOfTokenLocked(resultTo);</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line">				</span><br><span class="line">			if (index &gt;&#x3D; 0) &#123;</span><br><span class="line">				sourceRecord &#x3D; (ActivityRecord)mHistory.get(index);</span><br><span class="line">				if (requestCode &gt;&#x3D; 0 &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class="line">					......</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		int launchFlags &#x3D; intent.getFlags();</span><br><span class="line"> </span><br><span class="line">		if ((launchFlags&amp;Intent.FLAG_ACTIVITY_FORWARD_RESULT) !&#x3D; 0</span><br><span class="line">			&amp;&amp; sourceRecord !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (err &#x3D;&#x3D; START_SUCCESS &amp;&amp; intent.getComponent() &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (err &#x3D;&#x3D; START_SUCCESS &amp;&amp; aInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (err !&#x3D; START_SUCCESS) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		ActivityRecord r &#x3D; new ActivityRecord(mService, this, callerApp, callingUid,</span><br><span class="line">			intent, resolvedType, aInfo, mService.mConfiguration,</span><br><span class="line">			resultRecord, resultWho, requestCode, componentSpecified);</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		return startActivityUncheckedLocked(r, sourceRecord,</span><br><span class="line">			grantedUriPermissions, grantedMode, onlyIfNeeded, true);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里处理即将要启动的Actvity的相关信息，然后执行startActivityUncheckedLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final int startActivityUncheckedLocked(ActivityRecord r,</span><br><span class="line">		ActivityRecord sourceRecord, Uri[] grantedUriPermissions,</span><br><span class="line">		int grantedMode, boolean onlyIfNeeded, boolean doResume) &#123;</span><br><span class="line">		final Intent intent &#x3D; r.intent;</span><br><span class="line">		final int callingUid &#x3D; r.launchedFromUid;</span><br><span class="line"> </span><br><span class="line">		int launchFlags &#x3D; intent.getFlags();</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; We&#39;ll invoke onUserLeaving before onPause only if the launching</span><br><span class="line">		&#x2F;&#x2F; activity did not explicitly state that this is an automated launch.</span><br><span class="line">		mUserLeaving &#x3D; (launchFlags&amp;Intent.FLAG_ACTIVITY_NO_USER_ACTION) &#x3D;&#x3D; 0;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		ActivityRecord notTop &#x3D; (launchFlags&amp;Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP)</span><br><span class="line">			!&#x3D; 0 ? r : null;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If the onlyIfNeeded flag is set, then we can do this if the activity</span><br><span class="line">		&#x2F;&#x2F; being launched is the same as the one making the call...  or, as</span><br><span class="line">		&#x2F;&#x2F; a special case, if we do not know the caller then we count the</span><br><span class="line">		&#x2F;&#x2F; current top activity as the caller.</span><br><span class="line">		if (onlyIfNeeded) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (sourceRecord &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; else if (sourceRecord.launchMode &#x3D;&#x3D; ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; else if (r.launchMode &#x3D;&#x3D; ActivityInfo.LAUNCH_SINGLE_INSTANCE</span><br><span class="line">			|| r.launchMode &#x3D;&#x3D; ActivityInfo.LAUNCH_SINGLE_TASK) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (r.resultTo !&#x3D; null &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) !&#x3D; 0) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		boolean addingToTask &#x3D; false;</span><br><span class="line">		if (((launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) !&#x3D; 0 &amp;&amp;</span><br><span class="line">			(launchFlags&amp;Intent.FLAG_ACTIVITY_MULTIPLE_TASK) &#x3D;&#x3D; 0)</span><br><span class="line">			|| r.launchMode &#x3D;&#x3D; ActivityInfo.LAUNCH_SINGLE_TASK</span><br><span class="line">			|| r.launchMode &#x3D;&#x3D; ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">				&#x2F;&#x2F; If bring to front is requested, and no result is requested, and</span><br><span class="line">				&#x2F;&#x2F; we can find a task that was started with this same</span><br><span class="line">				&#x2F;&#x2F; component, then instead of launching bring that one to the front.</span><br><span class="line">				if (r.resultTo &#x3D;&#x3D; null) &#123;</span><br><span class="line">					&#x2F;&#x2F; See if there is a task to bring to the front.  If this is</span><br><span class="line">					&#x2F;&#x2F; a SINGLE_INSTANCE activity, there can be one and only one</span><br><span class="line">					&#x2F;&#x2F; instance of it in the history, and it is always in its own</span><br><span class="line">					&#x2F;&#x2F; unique task, so we do a special search.</span><br><span class="line">					ActivityRecord taskTop &#x3D; r.launchMode !&#x3D; ActivityInfo.LAUNCH_SINGLE_INSTANCE</span><br><span class="line">						? findTaskLocked(intent, r.info)</span><br><span class="line">						: findActivityLocked(intent, r.info);</span><br><span class="line">					if (taskTop !&#x3D; null) &#123;</span><br><span class="line">						......</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (r.packageName !&#x3D; null) &#123;</span><br><span class="line">			&#x2F;&#x2F; If the activity being launched is the same as the one currently</span><br><span class="line">			&#x2F;&#x2F; at the top, then we need to check if it should only be launched</span><br><span class="line">			&#x2F;&#x2F; once.</span><br><span class="line">			ActivityRecord top &#x3D; topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">			if (top !&#x3D; null &amp;&amp; r.resultTo &#x3D;&#x3D; null) &#123;</span><br><span class="line">				if (top.realActivity.equals(r.realActivity)) &#123;</span><br><span class="line">					......</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		boolean newTask &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Should this be considered a new task?</span><br><span class="line">		if (r.resultTo &#x3D;&#x3D; null &amp;&amp; !addingToTask</span><br><span class="line">			&amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) !&#x3D; 0) &#123;</span><br><span class="line">				&#x2F;&#x2F; todo: should do better management of integers.</span><br><span class="line">				mService.mCurTask++;</span><br><span class="line">				if (mService.mCurTask &lt;&#x3D; 0) &#123;</span><br><span class="line">					mService.mCurTask &#x3D; 1;</span><br><span class="line">				&#125;</span><br><span class="line">				r.task &#x3D; new TaskRecord(mService.mCurTask, r.info, intent,</span><br><span class="line">					(r.info.flags&amp;ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH) !&#x3D; 0);</span><br><span class="line">				......</span><br><span class="line">				newTask &#x3D; true;</span><br><span class="line">				if (mMainStack) &#123;</span><br><span class="line">					mService.addRecentTaskLocked(r.task);</span><br><span class="line">				&#125;</span><br><span class="line"> </span><br><span class="line">		&#125; else if (sourceRecord !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		startActivityLocked(r, newTask, doResume);</span><br><span class="line">		return START_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后进入startActivityLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void startActivityLocked(ActivityRecord r, boolean newTask,</span><br><span class="line">			boolean doResume) &#123;</span><br><span class="line">		final int NH &#x3D; mHistory.size();</span><br><span class="line"> </span><br><span class="line">		int addPos &#x3D; -1;</span><br><span class="line"> </span><br><span class="line">		if (!newTask) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Place a new activity at top of stack, so it is next to interact</span><br><span class="line">		&#x2F;&#x2F; with the user.</span><br><span class="line">		if (addPos &lt; 0) &#123;</span><br><span class="line">			addPos &#x3D; NH;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If we are not placing the new activity frontmost, we do not want</span><br><span class="line">		&#x2F;&#x2F; to deliver the onUserLeaving callback to the actual frontmost</span><br><span class="line">		&#x2F;&#x2F; activity</span><br><span class="line">		if (addPos &lt; NH) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Slot the activity into the history stack and proceed</span><br><span class="line">		mHistory.add(addPos, r);</span><br><span class="line">		r.inHistory &#x3D; true;</span><br><span class="line">		r.frontOfTask &#x3D; newTask;</span><br><span class="line">		r.task.numActivities++;</span><br><span class="line">		if (NH &gt; 0) &#123;</span><br><span class="line">			&#x2F;&#x2F; We want to show the starting preview window if we are</span><br><span class="line">			&#x2F;&#x2F; switching to a new task, or the next activity&#39;s process is</span><br><span class="line">			&#x2F;&#x2F; not currently running.</span><br><span class="line">			......</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			&#x2F;&#x2F; If this is the first activity, don&#39;t do any fancy animations,</span><br><span class="line">			&#x2F;&#x2F; because there is nothing for it to animate on top of.</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (doResume) &#123;</span><br><span class="line">			resumeTopActivityLocked(null);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里传进来的doResume为true，所以会进入resumeTopActivityLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	&#x2F;**</span><br><span class="line">	* Ensure that the top activity in the stack is resumed.</span><br><span class="line">	*</span><br><span class="line">	* @param prev The previously resumed activity, for when in the process</span><br><span class="line">	* of pausing; can be null to call from elsewhere.</span><br><span class="line">	*</span><br><span class="line">	* @return Returns true if something is being resumed, or false if</span><br><span class="line">	* nothing happened.</span><br><span class="line">	*&#x2F;</span><br><span class="line">	final boolean resumeTopActivityLocked(ActivityRecord prev) &#123;</span><br><span class="line">		&#x2F;&#x2F; Find the first activity that is not finishing.</span><br><span class="line">		ActivityRecord next &#x3D; topRunningActivityLocked(null);</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Remember how we&#39;ll process this pause&#x2F;resume situation, and ensure</span><br><span class="line">		&#x2F;&#x2F; that the state is reset however we wind up proceeding.</span><br><span class="line">		final boolean userLeaving &#x3D; mUserLeaving;</span><br><span class="line">		mUserLeaving &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		if (next &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		next.delayedResume &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If the top activity is the resumed one, nothing to do.</span><br><span class="line">		if (mResumedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.RESUMED) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If we are sleeping, and there is no resumed activity, and the top</span><br><span class="line">		&#x2F;&#x2F; activity is paused, well that is the state we want.</span><br><span class="line">		if ((mService.mSleeping || mService.mShuttingDown)</span><br><span class="line">			&amp;&amp; mLastPausedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.PAUSED) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If we are currently pausing an activity, then don&#39;t do anything</span><br><span class="line">		&#x2F;&#x2F; until that is done.</span><br><span class="line">		if (mPausingActivity !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; We need to start pausing the current activity so the top one</span><br><span class="line">		&#x2F;&#x2F; can be resumed...</span><br><span class="line">		if (mResumedActivity !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">			startPausingLocked(userLeaving, false);</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里没有正在处于pause状态的Activity,于是就会调用startPausingLocked，将当前Activity进入pause状态，这里的Activity就是Launcher.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void startPausingLocked(boolean userLeaving, boolean uiSleeping) &#123;</span><br><span class="line">		if (mPausingActivity !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		ActivityRecord prev &#x3D; mResumedActivity;</span><br><span class="line">		if (prev &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		......</span><br><span class="line">		mResumedActivity &#x3D; null;</span><br><span class="line">		mPausingActivity &#x3D; prev;</span><br><span class="line">		mLastPausedActivity &#x3D; prev;</span><br><span class="line">		prev.state &#x3D; ActivityState.PAUSING;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (prev.app !&#x3D; null &amp;&amp; prev.app.thread !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">			try &#123;</span><br><span class="line">				......</span><br><span class="line">				prev.app.thread.schedulePauseActivity(prev, prev.finishing, userLeaving,</span><br><span class="line">					prev.configChangeFlags);</span><br><span class="line">				......</span><br><span class="line">			&#125; catch (Exception e) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里prev.app.thread就是一个ApplicationThread，通过schedulePauseActivity将Launcher进入Pause状态.这个方法通过进程间通讯进入到ApplicationThread的schedulePauseActivity.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final class ApplicationThread extends ApplicationThreadNative &#123;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		public final void schedulePauseActivity(IBinder token, boolean finished,</span><br><span class="line">				boolean userLeaving, int configChanges) &#123;</span><br><span class="line">			queueOrSendMessage(</span><br><span class="line">				finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">				token,</span><br><span class="line">				(userLeaving ? 1 : 0),</span><br><span class="line">				configChanges);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationThread是ActvityThread的内部类.然后调用ActivityThread的成员函数queueOrSendMessage.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void queueOrSendMessage(int what, Object obj, int arg1) &#123;</span><br><span class="line">		queueOrSendMessage(what, obj, arg1, 0);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	private final void queueOrSendMessage(int what, Object obj, int arg1, int arg2) &#123;</span><br><span class="line">		synchronized (this) &#123;</span><br><span class="line">			......</span><br><span class="line">			Message msg &#x3D; Message.obtain();</span><br><span class="line">			msg.what &#x3D; what;</span><br><span class="line">			msg.obj &#x3D; obj;</span><br><span class="line">			msg.arg1 &#x3D; arg1;</span><br><span class="line">			msg.arg2 &#x3D; arg2;</span><br><span class="line">			mH.sendMessage(msg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后将相关的信息通过Handler发送出去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final class H extends Handler &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		public void handleMessage(Message msg) &#123;</span><br><span class="line">			......</span><br><span class="line">			switch (msg.what) &#123;</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line">			</span><br><span class="line">			case PAUSE_ACTIVITY:</span><br><span class="line">				handlePauseActivity((IBinder)msg.obj, false, msg.arg1 !&#x3D; 0, msg.arg2);</span><br><span class="line">				maybeSnapshot();</span><br><span class="line">				break;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			&#125;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行handlePauseActivity.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void handlePauseActivity(IBinder token, boolean finished,</span><br><span class="line">			boolean userLeaving, int configChanges) &#123;</span><br><span class="line"> </span><br><span class="line">		ActivityClientRecord r &#x3D; mActivities.get(token);</span><br><span class="line">		if (r !&#x3D; null) &#123;</span><br><span class="line">			&#x2F;&#x2F;Slog.v(TAG, &quot;userLeaving&#x3D;&quot; + userLeaving + &quot; handling pause of &quot; + r);</span><br><span class="line">			if (userLeaving) &#123;</span><br><span class="line">				performUserLeavingActivity(r);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			r.activity.mConfigChangeFlags |&#x3D; configChanges;</span><br><span class="line">			Bundle state &#x3D; performPauseActivity(token, finished, true);</span><br><span class="line"> </span><br><span class="line">			&#x2F;&#x2F; Make sure any pending writes are now committed.</span><br><span class="line">			QueuedWork.waitToFinish();</span><br><span class="line"> </span><br><span class="line">			&#x2F;&#x2F; Tell the activity manager we have paused.</span><br><span class="line">			try &#123;</span><br><span class="line">				ActivityManagerNative.getDefault().activityPaused(token, state);</span><br><span class="line">			&#125; catch (RemoteException ex) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过Binder进入ActivityManagerService的activityPaused方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">			implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public final void activityPaused(IBinder token, Bundle icicle) &#123;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">		mMainStack.activityPaused(token, icicle, false);</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后还是到了ActvityStack中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final void activityPaused(IBinder token, Bundle icicle, boolean timeout) &#123;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		ActivityRecord r &#x3D; null;</span><br><span class="line"> </span><br><span class="line">		synchronized (mService) &#123;</span><br><span class="line">			int index &#x3D; indexOfTokenLocked(token);</span><br><span class="line">			if (index &gt;&#x3D; 0) &#123;</span><br><span class="line">				r &#x3D; (ActivityRecord)mHistory.get(index);</span><br><span class="line">				if (!timeout) &#123;</span><br><span class="line">					r.icicle &#x3D; icicle;</span><br><span class="line">					r.haveState &#x3D; true;</span><br><span class="line">				&#125;</span><br><span class="line">				mHandler.removeMessages(PAUSE_TIMEOUT_MSG, r);</span><br><span class="line">				if (mPausingActivity &#x3D;&#x3D; r) &#123;</span><br><span class="line">					r.state &#x3D; ActivityState.PAUSED;</span><br><span class="line">					completePauseLocked();</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					......</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里通过token从history获取到当前的Activity，而这个Activity就是Launcher.<br>然后执行completePauseLocked方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void completePauseLocked() &#123;</span><br><span class="line">		ActivityRecord prev &#x3D; mPausingActivity;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (prev !&#x3D; null) &#123;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			mPausingActivity &#x3D; null;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (!mService.mSleeping &amp;&amp; !mService.mShuttingDown) &#123;</span><br><span class="line">			resumeTopActivityLocked(prev);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先将mPausingActivity参数清空,然后执行resumeTopActivityLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final boolean resumeTopActivityLocked(ActivityRecord prev) &#123;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Find the first activity that is not finishing.</span><br><span class="line">		ActivityRecord next &#x3D; topRunningActivityLocked(null);</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Remember how we&#39;ll process this pause&#x2F;resume situation, and ensure</span><br><span class="line">		&#x2F;&#x2F; that the state is reset however we wind up proceeding.</span><br><span class="line">		final boolean userLeaving &#x3D; mUserLeaving;</span><br><span class="line">		mUserLeaving &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		next.delayedResume &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If the top activity is the resumed one, nothing to do.</span><br><span class="line">		if (mResumedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.RESUMED) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If we are sleeping, and there is no resumed activity, and the top</span><br><span class="line">		&#x2F;&#x2F; activity is paused, well that is the state we want.</span><br><span class="line">		if ((mService.mSleeping || mService.mShuttingDown)</span><br><span class="line">			&amp;&amp; mLastPausedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.PAUSED) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		.......</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; We need to start pausing the current activity so the top one</span><br><span class="line">		&#x2F;&#x2F; can be resumed...</span><br><span class="line">		if (mResumedActivity !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		if (next.app !&#x3D; null &amp;&amp; next.app.thread !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">			startSpecificActivityLocked(next, true, true);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过topRunningActivityLocked取出栈顶的Activity.<br>然后执行startSpecificActivityLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void startSpecificActivityLocked(ActivityRecord r,</span><br><span class="line">			boolean andResume, boolean checkConfig) &#123;</span><br><span class="line">		&#x2F;&#x2F; Is this activity&#39;s application already running?</span><br><span class="line">		ProcessRecord app &#x3D; mService.getProcessRecordLocked(r.processName,</span><br><span class="line">			r.info.applicationInfo.uid);</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (app !&#x3D; null &amp;&amp; app.thread !&#x3D; null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">				return;</span><br><span class="line">			&#125; catch (RemoteException e) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</span><br><span class="line">			&quot;activity&quot;, r.intent.getComponent(), false);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终这个方法又会执行mService.startProcessLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final ProcessRecord startProcessLocked(String processName,</span><br><span class="line">			ApplicationInfo info, boolean knownToBeDead, int intentFlags,</span><br><span class="line">			String hostingType, ComponentName hostingName, boolean allowWhileBooting) &#123;</span><br><span class="line"> </span><br><span class="line">		ProcessRecord app &#x3D; getProcessRecordLocked(processName, info.uid);</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		String hostingNameStr &#x3D; hostingName !&#x3D; null</span><br><span class="line">			? hostingName.flattenToShortString() : null;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (app &#x3D;&#x3D; null) &#123;</span><br><span class="line">			app &#x3D; new ProcessRecordLocked(null, info, processName);</span><br><span class="line">			mProcessNames.put(processName, info.uid, app);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			&#x2F;&#x2F; If this is a new package in the process, add the package to the list</span><br><span class="line">			app.addPackage(info.packageName);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		startProcessLocked(app, hostingType, hostingNameStr);</span><br><span class="line">		return (app.pid !&#x3D; 0) ? app : null;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用startProcessLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void startProcessLocked(ProcessRecord app,</span><br><span class="line">				String hostingType, String hostingNameStr) &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		try &#123;</span><br><span class="line">			int uid &#x3D; app.info.uid;</span><br><span class="line">			int[] gids &#x3D; null;</span><br><span class="line">			try &#123;</span><br><span class="line">				gids &#x3D; mContext.getPackageManager().getPackageGids(</span><br><span class="line">					app.info.packageName);</span><br><span class="line">			&#125; catch (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			int debugFlags &#x3D; 0;</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line">			</span><br><span class="line">			int pid &#x3D; Process.start(&quot;android.app.ActivityThread&quot;,</span><br><span class="line">				mSimpleProcessManagement ? app.processName : null, uid, uid,</span><br><span class="line">				gids, debugFlags, null);</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125; catch (RuntimeException e) &#123;</span><br><span class="line">			</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里执行Process.start方法创建一个新的进程然后导入android.app.ActivityThread类并执行它的main方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void attach(boolean system) &#123;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		mSystemThread &#x3D; system;</span><br><span class="line">		if (!system) &#123;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			IActivityManager mgr &#x3D; ActivityManagerNative.getDefault();</span><br><span class="line">			try &#123;</span><br><span class="line">				mgr.attachApplication(mAppThread);</span><br><span class="line">			&#125; catch (RemoteException ex) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public static final void main(String[] args) &#123;</span><br><span class="line">		</span><br><span class="line">		.......</span><br><span class="line"> </span><br><span class="line">		ActivityThread thread &#x3D; new ActivityThread();</span><br><span class="line">		thread.attach(false);</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		Looper.loop();</span><br><span class="line"> </span><br><span class="line">		.......</span><br><span class="line"> </span><br><span class="line">		thread.detach();</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ActivityThread是一个程序的主入口.调用attach方法，然后当前进程进入消息循环.在attach中执行ActivityManagerProxy.attachApplication.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class ActivityManagerProxy implements IActivityManager</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public void attachApplication(IApplicationThread app) throws RemoteException</span><br><span class="line">	&#123;</span><br><span class="line">		Parcel data &#x3D; Parcel.obtain();</span><br><span class="line">		Parcel reply &#x3D; Parcel.obtain();</span><br><span class="line">		data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">		data.writeStrongBinder(app.asBinder());</span><br><span class="line">		mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);</span><br><span class="line">		reply.readException();</span><br><span class="line">		data.recycle();</span><br><span class="line">		reply.recycle();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过Binder进入ActiviyManagerService中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public final void attachApplication(IApplicationThread thread) &#123;</span><br><span class="line">		synchronized (this) &#123;</span><br><span class="line">			int callingPid &#x3D; Binder.getCallingPid();</span><br><span class="line">			final long origId &#x3D; Binder.clearCallingIdentity();</span><br><span class="line">			attachApplicationLocked(thread, callingPid);</span><br><span class="line">			Binder.restoreCallingIdentity(origId);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将操作转给了attachApplicationLocked.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final boolean attachApplicationLocked(IApplicationThread thread,</span><br><span class="line">			int pid) &#123;</span><br><span class="line">		&#x2F;&#x2F; Find the application record that is being attached...  either via</span><br><span class="line">		&#x2F;&#x2F; the pid if we are running in multiple processes, or just pull the</span><br><span class="line">		&#x2F;&#x2F; next app record if we are emulating process with anonymous threads.</span><br><span class="line">		ProcessRecord app;</span><br><span class="line">		if (pid !&#x3D; MY_PID &amp;&amp; pid &gt;&#x3D; 0) &#123;</span><br><span class="line">			synchronized (mPidsSelfLocked) &#123;</span><br><span class="line">				app &#x3D; mPidsSelfLocked.get(pid);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else if (mStartingProcesses.size() &gt; 0) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (app &#x3D;&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		String processName &#x3D; app.processName;</span><br><span class="line">		try &#123;</span><br><span class="line">			thread.asBinder().linkToDeath(new AppDeathRecipient(</span><br><span class="line">				app, pid, thread), 0);</span><br><span class="line">		&#125; catch (RemoteException e) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		app.thread &#x3D; thread;</span><br><span class="line">		app.curAdj &#x3D; app.setAdj &#x3D; -100;</span><br><span class="line">		app.curSchedGroup &#x3D; Process.THREAD_GROUP_DEFAULT;</span><br><span class="line">		app.setSchedGroup &#x3D; Process.THREAD_GROUP_BG_NONINTERACTIVE;</span><br><span class="line">		app.forcingToForeground &#x3D; null;</span><br><span class="line">		app.foregroundServices &#x3D; false;</span><br><span class="line">		app.debugging &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		boolean normalMode &#x3D; mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		boolean badApp &#x3D; false;</span><br><span class="line">		boolean didSomething &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; See if the top visible activity is waiting to run in this process...</span><br><span class="line">		ActivityRecord hr &#x3D; mMainStack.topRunningActivityLocked(null);</span><br><span class="line">		if (hr !&#x3D; null &amp;&amp; normalMode) &#123;</span><br><span class="line">			if (hr.app &#x3D;&#x3D; null &amp;&amp; app.info.uid &#x3D;&#x3D; hr.info.applicationInfo.uid</span><br><span class="line">				&amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">					try &#123;</span><br><span class="line">						if (mMainStack.realStartActivityLocked(hr, app, true, true)) &#123;</span><br><span class="line">							didSomething &#x3D; true;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; catch (Exception e) &#123;</span><br><span class="line">						......</span><br><span class="line">					&#125;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先从mMainStack.topRunningActivityLocked栈顶取出要启动的Activiy然后操作mMainStack.realStartActivityLocked执行真正的Activity的启动操作.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final boolean realStartActivityLocked(ActivityRecord r,</span><br><span class="line">			ProcessRecord app, boolean andResume, boolean checkConfig)</span><br><span class="line">			throws RemoteException &#123;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		r.app &#x3D; app;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		int idx &#x3D; app.activities.indexOf(r);</span><br><span class="line">		if (idx &lt; 0) &#123;</span><br><span class="line">			app.activities.add(r);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		try &#123;</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			List&lt;ResultInfo&gt; results &#x3D; null;</span><br><span class="line">			List&lt;Intent&gt; newIntents &#x3D; null;</span><br><span class="line">			if (andResume) &#123;</span><br><span class="line">				results &#x3D; r.results;</span><br><span class="line">				newIntents &#x3D; r.newIntents;</span><br><span class="line">			&#125;</span><br><span class="line">	</span><br><span class="line">			......</span><br><span class="line">			</span><br><span class="line">			app.thread.scheduleLaunchActivity(new Intent(r.intent), r,</span><br><span class="line">				System.identityHashCode(r),</span><br><span class="line">				r.info, r.icicle, results, newIntents, !andResume,</span><br><span class="line">				mService.isNextTransitionForward());</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125; catch (RemoteException e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过ActivityManagerService执行app.thread.scheduleLaunchActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final class ApplicationThread extends ApplicationThreadNative &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; we use token to identify this activity without having to send the</span><br><span class="line">		&#x2F;&#x2F; activity itself back to the activity manager. (matters more with ipc)</span><br><span class="line">		public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</span><br><span class="line">				ActivityInfo info, Bundle state, List&lt;ResultInfo&gt; pendingResults,</span><br><span class="line">				List&lt;Intent&gt; pendingNewIntents, boolean notResumed, boolean isForward) &#123;</span><br><span class="line">			ActivityClientRecord r &#x3D; new ActivityClientRecord();</span><br><span class="line"> </span><br><span class="line">			r.token &#x3D; token;</span><br><span class="line">			r.ident &#x3D; ident;</span><br><span class="line">			r.intent &#x3D; intent;</span><br><span class="line">			r.activityInfo &#x3D; info;</span><br><span class="line">			r.state &#x3D; state;</span><br><span class="line"> </span><br><span class="line">			r.pendingResults &#x3D; pendingResults;</span><br><span class="line">			r.pendingIntents &#x3D; pendingNewIntents;</span><br><span class="line"> </span><br><span class="line">			r.startsNotResumed &#x3D; notResumed;</span><br><span class="line">			r.isForward &#x3D; isForward;</span><br><span class="line"> </span><br><span class="line">			queueOrSendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后ActivityThread执行queueOrSendMessage.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final class ApplicationThread extends ApplicationThreadNative &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; if the thread hasn&#39;t started yet, we don&#39;t have the handler, so just</span><br><span class="line">		&#x2F;&#x2F; save the messages until we&#39;re ready.</span><br><span class="line">		private final void queueOrSendMessage(int what, Object obj) &#123;</span><br><span class="line">			queueOrSendMessage(what, obj, 0, 0);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		private final void queueOrSendMessage(int what, Object obj, int arg1, int arg2) &#123;</span><br><span class="line">			synchronized (this) &#123;</span><br><span class="line">				......</span><br><span class="line">				Message msg &#x3D; Message.obtain();</span><br><span class="line">				msg.what &#x3D; what;</span><br><span class="line">				msg.obj &#x3D; obj;</span><br><span class="line">				msg.arg1 &#x3D; arg1;</span><br><span class="line">				msg.arg2 &#x3D; arg2;</span><br><span class="line">				mH.sendMessage(msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后将消息分发出去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final class H extends Handler &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		public void handleMessage(Message msg) &#123;</span><br><span class="line">			......</span><br><span class="line">			switch (msg.what) &#123;</span><br><span class="line">			case LAUNCH_ACTIVITY: &#123;</span><br><span class="line">				ActivityClientRecord r &#x3D; (ActivityClientRecord)msg.obj;</span><br><span class="line"> </span><br><span class="line">				r.packageInfo &#x3D; getPackageInfoNoCheck(</span><br><span class="line">					r.activityInfo.applicationInfo);</span><br><span class="line">				handleLaunchActivity(r, null);</span><br><span class="line">			&#125; break;</span><br><span class="line">			......</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		Activity a &#x3D; performLaunchActivity(r, customIntent);</span><br><span class="line"> </span><br><span class="line">		if (a !&#x3D; null) &#123;</span><br><span class="line">			r.createdConfig &#x3D; new Configuration(mConfiguration);</span><br><span class="line">			Bundle oldState &#x3D; r.state;</span><br><span class="line">			handleResumeActivity(r.token, false, r.isForward);</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里通过performLaunchActivity来创建这个要启动的Activity实例.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityThread &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">		</span><br><span class="line">		ActivityInfo aInfo &#x3D; r.activityInfo;</span><br><span class="line">		if (r.packageInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">			r.packageInfo &#x3D; getPackageInfo(aInfo.applicationInfo,</span><br><span class="line">				Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		ComponentName component &#x3D; r.intent.getComponent();</span><br><span class="line">		if (component &#x3D;&#x3D; null) &#123;</span><br><span class="line">			component &#x3D; r.intent.resolveActivity(</span><br><span class="line">				mInitialApplication.getPackageManager());</span><br><span class="line">			r.intent.setComponent(component);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (r.activityInfo.targetActivity !&#x3D; null) &#123;</span><br><span class="line">			component &#x3D; new ComponentName(r.activityInfo.packageName,</span><br><span class="line">				r.activityInfo.targetActivity);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		Activity activity &#x3D; null;</span><br><span class="line">		try &#123;</span><br><span class="line">			java.lang.ClassLoader cl &#x3D; r.packageInfo.getClassLoader();</span><br><span class="line">			activity &#x3D; mInstrumentation.newActivity(</span><br><span class="line">				cl, component.getClassName(), r.intent);</span><br><span class="line">			r.intent.setExtrasClassLoader(cl);</span><br><span class="line">			if (r.state !&#x3D; null) &#123;</span><br><span class="line">				r.state.setClassLoader(cl);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		try &#123;</span><br><span class="line">			Application app &#x3D; r.packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			if (activity !&#x3D; null) &#123;</span><br><span class="line">				ContextImpl appContext &#x3D; new ContextImpl();</span><br><span class="line">				appContext.init(r.packageInfo, r.token, this);</span><br><span class="line">				appContext.setOuterContext(activity);</span><br><span class="line">				CharSequence title &#x3D; r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">				Configuration config &#x3D; new Configuration(mConfiguration);</span><br><span class="line">				......</span><br><span class="line">				activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">					r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">					r.embeddedID, r.lastNonConfigurationInstance,</span><br><span class="line">					r.lastNonConfigurationChildInstances, config);</span><br><span class="line"> </span><br><span class="line">				if (customIntent !&#x3D; null) &#123;</span><br><span class="line">					activity.mIntent &#x3D; customIntent;</span><br><span class="line">				&#125;</span><br><span class="line">				r.lastNonConfigurationInstance &#x3D; null;</span><br><span class="line">				r.lastNonConfigurationChildInstances &#x3D; null;</span><br><span class="line">				activity.mStartedActivity &#x3D; false;</span><br><span class="line">				int theme &#x3D; r.activityInfo.getThemeResource();</span><br><span class="line">				if (theme !&#x3D; 0) &#123;</span><br><span class="line">					activity.setTheme(theme);</span><br><span class="line">				&#125;</span><br><span class="line"> </span><br><span class="line">				activity.mCalled &#x3D; false;</span><br><span class="line">				mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">				......</span><br><span class="line">				r.activity &#x3D; activity;</span><br><span class="line">				r.stopped &#x3D; true;</span><br><span class="line">				if (!r.activity.mFinished) &#123;</span><br><span class="line">					activity.performStart();</span><br><span class="line">					r.stopped &#x3D; false;</span><br><span class="line">				&#125;</span><br><span class="line">				if (!r.activity.mFinished) &#123;</span><br><span class="line">					if (r.state !&#x3D; null) &#123;</span><br><span class="line">						mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (!r.activity.mFinished) &#123;</span><br><span class="line">					activity.mCalled &#x3D; false;</span><br><span class="line">					mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">					if (!activity.mCalled) &#123;</span><br><span class="line">						throw new SuperNotCalledException(</span><br><span class="line">							&quot;Activity &quot; + r.intent.getComponent().toShortString() +</span><br><span class="line">							&quot; did not call through to super.onPostCreate()&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			r.paused &#x3D; true;</span><br><span class="line"> </span><br><span class="line">			mActivities.put(r.token, r);</span><br><span class="line"> </span><br><span class="line">		&#125; catch (SuperNotCalledException e) &#123;</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		return activity;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用它的onCreate函数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassLoader cl &#x3D; r.packageInfo.getClassLoader();</span><br><span class="line">			activity &#x3D; mInstrumentation.newActivity(</span><br><span class="line">				cl, component.getClassName(), r.intent);</span><br></pre></td></tr></table></figure>
<p>通过classLoader将要启动的Activity加载进来.<br>创建Application对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application app &#x3D; r.packageInfo.makeApplication(false, mInstrumentation);</span><br></pre></td></tr></table></figure>
<p>创建当前Activity上下文等信息,通过attach将上下文信息关联到当前的Activity中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">					r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">					r.embeddedID, r.lastNonConfigurationInstance,</span><br><span class="line">					r.lastNonConfigurationChildInstances, config);</span><br></pre></td></tr></table></figure>

<p>然后回到handleLaunchActivity执行handleResumeActivity。<br>通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation.callActivityOnCreate(activity, r.state);</span><br></pre></td></tr></table></figure>
<p>方法执行要启动Activity的onCreate方法</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/27/2018-12-27-Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="ck8tr9s6n0008n29kce30c7qj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-27-Activity的启动过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/27/2018-12-27-Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2018-12-26T16:00:00.000Z" itemprop="datePublished">2018-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/27/2018-12-27-Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">Activity的工作过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>一般我们启动一个Activity都会调用系统提供的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startActivity(new Intent(HomeActivity.this, FavoriteActivity.class));</span><br></pre></td></tr></table></figure>
<p>在调用了startActivity后，系统最终继续执行startActivityForResult.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) &#123;</span><br><span class="line">    if (mParent &#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F;真正执行启动activity的代码逻辑</span><br><span class="line">        Instrumentation.ActivityResult ar &#x3D;</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                this, mMainThread.getApplicationThread(), mToken, this,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        &#x2F;&#x2F;启动activity返回的结果处理</span><br><span class="line">        if (ar !&#x3D; null) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        if (requestCode &gt;&#x3D; 0) &#123;</span><br><span class="line">     </span><br><span class="line">             mStartedActivity &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">        &#x2F;&#x2F; TODO Consider clearing&#x2F;flushing other event sources and events for child windows.</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (options !&#x3D; null) &#123;</span><br><span class="line">            mParent.startActivityFromChild(this, intent, requestCode, options);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; Note we want to go through this method for compatibility with</span><br><span class="line">            &#x2F;&#x2F; existing applications that may have overridden it.</span><br><span class="line">            mParent.startActivityFromChild(this, intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动Activity的方法最终调用给了Instrumentation。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public ActivityResult execStartActivity(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, int requestCode, Bundle options) &#123;</span><br><span class="line">   &#x2F;&#x2F;这个whoThread执行了启动activity</span><br><span class="line">    IApplicationThread whoThread &#x3D; (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer &#x3D; target !&#x3D; null ? target.onProvideReferrer() : null;</span><br><span class="line">    if (referrer !&#x3D; null) &#123;</span><br><span class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mActivityMonitors !&#x3D; null) &#123;</span><br><span class="line">        synchronized (mSync) &#123;</span><br><span class="line">            final int N &#x3D; mActivityMonitors.size();</span><br><span class="line">          &#x2F;&#x2F;遍历一遍，查询是否存在这个activity，activity类存放在intent中。</span><br><span class="line">            for (int i &#x3D; 0; i &lt; N; i++) &#123;</span><br><span class="line">                final ActivityMonitor am &#x3D; mActivityMonitors.get(i);</span><br><span class="line">                if (am.match(who, null, intent)) &#123;</span><br><span class="line">                    am.mHits++;</span><br><span class="line">                    if (am.isBlocking()) &#123;</span><br><span class="line">                        return requestCode &gt;&#x3D; 0 ? am.getResult() : null;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess();</span><br><span class="line">        &#x2F;&#x2F;这里通过ActivityManager启动了activity</span><br><span class="line">        int result &#x3D; ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target !&#x3D; null ? target.mEmbeddedID : null,</span><br><span class="line">                        requestCode, 0, null, options);</span><br><span class="line">        &#x2F;&#x2F;检查启动activity返回的结果</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Failure from system&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码可以知道Activity的启动有2点：</p>
<ol>
<li>真正执行Activity的启动是ActivityManagerNative.getDefault()(实际上是一个AMS)的startActivity。</li>
<li>最后启动Activity的返回结果。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public static void checkStartActivityResult(int res, Object intent) &#123;</span><br><span class="line">    if (res &gt;&#x3D; ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (res) &#123;</span><br><span class="line">        case ActivityManager.START_INTENT_NOT_RESOLVED:</span><br><span class="line">        case ActivityManager.START_CLASS_NOT_FOUND:</span><br><span class="line">            if (intent instanceof Intent &amp;&amp; ((Intent) intent).getComponent() !&#x3D; null)</span><br><span class="line">                throw new ActivityNotFoundException(</span><br><span class="line">                        &quot;Unable to find explicit activity class &quot;</span><br><span class="line">                                + ((Intent) intent).getComponent().toShortString()</span><br><span class="line">                                + &quot;; have you declared this activity in your AndroidManifest.xml?&quot;);</span><br><span class="line">            throw new ActivityNotFoundException(</span><br><span class="line">                    &quot;No Activity found to handle &quot; + intent);</span><br><span class="line">        case ActivityManager.START_PERMISSION_DENIED:</span><br><span class="line">            throw new SecurityException(&quot;Not allowed to start activity &quot;</span><br><span class="line">                    + intent);</span><br><span class="line">        case ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT:</span><br><span class="line">            throw new AndroidRuntimeException(</span><br><span class="line">                    &quot;FORWARD_RESULT_FLAG used while also requesting a result&quot;);</span><br><span class="line">        case ActivityManager.START_NOT_ACTIVITY:</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                    &quot;PendingIntent is not an activity&quot;);</span><br><span class="line">        case ActivityManager.START_NOT_VOICE_COMPATIBLE:</span><br><span class="line">            throw new SecurityException(</span><br><span class="line">                    &quot;Starting under voice control not allowed for: &quot; + intent);</span><br><span class="line">        case ActivityManager.START_NOT_CURRENT_USER_ACTIVITY:</span><br><span class="line">            &#x2F;&#x2F; Fail silently for this case so we don&#39;t break current apps.</span><br><span class="line">            &#x2F;&#x2F; TODO(b&#x2F;22929608): Instead of failing silently or throwing an exception,</span><br><span class="line">            &#x2F;&#x2F; we should properly position the activity in the stack (i.e. behind all current</span><br><span class="line">            &#x2F;&#x2F; user activity&#x2F;task) and not change the positioning of stacks.</span><br><span class="line">            Log.e(TAG,</span><br><span class="line">                    &quot;Not allowed to start background user activity that shouldn&#39;t be displayed&quot;</span><br><span class="line">                            + &quot; for all users. Failing silently...&quot;);</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            throw new AndroidRuntimeException(&quot;Unknown error code &quot;</span><br><span class="line">                    + res + &quot; when starting &quot; + intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实Activity的启动又由AMS来调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public final class ActivityManagerService extends ActivityManagerNative</span><br><span class="line">		implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	public final int startActivity(IApplicationThread caller,</span><br><span class="line">			Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">			int grantedMode, IBinder resultTo,</span><br><span class="line">			String resultWho, int requestCode, boolean onlyIfNeeded,</span><br><span class="line">			boolean debug) &#123;</span><br><span class="line">		return mMainStack.startActivityMayWait(caller, intent, resolvedType,</span><br><span class="line">			grantedUriPermissions, grantedMode, resultTo, resultWho,</span><br><span class="line">			requestCode, onlyIfNeeded, debug, null, null);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将操作给了成员变量mMainStack的startActivityMayWait方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final int startActivityMayWait(IApplicationThread caller,</span><br><span class="line">			Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">			int grantedMode, IBinder resultTo,</span><br><span class="line">			String resultWho, int requestCode, boolean onlyIfNeeded,</span><br><span class="line">			boolean debug, WaitResult outResult, Configuration config) &#123;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		boolean componentSpecified &#x3D; intent.getComponent() !&#x3D; null;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Don&#39;t modify the client&#39;s object!</span><br><span class="line">		intent &#x3D; new Intent(intent);</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Collect information about the target of the Intent.</span><br><span class="line">		ActivityInfo aInfo;</span><br><span class="line">		try &#123;</span><br><span class="line">			ResolveInfo rInfo &#x3D;</span><br><span class="line">				AppGlobals.getPackageManager().resolveIntent(</span><br><span class="line">				intent, resolvedType,</span><br><span class="line">				PackageManager.MATCH_DEFAULT_ONLY</span><br><span class="line">				| ActivityManagerService.STOCK_PM_FLAGS);</span><br><span class="line">			aInfo &#x3D; rInfo !&#x3D; null ? rInfo.activityInfo : null;</span><br><span class="line">		&#125; catch (RemoteException e) &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		if (aInfo !&#x3D; null) &#123;</span><br><span class="line">			&#x2F;&#x2F; Store the found target back into the intent, because now that</span><br><span class="line">			&#x2F;&#x2F; we have it we never want to do this again.  For example, if the</span><br><span class="line">			&#x2F;&#x2F; user navigates back to this point in the history, we should</span><br><span class="line">			&#x2F;&#x2F; always restart the exact same activity.</span><br><span class="line">			intent.setComponent(new ComponentName(</span><br><span class="line">				aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		synchronized (mService) &#123;</span><br><span class="line">			int callingPid;</span><br><span class="line">			int callingUid;</span><br><span class="line">			if (caller &#x3D;&#x3D; null) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				callingPid &#x3D; callingUid &#x3D; -1;</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			mConfigWillChange &#x3D; config !&#x3D; null</span><br><span class="line">				&amp;&amp; mService.mConfiguration.diff(config) !&#x3D; 0;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			if (mMainStack &amp;&amp; aInfo !&#x3D; null &amp;&amp;</span><br><span class="line">				(aInfo.applicationInfo.flags&amp;ApplicationInfo.FLAG_CANT_SAVE_STATE) !&#x3D; 0) &#123;</span><br><span class="line">				  </span><br><span class="line">		              ......</span><br><span class="line"> </span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			int res &#x3D; startActivityLocked(caller, intent, resolvedType,</span><br><span class="line">				grantedUriPermissions, grantedMode, aInfo,</span><br><span class="line">				resultTo, resultWho, requestCode, callingPid, callingUid,</span><br><span class="line">				onlyIfNeeded, componentSpecified);</span><br><span class="line"> </span><br><span class="line">			if (mConfigWillChange &amp;&amp; mMainStack) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">			if (outResult !&#x3D; null) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			return res;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>接下来就有调用了ActivityStack.startActivityLocked方法，接着调用了startActivityUncheckedLocked方法，接着startActivityUncheckedLocked又调用了AcaptivityStrack的ResumeTopActivitiesLocked方法，最终启动已经转移到了AcaptivityStrack。</p>
<p> 这里的doResume传进来的参数为true，所以就执行了resumeTopActivityLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	final boolean resumeTopActivityLocked(ActivityRecord prev) &#123;</span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Find the first activity that is not finishing.</span><br><span class="line">		ActivityRecord next &#x3D; topRunningActivityLocked(null);</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; Remember how we&#39;ll process this pause&#x2F;resume situation, and ensure</span><br><span class="line">		&#x2F;&#x2F; that the state is reset however we wind up proceeding.</span><br><span class="line">		final boolean userLeaving &#x3D; mUserLeaving;</span><br><span class="line">		mUserLeaving &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		next.delayedResume &#x3D; false;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If the top activity is the resumed one, nothing to do.</span><br><span class="line">		if (mResumedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.RESUMED) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; If we are sleeping, and there is no resumed activity, and the top</span><br><span class="line">		&#x2F;&#x2F; activity is paused, well that is the state we want.</span><br><span class="line">		if ((mService.mSleeping || mService.mShuttingDown)</span><br><span class="line">			&amp;&amp; mLastPausedActivity &#x3D;&#x3D; next &amp;&amp; next.state &#x3D;&#x3D; ActivityState.PAUSED) &#123;</span><br><span class="line">			......</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		.......</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		&#x2F;&#x2F; We need to start pausing the current activity so the top one</span><br><span class="line">		&#x2F;&#x2F; can be resumed...</span><br><span class="line">		if (mResumedActivity !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">		if (next.app !&#x3D; null &amp;&amp; next.app.thread !&#x3D; null) &#123;</span><br><span class="line">			......</span><br><span class="line"> </span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			......</span><br><span class="line">			startSpecificActivityLocked(next, true, true);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>最终程序又执行了startSpecificActivityLocked。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ActivityStack &#123;</span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">	private final void startSpecificActivityLocked(ActivityRecord r,</span><br><span class="line">			boolean andResume, boolean checkConfig) &#123;</span><br><span class="line">		&#x2F;&#x2F; Is this activity&#39;s application already running?</span><br><span class="line">		ProcessRecord app &#x3D; mService.getProcessRecordLocked(r.processName,</span><br><span class="line">			r.info.applicationInfo.uid);</span><br><span class="line"> </span><br><span class="line">		......</span><br><span class="line"> </span><br><span class="line">		if (app !&#x3D; null &amp;&amp; app.thread !&#x3D; null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">				return;</span><br><span class="line">			&#125; catch (RemoteException e) &#123;</span><br><span class="line">				......</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</span><br><span class="line">			&quot;activity&quot;, r.intent.getComponent(), false);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	......</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出，最后又执行了realStartActivityLocked。realStartActivityLocked方法有一段代码<br>app.thread.scheduleLauncherActivity,app.thread的类型为IApplicationThread，而IApplicationThread继承了IInterface接口，所以它是一个Binder类型，而IApplicationThread实现最后给了ApplicationThreadNative，而ApplicationThread最后实现了ApplicationThreadNative。然后ApplicationThread通过scheduleLaunchActivity方法来启动Activity，最后发送一个handler消息给Handler处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendMessage(H.LAUNCHE_ACTIVITY,r)</span><br></pre></td></tr></table></figure>
<p>最终Activiy的启动过程由ActivityThread的handleLaunchActivity方法来实现</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/27/2018-12-27-Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" data-id="ck8tr9s6o000an29k7bu3f0ol" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2018-12-24-Toast的Window创建过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/24/2018-12-24-Toast%E7%9A%84Window%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2018-12-23T16:00:00.000Z" itemprop="datePublished">2018-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/24/2018-12-24-Toast%E7%9A%84Window%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/">Toast的Window创建过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(MainActivity.this, &quot;Toast测试&quot;, Toast.LENGTH_SHORT).show();</span><br></pre></td></tr></table></figure>
<p>首先Toast会执行makeText方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static Toast makeText(Context context, CharSequence text, @Duration int duration) &#123;</span><br><span class="line">       return makeText(context, null, text, duration);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;**</span><br><span class="line">    * Make a standard toast to display using the specified looper.</span><br><span class="line">    * If looper is null, Looper.myLooper() is used.</span><br><span class="line">    * @hide</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public static Toast makeText(@NonNull Context context, @Nullable Looper looper,</span><br><span class="line">           @NonNull CharSequence text, @Duration int duration) &#123;</span><br><span class="line">       Toast result &#x3D; new Toast(context, looper);</span><br><span class="line"></span><br><span class="line">       LayoutInflater inflate &#x3D; (LayoutInflater)</span><br><span class="line">               context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">       View v &#x3D; inflate.inflate(com.android.internal.R.layout.transient_notification, null);</span><br><span class="line">       TextView tv &#x3D; (TextView)v.findViewById(com.android.internal.R.id.message);</span><br><span class="line">       tv.setText(text);</span><br><span class="line"></span><br><span class="line">       result.mNextView &#x3D; v;</span><br><span class="line">       result.mDuration &#x3D; duration;</span><br><span class="line"></span><br><span class="line">       return result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>创建Toast对象result,然后将我们的text内容和显示时间设置到这个对象中。</p>
<h2 id="Toast的Window创建过程"><a href="#Toast的Window创建过程" class="headerlink" title="Toast的Window创建过程"></a>Toast的Window创建过程</h2><p>在Toast内部有一个NotificationManagerService，而这个NotificationManagerService主要是负责管理Toast.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Show the view for the specified duration.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public void show() &#123;</span><br><span class="line">      if (mNextView &#x3D;&#x3D; null) &#123;</span><br><span class="line">          throw new RuntimeException(&quot;setView must have been called&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      INotificationManager service &#x3D; getService();</span><br><span class="line">      String pkg &#x3D; mContext.getOpPackageName();</span><br><span class="line">      TN tn &#x3D; mTN;</span><br><span class="line">      tn.mNextView &#x3D; mNextView;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">          service.enqueueToast(pkg, tn, mDuration);</span><br><span class="line">      &#125; catch (RemoteException e) &#123;</span><br><span class="line">          &#x2F;&#x2F; Empty</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在这里通过getService创建INotificationManager，然后调用service.enqueueToast方法向NotificationManagerService发送消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">static private INotificationManager getService() &#123;</span><br><span class="line">       if (sService !&#x3D; null) &#123;</span><br><span class="line">           return sService;</span><br><span class="line">       &#125;</span><br><span class="line">       sService &#x3D; INotificationManager.Stub.asInterface(ServiceManager.getService(&quot;notification&quot;));</span><br><span class="line">       return sService;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   private final IBinder mService &#x3D; new INotificationManager.Stub() &#123;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void enqueueToast(String pkg, ITransientNotification callback, int duration)</span><br><span class="line">   &#123;</span><br><span class="line">      ...</span><br><span class="line">       synchronized (mToastQueue) &#123;</span><br><span class="line">          ...</span><br><span class="line">           try &#123;</span><br><span class="line">               ToastRecord record;</span><br><span class="line">               int index &#x3D; indexOfToastLocked(pkg, callback);</span><br><span class="line">               &#x2F;&#x2F; 1. 如果这个toast已经存在于queue了，则只是更新它，但是并不会把它移动到队尾</span><br><span class="line">               if (index &gt;&#x3D; 0) &#123;</span><br><span class="line">                   record &#x3D; mToastQueue.get(index);</span><br><span class="line">                   record.update(duration);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   if (!isSystemToast) &#123;</span><br><span class="line">                       int count &#x3D; 0;</span><br><span class="line">                       final int N &#x3D; mToastQueue.size();</span><br><span class="line">                       for (int i&#x3D;0; i&lt;N; i++) &#123;</span><br><span class="line">                            final ToastRecord r &#x3D; mToastQueue.get(i);</span><br><span class="line">                           &#x2F;&#x2F; 2. 判断如果是同一个包， 则最多只能存在50个toast，</span><br><span class="line">                           &#x2F;&#x2F;否则不再允许添加进队列</span><br><span class="line">                            if (r.pkg.equals(pkg)) &#123;</span><br><span class="line">                                count++;</span><br><span class="line">                                if (count &gt;&#x3D; MAX_PACKAGE_NOTIFICATIONS) &#123;</span><br><span class="line">                                    return;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   record &#x3D; new ToastRecord(callingPid, pkg, callback, duration);</span><br><span class="line">                   &#x2F;&#x2F;把传过来的toast加入进队列， 等待显示</span><br><span class="line">                   mToastQueue.add(record);</span><br><span class="line">                  ...</span><br><span class="line">               &#125;</span><br><span class="line">               &#x2F;&#x2F; 3. 如果是第一个toast， 则直接显示</span><br><span class="line">               if (index &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                   showNextToastLocked();</span><br><span class="line">               &#125;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>enqueueToastd的主要作用有三个：</p>
<ol>
<li>检查当前Toast是否已经存在于队列中，如果已经存在就直接更新数据。</li>
<li>判断当前一个应用的Toast只能存在50个，如果超出将不在添加到队列中。</li>
<li>如果当前是第一个Toast,那么就直接显示。</li>
</ol>
<h2 id="Toast的Window显示过程和Show方法分析"><a href="#Toast的Window显示过程和Show方法分析" class="headerlink" title="Toast的Window显示过程和Show方法分析"></a>Toast的Window显示过程和Show方法分析</h2><p>在Toast的构造方法中，它又创建了一个TN对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public Toast(@NonNull Context context, @Nullable Looper looper) &#123;</span><br><span class="line">       mContext &#x3D; context;</span><br><span class="line">       mTN &#x3D; new TN(context.getPackageName(), looper);</span><br><span class="line">       mTN.mY &#x3D; context.getResources().getDimensionPixelSize(</span><br><span class="line">               com.android.internal.R.dimen.toast_y_offset);</span><br><span class="line">       mTN.mGravity &#x3D; context.getResources().getInteger(</span><br><span class="line">               com.android.internal.R.integer.config_toastDefaultGravity);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   TN(String packageName, @Nullable Looper looper) &#123;</span><br><span class="line">           &#x2F;&#x2F; XXX This should be changed to use a Dialog, with a Theme.Toast</span><br><span class="line">           &#x2F;&#x2F; defined that sets up the layout params appropriately.</span><br><span class="line">           final WindowManager.LayoutParams params &#x3D; mParams;</span><br><span class="line">           params.height &#x3D; WindowManager.LayoutParams.WRAP_CONTENT;</span><br><span class="line">           params.width &#x3D; WindowManager.LayoutParams.WRAP_CONTENT;</span><br><span class="line">           params.format &#x3D; PixelFormat.TRANSLUCENT;</span><br><span class="line">           params.windowAnimations &#x3D; com.android.internal.R.style.Animation_Toast;</span><br><span class="line">           params.type &#x3D; WindowManager.LayoutParams.TYPE_TOAST;</span><br><span class="line">           params.setTitle(&quot;Toast&quot;);</span><br><span class="line">           params.flags &#x3D; WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON</span><br><span class="line">                   | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE</span><br><span class="line">                   | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE;</span><br><span class="line"></span><br><span class="line">           mPackageName &#x3D; packageName;</span><br><span class="line"></span><br><span class="line">           if (looper &#x3D;&#x3D; null) &#123;</span><br><span class="line">               &#x2F;&#x2F; Use Looper.myLooper() if looper is not specified.</span><br><span class="line">               looper &#x3D; Looper.myLooper();</span><br><span class="line">               if (looper &#x3D;&#x3D; null) &#123;</span><br><span class="line">                   throw new RuntimeException(</span><br><span class="line">                           &quot;Can&#39;t toast on a thread that has not called Looper.prepare()&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mHandler &#x3D; new Handler(looper, null) &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public void handleMessage(Message msg) &#123;</span><br><span class="line">                   switch (msg.what) &#123;</span><br><span class="line">                       case SHOW: &#123;</span><br><span class="line">                           IBinder token &#x3D; (IBinder) msg.obj;</span><br><span class="line">                           handleShow(token);</span><br><span class="line">                           break;</span><br><span class="line">                       &#125;</span><br><span class="line">                       case HIDE: &#123;</span><br><span class="line">                           handleHide();</span><br><span class="line">                           &#x2F;&#x2F; Don&#39;t do this in handleHide() because it is also invoked by</span><br><span class="line">                           &#x2F;&#x2F; handleShow()</span><br><span class="line">                           mNextView &#x3D; null;</span><br><span class="line">                           break;</span><br><span class="line">                       &#125;</span><br><span class="line">                       case CANCEL: &#123;</span><br><span class="line">                           handleHide();</span><br><span class="line">                           &#x2F;&#x2F; Don&#39;t do this in handleHide() because it is also invoked by</span><br><span class="line">                           &#x2F;&#x2F; handleShow()</span><br><span class="line">                           mNextView &#x3D; null;</span><br><span class="line">                           try &#123;</span><br><span class="line">                               getService().cancelToast(mPackageName, TN.this);</span><br><span class="line">                           &#125; catch (RemoteException e) &#123;</span><br><span class="line">                           &#125;</span><br><span class="line">                           break;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>在TN内部有一个show方法和一个hide方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">       * schedule handleShow into the right thread</span><br><span class="line">       *&#x2F;</span><br><span class="line">      @Override</span><br><span class="line">      public void show(IBinder windowToken) &#123;</span><br><span class="line">          if (localLOGV) Log.v(TAG, &quot;SHOW: &quot; + this);</span><br><span class="line">          mHandler.obtainMessage(SHOW, windowToken).sendToTarget();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;**</span><br><span class="line">       * schedule handleHide into the right thread</span><br><span class="line">       *&#x2F;</span><br><span class="line">      @Override</span><br><span class="line">      public void hide() &#123;</span><br><span class="line">          if (localLOGV) Log.v(TAG, &quot;HIDE: &quot; + this);</span><br><span class="line">          mHandler.obtainMessage(HIDE).sendToTarget();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>在mHandler有去调用了handleShow和handleHide方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mHandler &#x3D; new Handler(looper, null) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void handleMessage(Message msg) &#123;</span><br><span class="line">                    switch (msg.what) &#123;</span><br><span class="line">                        case SHOW: &#123;</span><br><span class="line">                            IBinder token &#x3D; (IBinder) msg.obj;</span><br><span class="line">                            handleShow(token);</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        case HIDE: &#123;</span><br><span class="line">                            handleHide();</span><br><span class="line">                            &#x2F;&#x2F; Don&#39;t do this in handleHide() because it is also invoked by</span><br><span class="line">                            &#x2F;&#x2F; handleShow()</span><br><span class="line">                            mNextView &#x3D; null;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        case CANCEL: &#123;</span><br><span class="line">                            handleHide();</span><br><span class="line">                            &#x2F;&#x2F; Don&#39;t do this in handleHide() because it is also invoked by</span><br><span class="line">                            &#x2F;&#x2F; handleShow()</span><br><span class="line">                            mNextView &#x3D; null;</span><br><span class="line">                            try &#123;</span><br><span class="line">                                getService().cancelToast(mPackageName, TN.this);</span><br><span class="line">                            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure>
<p>最终在handleShow和handleHide</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public void handleShow(IBinder windowToken) &#123;</span><br><span class="line">               mWM &#x3D; (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">               &#x2F;&#x2F; We can resolve the Gravity here by using the Locale for getting</span><br><span class="line">               &#x2F;&#x2F; the layout direction</span><br><span class="line">               final Configuration config &#x3D; mView.getContext().getResources().getConfiguration();</span><br><span class="line">               final int gravity &#x3D; Gravity.getAbsoluteGravity(mGravity, config.getLayoutDirection());</span><br><span class="line">               mParams.gravity &#x3D; gravity;</span><br><span class="line">               if ((gravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#x3D;&#x3D; Gravity.FILL_HORIZONTAL) &#123;</span><br><span class="line">                   mParams.horizontalWeight &#x3D; 1.0f;</span><br><span class="line">               &#125;</span><br><span class="line">               if ((gravity &amp; Gravity.VERTICAL_GRAVITY_MASK) &#x3D;&#x3D; Gravity.FILL_VERTICAL) &#123;</span><br><span class="line">                   mParams.verticalWeight &#x3D; 1.0f;</span><br><span class="line">               &#125;</span><br><span class="line">               mParams.x &#x3D; mX;</span><br><span class="line">               mParams.y &#x3D; mY;</span><br><span class="line">               mParams.verticalMargin &#x3D; mVerticalMargin;</span><br><span class="line">               mParams.horizontalMargin &#x3D; mHorizontalMargin;</span><br><span class="line">               mParams.packageName &#x3D; packageName;</span><br><span class="line">               mParams.hideTimeoutMilliseconds &#x3D; mDuration &#x3D;&#x3D;</span><br><span class="line">                   Toast.LENGTH_LONG ? LONG_DURATION_TIMEOUT : SHORT_DURATION_TIMEOUT;</span><br><span class="line">               mParams.token &#x3D; windowToken;</span><br><span class="line">               if (mView.getParent() !&#x3D; null) &#123;</span><br><span class="line">                   if (localLOGV) Log.v(TAG, &quot;REMOVE! &quot; + mView + &quot; in &quot; + this);</span><br><span class="line">                   mWM.removeView(mView);</span><br><span class="line">               &#125;</span><br><span class="line">               if (localLOGV) Log.v(TAG, &quot;ADD! &quot; + mView + &quot; in &quot; + this);</span><br><span class="line">               &#x2F;&#x2F; Since the notification manager service cancels the token right</span><br><span class="line">               &#x2F;&#x2F; after it notifies us to cancel the toast there is an inherent</span><br><span class="line">               &#x2F;&#x2F; race and we may attempt to add a window after the token has been</span><br><span class="line">               &#x2F;&#x2F; invalidated. Let us hedge against that.</span><br><span class="line">               try &#123;</span><br><span class="line">                   mWM.addView(mView, mParams);</span><br><span class="line">                   trySendAccessibilityEvent();</span><br><span class="line">               &#125; catch (WindowManager.BadTokenException e) &#123;</span><br><span class="line">                   &#x2F;* ignore *&#x2F;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>最终还是通过WindowManager添加视图 mWM.addView(mView, mParams);</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2018/12/24/2018-12-24-Toast%E7%9A%84Window%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/" data-id="ck8tr9s6l0005n29k9h2654hy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
          </li>
        
          <li>
            <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
          </li>
        
          <li>
            <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
          </li>
        
          <li>
            <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/page/4/index/" data-id="ckgafe0de00485z9k3gbm9562" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-page/2/index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/page/2/index/" class="article-date">
  <time datetime="2020-10-15T03:18:44.739Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/page/2/index/">page/2/index</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/page/2/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-10-17-要么蠢要么坏的思维方式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2019-10-16T16:00:00.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/">要么蠢要么坏的思维方式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>多数人倒也是真的不一味反对市场，只是总有个“但是”。比如上篇文章里的一个读者是这么评论的：</p>
<p>在小地方，供给有限的情况下也确实可能串通涨价，可能一个小镇上只有两三家网吧，七八家理发店，你涨人家也涨，或者你串通一两家涨，其他的也未免不会跟风涨。市场经济的完全自由竞争是好的，但政府相应的监管我觉得也是不可或缺的，只是有时候大家觉得管多了，该管的不管，可是这个度，还真不好拿捏。</p>
<p>这套说辞十分常见，他们也赞同竞争的好处，但同时认为价格监管（至少上篇我们谈的是价格）也是必要的，只不过一个拿捏的问题。首先结论是，价格根本不需要也不应该被干预。在精密的超级计算机都计算不出来什么价格是最优的。这里不仅是动态变化，背后还有人的意志。</p>
<p>另外，很多人喜欢说完全自由竞争，其实也是一句顺口溜。理论上完全自由竞争并不存在，自由的竞争有，只要政府不插手，但完全的竞争，只是一种人脑子里期待的一种无限接近。从不存在完全的竞争，想象下也是存在过一瞬间，但其实是不可描述的状态。</p>
<p>上篇文章是从理发店开始，那我们更极端一点吧，假设一座孤岛上只有一座理发店，这个理发店提供的是一种延年益寿的特殊理发服务，理发养生，独门绝技。没有竞争，连潜在的竞争都没有。这种理发价格应该多少钱呢？正常情况下必然是天价了，人人都想多活几年。</p>
<p>好，那么价格应该多少合适？没有答案不是因为算不出来，而是因为定价权其实是私有财产的一个分支。什么叫定价权，就是我的东西我想卖想扔掉（等于是价格为零）都是我的自由。这是定价权。</p>
<p>如果这个岛上神奇的理发师有一天突然就不想理发了，给多少钱都不，可以吗？实在给不出任何理由。因为人家不欠任何人的。</p>
<p>一个尊重私有产权的社会在制定任何政策的时候都应该小心翼翼避免侵害了他人的财产权。当然，这是我们的期望。因为我相信大部分人都不希望自己的东西被肆意剥夺，在交易的时候价格被各种名义限制，都希望生活在私有财产能得到最大程度保障的社会，那么在思考问题时请尽量从个人权利的角度出发，否则要么是蠢要么就是坏了。</p>
<p>蠢，以为这种侵害不会到自己头上。坏，侵犯别人又不关我的事。</p>
<p>房产税支持，觉得主要是一种度的拿捏，遗产税支持，觉得要均衡好，稳定物价也支持，说这是关乎国计民生，稳定团结。总会找到理由，因为好像跟自己完全无关，贵州的一个县的牛肉粉就应该不让涨价，毕竟卖牛肉粉的不是你嘛。</p>
<p>从权利的角度谈问题很多人都觉得过于简单了，会钻牛角尖，举出各种困境。其实把这些暂且放在一边，只是说，最好需要养成这样的思维习惯，学会从权利的角度先想一遍。这是一个健全社会公民应有的基础思维方式。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/" data-id="ck8tr9s78001ln29kfy0sc7hl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">吴主任的公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-16-遗憾，这些人才是多数" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/" class="article-date">
  <time datetime="2019-10-15T16:00:00.000Z" itemprop="datePublished">2019-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/">遗憾，这些人才是多数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原创： 吴主任  吴主任  今天</p>
<p>贵州黔西县的牛肉粉因为涨价被当地市场监管部门认定为“串通涨价”事件。价格管制的话题我大概聊了有十年了，算上以前工作时做的专题，数量没法统计。所以那篇文章更想分享的是一大串的评论，想让大家知道，你以为的基础常识在很多人的认知里不是。</p>
<p>今天，中国的绝大多数人一边享受着市场经济带来的繁荣，一边又总是在期待有关部门能够把各种价格关起来，当然主要是那些他们觉得贵的，不合理的。</p>
<p>比如有个读者问：但如果一点都不管的话，商贩涨价完全没成本没约束啊，就像洗发店似的，一个比一个贵，去年还都25剪一个，今年蹭蹭蹭都涨到35。即使明天楼下的理发店都涨到50一次，我也没什么办法不是吗？难道每次要坐车去其它地方剪头发？</p>
<p>那就再一次耐心地就这个问题展开聊一聊。</p>
<p>说说我亲历的理发的价格。2009年，榆林市，50块钱。2019年，北京市，5块钱。请注意时间和地点。有些人确实不知道，北京一些广场或者路边那种理发摊位，就5块钱。当然，你随便去一家有托尼总监的店，一两百块钱不要太惊讶。</p>
<p>总体上几十年来的物价上涨非常明显，这个每个人稍微回忆一下都能体会到。也正因此总会有让你惊讶的价格存在。这也是很多人打开拼多多时的感受，但如果去过小地方的批发市场就明白，拼多多不过是把它们搬到网上去了而已。</p>
<p>这些都是竞争，价格也是动态的。说涨价没有约束完全是胡话。按照人们趋利避害的特性，谁卖东西不想卖个天价呢？这种想也就是痴心妄想，因为最大的约束就是市场。理发店也想理个头一千块钱，你去开个理发店试试，看是不是可以随意涨价。或者随便二手市场随便卖个东西，试试就知道了。</p>
<p>所以我们要感谢竞争，因为竞争是最大的监督和约束。商家们本分做事，笑脸相迎，服务到位绝不是吃饱了没事干，只是为了更有竞争力。只有那种被权力挡在门外的领域才可以高枕无忧，商品和服务态度都很恶劣，还活得不错。靠有关部门监督吗？可以，配合一下做做样子，但无法解决根本问题。</p>
<p>很简单的道理，应付监管容易，讨好消费者却非常难。前者不仅是死的，而且可以收买，后者的要求就苛刻了，而且随时在变化。比如说衣服，某种潮流可能过了一季就彻底无人问津了。</p>
<p>价格管制的必然结果就是打击供给，有利可图才会吸引更多人进来。价格严格管制，不仅打击了供给，也会让原本的商品和服务的质量在消费者注意不到的地方偷工减料。</p>
<p>就理发这么小的一件事，价格也是整个经济运转过程慢慢给出的。如果定高了可能就关店了，定低了呢，有些划不来。至于多少钱合适，没有任何可参考的标准，这跟该商品和服务的目标人群定位和所在地的整体经济情况以及整个大环境的物价等息息相关。因此，即便从这一点也可以看出价格管制有多荒谬。市场监管部门里的那些人凭什么知道某个商品多少钱合适？但他们觉得他们知道。</p>
<p>楼下的理发店突然涨到100块钱了，这件事可能发生吗？几乎不可能，除非就是不想干了。因为理发不是生死攸关，也不是整座城市就这一家。总有替代品。</p>
<p>如果有一天你醒来发现整座城市每家理发店剪个头发最少1000块钱，你确认下是不是穿越到二十年后了，然后出门看看楼下的一碗面条是不是差不多也得500块钱，如果都不是，依然是当下的时间和物价。那么，请相信我，大概率是你根本没心思关心发型问题，你和隔壁老王都在着急筹划快速开个理发店。媒体称这一现象为“莫名其妙的时尚保健风引起的理发店泡沫”“退潮了才知道谁在裸泳”……</p>
<p>常去的理发店突然涨价了你受不了，你当然没办法人家，但你可以选择便宜的，或者自己理发，要求管一管有些无耻，人家并没有欠你什么。除非你觉得有天物价局也来限制你的工资上限是合理的。今年你要求月薪五千，明年你希望找个八千的，凭什么呢？也让物价局管一管你的价格啊。不得高于五千！</p>
<p>如此基础枯燥且无聊的话题，聊着聊着就1600多个字了。但不可思议的是居然那么多人支持有关部门管一管贵州牛肉粉的涨价。但我们要直面现实，中国真的好大，地大物博物种丰富，我们国家8亿网民，估计有6亿是希望有关部门管一管各种商品价格的。所以，非常遗憾，现实就是这些人才是多数。也正因此有关部门如鱼得水。恭喜发财。</p>
<p>言归正传，真心希望能有更多人明白这些基础的知识。别人的观念看似与自己无关，但更深入地看，社会是由每个人的观念共同作用下决定了一个大致的方向。因此，不能说重复这些“基础常识”没用，考虑到当下的局面多数人的认知，更多人能明白些正确的且并不难懂理念，长远当然是有利于每个人。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/" data-id="ck8tr9s76001gn29kftakakyr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">吴主任的公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-11-Android Gradle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/11/2019-10-11-Android%20Gradle/" class="article-date">
  <time datetime="2019-10-10T16:00:00.000Z" itemprop="datePublished">2019-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/11/2019-10-11-Android%20Gradle/">Android Gradle</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>gradle是作为一个在Android studio中的编译打包工具。<br>关于grale的编译打包流程可以<a href="https://developer.android.com/studio/build" target="_blank" rel="noopener">看图</a></p>
<h1 id="项目编译配置文件"><a href="#项目编译配置文件" class="headerlink" title="项目编译配置文件"></a>项目编译配置文件</h1><p><a href="https://developer.android.com/studio/build" target="_blank" rel="noopener">看图</a><br>在日常我们创建一个Android项目的时候目录就是这样的。</p>
<h2 id="gradle配置文件"><a href="#gradle配置文件" class="headerlink" title="gradle配置文件"></a>gradle配置文件</h2><p>setting.gradle是当我们的项目中需要引入一些jar，arr等第三方库包含到我们的项目中时我们需要在这个gradle中配置。</p>
<h2 id="项目的gradle-—-build-gradle"><a href="#项目的gradle-—-build-gradle" class="headerlink" title="项目的gradle — build.gradle"></a>项目的gradle — build.gradle</h2><p>此编译文件适用于项目中所有模块的编译配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Top-level build file where you can add configuration options common to all sub-projects&#x2F;modules.</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    </span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#39;com.android.tools.build:gradle:3.3.1&#39;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; NOTE: Do not place your application dependencies here; they belong</span><br><span class="line">        &#x2F;&#x2F; in the individual module build.gradle files</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123; url &#39;https:&#x2F;&#x2F;jitpack.io&#39; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(type: Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的配置代码中buildscript代码块主要是依赖gradle插件。allprojects代码块可以理解为项目中需要依赖的第三方仓库从google和jcenter以及maven { url ‘<a href="https://jitpack.io&#39;" target="_blank" rel="noopener">https://jitpack.io&#39;</a> }拉取。</p>
<h2 id="配置项目属性"><a href="#配置项目属性" class="headerlink" title="配置项目属性"></a>配置项目属性</h2><p>在项目的build.gradle中我们还可以配置在所有模块build.gradle中共用的属性，因此可以在顶级项目build.gradle中ext代码块中配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;...&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;...&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; This block encapsulates custom properties and makes them available to all</span><br><span class="line">&#x2F;&#x2F; modules in the project.</span><br><span class="line">ext &#123;</span><br><span class="line">    &#x2F;&#x2F; The following are only a few examples of the types of properties you can define.</span><br><span class="line">    compileSdkVersion &#x3D; 28</span><br><span class="line">    &#x2F;&#x2F; You can also create properties to specify versions for dependencies.</span><br><span class="line">    &#x2F;&#x2F; Having consistent versions between modules can avoid conflicts with behavior.</span><br><span class="line">    supportLibVersion &#x3D; &quot;28.0.0&quot;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后在模块中引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  &#x2F;&#x2F; Use the following syntax to access properties you defined at the project level:</span><br><span class="line">  &#x2F;&#x2F; rootProject.ext.property_name</span><br><span class="line">  compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation &quot;com.android.support:appcompat-v7:$&#123;rootProject.ext.supportLibVersion&#125;&quot;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="应用级编译模块"><a href="#应用级编译模块" class="headerlink" title="应用级编译模块"></a>应用级编译模块</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * The first line in the build configuration applies the Android plugin for</span><br><span class="line"> * Gradle to this build and makes the android block available to specify</span><br><span class="line"> * Android-specific build options.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">apply plugin: &#39;com.android.application&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The android block is where you configure all your Android-specific</span><br><span class="line"> * build options.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * compileSdkVersion specifies the Android API level Gradle should use to</span><br><span class="line">   * compile your app. This means your app can use the API features included in</span><br><span class="line">   * this API level and lower.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  compileSdkVersion 28</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * buildToolsVersion specifies the version of the SDK build tools, command-line</span><br><span class="line">   * utilities, and compiler that Gradle should use to build your app. You need to</span><br><span class="line">   * download the build tools using the SDK Manager.</span><br><span class="line">   *</span><br><span class="line">   * This property is optional because the plugin uses a recommended version of</span><br><span class="line">   * the build tools by default.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  buildToolsVersion &quot;29.0.0&quot;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The defaultConfig block encapsulates default settings and entries for all</span><br><span class="line">   * build variants, and can override some attributes in main&#x2F;AndroidManifest.xml</span><br><span class="line">   * dynamically from the build system. You can configure product flavors to override</span><br><span class="line">   * these values for different versions of your app.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  defaultConfig &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * applicationId uniquely identifies the package for publishing.</span><br><span class="line">     * However, your source code should still reference the package name</span><br><span class="line">     * defined by the package attribute in the main&#x2F;AndroidManifest.xml file.</span><br><span class="line">     *&#x2F;</span><br><span class="line"></span><br><span class="line">    applicationId &#39;com.example.myapp&#39;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines the minimum API level required to run the app.</span><br><span class="line">    minSdkVersion 15</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Specifies the API level used to test the app.</span><br><span class="line">    targetSdkVersion 28</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines the version number of your app.</span><br><span class="line">    versionCode 1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines a user-friendly version name for your app.</span><br><span class="line">    versionName &quot;1.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The buildTypes block is where you can configure multiple build types.</span><br><span class="line">   * By default, the build system defines two build types: debug and release. The</span><br><span class="line">   * debug build type is not explicitly shown in the default build configuration,</span><br><span class="line">   * but it includes debugging tools and is signed with the debug key. The release</span><br><span class="line">   * build type applies Proguard settings and is not signed by default.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  buildTypes &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * By default, Android Studio configures the release build type to enable code</span><br><span class="line">     * shrinking, using minifyEnabled, and specifies the Proguard settings file.</span><br><span class="line">     *&#x2F;</span><br><span class="line"></span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled true &#x2F;&#x2F; Enables code shrinking for the release build type.</span><br><span class="line">        proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The productFlavors block is where you can configure multiple product flavors.</span><br><span class="line">   * This allows you to create different versions of your app that can</span><br><span class="line">   * override the defaultConfig block with their own settings. Product flavors</span><br><span class="line">   * are optional, and the build system does not create them by default.</span><br><span class="line">   *</span><br><span class="line">   * This example creates a free and paid product flavor. Each product flavor</span><br><span class="line">   * then specifies its own application ID, so that they can exist on the Google</span><br><span class="line">   * Play Store, or an Android device, simultaneously.</span><br><span class="line">   *</span><br><span class="line">   * If you declare product flavors, you must also declare flavor dimensions</span><br><span class="line">   * and assign each flavor to a flavor dimension.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  flavorDimensions &quot;tier&quot;</span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    free &#123;</span><br><span class="line">      dimension &quot;tier&quot;</span><br><span class="line">      applicationId &#39;com.example.myapp.free&#39;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paid &#123;</span><br><span class="line">      dimension &quot;tier&quot;</span><br><span class="line">      applicationId &#39;com.example.myapp.paid&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The splits block is where you can configure different APK builds that</span><br><span class="line">   * each contain only code and resources for a supported screen density or</span><br><span class="line">   * ABI. You&#39;ll also need to configure your build so that each APK has a</span><br><span class="line">   * different versionCode.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  splits &#123;</span><br><span class="line">    &#x2F;&#x2F; Settings to build multiple APKs based on screen density.</span><br><span class="line">    density &#123;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Enable or disable building multiple APKs.</span><br><span class="line">      enable false</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Exclude these densities when building multiple APKs.</span><br><span class="line">      exclude &quot;ldpi&quot;, &quot;tvdpi&quot;, &quot;xxxhdpi&quot;, &quot;400dpi&quot;, &quot;560dpi&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The dependencies block in the module-level build configuration file</span><br><span class="line"> * specifies dependencies required to build only the module itself.</span><br><span class="line"> * To learn more, go to Add build dependencies.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation project(&quot;:lib&quot;)</span><br><span class="line">    implementation &#39;com.android.support:appcompat-v7:28.0.0&#39;</span><br><span class="line">    implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果当前apk需要打多渠道包的话可以通过productFlavors添加不通的渠道。</p>
<h1 id="gradle-properties"><a href="#gradle-properties" class="headerlink" title="gradle.properties"></a>gradle.properties</h1><p>在这个文件中可以设置gradle。<br>#local.properties<br>当前编译环境的sdk和ndk路径，这个文件里的内容由Androidstudio自动完成。</p>
<h2 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h2><ul>
<li>implementation:只会暴露给直接依赖的模块<br>在项目中我们创建2个moudle,分别命名为Module1和Module2.他们的依赖关系为：<br>app(implementation Module1)—&gt;Module1(implementation Moudle2)—&gt;Module2.<br>这种依赖关系中我们无法在app中使用Module2中的资源。</li>
<li>api:会暴露给间接依赖的模块<br>如上此时app可以调用Module2中的资源。</li>
<li>compileOnly:只在编译期间依赖模块,打包以后运行时不会依赖。<br>如上依赖关系为 app(implementation Module1)—&gt;Module1(compileOnly  Module2)—&gt;Module2.<br>在编译期间app无法引用到Module2,Module1中正常引用，但是打包运行之后会报错，从名称也可以看出仅编译时。</li>
<li>runtimeOnly:只在运行时依赖模块,编译时不依赖 </li>
</ul>
<h2 id="productFlavors"><a href="#productFlavors" class="headerlink" title="productFlavors"></a>productFlavors</h2><h2 id="sourceSets"><a href="#sourceSets" class="headerlink" title="sourceSets"></a>sourceSets</h2><h2 id="怎样生成一个Gradle-Wrapper"><a href="#怎样生成一个Gradle-Wrapper" class="headerlink" title="怎样生成一个Gradle Wrapper"></a>怎样生成一个Gradle Wrapper</h2><p>项目中的gradle wrapper目录文件可以帮助我们统一gradle的版本以免造成程序开发中版本不一构建失败的问题。<br>有些时候我们可以在项目中通过命令的方式在我们的项目目录中生成一个wrapper（包装）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$gradle wrapper</span><br></pre></td></tr></table></figure>
<h2 id="gradle-wrapper-properties"><a href="#gradle-wrapper-properties" class="headerlink" title="gradle-wrapper.properties"></a>gradle-wrapper.properties</h2><p> 这个是在项目中的gradle文件中的gradle配置文件,它里面的内容主要有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Fri Oct 11 22:58:29 CST 2019</span><br><span class="line">distributionBase&#x3D;GRADLE_USER_HOME</span><br><span class="line">distributionPath&#x3D;wrapper&#x2F;dists</span><br><span class="line">zipStoreBase&#x3D;GRADLE_USER_HOME</span><br><span class="line">zipStorePath&#x3D;wrapper&#x2F;dists</span><br><span class="line">distributionUrl&#x3D;https\:&#x2F;&#x2F;services.gradle.org&#x2F;distributions&#x2F;gradle-5.4.1-all.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>distributionBase:这个表示下载后的gradle压缩包解压后存储的主目录</li>
<li>distributionPath:压缩包的路径</li>
<li>zipStoreBase:存放压缩后的zip</li>
<li>zipStorePath:zip压缩包的路径</li>
<li>distributionUrl:gralde的下载地址(这个非常的重要,因为这个会根据URL路径下载对应的gradle版本)</li>
</ul>
<h2 id="自定义Wrapper-Task"><a href="#自定义Wrapper-Task" class="headerlink" title="自定义Wrapper Task"></a>自定义Wrapper Task</h2><p>我们可以在当前根项目中的buidl.gradle脚本文件中创建一个冠以wrapper的task</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line">     * 通过task设置要下载的gradle的版本</span><br><span class="line">     *&#x2F;</span><br><span class="line">    task wrappers(type: Wrapper) &#123;</span><br><span class="line">    gradleVersion &#x3D; &#39;5.6.2&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时也可以添加一些其他的配置，比如上面的一些字段(distributionBase,distributionPath,distributionUrl)</p>
<h2 id="强制刷新依赖"><a href="#强制刷新依赖" class="headerlink" title="强制刷新依赖"></a>强制刷新依赖</h2><p>有些时候我们从maven库中下载的一些第三方依赖由于缓存的原因导致一直无法更新到最新的版本,这个时候我们可以通过一下的命令强制第三方依赖刷新.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle --refresh-dependencies assemble</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/11/2019-10-11-Android%20Gradle/" data-id="ck8tr9s77001in29k3kv3hunm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-10-Java反射机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" class="article-date">
  <time datetime="2019-10-09T16:00:00.000Z" itemprop="datePublished">2019-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/">Java反射机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是Java反射机制"><a href="#什么是Java反射机制" class="headerlink" title="什么是Java反射机制"></a>什么是Java反射机制</h1><p>在我们的开发过程中有些时候需要针对一些特定的类需要更改他的内部传参或者方法的调用以达到我们的目的.</p>
<p>#使用反射获取类的基本信息</p>
<h2 id="获取所有变量的信息"><a href="#获取所有变量的信息" class="headerlink" title="获取所有变量的信息"></a>获取所有变量的信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class childClass &#x3D; Child.class;</span><br><span class="line">        &#x2F;&#x2F;fileds方法是获取当前类和继承的父类的所有public变量</span><br><span class="line">        &#x2F;&#x2F;Field[] declaredFields &#x3D; childClass.getFields();</span><br><span class="line">        &#x2F;&#x2F;DeclaredFields是获取当前类的所有方法和成员变量</span><br><span class="line">        Field[] declaredFields &#x3D; childClass.getDeclaredFields();</span><br><span class="line">        for (Field field : declaredFields) &#123;</span><br><span class="line">            System.out.println(field.getType().getName() + &quot; &quot; + field.getName());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取所有方法的信息"><a href="#获取所有方法的信息" class="headerlink" title="获取所有方法的信息"></a>获取所有方法的信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">        * 获取所有方法的信息</span><br><span class="line">        *&#x2F;</span><br><span class="line">       &#x2F;&#x2F;获取当前类和父类的所有public方法</span><br><span class="line">       &#x2F;&#x2F;Method[] method &#x3D; childClass.getMethods();</span><br><span class="line">       &#x2F;&#x2F;获取本类的所有方法(不问访问权限)</span><br><span class="line">       Method[] methods &#x3D; childClass.getDeclaredMethods();</span><br><span class="line">       for (Method method : methods) &#123;</span><br><span class="line">           &#x2F;&#x2F;获取方法的访问权限</span><br><span class="line">           int modifiers &#x3D; method.getModifiers();</span><br><span class="line">           System.out.println(Modifier.toString(modifiers));</span><br><span class="line">           &#x2F;&#x2F;获取并输出方法的返回类型</span><br><span class="line">           Class&lt;?&gt; returnType &#x3D; method.getReturnType();</span><br><span class="line">           System.out.println(returnType.getName() + &quot; &quot; + method.getName() + &quot; &quot;);</span><br><span class="line">           &#x2F;&#x2F;获取并输出所有方法的参数</span><br><span class="line">           Parameter[] parameters &#x3D; method.getParameters();</span><br><span class="line">           for (Parameter parameter : parameters) &#123;</span><br><span class="line">               System.out.println(parameter.getType().getName() + &quot; &quot; + parameter.getName());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>#访问和操作类的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Method declaredMethod &#x3D; null;</span><br><span class="line">       Child child &#x3D; new Child();</span><br><span class="line">       Class&lt;? extends Child&gt; aClass &#x3D; child.getClass();</span><br><span class="line">       try &#123;</span><br><span class="line">           declaredMethod &#x3D; aClass.getDeclaredMethod(&quot;setGender&quot;, String.class);</span><br><span class="line">           &#x2F;&#x2F;这里调用Accessible的意思就是获取私有方法(private)的访问权限</span><br><span class="line">           declaredMethod.setAccessible(true);</span><br><span class="line">           declaredMethod.invoke(child, &quot;man&quot;);</span><br><span class="line">           System.out.println(child.getGender());</span><br><span class="line">       &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>#访问和操作变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">           Field field &#x3D; childClass.getDeclaredField(&quot;MSG&quot;);</span><br><span class="line">           field.setAccessible(true);</span><br><span class="line">           field.set(childClass, &quot;MSG CHANGE&quot;);</span><br><span class="line">           System.out.println(&quot;MSG AFTER:&quot; + new Child().getMsg());</span><br><span class="line">       &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" data-id="ck8tr9s730019n29k5da8b9yk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-28-Android事件分发机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/" class="article-date">
  <time datetime="2019-09-27T16:00:00.000Z" itemprop="datePublished">2019-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/">Android事件分发机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>学习Android的事件分发机制，掌握其原理能够处理复杂的事件分发解决滑动冲突编写一个Demo示例，通过查看Blog了解。<br>通常我们在业务开发中会碰到多个View可以同时响应一个事件的情况,但是事件又只能传递给其中的某一个View这个时候怎样让系统按照你的意愿将此事件分发给指定的View处理就需要有事件分发的基础了.<br>在Android的事件分发中当我们按下屏幕时这个点击事件传递的顺序是这样：<br>Activity—&gt;phoneWindow—&gt;DecorView—&gt;ViewGroup—&gt;……—&gt;View。</p>
<h2 id="Activity中的事件分发机制"><a href="#Activity中的事件分发机制" class="headerlink" title="Activity中的事件分发机制"></a>Activity中的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Called to process touch screen events.  You can override this to</span><br><span class="line">   * intercept all touch screen events before they are dispatched to the</span><br><span class="line">   * window.  Be sure to call this implementation for touch screen events</span><br><span class="line">   * that should be handled normally.</span><br><span class="line">   *</span><br><span class="line">   * @param ev The touch screen event.</span><br><span class="line">   *</span><br><span class="line">   * @return boolean Return true if this event was consumed.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">      if (ev.getAction() &#x3D;&#x3D; MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">          onUserInteraction();</span><br><span class="line">      &#125;</span><br><span class="line">      if (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      return onTouchEvent(ev);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>当前事件首先会在Activity中的dispatchTouchEvent接收,按下的Action先是MotionEvent.ACTION_DOWN然后首先会执行 onUserInteraction()这个方法。<br>接下来分析一下onUserInteraction()这个方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Called whenever a key, touch, or trackball event is dispatched to the</span><br><span class="line">     * activity.  Implement this method if you wish to know that the user has</span><br><span class="line">     * interacted with the device in some way while your activity is running.</span><br><span class="line">     * This callback and &#123;@link #onUserLeaveHint&#125; are intended to help</span><br><span class="line">     * activities manage status bar notifications intelligently; specifically,</span><br><span class="line">     * for helping activities determine the proper time to cancel a notfication.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;All calls to your activity&#39;s &#123;@link #onUserLeaveHint&#125; callback will</span><br><span class="line">     * be accompanied by calls to &#123;@link #onUserInteraction&#125;.  This</span><br><span class="line">     * ensures that your activity will be told of relevant user activity such</span><br><span class="line">     * as pulling down the notification pane and touching an item there.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;Note that this callback will be invoked for the touch down action</span><br><span class="line">     * that begins a touch gesture, but may not be invoked for the touch-moved</span><br><span class="line">     * and touch-up actions that follow.</span><br><span class="line">     *</span><br><span class="line">     * @see #onUserLeaveHint()</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void onUserInteraction() &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此方法是一个空方法，当此Activity在栈顶时,触屏点击按home，back，menu键都会触发此方法.<br>接下来分析第二个if语句：getWindow().superDispatchTouchEvent(ev)。<br>getWindow是一个Window它是一个抽象类具体实现是phoneWindow。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">       return mDecor.superDispatchTouchEvent(event);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里将会调用DecorView中的superDispatchTouchEvent。然后在superDispatchTouchEvent中接着调用ViewGroup中的dispatchTouchEvent。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        return super.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最终事件就传递到了我们的ViewGroup中.<br>如果此时getWindow().superDispatchTouchEvent(ev)返回的是true该点击事件将停止往下传递，事件传递结束。否则继续往下调用onTouchEvent(ev)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Called when a touch screen event was not handled by any of the views</span><br><span class="line">     * under it.  This is most useful to process touch events that happen</span><br><span class="line">     * outside of your window bounds, where there is no view to receive it.</span><br><span class="line">     *</span><br><span class="line">     * @param event The touch screen event being processed.</span><br><span class="line">     *</span><br><span class="line">     * @return Return true if you have consumed the event, false if you haven&#39;t.</span><br><span class="line">     * The default implementation always returns false.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        if (mWindow.shouldCloseOnTouch(this, event)) &#123;</span><br><span class="line">            finish();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>执行到onTouchEven中的mWindow.shouldCloseOnTouch(this, event)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean shouldCloseOnTouch(Context context, MotionEvent event) &#123;</span><br><span class="line">       final boolean isOutside &#x3D;</span><br><span class="line">               event.getAction() &#x3D;&#x3D; MotionEvent.ACTION_DOWN &amp;&amp; isOutOfBounds(context, event)</span><br><span class="line">               || event.getAction() &#x3D;&#x3D; MotionEvent.ACTION_OUTSIDE;</span><br><span class="line">       if (mCloseOnTouchOutside &amp;&amp; peekDecorView() !&#x3D; null &amp;&amp; isOutside) &#123;</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br><span class="line">       return false;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>返回ture说明事件在边界外,消费了该事件；false未消费此事件(默认).<br>最终onTouchEvent返回的是false(在事件的边界范围内时,默认返回false)，Activity的dispatchTouchEvent执行结束.</p>
<h2 id="ViewGroup的事件分发机制"><a href="#ViewGroup的事件分发机制" class="headerlink" title="ViewGroup的事件分发机制"></a>ViewGroup的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line">  * 源码分析：ViewGroup.dispatchTouchEvent（）</span><br><span class="line">  *&#x2F; </span><br><span class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123; </span><br><span class="line"></span><br><span class="line">    ... &#x2F;&#x2F; 仅贴出关键代码</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析1：ViewGroup每次事件分发时，都需调用onInterceptTouchEvent()询问是否拦截事件</span><br><span class="line">            if (disallowIntercept || !onInterceptTouchEvent(ev)) &#123;  </span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 判断值1：disallowIntercept &#x3D; 是否禁用事件拦截的功能(默认是false)，可通过调用requestDisallowInterceptTouchEvent（）修改</span><br><span class="line">            &#x2F;&#x2F; 判断值2： !onInterceptTouchEvent(ev) &#x3D; 对onInterceptTouchEvent()返回值取反</span><br><span class="line">                    &#x2F;&#x2F; a. 若在onInterceptTouchEvent()中返回false（即不拦截事件），就会让第二个值为true，从而进入到条件判断的内部</span><br><span class="line">                    &#x2F;&#x2F; b. 若在onInterceptTouchEvent()中返回true（即拦截事件），就会让第二个值为false，从而跳出了这个条件判断</span><br><span class="line">                    &#x2F;&#x2F; c. 关于onInterceptTouchEvent() -&gt;&gt;分析1</span><br><span class="line"></span><br><span class="line">                ev.setAction(MotionEvent.ACTION_DOWN);  </span><br><span class="line">                final int scrolledXInt &#x3D; (int) scrolledXFloat;  </span><br><span class="line">                final int scrolledYInt &#x3D; (int) scrolledYFloat;  </span><br><span class="line">                final View[] children &#x3D; mChildren;  </span><br><span class="line">                final int count &#x3D; mChildrenCount;  </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析2</span><br><span class="line">            &#x2F;&#x2F; 通过for循环，遍历了当前ViewGroup下的所有子View</span><br><span class="line">            for (int i &#x3D; count - 1; i &gt;&#x3D; 0; i--) &#123;  </span><br><span class="line">                final View child &#x3D; children[i];  </span><br><span class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) &#x3D;&#x3D; VISIBLE  </span><br><span class="line">                        || child.getAnimation() !&#x3D; null) &#123;  </span><br><span class="line">                    child.getHitRect(frame);  </span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; 判断当前遍历的View是不是正在点击的View，从而找到当前被点击的View</span><br><span class="line">                    &#x2F;&#x2F; 若是，则进入条件判断内部</span><br><span class="line">                    if (frame.contains(scrolledXInt, scrolledYInt)) &#123;  </span><br><span class="line">                        final float xc &#x3D; scrolledXFloat - child.mLeft;  </span><br><span class="line">                        final float yc &#x3D; scrolledYFloat - child.mTop;  </span><br><span class="line">                        ev.setLocation(xc, yc);  </span><br><span class="line">                        child.mPrivateFlags &amp;&#x3D; ~CANCEL_NEXT_UP_EVENT;  </span><br><span class="line"></span><br><span class="line">                        &#x2F;&#x2F; 条件判断的内部调用了该View的dispatchTouchEvent()</span><br><span class="line">                        &#x2F;&#x2F; 即 实现了点击事件从ViewGroup到子View的传递（具体请看下面的View事件分发机制）</span><br><span class="line">                        if (child.dispatchTouchEvent(ev))  &#123; </span><br><span class="line"></span><br><span class="line">                        mMotionTarget &#x3D; child;  </span><br><span class="line">                        return true; </span><br><span class="line">                        &#x2F;&#x2F; 调用子View的dispatchTouchEvent后是有返回值的</span><br><span class="line">                        &#x2F;&#x2F; 若该控件可点击，那么点击时，dispatchTouchEvent的返回值必定是true，因此会导致条件判断成立</span><br><span class="line">                        &#x2F;&#x2F; 于是给ViewGroup的dispatchTouchEvent（）直接返回了true，即直接跳出</span><br><span class="line">                        &#x2F;&#x2F; 即把ViewGroup的点击事件拦截掉</span><br><span class="line"></span><br><span class="line">                                &#125;  </span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            boolean isUpOrCancel &#x3D; (action &#x3D;&#x3D; MotionEvent.ACTION_UP) ||  </span><br><span class="line">                    (action &#x3D;&#x3D; MotionEvent.ACTION_CANCEL);  </span><br><span class="line">            if (isUpOrCancel) &#123;  </span><br><span class="line">                mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;  </span><br><span class="line">            &#125;  </span><br><span class="line">            final View target &#x3D; mMotionTarget;  </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析3</span><br><span class="line">        &#x2F;&#x2F; 若点击的是空白处（即无任何View接收事件） &#x2F; 拦截事件（手动复写onInterceptTouchEvent（），从而让其返回true）</span><br><span class="line">        if (target &#x3D;&#x3D; null) &#123;  </span><br><span class="line">            ev.setLocation(xf, yf);  </span><br><span class="line">            if ((mPrivateFlags &amp; CANCEL_NEXT_UP_EVENT) !&#x3D; 0) &#123;  </span><br><span class="line">                ev.setAction(MotionEvent.ACTION_CANCEL);  </span><br><span class="line">                mPrivateFlags &amp;&#x3D; ~CANCEL_NEXT_UP_EVENT;  </span><br><span class="line">            &#125;  </span><br><span class="line">            </span><br><span class="line">            return super.dispatchTouchEvent(ev);</span><br><span class="line">            &#x2F;&#x2F; 调用ViewGroup父类的dispatchTouchEvent()，即View.dispatchTouchEvent()</span><br><span class="line">            &#x2F;&#x2F; 因此会执行ViewGroup的onTouch() -&gt;&gt; onTouchEvent() -&gt;&gt; performClick（） -&gt;&gt; onClick()，即自己处理该事件，事件不会往下传递（具体请参考View事件的分发机制中的View.dispatchTouchEvent（））</span><br><span class="line">            &#x2F;&#x2F; 此处需与上面区别：子View的dispatchTouchEvent（）</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        ... </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**</span><br><span class="line">  * 分析1：ViewGroup.onInterceptTouchEvent()</span><br><span class="line">  * 作用：是否拦截事件</span><br><span class="line">  * 说明：</span><br><span class="line">  *     a. 返回true &#x3D; 拦截，即事件停止往下传递（需手动设置，即复写onInterceptTouchEvent（），从而让其返回true）</span><br><span class="line">  *     b. 返回false &#x3D; 不拦截（默认）</span><br><span class="line">  *&#x2F;</span><br><span class="line">  public boolean onInterceptTouchEvent(MotionEvent ev) &#123;  </span><br><span class="line">    </span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line">  &#x2F;&#x2F; 回到调用原处</span><br></pre></td></tr></table></figure>
<p>ViewGroup每次分发事件时都会调用intercepted询问是否需要拦截事件。对intercepted中的值进行取反。<br>如果intercepted=false就会到ViewGroup中的逻辑，进入newTouchTarget == null &amp;&amp; childrenCount != 0循环遍历找到当前被点击的View。如是进入条件判断的内部，然后调用该View的dispatchTouchEvent如果子View处理了点击事件则返回true直接跳出当前逻辑，否则执行super.dispatchTouchEvent(ev)。接着就会执行View中的onTouch—&gt;onTouchEvent—&gt;performClick。因此ViewGroup中的onTouchEvnet就执行自己处理此事件。</p>
<h2 id="View的事件分发机制"><a href="#View的事件分发机制" class="headerlink" title="View的事件分发机制"></a>View的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">  * Pass the touch screen motion event down to the target view, or this</span><br><span class="line">  * view if it is the target.</span><br><span class="line">  *</span><br><span class="line">  * @param event The motion event to be dispatched.</span><br><span class="line">  * @return True if the event was handled by the view, false otherwise.</span><br><span class="line">  *&#x2F;</span><br><span class="line"> public boolean dispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">     &#x2F;&#x2F; If the event should be handled by accessibility focus first.</span><br><span class="line">     if (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">         if ((mViewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line">         &#x2F;&#x2F;noinspection SimplifiableIfStatement</span><br><span class="line">         ListenerInfo li &#x3D; mListenerInfo;</span><br><span class="line">         if (li !&#x3D; null &amp;&amp; li.mOnTouchListener !&#x3D; null</span><br><span class="line">                 &amp;&amp; (mViewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; ENABLED</span><br><span class="line">                 &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>当li就是onTouchListener为空时或者onTouchListener.onTouch=false就会执行onTouchEvent方法,否则直接返回true.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Implement this method to handle touch screen motion events.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * If this method is used to detect click actions, it is recommended that</span><br><span class="line"> * the actions be performed by implementing and calling</span><br><span class="line"> * &#123;@link #performClick()&#125;. This will ensure consistent system behavior,</span><br><span class="line"> * including:</span><br><span class="line"> * &lt;ul&gt;</span><br><span class="line"> * &lt;li&gt;obeying click sound preferences</span><br><span class="line"> * &lt;li&gt;dispatching OnClickListener calls</span><br><span class="line"> * &lt;li&gt;handling &#123;@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</span><br><span class="line"> * accessibility features are enabled</span><br><span class="line"> * &lt;&#x2F;ul&gt;</span><br><span class="line"> *</span><br><span class="line"> * @param event The motion event.</span><br><span class="line"> * @return True if the event was handled, false otherwise.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">    final float x &#x3D; event.getX();</span><br><span class="line">    final float y &#x3D; event.getY();</span><br><span class="line">    final int viewFlags &#x3D; mViewFlags;</span><br><span class="line">    final int action &#x3D; event.getAction();</span><br><span class="line"></span><br><span class="line">    final boolean clickable &#x3D; ((viewFlags &amp; CLICKABLE) &#x3D;&#x3D; CLICKABLE</span><br><span class="line">            || (viewFlags &amp; LONG_CLICKABLE) &#x3D;&#x3D; LONG_CLICKABLE)</span><br><span class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) &#x3D;&#x3D; CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">    if ((viewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; DISABLED) &#123;</span><br><span class="line">        if (action &#x3D;&#x3D; MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0) &#123;</span><br><span class="line">            setPressed(false);</span><br><span class="line">        &#125;</span><br><span class="line">        mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">        &#x2F;&#x2F; A disabled view that is clickable still consumes the touch</span><br><span class="line">        &#x2F;&#x2F; events, it just doesn&#39;t respond to them.</span><br><span class="line">        return clickable;</span><br><span class="line">    &#125;</span><br><span class="line">    if (mTouchDelegate !&#x3D; null) &#123;</span><br><span class="line">        if (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (clickable || (viewFlags &amp; TOOLTIP) &#x3D;&#x3D; TOOLTIP) &#123;</span><br><span class="line">        switch (action) &#123;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                if ((viewFlags &amp; TOOLTIP) &#x3D;&#x3D; TOOLTIP) &#123;</span><br><span class="line">                    handleTooltipUp();</span><br><span class="line">                &#125;</span><br><span class="line">                if (!clickable) &#123;</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    mInContextButtonPress &#x3D; false;</span><br><span class="line">                    mHasPerformedLongPress &#x3D; false;</span><br><span class="line">                    mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                boolean prepressed &#x3D; (mPrivateFlags &amp; PFLAG_PREPRESSED) !&#x3D; 0;</span><br><span class="line">                if ((mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0 || prepressed) &#123;</span><br><span class="line">                    &#x2F;&#x2F; take focus if we don&#39;t have it already and we should in</span><br><span class="line">                    &#x2F;&#x2F; touch mode.</span><br><span class="line">                    boolean focusTaken &#x3D; false;</span><br><span class="line">                    if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                        focusTaken &#x3D; requestFocus();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (prepressed) &#123;</span><br><span class="line">                        &#x2F;&#x2F; The button is being released before we actually</span><br><span class="line">                        &#x2F;&#x2F; showed it as pressed.  Make it show the pressed</span><br><span class="line">                        &#x2F;&#x2F; state now (before scheduling the click) to ensure</span><br><span class="line">                        &#x2F;&#x2F; the user sees it.</span><br><span class="line">                        setPressed(true, x, y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                        &#x2F;&#x2F; This is a tap, so remove the longpress check</span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                        &#x2F;&#x2F; Only perform take click actions if we were in the pressed state</span><br><span class="line">                        if (!focusTaken) &#123;</span><br><span class="line">                            &#x2F;&#x2F; Use a Runnable and post this rather than calling</span><br><span class="line">                            &#x2F;&#x2F; performClick directly. This lets other visual state</span><br><span class="line">                            &#x2F;&#x2F; of the view update before click actions start.</span><br><span class="line">                            if (mPerformClick &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                mPerformClick &#x3D; new PerformClick();</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (!post(mPerformClick)) &#123;</span><br><span class="line">                                performClickInternal();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (mUnsetPressedState &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mUnsetPressedState &#x3D; new UnsetPressedState();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (prepressed) &#123;</span><br><span class="line">                        postDelayed(mUnsetPressedState,</span><br><span class="line">                                ViewConfiguration.getPressedStateDuration());</span><br><span class="line">                    &#125; else if (!post(mUnsetPressedState)) &#123;</span><br><span class="line">                        &#x2F;&#x2F; If the post failed, unpress right now</span><br><span class="line">                        mUnsetPressedState.run();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                &#125;</span><br><span class="line">                mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                if (event.getSource() &#x3D;&#x3D; InputDevice.SOURCE_TOUCHSCREEN) &#123;</span><br><span class="line">                    mPrivateFlags3 |&#x3D; PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                mHasPerformedLongPress &#x3D; false;</span><br><span class="line"></span><br><span class="line">                if (!clickable) &#123;</span><br><span class="line">                    checkForLongClick(0, x, y);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Walk up the hierarchy to determine if we&#39;re inside a scrolling container.</span><br><span class="line">                boolean isInScrollingContainer &#x3D; isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; For views inside a scrolling container, delay the pressed feedback for</span><br><span class="line">                &#x2F;&#x2F; a short period in case this is a scroll.</span><br><span class="line">                if (isInScrollingContainer) &#123;</span><br><span class="line">                    mPrivateFlags |&#x3D; PFLAG_PREPRESSED;</span><br><span class="line">                    if (mPendingCheckForTap &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mPendingCheckForTap &#x3D; new CheckForTap();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPendingCheckForTap.x &#x3D; event.getX();</span><br><span class="line">                    mPendingCheckForTap.y &#x3D; event.getY();</span><br><span class="line">                    postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Not inside a scrolling container, so show the feedback right away</span><br><span class="line">                    setPressed(true, x, y);</span><br><span class="line">                    checkForLongClick(0, x, y);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_CANCEL:</span><br><span class="line">                if (clickable) &#123;</span><br><span class="line">                    setPressed(false);</span><br><span class="line">                &#125;</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                mInContextButtonPress &#x3D; false;</span><br><span class="line">                mHasPerformedLongPress &#x3D; false;</span><br><span class="line">                mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                if (clickable) &#123;</span><br><span class="line">                    drawableHotspotChanged(x, y);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Be lenient about moving outside of buttons</span><br><span class="line">                if (!pointInView(x, y, mTouchSlop)) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Outside button</span><br><span class="line">                    &#x2F;&#x2F; Remove any future long press&#x2F;tap checks</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    if ((mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0) &#123;</span><br><span class="line">                        setPressed(false);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果控件可以点击clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP则进入switch判断如果当前事件的action=MotionEvent.ACTION_UP就会执行performClick。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean performClick() &#123;  </span><br><span class="line">       if (mOnClickListener !&#x3D; null) &#123;  </span><br><span class="line">           playSoundEffect(SoundEffectConstants.CLICK);  </span><br><span class="line">           mOnClickListener.onClick(this);  </span><br><span class="line">           return true;  </span><br><span class="line">           &#x2F;&#x2F; 只要我们通过setOnClickListener（）为控件View注册1个点击事件</span><br><span class="line">           &#x2F;&#x2F; 那么就会给mOnClickListener变量赋值（即不为空）</span><br><span class="line">           &#x2F;&#x2F; 则会往下回调onClick（） &amp; performClick（）返回true</span><br><span class="line">       &#125;  </span><br><span class="line">       return false;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>最终如果控件可点击返回true，否则返回false。</p>
<h2 id="requestDisallowInterceptTouchEvent的用法"><a href="#requestDisallowInterceptTouchEvent的用法" class="headerlink" title="requestDisallowInterceptTouchEvent的用法"></a>requestDisallowInterceptTouchEvent的用法</h2><p>先上代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Called when a child does not want this parent and its ancestors to</span><br><span class="line">   * intercept touch events with</span><br><span class="line">   * &#123;@link ViewGroup#onInterceptTouchEvent(MotionEvent)&#125;.</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt;This parent should pass this call onto its parents. This parent must obey</span><br><span class="line">   * this request for the duration of the touch (that is, only clear the flag</span><br><span class="line">   * after this parent has received an up or a cancel.&lt;&#x2F;p&gt;</span><br><span class="line">   * </span><br><span class="line">   * @param disallowIntercept True if the child does not want the parent to</span><br><span class="line">   *            intercept touch events.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public void requestDisallowInterceptTouchEvent(boolean disallowIntercept);</span><br></pre></td></tr></table></figure>
<p>从上面的英文注释我们知道当requestDisallowInterceptTouchEvent返回true表示子view不想父view拦截事件;当requestDisallowInterceptTouchEvent返回false则表示父view想自己处理当前事件(其实就相当于控制了父view是否会执行自己的onInterceptTouchEvent拦截事件方法).<br>requestDisallowInterceptTouchEvent可以用作处理滑动冲突的内部拦截法的一种方式。</p>
<ul>
<li>在内部拦截法中为什么需要在ACTION_DOWN中设置requestDisallowInterceptTouchEvent(true)?</li>
</ul>
<p>requestDisallowInterceptTouchEvent在ViewGroup中的具体实现:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) &#123;</span><br><span class="line"></span><br><span class="line">    if (disallowIntercept &#x3D;&#x3D; ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0)) &#123;</span><br><span class="line">        &#x2F;&#x2F; We&#39;re already in this state, assume our ancestors are too</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (disallowIntercept) &#123;</span><br><span class="line">        mGroupFlags |&#x3D; FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Pass it up to our parent</span><br><span class="line">    if (mParent !&#x3D; null) &#123;</span><br><span class="line">        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当disallowIntercept传入true或者false时都是对mGroupFlags产生影响.当事件发生时最先接收到的是父view中的dispatchTouchEvent。</p>
<figure class="highlight plain"><figcaption><span>Handle an initial down.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">if (actionMasked &#x3D;&#x3D; MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">    &#x2F;&#x2F; Throw away all previous state when starting a new touch gesture.</span><br><span class="line">    &#x2F;&#x2F; The framework may have dropped the up or cancel event for the previous gesture</span><br><span class="line">    &#x2F;&#x2F; due to an app switch, ANR, or some other state change.</span><br><span class="line">    cancelAndClearTouchTargets(ev);</span><br><span class="line">    resetTouchState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Check for interception.</span><br><span class="line">final boolean intercepted;</span><br><span class="line">if (actionMasked &#x3D;&#x3D; MotionEvent.ACTION_DOWN</span><br><span class="line">        || mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">    final boolean disallowIntercept &#x3D; (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0;</span><br><span class="line">    if (!disallowIntercept) &#123;</span><br><span class="line">        intercepted &#x3D; onInterceptTouchEvent(ev);</span><br><span class="line">        ev.setAction(action); &#x2F;&#x2F; restore action in case it was changed</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        intercepted &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; There are no touch targets and this action is not an initial down</span><br><span class="line">    &#x2F;&#x2F; so this view group continues to intercept touches.</span><br><span class="line">    intercepted &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里接收到的第一个事件就是MotionEvent.ACTION_DOWN事件,在这里做了两个判断执行一个是cancelAndClearTouchTargets和resetTouchState,另一个就是actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null。<br>首先看第一个判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Cancels and clears all touch targets.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void cancelAndClearTouchTargets(MotionEvent event) &#123;</span><br><span class="line">       if (mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">       ...</span><br><span class="line">       clearTouchTargets();</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">    &#x2F;**</span><br><span class="line">    * Clears all touch targets.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void clearTouchTargets() &#123;</span><br><span class="line">       ...</span><br><span class="line">       mFirstTouchTarget &#x3D; null;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是将mFirstTouchTarget设置为null；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Resets all touch state in preparation for a new cycle.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void resetTouchState() &#123;</span><br><span class="line">       clearTouchTargets();</span><br><span class="line">       resetCancelNextUpFlag(this);</span><br><span class="line">       mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">       mNestedScrollAxes &#x3D; SCROLL_AXIS_NONE;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>同时将mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;中的数值取反重置.这里也就是最重要的为什么我们需要在子view中的ACTION_DOWN中首先设置requestDisallowInterceptTouchEvent(true)的原因.如果我们不设置这句代码当程序执行到第二个ACTION_DOWN时就进入了if判断中:</p>
<figure class="highlight plain"><figcaption><span>(actionMasked </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">        || mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">    final boolean disallowIntercept &#x3D; (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0;</span><br><span class="line">    if (!disallowIntercept) &#123;</span><br><span class="line">        intercepted &#x3D; onInterceptTouchEvent(ev);</span><br><span class="line">        ev.setAction(action); &#x2F;&#x2F; restore action in case it was changed</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        intercepted &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; There are no touch targets and this action is not an initial down</span><br><span class="line">    &#x2F;&#x2F; so this view group continues to intercept touches.</span><br><span class="line">    intercepted &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候因为mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT之前被重置了所以disallowIntercept=false这个时候就会执行intercepted = onInterceptTouchEvent(ev)这条方法如果父view拦截了那么后续的ACTION_MOVE和ACTION_UP就都不会被子view接收到。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/" data-id="ck8tr9s75001dn29k41wl27ho" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-05-Android Fragment基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-09-04T16:00:00.000Z" itemprop="datePublished">2019-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/">Android Fragment基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android Fragment中文翻译为片段。从字面意思可以知道这个就是应用中的一个UI片段，它有自己的生命周期和创建方式。Fragment的出现最初主要是为了实现在大屏幕上 例如：平板的显示提供更加灵活的支持。<br><strong>Fragment必须要基于Activity出现，它不能单独实现自己所以它的生命周期受宿主Activity的影响,当Activity暂停时Fragment也会暂停，当Activity被销毁时Fragment也会被销毁</strong></p>
<h2 id="创建Fragment"><a href="#创建Fragment" class="headerlink" title="创建Fragment"></a>创建Fragment</h2><p>Fragment的创建可以通过两种方式创建一种是在Activity的xml布局文件中编写xml代码，另外一种方式就是通过代码的方式创建.</p>
<ul>
<li>通过xml布局的方式创建Fragment：<br>1.首先创建Fragment的实现类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MyFragment extends Fragment &#123;</span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.my_fragment, container, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在onCreateView中调用了inflater的inflate方法里面有三个参数，第一个是当前Fragment的布局文件，第二个是一个viewGroup，这里的ViewGroup就是与它关联的Activity，而第三个参数是一个boolean值，设置的是一个false.它的意思是当前布局不与container关联，因为我们在事务transaction中会调用add方法进行关联,如果这里设置为true那么就会关联两次就会有两个重复的布局抛出异常:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalStateException: The specified child already has a parent. You must call removeView() on the child&#39;s parent first.</span><br></pre></td></tr></table></figure>

<p>2.然后在Activity的xml布局中引用这个MyFragment:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout</span><br><span class="line">    android:id&#x3D;&quot;@+id&#x2F;add_fragment&quot;</span><br><span class="line">    android:layout_width&#x3D;&quot;match_parent&quot;</span><br><span class="line">    android:layout_height&#x3D;&quot;match_parent&quot;</span><br><span class="line">    android:orientation&#x3D;&quot;vertical&quot;&gt;</span><br><span class="line">    &lt;fragment</span><br><span class="line">        android:layout_width&#x3D;&quot;match_parent&quot;</span><br><span class="line">        android:layout_height&#x3D;&quot;match_parent&quot;</span><br><span class="line">        android:name&#x3D;&quot;com.example.myapplication.MyFragment&quot;</span><br><span class="line">        &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>然后运行程序，这个Fragment就加载到Activity中了.</p>
<ul>
<li>通过代码的方式添加Fragment:</li>
</ul>
<p>1.首先需要创建一个Fragment的类:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MyFragment extends Fragment &#123;</span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.my_fragment, container, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.然后在Activity中创建一个transaction事务，然后再创建Fragment对象，最后通过add的方式将这个Fragment提交.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">transaction &#x3D; getSupportFragmentManager().beginTransaction();</span><br><span class="line">        if (myFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">            myFragment &#x3D; new MyFragment();</span><br><span class="line">            transaction.add(R.id.add_fragment, myFragment).commit();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>在transaction中看到需要两个参数，第一个参数就是一个id而这个id就是在Activity的xml布局文件中指定的id，第二个参数就是Fragment对象，这个的意思就是将这个Fragment的对象添加到我们指定的id布局中，最后要commit提交这样一个Fragment才正式被添加到了Activity中.</p>
<h2 id="Fragment与Activity之间的通讯"><a href="#Fragment与Activity之间的通讯" class="headerlink" title="Fragment与Activity之间的通讯"></a>Fragment与Activity之间的通讯</h2><ul>
<li>Activity与Fragment通讯:</li>
</ul>
<p>1.Fragment中有一个onAttach方法：、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onAttach(Context context) &#123;</span><br><span class="line">    super.onAttach(context);</span><br><span class="line">    context &#x3D; (MainActivity) context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们可以将context强制转换成MainActivity,然后就可以调用我们在Activiy中定义的方法了.<br>2.通过Bundle方式<br>当我们在Activity创建Fragment对象后可以通过调用Bundle传递数据(Bundle只能put基本数据类型或序列化数据)到Fragment中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (myFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">           myFragment &#x3D; new MyFragment();</span><br><span class="line">           Bundle bundle &#x3D; new Bundle();</span><br><span class="line">           bundle.putString(&quot;key&quot;,&quot;value&quot;);</span><br><span class="line">           myFragment.setArguments(bundle);</span><br><span class="line">           transaction.add(R.id.add_fragment, myFragment).commit();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>这样就将一个数据发送给了Fragment.</p>
<ul>
<li>Fragment与Activity通讯：<br>在Fragment中编写一个接口,然后对外提供一个方法。在Activity中调用这个方法实现这个接口.</li>
</ul>
<h2 id="Fragment的生命周期"><a href="#Fragment的生命周期" class="headerlink" title="Fragment的生命周期"></a>Fragment的生命周期</h2><p>1.onAttach:Fragment和Activity关联时会被调用,在这个方法中我们可以获取Activity的引用，通过getArgument方法获取Activity传过来的数据.</p>
<p>2.onCreate:Fragment被创建时调用.</p>
<p>3.onCreateView:创建Fragment的布局</p>
<p>4.onActivityCreated:当Activity完成onCreate时调用</p>
<p>5.onStart：当Fragment可见时调用</p>
<p>6.onResume:当Fragment可见并且可交互时调用</p>
<p>7.onPause:当Fragment可见但不可交互时调用</p>
<p>8.onStop：当Fragment不可见时调用</p>
<p>9.onDestoryView：当Fragment的UI从视图结构中移除时调用</p>
<p>10.onDestory:销毁Fragment时调用</p>
<p>11.onDetach:当Fragment和Activity解除关联时调用</p>
<p>上述方法中除了onCreateView不需要super方法外，其他方法都需要</p>
<h2 id="Fragment回退栈BackStack"><a href="#Fragment回退栈BackStack" class="headerlink" title="Fragment回退栈BackStack"></a>Fragment回退栈BackStack</h2><p>Fragment有自己的回退栈，给一个Fragment添加回退栈则可以掉用：addToBackStack(“”).<br>如果加入了回退栈当用户点击返回按键时会回滚Fragment事务，如果没有加入回退栈按返回键则直接将Activity出栈。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transaction.add(R.id.add_fragment, myFragment).addToBackStack(&quot;myfragment&quot;).commit();</span><br></pre></td></tr></table></figure>
<p>addToBackStack:将Fragment添加到回退栈中.<br>popBackstack:清除栈顶中的Fragment<br>popBackStack(String tag,int i): 如果i=0,回退到该tag所对应的Fragment层;如果i=FragmentManager.POP_BACK_STACK_INCLUSIVE,回退到该tag所对应的Fragment的上一层<br>popBackStackImmediate:立即清除回退栈中栈顶的Fragment.<br>getBackStackEntryCount:获取回退栈中Fragment的个数.<br>getBackStackEntryAt(int index):获取回退栈中该索引值下的Fragment.<br><strong>示例：</strong><br>模拟京东的回退栈效果，当点击了其他的Fragment时按返回键退出到第一个Fragment.<br>##Fragment回退栈出现的问题<br>当我们将Fragment加入到回退栈时,这个时候按返回键进行操作回到第一个Fragment然后继续点击其他的Fragment时这个时候当前的Fragment的view会remove掉,f.mContainer.removeView(f.mView).<br>原因:当我们是以add方式入栈的时候，此时Fragment的状态为RESUMED，则moveToState将不进行操作；当我们以replace方式入栈，Fragment的状态为INITIALIZING，此时在moveToState中又会重新将此Fragment创建一次，重新走一遍创建时的生命周期。</p>
<h2 id="DialogFragment"><a href="#DialogFragment" class="headerlink" title="DialogFragment"></a>DialogFragment</h2><p>DialogFragment是专门用于处理对话框逻辑的功能，它与AlertDialog和Dialog的区别就是当用户旋转屏幕了之后AlertDialog和Dialog会销毁掉同时如果有数据输入的话数据也会销毁，而DialogFragment则不会同时也可以很好的管理其生命周期.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot;</span><br><span class="line">    android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">    android:background&#x3D;&quot;@color&#x2F;colorPrimary&quot;</span><br><span class="line">    android:layout_height&#x3D;&quot;wrap_content&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width&#x3D;&quot;300dp&quot;</span><br><span class="line">        android:layout_height&#x3D;&quot;300dp&quot;</span><br><span class="line">        android:layout_centerInParent&#x3D;&quot;true&quot;</span><br><span class="line">        android:text&#x3D;&quot;DialogFragment&quot;</span><br><span class="line">        android:textStyle&#x3D;&quot;bold&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;RelativeLayout&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class DialogFragment extends android.support.v4.app.DialogFragment &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.fragment_dialog_view,container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">    public void onClick(View v) &#123;</span><br><span class="line">        DialogFragment dialogFragment &#x3D; new DialogFragment();</span><br><span class="line">        dialogFragment.show(getSupportFragmentManager(),&quot;dialog_fragment&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>有些时候我们在设置DialogFragment固定布局的时候不是想要的效果,这个时候可以通过Fragment的onStart方法设置解决这个问题.具体使用方式如下:<br>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onStart() &#123;</span><br><span class="line">    super.onStart();</span><br><span class="line">    Dialog dialog &#x3D; getDialog();</span><br><span class="line">    if (dialog !&#x3D; null) &#123;</span><br><span class="line">        Window window &#x3D; dialog.getWindow();</span><br><span class="line">        WindowManager.LayoutParams attributes &#x3D; window.getAttributes();</span><br><span class="line">        attributes.width &#x3D; getResources().getDimensionPixelSize(R.dimen.width_400);</span><br><span class="line">        attributes.height &#x3D; getResources().getDimensionPixelSize(R.dimen.height_500);</span><br><span class="line">        window.setAttributes(attributes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##为什么需要在onStart后修改Dialog布局才有效<br>只有dialogFragment执行到onStart之后才会调用mDialog.show()显示弹框，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void onStart() &#123;</span><br><span class="line">       super.onStart();</span><br><span class="line">       if (mDialog !&#x3D; null) &#123;</span><br><span class="line">           mViewDestroyed &#x3D; false;</span><br><span class="line">           mDialog.show();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>接下来看一看dialog.show的源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void show() &#123;</span><br><span class="line">        if (mShowing) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!mCreated) &#123;</span><br><span class="line">            dispatchOnCreate(null);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    mWindowManager.addView(mDecor, l);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中如果dialog还没有创建就执行dispatchOnCreate(null)方法来创建dialog布局</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> void dispatchOnCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        if (!mCreated) &#123;</span><br><span class="line">            mDialog.setContentView(selectContentView());</span><br><span class="line">            mCreated &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;获取相应的布局样式</span><br><span class="line">    private int selectContentView() &#123;</span><br><span class="line">        if (mButtonPanelSideLayout &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return mAlertDialogLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        if (mButtonPanelLayoutHint &#x3D;&#x3D; AlertDialog.LAYOUT_HINT_SIDE) &#123;</span><br><span class="line">            recaiturn mButtonPanelSideLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        return mAlertDialogLayout;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里mDialog会通过selectContentView获取系统布局然后设置到setContentView中，所以在show之前如果我们自定义了dialog的宽高都是无效的，最后还是会在show中被覆盖成系统自带的格式。<br><strong>所以只有在show后面改变布局的属性才会有效</strong></p>
<h2 id="Fragment懒加载"><a href="#Fragment懒加载" class="headerlink" title="Fragment懒加载"></a>Fragment懒加载</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class BaseLazyFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    protected boolean isViewCreated;</span><br><span class="line"></span><br><span class="line">    protected boolean isVisibleToUser;</span><br><span class="line"></span><br><span class="line">    protected boolean isDataInited;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onAttach(Context context) &#123;</span><br><span class="line">        super.onAttach(context);</span><br><span class="line">        Log.e(&quot;Tag&quot;, &quot;------onAttach------&quot; + (isViewCreated));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityCreated(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onActivityCreated(savedInstanceState);</span><br><span class="line">        isViewCreated &#x3D; true;</span><br><span class="line">        prepareFetchData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void prepareFetchData() &#123;</span><br><span class="line">        prepareFetchData(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @param fetchdata</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void prepareFetchData(boolean fetchdata) &#123;</span><br><span class="line">        &#x2F;&#x2F;每次都加载数据</span><br><span class="line">        if (isVisibleToUser &amp;&amp; isViewCreated &amp;&amp; (!isDataInited || fetchdata)) &#123;</span><br><span class="line">            fetchdata();</span><br><span class="line">            isDataInited &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract void fetchdata();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setUserVisibleHint(boolean isVisibleToUser) &#123;</span><br><span class="line">        super.setUserVisibleHint(isVisibleToUser);</span><br><span class="line">        this.isVisibleToUser &#x3D; isVisibleToUser;</span><br><span class="line">        prepareFetchData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fragment中<strong>setUserVisibleHint</strong>方法表示是否显示,当Fragment是否显示或者不显示通过isVisibleToUser表示。<br>当Fragment UI被创建时，同时isVisibleToUser Fragment已经显示，这个时候执行加载数据的操作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/" data-id="ck8tr9s74001bn29k6rjygwri" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-01-16-HandlerThread简单使用和原理分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-09-02T16:00:00.000Z" itemprop="datePublished">2019-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">HandlerThread简单使用和原理分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HandlerThread的简单使用"><a href="#HandlerThread的简单使用" class="headerlink" title="HandlerThread的简单使用"></a>HandlerThread的简单使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stock_data_update &#x3D; new HandlerThread(&quot;stock_data_update&quot;);</span><br><span class="line">    stock_data_update.start();</span><br><span class="line">    stockHandler &#x3D; new Handler(stock_data_update.getLooper()) &#123;</span><br><span class="line">      @Override public void handleMessage(Message msg) &#123;</span><br><span class="line">        super.handleMessage(msg);</span><br><span class="line">        if (msg.what &#x3D;&#x3D; 100) &#123;</span><br><span class="line">          update();</span><br><span class="line">          stockHandler.sendEmptyMessage(100);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">     private void update() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      Thread.sleep(1000);</span><br><span class="line">      mHandler.post(new Runnable() &#123;</span><br><span class="line">        @Override public void run() &#123;</span><br><span class="line">          stockTv.setText(&quot;当前大盘实时数据：&quot; + (Math.random() * 3000 + 1000));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最在任务已经处理完成后要在合适的位置退出掉这个线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stock_data_update.quit();</span><br></pre></td></tr></table></figure>
<h2 id="HandlerThread的源码"><a href="#HandlerThread的源码" class="headerlink" title="HandlerThread的源码"></a>HandlerThread的源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Handy class for starting a new thread that has a looper. The looper can then be </span><br><span class="line"> * used to create handler classes. Note that start() must still be called.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class HandlerThread extends Thread &#123;</span><br><span class="line">    int mPriority;</span><br><span class="line">    int mTid &#x3D; -1;</span><br><span class="line">    Looper mLooper;</span><br><span class="line">    private @Nullable Handler mHandler;</span><br><span class="line"></span><br><span class="line">    public HandlerThread(String name) &#123;</span><br><span class="line">        super(name);</span><br><span class="line">        mPriority &#x3D; Process.THREAD_PRIORITY_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Constructs a HandlerThread.</span><br><span class="line">     * @param name</span><br><span class="line">     * @param priority The priority to run the thread at. The value supplied must be from </span><br><span class="line">     * &#123;@link android.os.Process&#125; and not from java.lang.Thread.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public HandlerThread(String name, int priority) &#123;</span><br><span class="line">        super(name);</span><br><span class="line">        mPriority &#x3D; priority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Call back method that can be explicitly overridden if needed to execute some</span><br><span class="line">     * setup before Looper loops.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected void onLooperPrepared() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        mTid &#x3D; Process.myTid();</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            mLooper &#x3D; Looper.myLooper();</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">        onLooperPrepared();</span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid &#x3D; -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * This method returns the Looper associated with this thread. If this thread not been started</span><br><span class="line">     * or for any reason isAlive() returns false, this method will return null. If this thread</span><br><span class="line">     * has been started, this method will block until the looper has been initialized.  </span><br><span class="line">     * @return The looper.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public Looper getLooper() &#123;</span><br><span class="line">        if (!isAlive()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; If the thread has been started, wait until the looper has been created.</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            while (isAlive() &amp;&amp; mLooper &#x3D;&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mLooper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @return a shared &#123;@link Handler&#125; associated with this thread</span><br><span class="line">     * @hide</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @NonNull</span><br><span class="line">    public Handler getThreadHandler() &#123;</span><br><span class="line">        if (mHandler &#x3D;&#x3D; null) &#123;</span><br><span class="line">            mHandler &#x3D; new Handler(getLooper());</span><br><span class="line">        &#125;</span><br><span class="line">        return mHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Quits the handler thread&#39;s looper.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * Causes the handler thread&#39;s looper to terminate without processing any</span><br><span class="line">     * more messages in the message queue.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</span><br><span class="line">     * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p class&#x3D;&quot;note&quot;&gt;</span><br><span class="line">     * Using this method may be unsafe because some messages may not be delivered</span><br><span class="line">     * before the looper terminates.  Consider using &#123;@link #quitSafely&#125; instead to ensure</span><br><span class="line">     * that all pending work is completed in an orderly manner.</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * @return True if the looper looper has been asked to quit or false if the</span><br><span class="line">     * thread had not yet started running.</span><br><span class="line">     *</span><br><span class="line">     * @see #quitSafely</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean quit() &#123;</span><br><span class="line">        Looper looper &#x3D; getLooper();</span><br><span class="line">        if (looper !&#x3D; null) &#123;</span><br><span class="line">            looper.quit();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Quits the handler thread&#39;s looper safely.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * Causes the handler thread&#39;s looper to terminate as soon as all remaining messages</span><br><span class="line">     * in the message queue that are already due to be delivered have been handled.</span><br><span class="line">     * Pending delayed messages with due times in the future will not be delivered.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</span><br><span class="line">     * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * If the thread has not been started or has finished (that is if</span><br><span class="line">     * &#123;@link #getLooper&#125; returns null), then false is returned.</span><br><span class="line">     * Otherwise the looper is asked to quit and true is returned.</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * @return True if the looper looper has been asked to quit or false if the</span><br><span class="line">     * thread had not yet started running.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean quitSafely() &#123;</span><br><span class="line">        Looper looper &#x3D; getLooper();</span><br><span class="line">        if (looper !&#x3D; null) &#123;</span><br><span class="line">            looper.quitSafely();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Returns the identifier of this thread. See Process.myTid().</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public int getThreadId() &#123;</span><br><span class="line">        return mTid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从源码看出HandlerThread继承了Thread类,所以它是一个线程只不过它的内部用了handler。创建一个HandlerThread对象后需要调用start方法启动它.然后它的run方法就执行了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    mTid &#x3D; Process.myTid();</span><br><span class="line">    Looper.prepare();</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        mLooper &#x3D; Looper.myLooper();</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(mPriority);</span><br><span class="line">    onLooperPrepared();</span><br><span class="line">    Looper.loop();</span><br><span class="line">    mTid &#x3D; -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里通过Looper开启无限循环,同时在onLooperPrepared方法中做一些初始化的工作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Call back method that can be explicitly overridden if needed to execute some</span><br><span class="line">    * setup before Looper loops.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   protected void onLooperPrepared() &#123;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" data-id="ck8tr9s6v000pn29k2ggvgexy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-03-Fragment加载过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-09-02T16:00:00.000Z" itemprop="datePublished">2019-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">Fragment加载过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>将一个布局添加到指定的容器中我们只要在activity中添加这样一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fragmentTransaction.add(R.id.fragment_container, fragment, &quot;fragment&quot;).addToBackStack(fragment.getClass().getName());</span><br></pre></td></tr></table></figure>
<p>这样就将fragment的布局载入到了指定的container布局中。</p>
<p>##源代码分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FragmentTransaction fragmentTransaction &#x3D; supportFragmentManager.beginTransaction();</span><br></pre></td></tr></table></figure>
<p>通过获取fragment事务得到BackStackRecord的对象，fragment的所有add，replce，show，hide等操作都是通过BackStackRecord执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public FragmentTransaction beginTransaction() &#123;</span><br><span class="line">        return new BackStackRecord(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着执行到add方法；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public FragmentTransaction add(int containerViewId, Fragment fragment, String tag) &#123;</span><br><span class="line">    doAddOp(containerViewId, fragment, tag, OP_ADD);</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将容器ID，fragment，以及add的标记传入了doAddOp方法中，同时doAddOp方法写入了一个OP_ADD的标记.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void doAddOp(int containerViewId, Fragment fragment, String tag, int opcmd) &#123; </span><br><span class="line">        fragment.mFragmentManager &#x3D; mManager; </span><br><span class="line">  if (tag !&#x3D; null) &#123; </span><br><span class="line">            if (fragment.mTag !&#x3D; null &amp;&amp; !tag.equals(fragment.mTag)) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Can&#39;t change tag of fragment &quot; </span><br><span class="line">                        + fragment + &quot;: was &quot; + fragment.mTag </span><br><span class="line">                        + &quot; now &quot; + tag); </span><br><span class="line">            &#125; </span><br><span class="line">            fragment.mTag &#x3D; tag; </span><br><span class="line">        &#125; </span><br><span class="line"> if (containerViewId !&#x3D; 0) &#123; </span><br><span class="line">            if (fragment.mFragmentId !&#x3D; 0 &amp;&amp; fragment.mFragmentId !&#x3D; containerViewId) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Can&#39;t change container ID of fragment &quot; </span><br><span class="line">                        + fragment + &quot;: was &quot; + fragment.mFragmentId </span><br><span class="line">                        + &quot; now &quot; + containerViewId); </span><br><span class="line">            &#125; </span><br><span class="line">            fragment.mContainerId &#x3D; fragment.mFragmentId &#x3D; containerViewId; </span><br><span class="line">        &#125; </span><br><span class="line"> Op op &#x3D; new Op(); </span><br><span class="line">        op.cmd &#x3D; opcmd; </span><br><span class="line">        op.fragment &#x3D; fragment; </span><br><span class="line">        addOp(op); </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>设置fragment的tag，容器的id，以及创建一个Op类的对象(Op类内部维护的是一个栈),同时将fragment和OP_ADD赋值给op成员变量。接着执行addOp(op)方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void addOp(Op op) &#123; </span><br><span class="line">        if (mHead &#x3D;&#x3D; null) &#123; </span><br><span class="line">            mHead &#x3D; mTail &#x3D; op; </span><br><span class="line">        &#125; else &#123; </span><br><span class="line">            op.prev &#x3D; mTail; </span><br><span class="line">            mTail.next &#x3D; op; </span><br><span class="line">            mTail &#x3D; op; </span><br><span class="line">        &#125; </span><br><span class="line">        op.enterAnim &#x3D; mEnterAnim; </span><br><span class="line">        op.exitAnim &#x3D; mExitAnim; </span><br><span class="line">        op.popEnterAnim &#x3D; mPopEnterAnim; </span><br><span class="line">        op.popExitAnim &#x3D; mPopExitAnim; </span><br><span class="line">        mNumOp++; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里将设置的动画加入op中。</p>
<p>接下来执行commit方法,commit方法也是在BackStackRecord类中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public int commit() &#123; </span><br><span class="line">        return commitInternal(false); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int commitInternal(boolean allowStateLoss) &#123; </span><br><span class="line">        if (mCommitted) throw new IllegalStateException(&quot;commit already called&quot;); </span><br><span class="line">        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Commit: &quot; + this); </span><br><span class="line">        mCommitted &#x3D; true; </span><br><span class="line">        if (mAddToBackStack) &#123; </span><br><span class="line">            mIndex &#x3D; mManager.allocBackStackIndex(this); </span><br><span class="line">        &#125; else &#123; </span><br><span class="line">            mIndex &#x3D; -1; </span><br><span class="line">        &#125; </span><br><span class="line">        mManager.enqueueAction(this, allowStateLoss); </span><br><span class="line">        return mIndex; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在这个类只如果设置了addToBackStack回退栈方法这里的mAddToBackStack就会被执行到。<br>mManager是FragmentManagerImpl的对象，最终调用了enqueueAction方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void enqueueAction(Runnable action, boolean allowStateLoss) &#123; </span><br><span class="line">        if (!allowStateLoss) &#123; </span><br><span class="line">            checkStateLoss(); </span><br><span class="line">        &#125; </span><br><span class="line">        synchronized (this) &#123; </span><br><span class="line">            if (mActivity &#x3D;&#x3D; null) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Activity has been destroyed&quot;); </span><br><span class="line">            &#125; </span><br><span class="line">            if (mPendingActions &#x3D;&#x3D; null) &#123; </span><br><span class="line">                mPendingActions &#x3D; new ArrayList&lt;Runnable&gt;(); </span><br><span class="line">            &#125; </span><br><span class="line">            mPendingActions.add(action); </span><br><span class="line">            if (mPendingActions.size() &#x3D;&#x3D; 1) &#123; </span><br><span class="line">                mActivity.mHandler.removeCallbacks(mExecCommit); </span><br><span class="line">                mActivity.mHandler.post(mExecCommit); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>其中allowStateLoss为true是不执行checkStateLoss，如果为false就执行checkStateLoss。这对应着我们选择commit(false)还是commitAllowingStateLoss(true).接着是一个同步方法将BackStackRecord方法装入mPendingActions中，最后在主线程中执行了mExecCommit。在mExecCommit的runnable方法中调用了execPendingActions。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public boolean execPendingActions() &#123; </span><br><span class="line">        if (mExecutingActions) &#123; </span><br><span class="line">            throw new IllegalStateException(&quot;Recursive entry to executePendingTransactions&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">        if (Looper.myLooper() !&#x3D; mActivity.mHandler.getLooper()) &#123; </span><br><span class="line">            throw new IllegalStateException(&quot;Must be called from main thread of process&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">  boolean didSomething &#x3D; false;</span><br><span class="line">  while (true) &#123;</span><br><span class="line">            int numActions; </span><br><span class="line">             </span><br><span class="line">            synchronized (this) &#123; </span><br><span class="line">                if (mPendingActions &#x3D;&#x3D; null || mPendingActions.size() &#x3D;&#x3D; 0) &#123; </span><br><span class="line">                    break; </span><br><span class="line">                &#125; </span><br><span class="line">                 </span><br><span class="line">                numActions &#x3D; mPendingActions.size(); </span><br><span class="line">                if (mTmpActions &#x3D;&#x3D; null || mTmpActions.length &lt; numActions) &#123; </span><br><span class="line">                    mTmpActions &#x3D; new Runnable[numActions]; </span><br><span class="line">                &#125; </span><br><span class="line">                mPendingActions.toArray(mTmpActions); </span><br><span class="line">                mPendingActions.clear(); </span><br><span class="line">                mActivity.mHandler.removeCallbacks(mExecCommit); </span><br><span class="line">            &#125; </span><br><span class="line">             </span><br><span class="line">            mExecutingActions &#x3D; true; </span><br><span class="line">            for (int i&#x3D;0; i&lt;numActions; i++) &#123; </span><br><span class="line">                mTmpActions[i].run(); </span><br><span class="line">                mTmpActions[i] &#x3D; null; </span><br><span class="line">            &#125; </span><br><span class="line">            mExecutingActions &#x3D; false; </span><br><span class="line">            didSomething &#x3D; true; </span><br><span class="line">        &#125; </span><br><span class="line"> if (mHavePendingDeferredStart) &#123;</span><br><span class="line">            boolean loadersRunning &#x3D; false; </span><br><span class="line">            for (int i&#x3D;0; i&lt;mActive.size(); i++) &#123; </span><br><span class="line">                Fragment f &#x3D; mActive.get(i); </span><br><span class="line">                if (f !&#x3D; null &amp;&amp; f.mLoaderManager !&#x3D; null) &#123; </span><br><span class="line">                    loadersRunning |&#x3D; f.mLoaderManager.hasRunningLoaders(); </span><br><span class="line">                &#125; </span><br><span class="line">            &#125; </span><br><span class="line">            if (!loadersRunning) &#123; </span><br><span class="line">                mHavePendingDeferredStart &#x3D; false; </span><br><span class="line">                startPendingDeferredFragments(); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        return didSomething; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个里面用了一个while(true)循环对象对mPendingActions进行操作 mPendingActions中还是一个BackStackRecord对象，然后执行mPendingActions中的run方法，最终还是回到了BackStackRecord类中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Run: &quot; + this);</span><br><span class="line">        if (mAddToBackStack) &#123;</span><br><span class="line">            if (mIndex &lt; 0) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;addToBackStack() called after commit()&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bumpBackStackNesting(1);</span><br><span class="line">        Op op &#x3D; mHead;</span><br><span class="line">        while (op !&#x3D; null) &#123;</span><br><span class="line">            switch (op.cmd) &#123;</span><br><span class="line">                case OP_ADD: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.addFragment(f, false);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_REPLACE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    if (mManager.mAdded !&#x3D; null) &#123;</span><br><span class="line">                        for (int i&#x3D;0; i&lt;mManager.mAdded.size(); i++) &#123;</span><br><span class="line">                            Fragment old &#x3D; mManager.mAdded.get(i);</span><br><span class="line">                            if (FragmentManagerImpl.DEBUG) Log.v(TAG,</span><br><span class="line">                                    &quot;OP_REPLACE: adding&#x3D;&quot; + f + &quot; old&#x3D;&quot; + old);</span><br><span class="line">                            if (f &#x3D;&#x3D; null || old.mContainerId &#x3D;&#x3D; f.mContainerId) &#123;</span><br><span class="line">                                if (old &#x3D;&#x3D; f) &#123;</span><br><span class="line">                                    op.fragment &#x3D; f &#x3D; null;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    if (op.removed &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                        op.removed &#x3D; new ArrayList&lt;Fragment&gt;();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    op.removed.add(old);</span><br><span class="line">                                    old.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                                    if (mAddToBackStack) &#123;</span><br><span class="line">                                        old.mBackStackNesting +&#x3D; 1;</span><br><span class="line">                                        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Bump nesting of &quot;</span><br><span class="line">                                                + old + &quot; to &quot; + old.mBackStackNesting);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    mManager.removeFragment(old, mTransition, mTransitionStyle);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (f !&#x3D; null) &#123;</span><br><span class="line">                        f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                        mManager.addFragment(f, false);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_REMOVE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.removeFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_HIDE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.hideFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_SHOW: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.showFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_DETACH: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.detachFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_ATTACH: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.attachFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                default: &#123;</span><br><span class="line">                    throw new IllegalArgumentException(&quot;Unknown cmd: &quot; + op.cmd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            op &#x3D; op.next;</span><br><span class="line">        &#125;</span><br><span class="line">        mManager.moveToState(mManager.mCurState, mTransition,</span><br><span class="line">                mTransitionStyle, true);</span><br><span class="line">        if (mAddToBackStack) &#123;</span><br><span class="line">            mManager.addBackStackState(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个里面也是一个while(true)的循环判断，最终不断的轮训op类，每个op类的实例都包装了一个Fragment实例，方法内部对不同的实例用switch执行，由于上面的代码中我们用了add来添加一个Fragment，op的cmd标记设置为了OP_ADD因此接下来会执行到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Fragment f &#x3D; op.fragment;</span><br><span class="line">f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">mManager.addFragment(f, false);</span><br></pre></td></tr></table></figure>
<p>这里通过FragmentManager的管理类addFragment，将fragment加入一个叫做mAdded的成员变量中，类型是ArrayList。接着执行FragmentManager的moveToState方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void moveToState(int newState, int transit, int transitStyle, boolean always) &#123;</span><br><span class="line">        if (mActivity &#x3D;&#x3D; null &amp;&amp; newState !&#x3D; Fragment.INITIALIZING) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;No activity&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        if (!always &amp;&amp; mCurState &#x3D;&#x3D; newState) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        mCurState &#x3D; newState;</span><br><span class="line">        if (mActive !&#x3D; null) &#123;</span><br><span class="line">            boolean loadersRunning &#x3D; false;</span><br><span class="line">            for (int i&#x3D;0; i&lt;mActive.size(); i++) &#123;</span><br><span class="line">                Fragment f &#x3D; mActive.get(i);</span><br><span class="line">                if (f !&#x3D; null) &#123;</span><br><span class="line">                    moveToState(f, newState, transit, transitStyle, false);</span><br><span class="line">                    if (f.mLoaderManager !&#x3D; null) &#123;</span><br><span class="line">                        loadersRunning |&#x3D; f.mLoaderManager.hasRunningLoaders();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!loadersRunning) &#123;</span><br><span class="line">                startPendingDeferredFragments();</span><br><span class="line">            &#125;</span><br><span class="line">            if (mNeedMenuInvalidate &amp;&amp; mActivity !&#x3D; null &amp;&amp; mCurState &#x3D;&#x3D; Fragment.RESUMED) &#123;</span><br><span class="line">                mActivity.invalidateOptionsMenu();</span><br><span class="line">                mNeedMenuInvalidate &#x3D; false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在当前方法中通过for循环获取fragment，然后调用5个参数的moveToState。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">void moveToState(Fragment f, int newState, int transit, int transitionStyle,</span><br><span class="line">            boolean keepActive) &#123;</span><br><span class="line">        &#x2F;&#x2F; Fragments that are not currently added will sit in the onCreate() state.</span><br><span class="line">        if ((!f.mAdded || f.mDetached) &amp;&amp; newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">            newState &#x3D; Fragment.CREATED;</span><br><span class="line">        &#125;</span><br><span class="line">        if (f.mRemoving &amp;&amp; newState &gt; f.mState) &#123;</span><br><span class="line">            &#x2F;&#x2F; While removing a fragment, we can&#39;t change it to a higher state.</span><br><span class="line">            newState &#x3D; f.mState;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; Defer start if requested; don&#39;t allow it to move to STARTED or higher</span><br><span class="line">        &#x2F;&#x2F; if it&#39;s not already started.</span><br><span class="line">        if (f.mDeferStart &amp;&amp; f.mState &lt; Fragment.STARTED &amp;&amp; newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">            newState &#x3D; Fragment.STOPPED;</span><br><span class="line">        &#125;</span><br><span class="line">        if (f.mState &lt; newState) &#123;</span><br><span class="line">            &#x2F;&#x2F; For fragments that are created from a layout, when restoring from</span><br><span class="line">            &#x2F;&#x2F; state we don&#39;t want to allow them to be created until they are</span><br><span class="line">            &#x2F;&#x2F; being reloaded from the layout.</span><br><span class="line">            if (f.mFromLayout &amp;&amp; !f.mInLayout) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; The fragment is currently being animated... but! Now we</span><br><span class="line">                &#x2F;&#x2F; want to move our state back up. Give up on waiting for the</span><br><span class="line">                &#x2F;&#x2F; animation, move to whatever the final state should be once</span><br><span class="line">                &#x2F;&#x2F; the animation is done, and then we can proceed from there.</span><br><span class="line">                f.mAnimatingAway &#x3D; null;</span><br><span class="line">                moveToState(f, f.mStateAfterAnimating, 0, 0, true);</span><br><span class="line">            &#125;</span><br><span class="line">            switch (f.mState) &#123;</span><br><span class="line">                case Fragment.INITIALIZING:</span><br><span class="line">                    if (DEBUG) Log.v(TAG, &quot;moveto CREATED: &quot; + f);</span><br><span class="line">                    if (f.mSavedFragmentState !&#x3D; null) &#123;</span><br><span class="line">                        f.mSavedViewState &#x3D; f.mSavedFragmentState.getSparseParcelableArray(</span><br><span class="line">                                FragmentManagerImpl.VIEW_STATE_TAG);</span><br><span class="line">                        f.mTarget &#x3D; getFragment(f.mSavedFragmentState,</span><br><span class="line">                                FragmentManagerImpl.TARGET_STATE_TAG);</span><br><span class="line">                        if (f.mTarget !&#x3D; null) &#123;</span><br><span class="line">                            f.mTargetRequestCode &#x3D; f.mSavedFragmentState.getInt(</span><br><span class="line">                                    FragmentManagerImpl.TARGET_REQUEST_CODE_STATE_TAG, 0);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mUserVisibleHint &#x3D; f.mSavedFragmentState.getBoolean(</span><br><span class="line">                                FragmentManagerImpl.USER_VISIBLE_HINT_TAG, true);</span><br><span class="line">                        if (!f.mUserVisibleHint) &#123;</span><br><span class="line">                            f.mDeferStart &#x3D; true;</span><br><span class="line">                            if (newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">                                newState &#x3D; Fragment.STOPPED;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    f.mActivity &#x3D; mActivity;</span><br><span class="line">                    f.mParentFragment &#x3D; mParent;</span><br><span class="line">                    f.mFragmentManager &#x3D; mParent !&#x3D; null</span><br><span class="line">                            ? mParent.mChildFragmentManager : mActivity.mFragments;</span><br><span class="line">                    f.mCalled &#x3D; false;</span><br><span class="line">                    f.onAttach(mActivity);</span><br><span class="line">                    if (!f.mCalled) &#123;</span><br><span class="line">                        throw new SuperNotCalledException(&quot;Fragment &quot; + f</span><br><span class="line">                                + &quot; did not call through to super.onAttach()&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (f.mParentFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mActivity.onAttachFragment(f);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!f.mRetaining) &#123;</span><br><span class="line">                        f.performCreate(f.mSavedFragmentState);</span><br><span class="line">                    &#125;</span><br><span class="line">                    f.mRetaining &#x3D; false;</span><br><span class="line">                    if (f.mFromLayout) &#123;</span><br><span class="line">                        &#x2F;&#x2F; For fragments that are part of the content view</span><br><span class="line">                        &#x2F;&#x2F; layout, we need to instantiate the view immediately</span><br><span class="line">                        &#x2F;&#x2F; and the inflater will take care of adding it.</span><br><span class="line">                        f.mView &#x3D; f.performCreateView(f.getLayoutInflater(</span><br><span class="line">                                f.mSavedFragmentState), null, f.mSavedFragmentState);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            f.mInnerView &#x3D; f.mView;</span><br><span class="line">                            f.mView &#x3D; NoSaveStateFrameLayout.wrap(f.mView);</span><br><span class="line">                            if (f.mHidden) f.mView.setVisibility(View.GONE);</span><br><span class="line">                            f.onViewCreated(f.mView, f.mSavedFragmentState);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            f.mInnerView &#x3D; null;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.CREATED:</span><br><span class="line">                    if (newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto ACTIVITY_CREATED: &quot; + f);</span><br><span class="line">                        if (!f.mFromLayout) &#123;</span><br><span class="line">                            ViewGroup container &#x3D; null;</span><br><span class="line">                            if (f.mContainerId !&#x3D; 0) &#123;</span><br><span class="line">                                container &#x3D; (ViewGroup)mContainer.findViewById(f.mContainerId);</span><br><span class="line">                                if (container &#x3D;&#x3D; null &amp;&amp; !f.mRestored) &#123;</span><br><span class="line">                                    throwException(new IllegalArgumentException(</span><br><span class="line">                                            &quot;No view found for id 0x&quot;</span><br><span class="line">                                            + Integer.toHexString(f.mContainerId) + &quot; (&quot;</span><br><span class="line">                                            + f.getResources().getResourceName(f.mContainerId)</span><br><span class="line">                                            + &quot;) for fragment &quot; + f));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mContainer &#x3D; container;</span><br><span class="line">                            f.mView &#x3D; f.performCreateView(f.getLayoutInflater(</span><br><span class="line">                                    f.mSavedFragmentState), container, f.mSavedFragmentState);</span><br><span class="line">                            if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                                f.mInnerView &#x3D; f.mView;</span><br><span class="line">                                f.mView &#x3D; NoSaveStateFrameLayout.wrap(f.mView);</span><br><span class="line">                                if (container !&#x3D; null) &#123;</span><br><span class="line">                                    Animation anim &#x3D; loadAnimation(f, transit, true,</span><br><span class="line">                                            transitionStyle);</span><br><span class="line">                                    if (anim !&#x3D; null) &#123;</span><br><span class="line">                                        f.mView.startAnimation(anim);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    container.addView(f.mView);</span><br><span class="line">                                &#125;</span><br><span class="line">                                if (f.mHidden) f.mView.setVisibility(View.GONE);</span><br><span class="line">                                f.onViewCreated(f.mView, f.mSavedFragmentState);</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                f.mInnerView &#x3D; null;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.performActivityCreated(f.mSavedFragmentState);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            f.restoreViewState(f.mSavedFragmentState);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mSavedFragmentState &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.ACTIVITY_CREATED:</span><br><span class="line">                case Fragment.STOPPED:</span><br><span class="line">                    if (newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto STARTED: &quot; + f);</span><br><span class="line">                        f.performStart();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STARTED:</span><br><span class="line">                    if (newState &gt; Fragment.STARTED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto RESUMED: &quot; + f);</span><br><span class="line">                        f.mResumed &#x3D; true;</span><br><span class="line">                        f.performResume();</span><br><span class="line">                        f.mSavedFragmentState &#x3D; null;</span><br><span class="line">                        f.mSavedViewState &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (f.mState &gt; newState) &#123;</span><br><span class="line">            switch (f.mState) &#123;</span><br><span class="line">                case Fragment.RESUMED:</span><br><span class="line">                    if (newState &lt; Fragment.RESUMED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom RESUMED: &quot; + f);</span><br><span class="line">                        f.performPause();</span><br><span class="line">                        f.mResumed &#x3D; false;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STARTED:</span><br><span class="line">                    if (newState &lt; Fragment.STARTED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom STARTED: &quot; + f);</span><br><span class="line">                        f.performStop();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STOPPED:</span><br><span class="line">                    if (newState &lt; Fragment.STOPPED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom STOPPED: &quot; + f);</span><br><span class="line">                        f.performReallyStop();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.ACTIVITY_CREATED:</span><br><span class="line">                    if (newState &lt; Fragment.ACTIVITY_CREATED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom ACTIVITY_CREATED: &quot; + f);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            &#x2F;&#x2F; Need to save the current view state if not</span><br><span class="line">                            &#x2F;&#x2F; done already.</span><br><span class="line">                            if (!mActivity.isFinishing() &amp;&amp; f.mSavedViewState &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                saveFragmentViewState(f);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.performDestroyView();</span><br><span class="line">                        if (f.mView !&#x3D; null &amp;&amp; f.mContainer !&#x3D; null) &#123;</span><br><span class="line">                            Animation anim &#x3D; null;</span><br><span class="line">                            if (mCurState &gt; Fragment.INITIALIZING &amp;&amp; !mDestroyed) &#123;</span><br><span class="line">                                anim &#x3D; loadAnimation(f, transit, false,</span><br><span class="line">                                        transitionStyle);</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (anim !&#x3D; null) &#123;</span><br><span class="line">                                final Fragment fragment &#x3D; f;</span><br><span class="line">                                f.mAnimatingAway &#x3D; f.mView;</span><br><span class="line">                                f.mStateAfterAnimating &#x3D; newState;</span><br><span class="line">                                anim.setAnimationListener(new AnimationListener() &#123;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationEnd(Animation animation) &#123;</span><br><span class="line">                                        if (fragment.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                                            fragment.mAnimatingAway &#x3D; null;</span><br><span class="line">                                            moveToState(fragment, fragment.mStateAfterAnimating,</span><br><span class="line">                                                    0, 0, false);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationRepeat(Animation animation) &#123;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationStart(Animation animation) &#123;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                                f.mView.startAnimation(anim);</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mContainer.removeView(f.mView);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mContainer &#x3D; null;</span><br><span class="line">                        f.mView &#x3D; null;</span><br><span class="line">                        f.mInnerView &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.CREATED:</span><br><span class="line">                    if (newState &lt; Fragment.CREATED) &#123;</span><br><span class="line">                        if (mDestroyed) &#123;</span><br><span class="line">                            if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                                &#x2F;&#x2F; The fragment&#39;s containing activity is</span><br><span class="line">                                &#x2F;&#x2F; being destroyed, but this fragment is</span><br><span class="line">                                &#x2F;&#x2F; currently animating away. Stop the</span><br><span class="line">                                &#x2F;&#x2F; animation right now -- it is not needed,</span><br><span class="line">                                &#x2F;&#x2F; and we can&#39;t wait any more on destroying</span><br><span class="line">                                &#x2F;&#x2F; the fragment.</span><br><span class="line">                                View v &#x3D; f.mAnimatingAway;</span><br><span class="line">                                f.mAnimatingAway &#x3D; null;</span><br><span class="line">                                v.clearAnimation();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                            &#x2F;&#x2F; We are waiting for the fragment&#39;s view to finish</span><br><span class="line">                            &#x2F;&#x2F; animating away. Just make a note of the state</span><br><span class="line">                            &#x2F;&#x2F; the fragment now should move to once the animation</span><br><span class="line">                            &#x2F;&#x2F; is done.</span><br><span class="line">                            f.mStateAfterAnimating &#x3D; newState;</span><br><span class="line">                            newState &#x3D; Fragment.CREATED;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            if (DEBUG) Log.v(TAG, &quot;movefrom CREATED: &quot; + f);</span><br><span class="line">                            if (!f.mRetaining) &#123;</span><br><span class="line">                                f.performDestroy();</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mCalled &#x3D; false;</span><br><span class="line">                            f.onDetach();</span><br><span class="line">                            if (!f.mCalled) &#123;</span><br><span class="line">                                throw new SuperNotCalledException(&quot;Fragment &quot; + f</span><br><span class="line">                                        + &quot; did not call through to super.onDetach()&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (!keepActive) &#123;</span><br><span class="line">                                if (!f.mRetaining) &#123;</span><br><span class="line">                                    makeInactive(f);</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    f.mActivity &#x3D; null;</span><br><span class="line">                                    f.mFragmentManager &#x3D; null;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        f.mState &#x3D; newState;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中会依次执行INITIALIZING，CREATED，ACTIVITY_CREATED代码片段，最终在CREATED语句中通过container.addView(f.mView);加载fragment布局。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="ck8tr9s710012n29k1uj5gopq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-08-28-Java中的自动装箱和拆箱" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/" class="article-date">
  <time datetime="2019-08-27T16:00:00.000Z" itemprop="datePublished">2019-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/">Java中的自动装箱和拆箱</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#为什么要有自动装箱和拆箱</p>
<ol>
<li>将一个数值转换成一个类，可以使这个类有多种可以调用的方法。</li>
<li>基本类型的数据不是对象需要装箱才能和其他Object类型的子类共用同一个接口。</li>
</ol>
<p>#什么是装箱拆箱<br>从JavaSE5就提供了自动装箱的操作，如果生成一个数值为10的Integer对象只要这样操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer value &#x3D; 10;</span><br></pre></td></tr></table></figure>
<p>这个过程就会自动的将10这个int类型的数据转换成Object对象类型.<br>现在如果要将value这个Object类型的数据转换成int类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int n &#x3D; value</span><br></pre></td></tr></table></figure>
<p>这样就将value转换成了int类型，完成了自动拆箱的操作.<br>基本类型包装成Object类型有这些</p>
<ol>
<li>int—&gt;Integer</li>
<li>byte–&gt;Byte</li>
<li>short-&gt;Short</li>
<li>char–&gt;Character</li>
<li>long–&gt;Long</li>
<li>double-&gt;Double</li>
<li>float–&gt;Float</li>
<li>boolean-&gt;Boolean</li>
</ol>
<p>#常见问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Integer i1 &#x3D; 100;</span><br><span class="line">        Integer i2 &#x3D; 100;</span><br><span class="line">        Integer i3 &#x3D; 200;</span><br><span class="line">        Integer i4 &#x3D; 200;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段程序输出怎样的结果?第一段代码输出 true;第二段代码输出 false;这段代码当执行到Integer i1 = 100时,内部执行的是Integer i1 = Integer.valueOf(100).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static Integer valueOf(int i) &#123;</span><br><span class="line">        if (i &gt;&#x3D; IntegerCache.low &amp;&amp; i &lt;&#x3D; IntegerCache.high)</span><br><span class="line">            return IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">        return new Integer(i);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从源代码中可以看出当我们传入的值在IntegerCache.low和IntegerCache.high之间(也就是-127～128)就直接从缓存中返回数据,否则就重新创建一个对象，执行new Integer(i)。<br>因此上面的代码中100在-127～128之间，但是200不在这个区间就会重新创建对象，由于不是同一个对象了所以返回false。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Double i1 &#x3D; 100.0;</span><br><span class="line">        Double i2 &#x3D; 100.0;</span><br><span class="line">        Double i3 &#x3D; 200.0;</span><br><span class="line">        Double i4 &#x3D; 200.0;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码都会输出false。从下面的源码可以看出都会new一个double类型的数据；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Double valueOf(double d) &#123;</span><br><span class="line">        return new Double(d);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Boolean i1 &#x3D; false;</span><br><span class="line">        Boolean i2 &#x3D; false;</span><br><span class="line">        Boolean i3 &#x3D; true;</span><br><span class="line">        Boolean i4 &#x3D; true;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码都会输出true。我们查看一下源代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Boolean valueOf(boolean b) &#123;</span><br><span class="line">        return (b ? TRUE : FALSE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而其中的TRUE和FALSE,他们都是一个静态的常量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * The &#123;@code Boolean&#125; object corresponding to the primitive</span><br><span class="line"> * value &#123;@code true&#125;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static final Boolean TRUE &#x3D; new Boolean(true);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The &#123;@code Boolean&#125; object corresponding to the primitive</span><br><span class="line"> * value &#123;@code false&#125;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static final Boolean FALSE &#x3D; new Boolean(false);</span><br></pre></td></tr></table></figure>

<p>参考文章:<br><a href="https://www.cnblogs.com/dolphin0520/p/3780005.html" target="_blank" rel="noopener">https://www.cnblogs.com/dolphin0520/p/3780005.html</a>;<br><a href="https://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/" target="_blank" rel="noopener">https://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/</a>    </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/" data-id="ck8tr9s720014n29kdsmk557j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-7-17-理解LayoutInflate.inflater的三个参数含义" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/" class="article-date">
  <time datetime="2019-07-16T16:00:00.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/">理解LayoutInflate.inflater的三个参数含义</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有些时候我们可以通过代码来添加一个布局到我们的应用中,这个时候就需要用到LayoutInflate.inflate了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</span><br></pre></td></tr></table></figure>
<ol>
<li>resource:这个参数表示要添加的布局结构；</li>
<li>root:表示要添加的布局结构需要依赖的根布局;</li>
<li>attachToRoot:表示布局是否要添加到根布局。</li>
</ol>
<h2 id="root-null-attachToRoot-true"><a href="#root-null-attachToRoot-true" class="headerlink" title="root != null,attachToRoot = true"></a>root != null,attachToRoot = true</h2><p>当root不为空,attachToRoot为true时表示将resource布局添加到root中,resource的各个节点都是有效的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LinearLayout ll &#x3D; (LinearLayout) findViewById(R.id.ll);</span><br><span class="line">LayoutInflater inflater &#x3D; LayoutInflater.from(this);</span><br><span class="line">View view &#x3D; inflater.inflate(R.layout.linearlayout, ll, true);</span><br></pre></td></tr></table></figure>
<p>如果这个时候我们添加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll.addView(view);</span><br></pre></td></tr></table></figure>
<p>那么这个时候就会报重复添加的错误.</p>
<h2 id="root-null-attachToRoot-false"><a href="#root-null-attachToRoot-false" class="headerlink" title="root != null,attachToRoot = false"></a>root != null,attachToRoot = false</h2><p>当root不为空,attachToRoot为false时表示将resource布局不添加到root中。这种情况表示我们想要resource的各个节点有效但是又不想将这个resource和root关联，这个时候如果需要添加到root中需要手动调用addview。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LinearLayout ll &#x3D; (LinearLayout) findViewById(R.id.ll);</span><br><span class="line">LayoutInflater inflater &#x3D; LayoutInflater.from(this);</span><br><span class="line">View view &#x3D; inflater.inflate(R.layout.linearlayout, ll, true);</span><br><span class="line">ll.addView(view);&#x2F;&#x2F;在这里需要手动添加</span><br></pre></td></tr></table></figure>
<h2 id="root-null-attachToRoot-true-false"><a href="#root-null-attachToRoot-true-false" class="headerlink" title="root = null,attachToRoot = true | false"></a>root = null,attachToRoot = true | false</h2><p>这个时候由于我们的root为空所以我们的resource布局的根节点的宽高就会失效布局样式就不会是我们编写的效果,无论attachToRoot为true还是false.</p>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</span><br></pre></td></tr></table></figure>
<p>这个代码最终都会执行到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">        synchronized (mConstructorArgs) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;inflate&quot;);</span><br><span class="line"></span><br><span class="line">            final Context inflaterContext &#x3D; mContext;</span><br><span class="line">            final AttributeSet attrs &#x3D; Xml.asAttributeSet(parser);</span><br><span class="line">            Context lastContext &#x3D; (Context) mConstructorArgs[0];</span><br><span class="line">            mConstructorArgs[0] &#x3D; inflaterContext;</span><br><span class="line">            View result &#x3D; root;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; Look for the root node.</span><br><span class="line">                int type;</span><br><span class="line">                while ((type &#x3D; parser.next()) !&#x3D; XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">                        type !&#x3D; XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Empty</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (type !&#x3D; XmlPullParser.START_TAG) &#123;</span><br><span class="line">                    throw new InflateException(parser.getPositionDescription()</span><br><span class="line">                            + &quot;: No start tag found!&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                final String name &#x3D; parser.getName();</span><br><span class="line"></span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                    System.out.println(&quot;Creating root view: &quot;</span><br><span class="line">                            + name);</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">                    if (root &#x3D;&#x3D; null || !attachToRoot) &#123;</span><br><span class="line">                        throw new InflateException(&quot;&lt;merge &#x2F;&gt; can be used only with a valid &quot;</span><br><span class="line">                                + &quot;ViewGroup root and attachToRoot&#x3D;true&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;初始化所有的子控件，加载xml内view,并添加到temp中</span><br><span class="line">                    rInflate(parser, root, inflaterContext, attrs, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Temp is the root view that was found in the xml</span><br><span class="line">                    final View temp &#x3D; createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class="line"></span><br><span class="line">                    ViewGroup.LayoutParams params &#x3D; null;</span><br><span class="line"></span><br><span class="line">                    if (root !&#x3D; null) &#123;</span><br><span class="line">                        if (DEBUG) &#123;</span><br><span class="line">                            System.out.println(&quot;Creating params from root: &quot; +</span><br><span class="line">                                    root);</span><br><span class="line">                        &#125;</span><br><span class="line">                        &#x2F;&#x2F; Create layout params that match root, if supplied</span><br><span class="line">                        params &#x3D; root.generateLayoutParams(attrs);&#x2F;&#x2F;1</span><br><span class="line">                        if (!attachToRoot) &#123;&#x2F;&#x2F;3</span><br><span class="line">                            &#x2F;&#x2F; Set the layout params for temp if we are not</span><br><span class="line">                            &#x2F;&#x2F; attaching. (If we are, we use addView, below)</span><br><span class="line">                            temp.setLayoutParams(params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; start inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; Inflate all children under temp against its context.</span><br><span class="line">                    rInflateChildren(parser, temp, attrs, true);</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; done inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; We are supposed to attach all the views we found (int temp)</span><br><span class="line">                    &#x2F;&#x2F; to root. Do that now.</span><br><span class="line">                    if (root !&#x3D; null &amp;&amp; attachToRoot) &#123;&#x2F;&#x2F;2</span><br><span class="line">                        root.addView(temp, params);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; Decide whether to return the root that was passed in or the</span><br><span class="line">                    &#x2F;&#x2F; top view found in xml.</span><br><span class="line">                    if (root &#x3D;&#x3D; null || !attachToRoot) &#123;&#x2F;&#x2F;4</span><br><span class="line">                        result &#x3D; temp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; catch (XmlPullParserException e) &#123;</span><br><span class="line">                final InflateException ie &#x3D; new InflateException(e.getMessage(), e);</span><br><span class="line">                ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">                throw ie;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                final InflateException ie &#x3D; new InflateException(parser.getPositionDescription()</span><br><span class="line">                        + &quot;: &quot; + e.getMessage(), e);</span><br><span class="line">                ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">                throw ie;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                &#x2F;&#x2F; Don&#39;t retain static reference on context.</span><br><span class="line">                mConstructorArgs[0] &#x3D; lastContext;</span><br><span class="line">                mConstructorArgs[1] &#x3D; null;</span><br><span class="line"></span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>当root!=null时我们会先找出根节点的布局参数(1):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params &#x3D; root.generateLayoutParams(attrs);</span><br></pre></td></tr></table></figure>
<p>然后判断当root!=null,attachToRoot=true就会执行(2):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (root !&#x3D; null &amp;&amp; attachToRoot) &#123;&#x2F;&#x2F;2</span><br><span class="line">                        root.addView(temp, params);</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>
<p>所以如果我们在代码中又重复调用addView的话就会报重复添加view的错误.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!attachToRoot) &#123;&#x2F;&#x2F;3</span><br><span class="line">                            &#x2F;&#x2F; Set the layout params for temp if we are not</span><br><span class="line">                            &#x2F;&#x2F; attaching. (If we are, we use addView, below)</span><br><span class="line">                            temp.setLayoutParams(params);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>
<p>如果root!=null同时attachToRoot为false这时候就会将刚刚生成的params设置到temp中.<br>如果指定root=null(4)，那么无论attachToRoot为true或者false都会将temp赋值给result.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/" data-id="ck8tr9s7o002on29k5ss2511n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
          </li>
        
          <li>
            <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
          </li>
        
          <li>
            <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
          </li>
        
          <li>
            <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/page/2/index/" data-id="ckgafe0db00465z9k87s5au78" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-page/3/index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/page/3/index/" class="article-date">
  <time datetime="2020-10-15T03:18:44.739Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/page/3/index/">page/3/index</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/page/3/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-7-10-屏幕适配" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/10/2019-7-10-%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D/" class="article-date">
  <time datetime="2019-07-09T16:00:00.000Z" itemprop="datePublished">2019-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/10/2019-7-10-%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D/">屏幕适配</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="最小宽度适配"><a href="#最小宽度适配" class="headerlink" title="最小宽度适配"></a>最小宽度适配</h1><p>Android中屏幕适配的方式有很多种,其中最小宽度适配是通过获取手机屏幕的最小宽度进行适配。<br>在项目中我们通过获取屏幕的最小宽度dp值给定一个基础数据dp。它的计算是：<br>最小宽度(例如:1080)/(手机的dpi/160) = dp.<br>例如：1080*1920,480dpi.根据上面的公式计算得出的dp=360.所以将屏幕的最小宽度就设置为360dp(一般大部分手机屏幕的最小基本数值为360,这样将宽度就等分成360份).<br>将手机屏幕等分成360份之后,需要在项目中的values文件的dimens.xml文件中设置.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">	&lt;dimen name="dp_1"&gt;1dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_2"&gt;2dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_3"&gt;3dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_4"&gt;4dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_5"&gt;5dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_6"&gt;6dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_7"&gt;7dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_8"&gt;8dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_9"&gt;9dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_10"&gt;10dp&lt;/dimen&gt;</span><br><span class="line">	...</span><br><span class="line">	&lt;dimen name="dp_356"&gt;356dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_357"&gt;357dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_358"&gt;358dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_359"&gt;359dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_360"&gt;360dp&lt;/dimen&gt;</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
<p>这样其他的dp的值就以360作为基础数值计算出适配的大小.<br>360dp是基础数值时，values-sw400dp的计算出来的数值就是:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">	&lt;dimen name="dp_1"&gt;1.1111dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_2"&gt;2.2222dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_3"&gt;3.3333dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_4"&gt;4.4444dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_5"&gt;5.5556dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_6"&gt;6.6667dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_7"&gt;7.7778dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_8"&gt;8.8889dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_9"&gt;10.0000dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_10"&gt;11.1111dp&lt;/dimen&gt;</span><br><span class="line">	...</span><br><span class="line">	&lt;dimen name="dp_355"&gt;394.4444dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_356"&gt;395.5556dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_357"&gt;396.6667dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_358"&gt;397.7778dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_359"&gt;398.8889dp&lt;/dimen&gt;</span><br><span class="line">	&lt;dimen name="dp_360"&gt;400.0000dp&lt;/dimen&gt;</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
<p>这样就可以保证不管在任何手机上运行只要找到其对应的values-sw<N>dp就可以适配了。<br>但是如果我们计算每个values中的dp具体数据就太麻烦了,可以<a href="https://www.jianshu.com/p/1302ad5a4b04" target="_blank" rel="noopener">参考</a>插件一键生成.<br>通过按照最小宽度适配方案可以达到在不同手机上一样的显示效果但是有几个缺点:<br>1.我们需要设置不同的values-sw<N>dp,这样values下面的dimens.xml就会增加(相对于屏幕分辨率适配要少很多)。<br>2.我们是引用@dimen/dp_N,如果以后又要更换适配方案的话需要更换布局文件中大量的dimen值。<br>但是它也有几个优点:<br>1.相对于屏幕分辨率适配,最小宽度适配是找到屏幕的最小宽度如果没有找到就会继续在valuse-sw<N>dp文件中找到相近匹配的。<br>2.最小宽度的dimens文件中使用dp作为基本单位更加灵活.</p>
<h1 id="今日头条适配方案"><a href="#今日头条适配方案" class="headerlink" title="今日头条适配方案"></a>今日头条适配方案</h1><p>单位换算的源代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Converts an unpacked complex data value holding a dimension to its final floating </span></span><br><span class="line"><span class="comment">    * point value. The two parameters &lt;var&gt;unit&lt;/var&gt; and &lt;var&gt;value&lt;/var&gt;</span></span><br><span class="line"><span class="comment">    * are as in &#123;<span class="doctag">@link</span> #TYPE_DIMENSION&#125;.</span></span><br><span class="line"><span class="comment">    *  </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> unit The unit to convert from.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value The value to apply the unit to.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> metrics Current display metrics to use in the conversion -- </span></span><br><span class="line"><span class="comment">    *                supplies display density and scaling information.</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> The complex floating point value multiplied by the appropriate </span></span><br><span class="line"><span class="comment">    * metrics depending on its unit. </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">applyDimension</span><span class="params">(<span class="keyword">int</span> unit, <span class="keyword">float</span> value,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      DisplayMetrics metrics)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">switch</span> (unit) &#123;</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_PX:</span><br><span class="line">           <span class="keyword">return</span> value;</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_DIP:</span><br><span class="line">           <span class="keyword">return</span> value * metrics.density;</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_SP:</span><br><span class="line">           <span class="keyword">return</span> value * metrics.scaledDensity;</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_PT:</span><br><span class="line">           <span class="keyword">return</span> value * metrics.xdpi * (<span class="number">1.0f</span>/<span class="number">72</span>);</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_IN:</span><br><span class="line">           <span class="keyword">return</span> value * metrics.xdpi;</span><br><span class="line">       <span class="keyword">case</span> COMPLEX_UNIT_MM:</span><br><span class="line">           <span class="keyword">return</span> value * metrics.xdpi * (<span class="number">1.0f</span>/<span class="number">25.4f</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过修改系统像素的密度值<strong>density</strong>来达到适配我们设计图的效果。系统中是通过屏幕像素(displayMetrics.widthPixels/displayMetrics.heightPixels)/160=density.这里的160我们完全可以换成设计图的尺寸计算出我们自己的density密度然后将我们自己的密度赋值给displayMetrics.density。<br>如果是字体的适配没有修改的时候密度和density是相同的如果修改了字体的大小那密度就不同了这个时候我们可以监听字体大小是否修改来获取改变后的密度。<br>今日头条代码实例(推荐使用DP作为适配方案):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统的Density</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> sNoncompatDensity;</span><br><span class="line"><span class="comment">// 系统的ScaledDensity</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> sNoncompatScaledDensity;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCustomDensity</span><span class="params">(Activity activity, Application application)</span> </span>&#123;</span><br><span class="line">       DisplayMetrics displayMetrics = application.getResources().getDisplayMetrics();</span><br><span class="line">       <span class="keyword">if</span> (sNoncompatDensity == <span class="number">0</span>) &#123;</span><br><span class="line">           sNoncompatDensity = displayMetrics.density;</span><br><span class="line">           sNoncompatScaledDensity = displayMetrics.scaledDensity;</span><br><span class="line">           <span class="comment">// 监听在系统设置中切换字体</span></span><br><span class="line">           application.registerComponentCallbacks(<span class="keyword">new</span> ComponentCallbacks() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (newConfig != <span class="keyword">null</span> &amp;&amp; newConfig.fontScale &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                       sNoncompatScaledDensity=application.getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 此处以360dp的设计图作为例子</span></span><br><span class="line">       <span class="keyword">float</span> targetDensity=displayMetrics.widthPixels/<span class="number">360</span>;</span><br><span class="line">       <span class="keyword">float</span> targetScaledDensity=targetDensity*(sNoncompatScaledDensity/sNoncompatDensity);</span><br><span class="line">       <span class="keyword">int</span> targetDensityDpi= (<span class="keyword">int</span>) (<span class="number">160</span> * targetDensity);</span><br><span class="line">       displayMetrics.density = targetDensity;</span><br><span class="line">       displayMetrics.scaledDensity = targetScaledDensity;</span><br><span class="line">       displayMetrics.densityDpi = targetDensityDpi;</span><br><span class="line"></span><br><span class="line">       DisplayMetrics activityDisplayMetrics = activity.getResources().getDisplayMetrics();</span><br><span class="line">       activityDisplayMetrics.density = targetDensity;</span><br><span class="line">       activityDisplayMetrics.scaledDensity = targetScaledDensity;</span><br><span class="line">       activityDisplayMetrics.densityDpi = targetDensityDpi;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://www.jianshu.com/p/1eeb0d8d1c86" target="_blank" rel="noopener">https://www.jianshu.com/p/1eeb0d8d1c86</a><br><a href="https://mp.weixin.qq.com/s/d9QCoBP6kV9VSWvVldVVwA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/d9QCoBP6kV9VSWvVldVVwA</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/07/10/2019-7-10-%E5%B1%8F%E5%B9%95%E9%80%82%E9%85%8D/" data-id="ck8tr9s7n002ln29kg8cq0pyc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-5-23-Android多线程编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/23/2019-5-23-Android%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" class="article-date">
  <time datetime="2019-05-22T16:00:00.000Z" itemprop="datePublished">2019-05-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/23/2019-5-23-Android%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/">Android多线程编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.学什么：学习Android中的多线程编程。<br>2.怎么学：《Android进阶之光》，博客。<br>3.学到什么为止:掌握多线程的处理方式和原理(synchronized,volatile,阻塞队列，线程池)能够熟练应对Android多线程业务功能的需求，最终能够写一个简易的多线程下载功能。</p>
<h2 id="线程的多种状态"><a href="#线程的多种状态" class="headerlink" title="线程的多种状态"></a>线程的多种状态</h2><p>1.new:新建状态,该线程处于new thread ~ thread.start()之间.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static class CarThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void run() &#123;</span><br><span class="line">           synchronized (o) &#123;</span><br><span class="line">               System.out.println(&quot;汽车 running&quot;);</span><br><span class="line">               try &#123;</span><br><span class="line">                   o.wait();</span><br><span class="line">                   o.notify();</span><br><span class="line">               &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               System.out.println(&quot;汽车 running end&quot;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   CarThread carThread &#x3D; new CarThread();</span><br><span class="line">   new Thread(carThread).start();</span><br></pre></td></tr></table></figure>
<p>2.runnable:可执行状态,可以让cpu调度执行.<br>3.running:可运行状态,线程获得cpu的使用权<br>4.blocking:阻塞状态,线程由于某种原因放弃了cpu的使用权，处于暂停（sleep,wait,join,yield,同步锁）.</p>
<ul>
<li>sleep：让当前线程休眠一段时间让出cpu的使用权(但并不会释放锁).<br>示例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public static class CarThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">     @Override</span><br><span class="line">     public void run() &#123;</span><br><span class="line">         System.out.println(&quot;汽车 running&quot;);</span><br><span class="line">         try &#123;</span><br><span class="line">             Thread.sleep(1000);</span><br><span class="line">         &#125; catch (InterruptedException e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println(&quot;汽车 running end&quot;);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> public static class AmlsThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">     @Override</span><br><span class="line">     public void run() &#123;</span><br><span class="line">         System.out.println(&quot;amls running&quot;);</span><br><span class="line">         System.out.println(&quot;amls running end&quot;);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> 执行结果：</span><br><span class="line"> 汽车 running</span><br><span class="line"> amls running</span><br><span class="line"> amls running end</span><br><span class="line"> 汽车 running end</span><br></pre></td></tr></table></figure></li>
<li>wait:当前线程让出cpu的使用权但是会释放锁(wait的使用必须在同步代码块或者同步方法中)，只有调用notify或者notifyAll,线程的wait状态才会得到解除.<br>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    public static class CarThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            synchronized (o) &#123;</span><br><span class="line">                System.out.println(&quot;汽车 running&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    o.wait();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(&quot;汽车 running end&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class AmlsThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            synchronized (o) &#123;</span><br><span class="line">                System.out.println(&quot;amls running&quot;);</span><br><span class="line">                o.notify();</span><br><span class="line">                System.out.println(&quot;amls running end&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">执行结果：</span><br><span class="line">汽车 running</span><br><span class="line">amls running</span><br><span class="line">amls running end</span><br><span class="line">汽车 running end</span><br></pre></td></tr></table></figure>
<ul>
<li>join：阻塞当前的线程,直到join的线程超时或者结束.<br>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public static class CarThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;汽车 running&quot;);</span><br><span class="line">            System.out.println(&quot;汽车 running end&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class AmlsThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;amls running&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                thread.join();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;amls running end&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">执行结果：</span><br><span class="line">amls running</span><br><span class="line">汽车 running</span><br><span class="line">汽车 running end</span><br><span class="line">amls running end</span><br></pre></td></tr></table></figure>
<ul>
<li>yield：当前线程让出cpu的使用权，之后再一起同等争夺(不能理解成让其他线程执行)<br>示例:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static class CarThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private String carName;</span><br><span class="line"></span><br><span class="line">        public CarThread(String carName) &#123;</span><br><span class="line">            this.carName &#x3D; carName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">                System.out.println(carName+&quot;---------&quot;+i);</span><br><span class="line">                if (i &#x3D;&#x3D; 5) &#123;</span><br><span class="line">                    Thread.yield();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>5.dead:死亡状态，线程执行完毕或者某种原因异常.</p>
<h2 id="线程中断"><a href="#线程中断" class="headerlink" title="线程中断"></a>线程中断</h2><p>线程中断即是让线程在运行过程中被打断了。线程中断不同于stop，stop是向系统发送中断信号强制执行中断，而interrupt则是发送一个中断信号给目标线程，此线程会不时的检查有没有中断信号，如果在线程中不处理这个中断信号那么线程将不会响应中断(注:不是发送一个中断信号当前线程就会终止,还需要目标线程在程序中通过isInterrupt来获取中断信息以此判断是否需要中断.)<br>interrupt可以用来中断一个线程,当一个线程执行了thread.interrupt时当前线程的中断状态就从false转变为true状态。如果一个线程处于阻塞状态，线程在检查中断标记位时发现中断标记为true,就会在阻塞的地方抛出一个异常并且将中断标记位致位false复位。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Thread thread &#x3D; new Thread(() -&gt; &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                &#x2F;&#x2F; 响应中断</span><br><span class="line">                if (Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                    System.out.println(&quot;Java技术栈线程被中断，程序退出。&quot;);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(3000);</span><br><span class="line">                    System.out.println(&quot;sleep执行了&quot;);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    System.out.println(&quot;Java技术栈线程休眠被中断，程序退出。&quot;);</span><br><span class="line">                    &#x2F;&#x2F;在线程阻塞状态下重新阻塞该线程</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line">        thread.interrupt();</span><br></pre></td></tr></table></figure>
<h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2><ul>
<li>synchronized关键字:synchronized主要用于多线程中线程同步,解决当有多个线程调用同一个逻辑时数据不同步问题,synchronized关键字可以同步方法也可以同步代码块。当同步方法只有当前就只有一个线程执行其他线程需要等待当前线程执行完<br>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> public static class test7 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private String threadName;</span><br><span class="line"></span><br><span class="line">        public test7(String threadName) &#123;</span><br><span class="line">            this.threadName &#x3D; threadName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line"></span><br><span class="line">            synchronized (test7.class) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                    System.out.println(threadName + &quot;正在执行......&quot;);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">执行结果:</span><br><span class="line">0正在执行......</span><br><span class="line">9正在执行......</span><br><span class="line">8正在执行......</span><br><span class="line">7正在执行......</span><br><span class="line">6正在执行......</span><br><span class="line">5正在执行......</span><br><span class="line">4正在执行......</span><br><span class="line">3正在执行......</span><br><span class="line">2正在执行......</span><br><span class="line">1正在执行......</span><br></pre></td></tr></table></figure>

<ul>
<li>volatile关键字:在开发过程中如果我们为了同步几个实体域就使用synchronized关键字的话，那就开销太大了而volatile关键字为实体域提供了免锁机制。当一个实体域更新了数据之后其他的线程都会看到这个更新(可见性),同时被volatile修饰的实体不能被重排序(保证有序性).<br>volatile在多线程开发中能够保证程序的可见性，有序性但是不保证原子性,因此使用 volatile修饰的实体域不能做自增，自减操作只能做赋值操作.因为原子性的操作在cpu中会被分为好几个步骤执行因此在多线程中有可能当前的线程失去了cpu的控制权导致数据只执行了一半.</li>
</ul>
<h2 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h2><p>阻塞队列是支持两个附加操作的队列,当队列为空时，获取元素的线程就会阻塞，直到队列中有数据被添加进来，当队列数据满了时，插入元素的线程就会阻塞，直到队列中有空位置可以使用。<br>Java中的阻塞队列有7种:</p>
<ul>
<li>ArrayBlockingQueue:由数组结构组成的有界阻塞队列.</li>
<li>LinkedBlockingQueue:由链表组成的有界阻塞队列.(当不指定队列大小时，默认为MAX_VALUE)</li>
<li>PriorityBlockingQueue:支持优先级排序的无解阻塞队列。</li>
<li>DelayQueue:使用优先级实现的无界阻塞队列.</li>
<li>SynchronousQueue:不存储元素的阻塞队列.</li>
<li>LinkedTransferQueue:由链表结构组成的无界阻塞队列.</li>
<li>LinkedBlockingDeque:由链表结构组成的双向阻塞队列.<br>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public class BlockQueueThread &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        LinkedBlockingQueue&lt;Integer&gt; linkedBlockingQueue &#x3D; new LinkedBlockingQueue&lt;&gt;(10);</span><br><span class="line"></span><br><span class="line">        ProductThread productThread &#x3D; new ProductThread(linkedBlockingQueue);</span><br><span class="line">        CustomThread customThread &#x3D; new CustomThread(linkedBlockingQueue);</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">            if (i &lt; 5) &#123;</span><br><span class="line">                new Thread(productThread).start();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                new Thread(customThread).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建生产者</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static class ProductThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private LinkedBlockingQueue&lt;Integer&gt; linkedBlockingQueue;</span><br><span class="line">        private final Random random;</span><br><span class="line"></span><br><span class="line">        ProductThread(LinkedBlockingQueue&lt;Integer&gt; linkedBlockingQueue) &#123;</span><br><span class="line">            this.linkedBlockingQueue &#x3D; linkedBlockingQueue;</span><br><span class="line">            random &#x3D; new Random();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                int i &#x3D; random.nextInt(100);</span><br><span class="line">                linkedBlockingQueue.put(i);</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot;向队列插入数据------&quot; + i);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 创建消费者</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static class CustomThread implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private LinkedBlockingQueue&lt;Integer&gt; linkedBlockingQueue;</span><br><span class="line"></span><br><span class="line">        CustomThread(LinkedBlockingQueue&lt;Integer&gt; linkedBlockingQueue) &#123;</span><br><span class="line">            this.linkedBlockingQueue &#x3D; linkedBlockingQueue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Integer take &#x3D; linkedBlockingQueue.take();</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot;向队列取出数据------&quot; + take);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>在编程过程中如果我们在程序中每次都需要开启一个线程执行任务，那么势必会造成系统资源的消耗浪费，所以就有了线程池。线程池的作用就是当我们开启了一个线程任务后将这个线程放入线程池中统一管理，当当前线程处理完任务后不会被销毁而是重用当前线程.<br>创建线程池最好是使用ThreadPoolExecutor这个方法.FixedThreadPool和SingleThreadPool:允许请求的队列长度为interger.MAX_VALUE，可能会堆积大量的请求，导致OOM<br>CacheThreadPool和ScheduledThreadPool:允许创建的线程数量为MAX_VALUE,可能会创建大量的线程,从而导致OOM。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public ThreadPoolExecutor(int corePoolSize,</span><br><span class="line">                              int maximumPoolSize,</span><br><span class="line">                              long keepAliveTime,</span><br><span class="line">                              TimeUnit unit,</span><br><span class="line">                              BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">                              ThreadFactory threadFactory,RejectedExecutionHandler handler) &#123;</span><br><span class="line">        this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             threadFactory, defaultHandler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看上面代码ThreadPoolExecutor的几个构造方法其中做多的一共需要传入6个参数。这些参数分别为：</p>
<ul>
<li>corePoolSize:核心线程数。默认情况下线程池是空的，只有提交任务时才会创建线程，如果当前运行的线程数少于或等于corePoolSize就不会在创建核心线程。</li>
<li>maximumPoolSize:线程池允许创建的最大线程数。如果任务队列已经满了，并且当前线程数也大于corePoolSize小于maximumPoolSize，则线程会创建新的线程执行任务。</li>
<li>keepAliveTime:非核心线程闲置的时间，当超过这个时候就会回收。</li>
<li>unit:keepAliveTime的时间单位。</li>
<li>BlockingQueue<Runnable>:阻塞队列。如果当前线程数大于corePoolSize就将任务添加到此队列中。</li>
<li>ThreadFactory:线程工厂</li>
<li>RejectedExecutionHandler:饱和策略。当线程池和任务队列都满了时表示无法处理新任务抛出异常。</li>
</ul>
<h2 id="Thread和Runnable的区别"><a href="#Thread和Runnable的区别" class="headerlink" title="Thread和Runnable的区别"></a>Thread和Runnable的区别</h2><ul>
<li>Thread是一个类，Runnable是一个接口。</li>
<li>Thread类相对独立不适合多线程资源共享.而Runnable的代码可以被多个线程共享适用于多个线程处理同一资源的情况。</li>
<li>在Runable中虽然可以多个线程进行资源共享但是会存在线程安全问题，所以我们需要在代码中加入锁机制(互斥锁)。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class ticket implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    private int ticket &#x3D; 5;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        synchronized (ticket.class) &#123;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">                if (ticket &gt; 0) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(1000);</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(&quot;ticket &#x3D; &quot; + ticket--);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ticket ticket &#x3D; new ticket();</span><br><span class="line">new Thread(ticket).start();</span><br><span class="line">new Thread(ticket).start();</span><br><span class="line">new Thread(ticket).start();</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/05/23/2019-5-23-Android%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" data-id="ck8tr9s7l002hn29kgzeqfpzr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-5-20-多线程中Future和FutureTask的区别和联系" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/20/2019-5-20-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%ADFuture%E5%92%8CFutureTask%E7%9A%84%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/" class="article-date">
  <time datetime="2019-05-19T16:00:00.000Z" itemprop="datePublished">2019-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/20/2019-5-20-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%ADFuture%E5%92%8CFutureTask%E7%9A%84%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/">多线程中Future和FutureTask的区别和联系</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java多线程中我们开启一个线程主要是通过继承Thread类或者实现Runnable接口的方式,但是这两种方式都无法返回线程的执行结果。于是就设计了Future和FutureTask<br>使用Future和FutureTask开启线程需要用到Callable这个接口。<br>Callable的接口定义如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Callable&lt;V&gt; &#123;</span><br><span class="line">    V call() throw Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出Callable可以返回一个V。</p>
<h2 id="Future接口"><a href="#Future接口" class="headerlink" title="Future接口"></a>Future<V>接口</h2><p>Futuer接口是用于获取一个线程执行的结果，对执行的结果进行获取(get)，取消(cancle),判断是否完成等操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public interface Future&lt;V&gt; &#123;</span><br><span class="line">    boolean cancle(boolean mayInterruptIfRunning);</span><br><span class="line">    boolean isCancelled();</span><br><span class="line">    boolean isDone();</span><br><span class="line">    V get();</span><br><span class="line">    V get(long timeout,TimeUnit unit);</span><br><span class="line">&#125;</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">* V get():获取异步执行的结果，如果没有执行的结果，此方法会阻塞知道异步计算完成。</span><br><span class="line">* V get(long timeout,TimeUnit unit):此方法也是获取异步的执行结果，只不过会有时间限制当超过时间限制时就会抛出异常。</span><br><span class="line">* isDone():任务执行结束,无论是正常结束还是异常取消或者发生异常,都会返回true。</span><br><span class="line">* isCnacelled():任务是否被取消，如果任务在完成前取消则返回true。</span><br><span class="line">* cancle():如果任务还没开始执行取消则返回false，如果任务已经启动执行cancle（true）则任务会以中断的方式试图停止任务，如果停止成功则返回true；当任务已经启动，执行cancle（false）方法将不会对正在执行的任务产生影响，此时返回false；当任务已经完成执行cancle方法将返回false。</span><br><span class="line"></span><br><span class="line">## FutureTask类</span><br><span class="line">FutureTask实现了Future&lt;V&gt;:</span><br></pre></td></tr></table></figure>
<p>public class FutureTask<V> implements RunnableFuture<V> {}</p>
<p>public interface RunnableFuture<V> extends Runnable,Future<V> {}</p>
<pre><code></code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/05/20/2019-5-20-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%ADFuture%E5%92%8CFutureTask%E7%9A%84%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/" data-id="ck8tr9s7k002en29k7zbs0fgf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-5-13-CountDownLatch的使用场景" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/13/2019-5-13-CountDownLatch%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" class="article-date">
  <time datetime="2019-05-12T16:00:00.000Z" itemprop="datePublished">2019-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/13/2019-5-13-CountDownLatch%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/">CountDownLatch的使用场景</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>countdownlatch能够使一个和多个线程处于等待状态直到其他线程执行完再执行。countdownlatch是通过一个计数器来实现的当一个线程完成后count就会减1,直到计数器为0所有的线程都完成了任务，它的闭锁线程才恢复执行。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public class CountDoneLatch &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CountDownLatch countDownLatch &#x3D; new CountDownLatch(3);</span><br><span class="line">        new Thread(new Worker(countDownLatch, &quot;1&quot;)).start();</span><br><span class="line">        new Thread(new Worker(countDownLatch, &quot;2&quot;)).start();</span><br><span class="line">        new Thread(new Worker(countDownLatch, &quot;3&quot;)).start();</span><br><span class="line">        new Thread(new Boss(countDownLatch)).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static class Boss implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private CountDownLatch countDoneLatch;</span><br><span class="line"></span><br><span class="line">        Boss(CountDownLatch countDoneLatch) &#123;</span><br><span class="line">            this.countDoneLatch &#x3D; countDoneLatch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;boss is check work down...&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                countDoneLatch.await();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;boss is checked ok&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Worker implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        private final CountDownLatch countDownLatch;</span><br><span class="line">        private final String name;</span><br><span class="line"></span><br><span class="line">        Worker(CountDownLatch countDownLatch, String name) &#123;</span><br><span class="line"></span><br><span class="line">            this.countDownLatch &#x3D; countDownLatch;</span><br><span class="line">            this.name &#x3D; name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(&quot;worker&quot; + name + &quot;  work down!&quot;);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/05/13/2019-5-13-CountDownLatch%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" data-id="ck8tr9s7j002cn29ka2feg80m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-4-27-Bitmap位图优化处理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/27/2019-4-27-Bitmap%E4%BD%8D%E5%9B%BE%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86/" class="article-date">
  <time datetime="2019-04-26T16:00:00.000Z" itemprop="datePublished">2019-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/27/2019-4-27-Bitmap%E4%BD%8D%E5%9B%BE%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86/">Bitmap位图优化处理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android中由于Bitmap位图在加载的时候需要很大的内存开销，容易造成程序OOM。因此系统提供了不同的方式解决Bitmap加载问题.</p>
<h2 id="计算Bitmap的尺寸"><a href="#计算Bitmap的尺寸" class="headerlink" title="计算Bitmap的尺寸"></a>计算Bitmap的尺寸</h2><p>加载位图的方式可以通过decodeByteArray(),decodeFile(),decodeResource()等等。这样的加载方式很容易导致OOM异常。每种类型的加载可以通过BitmapFactory.Options类配置解码选项。在解码的过程中可以通过inJustDecodeBounds属性设置true这样在图片只有宽高资源不会加载到内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> BitmapFactory.Options options &#x3D; new BitmapFactory.Options();</span><br><span class="line">options.inJustDecodeBounds &#x3D; true;</span><br><span class="line">BitmapFactory.decodeResource(getResources(), R.id.myimage, options);</span><br><span class="line">int imageHeight &#x3D; options.outHeight;</span><br><span class="line">int imageWidth &#x3D; options.outWidth;</span><br><span class="line">String imageType &#x3D; options.outMimeType;</span><br></pre></td></tr></table></figure>
<p>这样就已经获取到了图片的尺寸而且资源没有加载到内存，我们就可以操作图片的宽高达到我们规定的大小。我们可以设置自己的采样率大小，将最终计算的值设置给inSimapleSize.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static int calculateInSampleSize(</span><br><span class="line">            BitmapFactory.Options options, int reqWidth, int reqHeight) &#123;</span><br><span class="line">    &#x2F;&#x2F; Raw height and width of image</span><br><span class="line">    final int height &#x3D; options.outHeight;</span><br><span class="line">    final int width &#x3D; options.outWidth;</span><br><span class="line">    int inSampleSize &#x3D; 1;</span><br><span class="line"></span><br><span class="line">    if (height &gt; reqHeight || width &gt; reqWidth) &#123;</span><br><span class="line"></span><br><span class="line">        final int halfHeight &#x3D; height &#x2F; 2;</span><br><span class="line">        final int halfWidth &#x3D; width &#x2F; 2;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Calculate the largest inSampleSize value that is a power of 2 and keeps both</span><br><span class="line">        &#x2F;&#x2F; height and width larger than the requested height and width.</span><br><span class="line">        while ((halfHeight &#x2F; inSampleSize) &gt;&#x3D; reqHeight</span><br><span class="line">                &amp;&amp; (halfWidth &#x2F; inSampleSize) &gt;&#x3D; reqWidth) &#123;</span><br><span class="line">            inSampleSize *&#x3D; 2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return inSampleSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置完inSimpleSize之后还需要将inJustDecodeBounds设置为false，因为在这之前图片的资源还没有在内存中，因此现在将图片加载到内存(我们计算后的大小)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static Bitmap decodeSampledBitmapFromResource(Resources res, int resId,</span><br><span class="line">        int reqWidth, int reqHeight) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; First decode with inJustDecodeBounds&#x3D;true to check dimensions</span><br><span class="line">    final BitmapFactory.Options options &#x3D; new BitmapFactory.Options();</span><br><span class="line">    options.inJustDecodeBounds &#x3D; true;</span><br><span class="line">    BitmapFactory.decodeResource(res, resId, options);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Calculate inSampleSize</span><br><span class="line">    options.inSampleSize &#x3D; calculateInSampleSize(options, reqWidth, reqHeight);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Decode bitmap with inSampleSize set</span><br><span class="line">    options.inJustDecodeBounds &#x3D; false;</span><br><span class="line">    return BitmapFactory.decodeResource(res, resId, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imageView.setImageBitmap(</span><br><span class="line">    decodeSampledBitmapFromResource(getResources(), R.id.myimage, 100, 100));</span><br></pre></td></tr></table></figure>
<h2 id="LruCache"><a href="#LruCache" class="headerlink" title="LruCache"></a>LruCache</h2><p>当我们在无网络环境或者需要频繁访问一个资源图片的时候就可以将我们的数据先加载进内存缓存中然后等需要的时候在取出来这样可以提高一个图片的访问速度.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F;获取系统运行内存</span><br><span class="line">    final int maxMemory &#x3D; (int) (Runtime.getRuntime().maxMemory() &#x2F; 1024);</span><br><span class="line">    &#x2F;&#x2F;设置缓存大小</span><br><span class="line">    final int cacheSize &#x3D; maxMemory &#x2F; 8;</span><br><span class="line">    lruCache &#x3D; new LruCache&lt;String, Bitmap&gt;(cacheSize) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected int sizeOf(@NonNull String key, @NonNull Bitmap bitmap) &#123;</span><br><span class="line">            return bitmap.getByteCount() &#x2F; 1024;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">       </span><br><span class="line">&#x2F;**</span><br><span class="line"> * 将bitmap设置到缓存中</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void addBitmapToMemoryCache(String key, Bitmap bitmap) &#123;</span><br><span class="line">    if (lruCache !&#x3D; null) &#123;</span><br><span class="line">        if (getBitmapFormCache(key) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            lruCache.put(key, bitmap);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.e(&quot;tag&quot;, &quot;图片已经加入缓存了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 从缓存中取出bitmap</span><br><span class="line"> *&#x2F;</span><br><span class="line">public Bitmap getBitmapFormCache(String key) &#123;</span><br><span class="line">    return lruCache.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DiskLruCache"><a href="#DiskLruCache" class="headerlink" title="DiskLruCache"></a>DiskLruCache</h2><p>有些时候我们无法保证缓存的数据一直在内存中，例如：当前缓存的应用退到后台被销毁。<br>这个时候就需要磁盘缓存数据,以保证我们的数据减少Bitmap加载次数.磁盘缓存读取数据依然需要在非UI线程中执行，因为我们无法知道当前读取的时长。<br>使用示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">File diskLruCacheDir &#x3D; getDiskLruCacheDir(this);</span><br><span class="line">        try &#123;</span><br><span class="line">            mDiskLruCache &#x3D; DiskLruCache.open(diskLruCacheDir, 1, 1, DISK_CACHE_SIZE);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">private File getDiskLruCacheDir(Context context) &#123;</span><br><span class="line">        final String cachePath &#x3D; Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())</span><br><span class="line">                || !isExternalStorageRemovable() ? Objects.requireNonNull(getExternalCacheDir()).getPath() : context.getCacheDir().getPath();</span><br><span class="line">        return new File(cachePath + File.separator + DiskLruCacheActivity.DISK_CACHE_SUBDIR);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> try &#123;</span><br><span class="line">                    &#x2F;&#x2F;将bitmap加入硬盘缓存</span><br><span class="line">                    DiskLruCache.Editor edit &#x3D; mDiskLruCache.edit(&quot;100&quot;);</span><br><span class="line">                    OutputStream os &#x3D; edit.newOutputStream(0);</span><br><span class="line">                    URL url &#x3D; new URL(urls);</span><br><span class="line">                    HttpURLConnection urlConnection &#x3D; (HttpURLConnection) url.openConnection();</span><br><span class="line">                    urlConnection.connect();</span><br><span class="line">                    int contentLength &#x3D; urlConnection.getContentLength();</span><br><span class="line">                    BufferedInputStream bis &#x3D; new BufferedInputStream(urlConnection.getInputStream(), contentLength);</span><br><span class="line">                    BufferedOutputStream bos &#x3D; new BufferedOutputStream(os, contentLength);</span><br><span class="line">                    int b;</span><br><span class="line">                    while ((b &#x3D; bis.read()) !&#x3D; -1) &#123;</span><br><span class="line">                        bos.write(b);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bos.flush();</span><br><span class="line"></span><br><span class="line">                    bos.close();</span><br><span class="line">                    bis.close();</span><br><span class="line"></span><br><span class="line">                    edit.commit();</span><br><span class="line">                    mDiskLruCache.flush();</span><br><span class="line">                &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;   </span><br><span class="line">                </span><br><span class="line">                &#x2F;&#x2F;获取磁盘缓存中的图片</span><br><span class="line">        try &#123;</span><br><span class="line">            DiskLruCache.Snapshot snapshot &#x3D; mDiskLruCache.get(&quot;100&quot;);</span><br><span class="line">            InputStream inputStream &#x3D; snapshot.getInputStream(0);</span><br><span class="line">            Bitmap bitmap &#x3D; BitmapFactory.decodeStream(inputStream);</span><br><span class="line">            diskCacheIv.setImageBitmap(bitmap);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="选择合适的Bitmap解码方式"><a href="#选择合适的Bitmap解码方式" class="headerlink" title="选择合适的Bitmap解码方式"></a>选择合适的Bitmap解码方式</h2><p>Android系统中Bitmap解码默认是ARGB_8888，也就是一个像素占用4个字节.<br>我们可以通过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;&#x2F;系统默认是ARGB_8888每个像素占4个字节</span><br><span class="line">options.inPreferredConfig &#x3D; Bitmap.Config.ARGB_4444;</span><br></pre></td></tr></table></figure>
<p>设置成其他的解码方式.</p>
<h2 id="多线程并发问题"><a href="#多线程并发问题" class="headerlink" title="多线程并发问题"></a>多线程并发问题</h2><p>当Bitmap的加载是在gridView或者RecyclerView这样的列表视图中时，由于我们的Bitmap加载每次都会开启一个线程这样就会造成多线程并发问题.</p>
<h2 id="及时回收Bitmap内存"><a href="#及时回收Bitmap内存" class="headerlink" title="及时回收Bitmap内存"></a>及时回收Bitmap内存</h2><p>处理完Bitmap图片之后要记得回收掉Bitmap释放资源。在Android 2.3.3及以下需要调用recycle()函数，在2.3.3以上GC会自动管理。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(Build.VERSION.SDK-INT&lt;&#x3D;10) &#123;</span><br><span class="line">        bitmap.recycle();</span><br><span class="line">&#125;</span><br><span class="line">bitmap &#x3D; null;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/04/27/2019-4-27-Bitmap%E4%BD%8D%E5%9B%BE%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86/" data-id="ck8tr9s7n002jn29k4pf08yh0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-04-16-不是市场失灵，而是那啥失灵" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/2019-04-16-%E4%B8%8D%E6%98%AF%E5%B8%82%E5%9C%BA%E5%A4%B1%E7%81%B5%EF%BC%8C%E8%80%8C%E6%98%AF%E9%82%A3%E5%95%A5%E5%A4%B1%E7%81%B5/" class="article-date">
  <time datetime="2019-04-15T16:00:00.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/2019-04-16-%E4%B8%8D%E6%98%AF%E5%B8%82%E5%9C%BA%E5%A4%B1%E7%81%B5%EF%BC%8C%E8%80%8C%E6%98%AF%E9%82%A3%E5%95%A5%E5%A4%B1%E7%81%B5/">不是市场失灵，而是那啥失灵</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>不是市场失灵，而是那啥失灵</p>
<p>因为奔驰女车主的维权事件，知名记者王志安起底了4S店的金融服务费乱象。</p>
<p>女车主王倩（化名）的购车经历是这样的：她在买车时计划全款，但是，利之星的销售反复劝她分期，在缴纳了20多万首付、办完贷款之后，销售突然通知她要缴纳15000元的金融服务费。</p>
<p>顺着这个事，王志安去了解了4S店的一些潜规则：</p>
<p>汽车销售原本是暴利行业。早些年，投资一家4S店，快的两三年就可以收回本金。</p>
<p>但最近几年，竞争日趋激烈，收益率在持续下降。随着价格战越来越激烈，汽车销售的毛利率越来越低，许多4S店零利润甚至负利润也会销售，这就是业内熟知的价格倒挂现象。</p>
<p>因为厂商会在年终时根据销售业绩给4S店返点，如果销售业绩上去了，虽然单车销售可能是亏损的，但算上返点依然有得赚。</p>
<p>除此之外，4S店还挖空心思开发其他盈利点，金融服务费、保险抵押金、店内强制搭售保险、高价销售配件，有些品牌还有出库费、牌费等收费项目，就在这一背景下粉墨登场了。</p>
<p>渐渐地，中国的汽车销售行业形成了这么一种通用模式：用不真实的低价吸引顾客进店，然后再谈交易，交易达成过程中，通过其他附加交易赚取利润。</p>
<p>最后，王老师对这种乱象开出了“政府管一管”的唯一药方：</p>
<p>有什么办法改变么？</p>
<p>只有一个办法，</p>
<p>政府对这个日渐混乱的市场强监管。取消不合法的金融服务费，废除强制搭售的店内保险，取消4S店的一切强制搭售。</p>
<p>如此，这个市场才会逐渐回归服务和诚信。</p>
<p>微博上有网友，甚至包括来去之间这样的微博CEO也认为，这件事反应了市场没能奖优罚劣，是市场失灵的明证。</p>
<p>王志安是一位比较专业的调查记者，我们假设他对事实的调查都是对的，但给出的结论和对策却是完全错的。</p>
<p>首先，我们看女车主王倩的遭遇，她在被诱导办理分期买车之后，突然被告知需要另交15000元的金融服务费。</p>
<p>王倩对此事提出两点质疑：第一、这属于消费欺诈，因为事先没人告知她有这笔开支；第二，所谓的服务并不存在，贷款手续是她自己办的。</p>
<p>王倩的表达非常清晰，这个案子体现的并不是自愿交易的市场行为，而是欺诈，是生米煮成熟饭之后的敲竹杠。</p>
<p>假如我们处在一个更为理想的市场环境里，这种情况可能会以什么方式解决呢？在这个环境里，我们会有真正站在消费者立场的消费者权益保护机构，他们将高效动用舆论或者司法资源来解决这个冲突。</p>
<p>这些机构存在的根基，来源于真正维护消费者权益的举动，而不是税收的无条件供养。这些机构也是彼此竞争的，为了赢得消费者的信任，它们不得不以越来越高的效率、越来越低的成本来解决此类冲突。</p>
<p>现实中，正是因为权力在很大程度上垄断了处理此类冲突的事权，才会导致相应组织（比如工商局、消协，它们有竞争对手吗？）效率低下，它们的核心诉求不是真正解决消费者的问题，而是多一事不如少一事。</p>
<p>想想吧，如果王倩只要打一个电话给消协投诉，就能解决她和奔驰之间的冲突，一个买得起奔驰车的人，何苦撕破脸大闹4S店呢？</p>
<p>现实中就有典型的案例，前段时间，为了加强竞争力，某电商平台升级退换货服务，甚至不需要填理由，点下手指，就有专人上门取货。这可不是因为他们老板良心好，而是因为要面对激烈的市场竞争。</p>
<p>人们容易对市场有两个误会：</p>
<p>一是认为市场应该杜绝一切恶行，如果出现了不完美的情况，那就是市场失灵。实际上，市场只是一种最高效、最经济的选择。再自由的市场，一样会有恶人存在，但市场可以用更低的成本解决或者改善这些问题。完美的世界，只存在于想象中的天国。</p>
<p>第二个误会是，以王倩的案子为例，很多人认为市场的参与主体就是王倩和利之星4S店。西安利之星把王倩欺负成这样，那就是市场失灵了。实际上，市场主体可以是每一个人和机构，王倩的案子是怎么解决的？是她大闹4S店的视频被传到微博，引发众怒才得到解决的。</p>
<p>在这过程中，每一个关注此事的人，都不同程度地参与其中，包括王志安。王志安做这个调查报告，也许不能从王倩身上获得什么直接收益，但收获了粉丝和关注度吧？再次加强了良心大V的人设吧？</p>
<p>感谢市场带来的媒体大发展吧，如果时间回到十几年前，没有自媒体的时代，这位女士就算哭死了也未必有人能帮她。</p>
<p>西安奔驰这个案子的本质是什么呢？是政府（当地工商局、消协）失灵了，王倩不得不撕破脸皮放手一搏，巧妙地撬动了其他市场主体（看客、媒体、媒体平台）的力量，解决了这个问题。</p>
<p>至于王志安说的，4S店卖车不赚钱，只能掏空心思通过别的服务赚钱，我作为一个消费者，怎么看就怎么觉得这是好事。难道我们还应该期待回到4S店卖车暴利，一辆车赚你十几万的时代吗？</p>
<p>4S店目前的这种商业模式，不就跟微信让你免费使用，然后通过一些增值服务来赚钱是一个道理吗？</p>
<p>只要提前告知购车过程中将发生的各种费用，消费者能够自由选择即可，是不是捆绑销售根本不重要。我们真正应该反对的，是这个过程中发生的欺诈现象，而不是这种商业模式本身。</p>
<p>如果按王志安给出的药方：</p>
<p>政府对这个日渐混乱的市场强监管。取消不合法的金融服务费，废除强制搭售的店内保险，取消4S店的一切强制搭售。</p>
<p>这个市场在恢复服务和诚信之前（能不能恢复还不知道，但监管成本一定会迅速增长），车辆一定会先恢复昂贵。</p>
<p>最后，我们再看一个市场显灵的例子吧，算是送李想一次免费广告：</p>
<p>对于真正有远见的企业家而言，市场上的任何痛点，都可能成为他们的盈利点，这样的人多了，剩下的商家要么跟进，要么被淘汰，这也是我们对市场的信心所在：</p>
<p>只要让人自由逐利，这个世界只能越来越好。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/04/16/2019-04-16-%E4%B8%8D%E6%98%AF%E5%B8%82%E5%9C%BA%E5%A4%B1%E7%81%B5%EF%BC%8C%E8%80%8C%E6%98%AF%E9%82%A3%E5%95%A5%E5%A4%B1%E7%81%B5/" data-id="ck8tr9s6y000xn29k79htf89y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" rel="tag">仓央嘉措菜</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-04-01-Android属性动画源码解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/01/2019-04-01-Android%E5%B1%9E%E6%80%A7%E5%8A%A8%E7%94%BB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2019-03-31T16:00:00.000Z" itemprop="datePublished">2019-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/01/2019-04-01-Android%E5%B1%9E%E6%80%A7%E5%8A%A8%E7%94%BB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Android属性动画源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android属性动画的用法主要是针对某一个属性设置具体的动画效果。<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ObjectAnimator</span><br><span class="line">.ofInt(target,propName,values[])</span><br><span class="line">.setInterpolator(LinearInterpolator)</span><br><span class="line">.setEvaluator(IntEvaluator)</span><br><span class="line">.setDuration(500)</span><br><span class="line">.start();</span><br></pre></td></tr></table></figure>
<p>设置动画作用于view，设置它变化的数据，以及插值器和估值器等最后调用start方法执行动画。</p>
<h2 id="ofInt"><a href="#ofInt" class="headerlink" title="ofInt"></a>ofInt</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static ObjectAnimator ofInt(Object target, String propertyName, int... values) &#123;</span><br><span class="line">ObjectAnimator anim &#x3D; new ObjectAnimator(target, propertyName);</span><br><span class="line">anim.setIntValues(values);</span><br><span class="line">return anim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述示例中首先调用了ofInt方法设置要变化的数据。在源代码中首先通过ObjectAnimator属性动画的构造方法，传入作用的属性<br>target和propertyName.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private ObjectAnimator(Object target, String propertyName) &#123;</span><br><span class="line">mTarget &#x3D; target;</span><br><span class="line">setPropertyName(propertyName);</span><br><span class="line">&#125;</span><br><span class="line">public void setPropertyName(String propertyName) &#123;</span><br><span class="line">&#x2F;&#x2F;...</span><br><span class="line">mPropertyName &#x3D; propertyName;</span><br><span class="line">mInitialized &#x3D; false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造方法里面主要是讲target和propertyName记录下来赋值给mTarget和mPropertyName。<br>记录完成后调用setIntValues(values);从调用的名称可以看出这个主要是设置我们传入的具体数值的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setIntValues(int... values)</span><br><span class="line">setValues(PropertyValuesHolder.ofInt(mPropertyName, values));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在setIntValues中调用了setValues将上面的propertyName和valuse传入到PropertyValuesHolder的ofInt中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static PropertyValuesHolder ofInt(String propertyName, int... values) &#123;</span><br><span class="line">return new IntPropertyValuesHolder(propertyName, values);</span><br><span class="line">&#125;</span><br><span class="line">public IntPropertyValuesHolder(String propertyName, int... values) &#123;</span><br><span class="line">mPropertyName &#x3D; propertyName;</span><br><span class="line">setIntValues(values);</span><br><span class="line">&#125;</span><br><span class="line">@Override</span><br><span class="line">public void setIntValues(int... values) &#123;</span><br><span class="line">mValueType &#x3D; int.class;</span><br><span class="line">mKeyframeSet &#x3D; KeyframeSet.ofInt(values);</span><br><span class="line">mIntKeyframeSet &#x3D; (IntKeyframeSet) mKeyframeSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从PropertyValuesHolder中可以看到将propertyName赋值给了mPropertyName，传出了mValuesType<br>然后还存储了mIntKeyframeSet，从字面意思看是关键帧。这里的mKeyframeSet是由KeyframeSet.ofInt方法获取到的是keyframe的集合，而keyframe叫做关键帧为动画保存time/value对。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static KeyframeSet ofInt(int... values) &#123;</span><br><span class="line">int numKeyframes &#x3D; values.length;</span><br><span class="line">IntKeyframe keyframes[] &#x3D; new IntKeyframe[Math.max(numKeyframes,2)];</span><br><span class="line">if (numKeyframes &#x3D;&#x3D; 1) &#123;</span><br><span class="line">keyframes[0] &#x3D; (IntKeyframe) Keyframe.ofInt(0f);</span><br><span class="line">keyframes[1] &#x3D; (IntKeyframe) Keyframe.ofInt(1f, values[0]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">&#x2F;&#x2F;...</span><br><span class="line">&#125;</span><br><span class="line">return new IntKeyframeSet(keyframes);</span><br><span class="line">&#125;</span><br><span class="line">public IntKeyframeSet(IntKeyframe... keyframes) &#123;</span><br><span class="line">mNumKeyframes &#x3D; keyframes.length;</span><br><span class="line">mKeyframes &#x3D; new ArrayList&lt;Keyframe&gt;();</span><br><span class="line">mKeyframes.addAll(Arrays.asList(keyframes));</span><br><span class="line">mFirstKeyframe &#x3D; mKeyframes.get(0);</span><br><span class="line">mLastKeyframe &#x3D; mKeyframes.get(mNumKeyframes - 1);</span><br><span class="line">mInterpolator &#x3D; mLastKeyframe.getInterpolator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先根据values的长度设置一个keyframes数组，由于我们这里之传入了一个values，所以这个keyframes的长度就是2.然后通过keyframe的ofInt方法去构造keyframe对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IntKeyframe(float fraction, int value) &#123;</span><br><span class="line">mFraction &#x3D; fraction;</span><br><span class="line">mValue &#x3D; value;</span><br><span class="line">mValueType &#x3D; int.class;</span><br><span class="line">mHasValue &#x3D; true;</span><br><span class="line">&#125;</span><br><span class="line">IntKeyframe(float fraction) &#123;</span><br><span class="line">mFraction &#x3D; fraction;</span><br><span class="line">mValueType &#x3D; int.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就只是对fraction和value进行了赋值操作。然后拿到keyframes数组后调用了IntKeyframeSet方法。<br>初始化IntKeyframeSet内的一些成员变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public IntKeyframeSet(IntKeyframe... keyframes) &#123;</span><br><span class="line">mNumKeyframes &#x3D; keyframes.length;</span><br><span class="line">mKeyframes &#x3D; new ArrayList&lt;Keyframe&gt;();</span><br><span class="line">mKeyframes.addAll(Arrays.asList(keyframes));</span><br><span class="line">mFirstKeyframe &#x3D; mKeyframes.get(0);</span><br><span class="line">mLastKeyframe &#x3D; mKeyframes.get(mNumKeyframes - 1);</span><br><span class="line">mInterpolator &#x3D; mLastKeyframe.getInterpolator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后最终返回了PropertyValuesHolder.ofInt，最终将target，keyframe，valueType交给了setValues中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void setValues(PropertyValuesHolder... values) &#123;</span><br><span class="line">int numValues &#x3D; values.length;</span><br><span class="line">mValues &#x3D; values;</span><br><span class="line">mValuesMap &#x3D; new HashMap&lt;String, PropertyValuesHolder&gt;(numValues);</span><br><span class="line">for (int i &#x3D; 0; i &lt; numValues; ++i) &#123;</span><br><span class="line">PropertyValuesHolder valuesHolder &#x3D; values[i];</span><br><span class="line">mValuesMap.put(valuesHolder.getPropertyName(), valuesHolder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里最终将PropertyValuesHolder的values，然后通过一个mValuesMap记录以key为属性名称，值为PropertyValuesHolder。</p>
<h2 id="setInterpolator"><a href="#setInterpolator" class="headerlink" title="setInterpolator"></a>setInterpolator</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setInterpolator(TimeInterpolator value) &#123;</span><br><span class="line">if (value !&#x3D; null) &#123;</span><br><span class="line">mInterpolator &#x3D; value;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">mInterpolator &#x3D; new LinearInterpolator();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这主要就是记录一下插值器，从源码可以看出<strong>默认是线性的插值器</strong>。</p>
<h2 id="setEvaluator"><a href="#setEvaluator" class="headerlink" title="setEvaluator"></a>setEvaluator</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void setEvaluator(TypeEval    uator value) &#123;</span><br><span class="line">if (value !&#x3D; null &amp;&amp; mValues !&#x3D; null &amp;&amp; mValues.length &gt; 0) &#123;</span><br><span class="line">mValues[0].setEvaluator(value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其中有个mValues就是在ofInt中初始化的PropertyValuesHolder。然后调用PropertyValuesHolder.setEvalutor。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void setEvaluator(TypeEvaluator evaluator) &#123;</span><br><span class="line">mEvaluator &#x3D; evaluator;</span><br><span class="line">mKeyframeSet.setEvaluator(evaluator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是记录一下设置的估值器然后将估值器传入mKeyframeSet中。</p>
<h2 id="setDuration"><a href="#setDuration" class="headerlink" title="setDuration"></a>setDuration</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private long mDuration &#x3D; (long)(300 * sDurationScale);</span><br><span class="line">private long mUnscaledDuration &#x3D; 300;</span><br><span class="line">private static float sDurationScale &#x3D; 1.0f;</span><br><span class="line">public ObjectAnimator setDuration(long duration) &#123;</span><br><span class="line">if (duration &lt; 0) &#123;</span><br><span class="line">throw new IllegalArgumentException(&quot;Animators cannot have negative duration: &quot; +</span><br><span class="line">duration);</span><br><span class="line">&#125;</span><br><span class="line">mUnscaledDuration &#x3D; duration;</span><br><span class="line">mDuration &#x3D; (long)(duration * sDurationScale);</span><br><span class="line">return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置动画的执行时间。<br>keyframeset中存了Keyframe集合，keyframe中存储了（fraction , valuetype , value(这个是我们要传入的真正的数值) , hasValue）。</p>
<h2 id="start"><a href="#start" class="headerlink" title="start"></a>start</h2><p>设置完动画的所有参数后,接下来就到了最关键的start方法了，在这里执行动画的操作 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> @Override</span><br><span class="line">public void start() &#123;</span><br><span class="line">super.start();</span><br><span class="line">&#125;</span><br><span class="line">ValueAnimator</span><br><span class="line">@Override</span><br><span class="line">public void start() &#123;</span><br><span class="line">start(false);</span><br><span class="line">&#125;</span><br><span class="line">ValueAnimator</span><br><span class="line">private void start(boolean playBackwards) &#123;</span><br><span class="line">if (Looper.myLooper() &#x3D;&#x3D; null) &#123;</span><br><span class="line">throw new AndroidRuntimeException(&quot;Animators may only be run on Looper threads&quot;);</span><br><span class="line">&#125;</span><br><span class="line">mPlayingBackwards &#x3D; playBackwards;</span><br><span class="line">mCurrentIteration &#x3D; 0;</span><br><span class="line">mPlayingState &#x3D; STOPPED;</span><br><span class="line">mStarted &#x3D; true;</span><br><span class="line">mStartedDelay &#x3D; false;</span><br><span class="line">mPaused &#x3D; false;</span><br><span class="line">AnimationHandler animationHandler &#x3D; getOrCreateAnimationHandler();</span><br><span class="line">animationHandler.mPendingAnimations.add(this);</span><br><span class="line">if (mStartDelay &#x3D;&#x3D; 0) &#123;</span><br><span class="line">&#x2F;&#x2F; This sets the initial value of the animation, prior to actually starting it running</span><br><span class="line">setCurrentPlayTime(0);</span><br><span class="line">mPlayingState &#x3D; STOPPED;</span><br><span class="line">mRunning &#x3D; true;</span><br><span class="line">notifyStartListeners();</span><br><span class="line">&#125;</span><br><span class="line">animationHandler.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终从ObjectAnimator的start执行到了ValueAnimator的 start方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mPlayingBackwards &#x3D; playBackwards;</span><br><span class="line">mCurrentIteration &#x3D; 0;</span><br><span class="line">mPlayingState &#x3D; STOPPED;</span><br><span class="line">mStarted &#x3D; true;</span><br><span class="line">mStartedDelay &#x3D; false;</span><br><span class="line">mPaused &#x3D; false;</span><br></pre></td></tr></table></figure>
<p>这里主要是设置动画的一些标记位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AnimationHandler animationHandler &#x3D; getOrCreateAnimationHandler();</span><br><span class="line">animationHandler.mPendingAnimations.add(this);</span><br></pre></td></tr></table></figure>
<p>这里主要是生成一个AnimationHandler对象这里主要是存储各种状态的valueAnimator。</p>
<h2 id="setCurrentPlayTime"><a href="#setCurrentPlayTime" class="headerlink" title="setCurrentPlayTime"></a>setCurrentPlayTime</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void setCurrentPlayTime(long playTime) &#123;</span><br><span class="line">        initAnimation();</span><br><span class="line">        long currentTime &#x3D; AnimationUtils.currentAnimationTimeMillis();</span><br><span class="line">        if (mPlayingState !&#x3D; RUNNING) &#123;</span><br><span class="line">            mSeekTime &#x3D; playTime;</span><br><span class="line">            mPlayingState &#x3D; SEEKED;</span><br><span class="line">        &#125;</span><br><span class="line">        mStartTime &#x3D; currentTime - playTime;</span><br><span class="line">        doAnimationFrame(currentTime);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>首先调用initAnimation初始化动画，然后调用 系统的现在时间currentTime，然后把mPlayingState设置为SEEKED状态，最后调用doAnimationFrame方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void initAnimation() &#123;</span><br><span class="line">        if (!mInitialized) &#123;</span><br><span class="line">            int numValues &#x3D; mValues.length;</span><br><span class="line">            for (int i &#x3D; 0; i &lt; numValues; ++i) &#123;</span><br><span class="line">                mValues[i].init();</span><br><span class="line">            &#125;</span><br><span class="line">            mInitialized &#x3D; true;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是设置我们 IntPropertyValueHolder的mEvaluator。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PropertyValueHolder的init方法</span><br><span class="line">void init() &#123;</span><br><span class="line">        if (mEvaluator &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; We already handle int and float automatically, but not their Object</span><br><span class="line">            &#x2F;&#x2F; equivalents</span><br><span class="line">            mEvaluator &#x3D; (mValueType &#x3D;&#x3D; Integer.class) ? sIntEvaluator :</span><br><span class="line">                    (mValueType &#x3D;&#x3D; Float.class) ? sFloatEvaluator :</span><br><span class="line">                    null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (mEvaluator !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; KeyframeSet knows how to evaluate the common types - only give it a custom</span><br><span class="line">            &#x2F;&#x2F; evaluator if one has been set on this class</span><br><span class="line">            mKeyframeSet.setEvaluator(mEvaluator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>设置IntPropertyValueHolder的mEvaluator的属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final boolean doAnimationFrame(long frameTime) &#123;</span><br><span class="line">        </span><br><span class="line">        final long currentTime &#x3D; Math.max(frameTime, mStartTime);</span><br><span class="line">        return animationFrame(currentTime);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>内部调用了animationFrame</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">boolean animationFrame(long currentTime) &#123;</span><br><span class="line">        boolean done &#x3D; false;</span><br><span class="line">        switch (mPlayingState) &#123;</span><br><span class="line">        case RUNNING:</span><br><span class="line">        case SEEKED:</span><br><span class="line">            float fraction &#x3D; mDuration &gt; 0 ? (float)(currentTime - mStartTime) &#x2F; mDuration : 1f;</span><br><span class="line">            if (fraction &gt;&#x3D; 1f) &#123;</span><br><span class="line">               &#x2F;&#x2F;...</span><br><span class="line">            &#125;</span><br><span class="line">            if (mPlayingBackwards) &#123;</span><br><span class="line">                fraction &#x3D; 1f - fraction;</span><br><span class="line">            &#125;</span><br><span class="line">            animateValue(fraction);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        return done;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>根据上面 代码中设置的动画执行 状态判断 执行到SEEKED。设置动画执行的fraction<br>然后执行了animaeValue方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void animateValue(float fraction) &#123;</span><br><span class="line">        fraction &#x3D; mInterpolator.getInterpolation(fraction);</span><br><span class="line">        mCurrentFraction &#x3D; fraction;</span><br><span class="line">        int numValues &#x3D; mValues.length;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].calculateValue(fraction);</span><br><span class="line">        &#125;</span><br><span class="line">        if (mUpdateListeners !&#x3D; null) &#123;</span><br><span class="line">            int numListeners &#x3D; mUpdateListeners.size();</span><br><span class="line">            for (int i &#x3D; 0; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                mUpdateListeners.get(i).onAnimationUpdate(this);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       int numValues &#x3D; mValues.length;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].setAnimatedValue(mTarget);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里传入我们计算的fraction获取插值器处理后的fraction。<br>接下来执行 mValues[i].calculateValue(fraction)方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void calculateValue(float fraction) &#123;</span><br><span class="line">mAnimatedValue &#x3D; mKeyframeSet.getValue(fraction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在内部又调用了getValue方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public Object getValue(float fraction) &#123;</span><br><span class="line">        return getIntValue(fraction);</span><br><span class="line">    &#125;</span><br><span class="line">public int getIntValue(float fraction) &#123;</span><br><span class="line">        if (mNumKeyframes &#x3D;&#x3D; 2) &#123;</span><br><span class="line">            if (firstTime) &#123;</span><br><span class="line">                firstTime &#x3D; false;</span><br><span class="line">                firstValue &#x3D; ((IntKeyframe) mKeyframes.get(0)).getIntValue();</span><br><span class="line">                lastValue &#x3D; ((IntKeyframe) mKeyframes.get(1)).getIntValue();</span><br><span class="line">                deltaValue &#x3D; lastValue - firstValue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (mInterpolator !&#x3D; null) &#123;</span><br><span class="line">                fraction &#x3D; mInterpolator.getInterpolation(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">            if (mEvaluator &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return firstValue + (int)(fraction * deltaValue);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return ((Number)mEvaluator.evaluate(fraction, firstValue, lastValue)).intValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;...省略了很多代码</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个里面就是调用估值算法通过fraction的值设置动画每一帧执行多少，然后for循环拿到所有的动画执行的百分比计算的数值后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (mEvaluator &#x3D;&#x3D; null) &#123;</span><br><span class="line">               return firstValue + (int)(fraction * deltaValue);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               return ((Number)mEvaluator.evaluate(fraction, firstValue, lastValue)).intValue();</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>最终给了 IntPropertyValueHolder的 mIntAnimatedValue属性。<br>接下来调用 mValues[i].setAnimatedValue(mTarget);计算后的值通过反射将其设置到set中。<br>最终调用了animationHandler的start方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void start() &#123;</span><br><span class="line">            scheduleAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">private void scheduleAnimation() &#123;</span><br><span class="line">            if (!mAnimationScheduled) &#123;</span><br><span class="line">                mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, this, null);</span><br><span class="line">                mAnimationScheduled &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>根据运行时间继续调用doAnimationFrame方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/04/01/2019-04-01-Android%E5%B1%9E%E6%80%A7%E5%8A%A8%E7%94%BB%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" data-id="ck8tr9s6x000vn29k0cp0f6ka" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-03-14-Android Service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/14/2019-03-14-Android%20Service/" class="article-date">
  <time datetime="2019-03-13T16:00:00.000Z" itemprop="datePublished">2019-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/14/2019-03-14-Android%20Service/">Android Service</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>service是一个可以在后台长时间运行的组件，并且没有用户界面.任何一个组件都可以吊起service。同时服务还可以绑定在其他组件中与其进行交互。日常中我们的网络，音乐以及文件I/O都可以在服务中执行。<strong>但是所有的服务都运行在主线程中，因此虽然service可以长时间运行在后台但是自身并不能执行长时间的阻塞主线程的活动，只能开启线程执行。</strong><br>service的启动分为两种：<br>1.调用startServie()启动。这种操作一般是在后台执行单一任务执行完就结束，不会与客户端进行交互。<br>2.bindService()启动。这种操作一般是需要与客户端进行交互的启动方式，在服务中执行长时间的耗时操作然后将结果传给客户端。</p>
<h2 id="使用服务"><a href="#使用服务" class="headerlink" title="使用服务"></a>使用服务</h2><p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class BaseService extends Service &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onCreate启动了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int onStartCommand(Intent intent, int flags, int startId) &#123;</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onStartCommand执行了&quot;);</span><br><span class="line">        return super.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        super.onDestroy();</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onDestroy执行了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">启动:</span><br><span class="line">Intent serviceIntent &#x3D; new Intent(this, BaseService.class);</span><br><span class="line">startService(serviceIntent);</span><br></pre></td></tr></table></figure>
<p>当调用startService启动服务时服务将一直处于运行状态，调用stopSelf或者stopService停止。<br>当内存不足时系统才会强制停止服务，如果服务已经绑定到Activity上这个时候服务一般是不太会被系统杀死。前台服务是永远都不回被系统杀死的。只有当服务已经启动并且长时间运行在后台这个时候服务才会被系统杀死,一旦资源变得再次可用系统便会重启服务(主要受启动模式的影响)。</p>
<h2 id="bind服务"><a href="#bind服务" class="headerlink" title="bind服务"></a>bind服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">package com.example.androidservice;</span><br><span class="line"></span><br><span class="line">import android.app.Service;</span><br><span class="line">import android.content.Intent;</span><br><span class="line">import android.os.Binder;</span><br><span class="line">import android.os.IBinder;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class BaseService extends Service &#123;</span><br><span class="line"></span><br><span class="line">    public BaseBinder baseBinder &#x3D; new BaseBinder();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onCreate启动了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int onStartCommand(Intent intent, int flags, int startId) &#123;</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onStartCommand执行了&quot;);</span><br><span class="line">        return super.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class BaseBinder extends Binder &#123;</span><br><span class="line">        public int getCount() &#123;</span><br><span class="line">            return 5;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        return baseBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        super.onDestroy();</span><br><span class="line">        Log.e(&quot;service&quot;, &quot;onDestroy执行了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> private ServiceConnection serviceConnection &#x3D; new ServiceConnection() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceConnected(ComponentName name, IBinder service) &#123;</span><br><span class="line">            BaseService.BaseBinder serviceBinder &#x3D; (BaseService.BaseBinder) service;</span><br><span class="line">            int count &#x3D; serviceBinder.getCount();</span><br><span class="line">            Log.e(&quot;service&quot;, &quot;绑定的值:&quot; + count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceDisconnected(ComponentName name) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">启动:</span><br><span class="line">Intent serviceIntent &#x3D; new Intent(this, BaseService.class);</span><br><span class="line">bindService(serviceIntent, serviceConnection, BIND_AUTO_CREATE);</span><br></pre></td></tr></table></figure>
<p>绑定服务的方式有很多种:<br>1.调用服务的onBind方法:如果当前客户端要与服务端进行交互就需要调用这个方法。当我们不需要进行多进程处理的时候就可以调用这个方法进行操作。<br>2.Messenger:当程序需要多进程处理事务的时候，可以在服务中调用Messenger方法.<br>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.example.androidservice;</span><br><span class="line"></span><br><span class="line">import android.annotation.SuppressLint;</span><br><span class="line">import android.app.Service;</span><br><span class="line">import android.content.Intent;</span><br><span class="line">import android.os.Handler;</span><br><span class="line">import android.os.IBinder;</span><br><span class="line">import android.os.Message;</span><br><span class="line">import android.os.Messenger;</span><br><span class="line">import android.os.RemoteException;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class BindService extends Service &#123;</span><br><span class="line">    public static final int MSG_WHAT &#x3D; 100;</span><br><span class="line"></span><br><span class="line">    @SuppressLint(&quot;HandlerLeak&quot;)</span><br><span class="line">    class mHandler extends Handler &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void handleMessage(Message msg) &#123;</span><br><span class="line">            switch (msg.what) &#123;</span><br><span class="line">                case MSG_WHAT:</span><br><span class="line">                    int arg1 &#x3D; msg.arg1;</span><br><span class="line">                    Log.e(&quot;TAG&quot;, &quot;建立连接了---&quot; + arg1);</span><br><span class="line">                    Message msgs &#x3D; new Message();</span><br><span class="line">                    msgs.arg1 &#x3D; 10000+arg1;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        msg.replyTo.send(msgs);</span><br><span class="line">                    &#125; catch (RemoteException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    super.handleMessage(msg);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final Messenger sMessage &#x3D; new Messenger(new mHandler());</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(Intent intent) &#123;</span><br><span class="line">        return sMessage.getBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    @SuppressLint(&quot;HandlerLeak&quot;)</span><br><span class="line">    public Messenger messengerclient &#x3D; new Messenger(new Handler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void handleMessage(Message msg) &#123;</span><br><span class="line">            super.handleMessage(msg);</span><br><span class="line">            int arg1 &#x3D; msg.arg1;</span><br><span class="line">            Log.e(&quot;TAG&quot;, &quot;服务器返回的数据-------&quot; + arg1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">Intent serviceIntent &#x3D; new Intent(this, BindService.class);</span><br><span class="line">bindService(serviceIntent, serviceConnection, BIND_AUTO_CREATE);</span><br><span class="line"></span><br><span class="line">    private ServiceConnection serviceConnection &#x3D; new ServiceConnection() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceConnected(ComponentName name, IBinder service) &#123;</span><br><span class="line">            Messenger messenger &#x3D; new Messenger(service);</span><br><span class="line">            Message msg &#x3D; new Message();</span><br><span class="line">            msg.arg1 &#x3D; 200;</span><br><span class="line">            msg.replyTo &#x3D; messengerclient;</span><br><span class="line">            msg.what &#x3D; BindService.MSG_WHAT;</span><br><span class="line">            try &#123;</span><br><span class="line">                messenger.send(msg);</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceDisconnected(ComponentName name) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="前台运行服务"><a href="#前台运行服务" class="headerlink" title="前台运行服务"></a>前台运行服务</h2><p>前台服务是一种用户感知的服务，它不会被系统杀死。它是以一种状态栏的形式被创建.<br>例如:音乐播放器<br>通过调用startForeground就可以启动前台服务了.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Notification notification &#x3D; new Notification(R.drawable.icon, getText(R.string.ticker_text),</span><br><span class="line">        System.currentTimeMillis());</span><br><span class="line">Intent notificationIntent &#x3D; new Intent(this, ExampleActivity.class);</span><br><span class="line">PendingIntent pendingIntent &#x3D; PendingIntent.getActivity(this, 0, notificationIntent, 0);</span><br><span class="line">notification.setLatestEventInfo(this, getText(R.string.notification_title),</span><br><span class="line">        getText(R.string.notification_message), pendingIntent);</span><br><span class="line">startForeground(ONGOING_NOTIFICATION_ID, notification);</span><br></pre></td></tr></table></figure>
<p>在结束的时候停止当前这个前台服务时调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stopForeground(ONGOING_NOTIFICATION_ID)</span><br></pre></td></tr></table></figure>

<h2 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h2><p>IntentService是Service的子类，它可以处理对与服务有多个请求的事件。内部通过一个工作队列处理对多个线程的请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package com.example.androidservice;</span><br><span class="line"></span><br><span class="line">import android.app.IntentService;</span><br><span class="line">import android.content.Intent;</span><br><span class="line">import android.os.Handler;</span><br><span class="line">import android.os.Message;</span><br><span class="line">import android.support.annotation.Nullable;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class BaseIntentService extends IntentService &#123;</span><br><span class="line"></span><br><span class="line">    private static final String TAG &#x3D; &quot;base_intent_service&quot;;</span><br><span class="line"></span><br><span class="line">    private static Handler mHandler;</span><br><span class="line"></span><br><span class="line">    public static final int HANDLER_WHAT &#x3D; 100;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Creates an IntentService.  Invoked by your subclass&#39;s constructor.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void setUiHandler(Handler mUiHandler) &#123;</span><br><span class="line">        mHandler &#x3D; mUiHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public BaseIntentService() &#123;</span><br><span class="line">        super(TAG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onHandleIntent(@Nullable Intent intent) &#123;</span><br><span class="line">        String numberInteger &#x3D; intent.getExtras().getString(MainActivity.NUMBER_INTEGER);</span><br><span class="line">        setUiData(mHandler, numberInteger);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setUiData(Handler mHandler, String numberInteger) &#123;</span><br><span class="line">        Message msg &#x3D; mHandler.obtainMessage();</span><br><span class="line">        msg.obj &#x3D; numberInteger;</span><br><span class="line">        msg.what &#x3D; HANDLER_WHAT;</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BaseIntentService.setUiHandler(new Handler(this));</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean handleMessage(Message msg) &#123;</span><br><span class="line">        switch (msg.what) &#123;</span><br><span class="line">            case BaseIntentService.HANDLER_WHAT:</span><br><span class="line">                String number &#x3D; (String) msg.obj;</span><br><span class="line">                Log.e(&quot;TAG&quot;, &quot;----------&quot; + number);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/03/14/2019-03-14-Android%20Service/" data-id="ck8tr9s720016n29k5uwnee8r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-03-10-Fragment常见问题分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/10/2019-03-10-Fragment%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-03-09T16:00:00.000Z" itemprop="datePublished">2019-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/10/2019-03-10-Fragment%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/">Fragment常见问题分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="getActivity空指针异常"><a href="#getActivity空指针异常" class="headerlink" title="getActivity空指针异常"></a>getActivity空指针异常</h2><p>有些时候当我们调用getActivity的时候会出现空指针异常的情况，例如：在“内存重启”(这个可以理解为屏幕旋转的时候)或者Frgment中有一些耗时较长的任务还在执行的时候此时  Fragment已经Detach了Activity所以getActivity会报空指针异常.<br>解决方法为:<br>    在Fragment基类里设置一个Activity mActivity的全局变量,在onAttach方法中赋值使用mActivity取代getActivity.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void onAttach(@NonNull Context context) &#123;</span><br><span class="line">        super.onAttach(context);</span><br><span class="line">        mActivity &#x3D; (Activity) context;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="异常：Can-not-perform-this-action-after-onSaveInstanceState"><a href="#异常：Can-not-perform-this-action-after-onSaveInstanceState" class="headerlink" title="异常：Can not perform this action after onSaveInstanceState"></a>异常：Can not perform this action after onSaveInstanceState</h2><p>产生这个异常的原因就是当出现意外情况时宿主Activity已经onStop了这个时候如果我们执行Fragment的事务的话就会报这个异常，因为当我们的Activity被stop之后系统就会执行onSaveInstanceState方法保存当前Activity的所有状态。又因为Fragment的事务是在onStop之后调用的当前Activity没有保存状态。<br>解决方法:<br>  1.调用commitAllowingStateLoss方法，但是事务有可能提交不成功.</p>
<h2 id="Fragment重叠问题"><a href="#Fragment重叠问题" class="headerlink" title="Fragment重叠问题"></a>Fragment重叠问题</h2><p>当宿主Activity将被kill或者旋转屏幕或者内存泄漏时系统就会调用onSaveInstanceState方法保存当前Activity状态,所以Fragmnt的状态也将会被保存下来又因为系统没有将Fragment的显示或者隐藏状态保存，Fragment默认状态为show()因此就发生了重叠。<br>解决方法:<br>在基类Fragment中我们可以自己记录Fragment的显示和隐藏状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class BaseFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    private static final String STATE_SAVE_IS_HIDDEN &#x3D; &quot;STATE_SAVE_IS_HIDDEN&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        if (savedInstanceState !&#x3D; null) &#123;</span><br><span class="line"></span><br><span class="line">            boolean aBoolean &#x3D; savedInstanceState.getBoolean(STATE_SAVE_IS_HIDDEN);</span><br><span class="line">            FragmentTransaction transaction &#x3D; getFragmentManager().beginTransaction();</span><br><span class="line">            if (aBoolean) &#123;</span><br><span class="line">                transaction.hide(this);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                transaction.show(this);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onSaveInstanceState(@NonNull Bundle outState) &#123;</span><br><span class="line">        super.onSaveInstanceState(outState);</span><br><span class="line">        outState.putBoolean(STATE_SAVE_IS_HIDDEN, isHidden());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时如果还发生重叠现象那是因为在根Fragemnt中没有对状态做判断.</p>
<h2 id="Fragment中startActivityForResult与getActivity-startActivityForResult的区别"><a href="#Fragment中startActivityForResult与getActivity-startActivityForResult的区别" class="headerlink" title="Fragment中startActivityForResult与getActivity().startActivityForResult的区别"></a>Fragment中startActivityForResult与getActivity().startActivityForResult的区别</h2><p>在Frgment中有些时候我们启动一个Activity时调用startActivityForResult()方法获取返回结果有些时候requestCode总有对应不上的情况.<br>示例:<br>startActivityForResult:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-03-10 10:45:10.768 14193-14193&#x2F;com.example.myapplication E&#x2F;tag: 这是未添加getActivity的方式 MyFragment requestCode:1</span><br><span class="line">2019-03-10 10:45:10.768 14193-14193&#x2F;com.example.myapplication E&#x2F;tag: 这是未添加getActivity的方式 MainActivity  requestCode:65537</span><br></pre></td></tr></table></figure>

<p>getActivity().startActivityForResult:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-03-10 10:47:50.154 14426-14426&#x2F;com.example.myapplication E&#x2F;tag: 这是getActivity的方式 MainActivity  requestCode:1</span><br></pre></td></tr></table></figure>
<p>从上面的示例可以看出当我们调用startActivityForResult方法时Fragment中的onActivityResult获取到的结果是一致的，但是Activity中获取到的值要大于65535.通过调用getActivity().startActivityForResult时只有MainActivity能接收到返回结果.</p>
<p><strong>源码分析</strong><br>1.Fragment的startActivityForResult:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void startActivityForResult(Intent intent, int requestCode) &#123;</span><br><span class="line">    startActivityForResult(intent, requestCode, null);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) &#123;</span><br><span class="line">    if (mHost &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Fragment &quot; + this + &quot; not attached to Activity&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    mHost.onStartActivityFromFragment(this &#x2F;*fragment*&#x2F;, intent, requestCode, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startActivityForResult方法最终调用的是mHost.onStartActivityFromFragment方法。mHost是Fragment中HostCallbacks的对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class HostCallbacks extends FragmentHostCallback&lt;FragmentActivity&gt; &#123;</span><br><span class="line">    public HostCallbacks() &#123;</span><br><span class="line">        super(FragmentActivity.this &#x2F;*fragmentActivity*&#x2F;);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ....</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void onStartActivityFromFragment(</span><br><span class="line">            Fragment fragment, Intent intent, int requestCode, @Nullable Bundle options) &#123;</span><br><span class="line">        FragmentActivity.this.startActivityFromFragment(fragment, intent, requestCode, options);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用了onStartActivityFromFragment方法，然后执行了FragmentActivity.this.startActivityFromFragment。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Called by Fragment.startActivityForResult() to implement its behavior.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void startActivityFromFragment(Fragment fragment, Intent intent,</span><br><span class="line">                                      int requestCode, @Nullable Bundle options) &#123;</span><br><span class="line">    mStartedActivityFromFragment &#x3D; true;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 第1步</span><br><span class="line">        if (requestCode &#x3D;&#x3D; -1) &#123;</span><br><span class="line">            ActivityCompat.startActivityForResult(this, intent, -1, options);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 第2步</span><br><span class="line">        checkForValidRequestCode(requestCode);</span><br><span class="line">        &#x2F;&#x2F; 第3步</span><br><span class="line">        int requestIndex &#x3D; allocateRequestIndex(fragment);</span><br><span class="line">	&#x2F;&#x2F; 第4步</span><br><span class="line">        ActivityCompat.startActivityForResult(</span><br><span class="line">                this, intent, ((requestIndex + 1) &lt;&lt; 16) + (requestCode &amp; 0xffff), options);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mStartedActivityFromFragment &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步:<br>当requestCode == -1时，这个是调用startActivity的时候执行的。<br>第二步:<br>检查requestCode的合法性。requestCode的取值范围在[0-65535]之间.<br>第三步:<br>获取当前fragment的请求索引值。<br>第四步:<br>调用Activity中的startActivityForResult方法,同时将requestCode方法右移16位。</p>
<p>2.Fragment中的getActivity().startActivityForResult().</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Modifies the standard behavior to allow results to be delivered to fragments.</span><br><span class="line"> * This imposes a restriction that requestCode be &lt;&#x3D; 0xffff.</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">public void startActivityForResult(Intent intent, int requestCode) &#123;</span><br><span class="line">    &#x2F;&#x2F; If this was started from a Fragment we&#39;ve already checked the upper 16 bits were not in</span><br><span class="line">    &#x2F;&#x2F; use, and then repurposed them for the Fragment&#39;s index.</span><br><span class="line">    if (!mStartedActivityFromFragment) &#123;</span><br><span class="line">        if (requestCode !&#x3D; -1) &#123;</span><br><span class="line">            checkForValidRequestCode(requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    super.startActivityForResult(intent, requestCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终执行到了onActivityResult()方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Dispatch incoming result to the correct fragment.</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</span><br><span class="line">    mFragments.noteStateNotSaved();</span><br><span class="line">    int requestIndex &#x3D; requestCode&gt;&gt;16;</span><br><span class="line">    if (requestIndex !&#x3D; 0) &#123;</span><br><span class="line">        requestIndex--;</span><br><span class="line"> </span><br><span class="line">        String who &#x3D; mPendingFragmentActivityResults.get(requestIndex);</span><br><span class="line">        mPendingFragmentActivityResults.remove(requestIndex);</span><br><span class="line">        if (who &#x3D;&#x3D; null) &#123;</span><br><span class="line">            Log.w(TAG, &quot;Activity result delivered for unknown Fragment.&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        Fragment targetFragment &#x3D; mFragments.findFragmentByWho(who);</span><br><span class="line">        if (targetFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">            Log.w(TAG, &quot;Activity result no fragment exists for who: &quot; + who);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            targetFragment.onActivityResult(requestCode &amp; 0xffff, resultCode, data);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    super.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于这里调用了onActivityResult,所以Activity中的onActivityResult方法就会被调用获取到requestCode值但是这个值是已经被改变了的。这里现将requestCode左移16位获取requestIndex的值，如果!=0就获取到目标Fragment然后调用Fragment中的onActivityResult，同时将requestCode还原(requestCode &amp; 0xffff).<br>如果是getActivity调用startActivityForResult时，requestIndex=0就不执行if语句<br>直接执行super.onActivityResult(requestCode, resultCode, data)。</p>
<p>总结:<br>所以当我们在Fragment中如果需要Fragment获取到返回值时，需要调用startActivityForResult。<br>requestCode一定不要大于65535.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/03/10/2019-03-10-Fragment%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/" data-id="ck8tr9s70000zn29k1yco7vi9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-02-20-RecyclerView源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/20/2019-02-20-RecyclerView%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-02-19T16:00:00.000Z" itemprop="datePublished">2019-02-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/20/2019-02-20-RecyclerView%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">RecyclerView源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>RecyclerView做为一个可以处理大量数据的控件同时也是日常开发中经常需要用到了的控件所以知道它的内部实现原理对于解决一些常见问题还是非常有帮助的，它的内部就是一个自定义的ViewGroup，<code>public class RecyclerView extends ViewGroup implements ScrollingView, NestedScrollingChild2</code>就来看一下它的内部是怎么样自定义这个ViewGroup的，又是怎样处理这些数据和缓存的逻辑等等。</p>
<h2 id="OnMeasure过程"><a href="#OnMeasure过程" class="headerlink" title="OnMeasure过程"></a>OnMeasure过程</h2><p>既然是一个自定义的ViewGroup所以必然会执行onMeasure方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void onMeasure(int widthSpec, int heightSpec) &#123;</span><br><span class="line">    ...</span><br><span class="line">    if (mLayout.mAutoMeasure) &#123;</span><br><span class="line">        final int widthMode &#x3D; MeasureSpec.getMode(widthSpec);</span><br><span class="line">        final int heightMode &#x3D; MeasureSpec.getMode(heightSpec);</span><br><span class="line">        final boolean skipMeasure &#x3D; widthMode &#x3D;&#x3D; MeasureSpec.EXACTLY</span><br><span class="line">                &amp;&amp; heightMode &#x3D;&#x3D; MeasureSpec.EXACTLY;</span><br><span class="line">        mLayout.onMeasure(mRecycler, mState, widthSpec, heightSpec);</span><br><span class="line">        if (skipMeasure || mAdapter &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        dispatchLayoutStep2();</span><br><span class="line"></span><br><span class="line">        mLayout.setMeasuredDimensionFromChildren(widthSpec, heightSpec);</span><br><span class="line">        ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到mLayout调用了onMeasure方法,而这个mLayout就是一个LayoutManager，是RecyclerView的内部类.所以RecyclrView的onMeasure就是交给了LayoutManager处理.<br>在layoutManager中调用了defaultOnMeasure方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void onMeasure(@NonNull RecyclerView.Recycler recycler, @NonNull RecyclerView.State state, int widthSpec, int heightSpec) &#123;</span><br><span class="line">      this.mRecyclerView.defaultOnMeasure(widthSpec, heightSpec);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>所以onMeasure方法最后又调用了RecyclerView的defaultOnMeasure.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void defaultOnMeasure(int widthSpec, int heightSpec) &#123;</span><br><span class="line">   int width &#x3D; RecyclerView.LayoutManager.chooseSize(widthSpec, this.getPaddingLeft() + this.getPaddingRight(), ViewCompat.getMinimumWidth(this));</span><br><span class="line">   int height &#x3D; RecyclerView.LayoutManager.chooseSize(heightSpec, this.getPaddingTop() + this.getPaddingBottom(), ViewCompat.getMinimumHeight(this));</span><br><span class="line">   this.setMeasuredDimension(width, height);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>最后是在defaultOnMeasure中测量了RecyclerView，调用chooseSize方法获取测量大小和测量模式.<br>回到上面接着就是调用了dispatchLayoutStep2.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void dispatchLayoutStep2() &#123;</span><br><span class="line">  this.startInterceptRequestLayout();</span><br><span class="line">  this.onEnterLayoutOrScroll();</span><br><span class="line">  this.mState.assertLayoutStep(6);</span><br><span class="line">  this.mAdapterHelper.consumeUpdatesInOnePass();</span><br><span class="line">  this.mState.mItemCount &#x3D; this.mAdapter.getItemCount();</span><br><span class="line">  this.mState.mDeletedInvisibleItemCountSincePreviousLayout &#x3D; 0;</span><br><span class="line">  this.mState.mInPreLayout &#x3D; false;</span><br><span class="line">  this.mLayout.onLayoutChildren(this.mRecycler, this.mState);</span><br><span class="line">  this.mState.mStructureChanged &#x3D; false;</span><br><span class="line">  this.mPendingSavedState &#x3D; null;</span><br><span class="line">  this.mState.mRunSimpleAnimations &#x3D; this.mState.mRunSimpleAnimations &amp;&amp; this.mItemAnimator !&#x3D; null;</span><br><span class="line">  this.mState.mLayoutStep &#x3D; 4;</span><br><span class="line">  this.onExitLayoutOrScroll();</span><br><span class="line">  this.stopInterceptRequestLayout(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个里面可以看到有一个this.mLayout.onLayoutChildren的方法,这里就是测量子控件的大小和位置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public void onLayoutChildren(RecyclerView.Recycler recycler, RecyclerView.State state) &#123;</span><br><span class="line">    &#x2F;&#x2F; layout algorithm:</span><br><span class="line">    &#x2F;&#x2F; 1) by checking children and other variables, find an anchor coordinate and an anchor</span><br><span class="line">    &#x2F;&#x2F;  item position.</span><br><span class="line">    &#x2F;&#x2F; 2) fill towards start, stacking from bottom</span><br><span class="line">    &#x2F;&#x2F; 3) fill towards end, stacking from top</span><br><span class="line">    &#x2F;&#x2F; 4) scroll to fulfill requirements like stack from bottom.</span><br><span class="line">    ...</span><br><span class="line">    mAnchorInfo.mLayoutFromEnd &#x3D; mShouldReverseLayout ^ mStackFromEnd;</span><br><span class="line">    &#x2F;&#x2F; calculate anchor position and coordinate</span><br><span class="line">    updateAnchorInfoForLayout(recycler, state, mAnchorInfo);</span><br><span class="line">    ...</span><br><span class="line">    if (mAnchorInfo.mLayoutFromEnd) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; fill towards end</span><br><span class="line">        updateLayoutStateToFillEnd(mAnchorInfo);</span><br><span class="line">        mLayoutState.mExtra &#x3D; extraForEnd;</span><br><span class="line">        fill(recycler, mLayoutState, state, false);</span><br><span class="line">        endOffset &#x3D; mLayoutState.mOffset;</span><br><span class="line">        final int lastElement &#x3D; mLayoutState.mCurrentPosition;</span><br><span class="line">        if (mLayoutState.mAvailable &gt; 0) &#123;</span><br><span class="line">            extraForStart +&#x3D; mLayoutState.mAvailable;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; fill towards start</span><br><span class="line">        updateLayoutStateToFillStart(mAnchorInfo);</span><br><span class="line">        mLayoutState.mExtra &#x3D; extraForStart;</span><br><span class="line">        mLayoutState.mCurrentPosition +&#x3D; mLayoutState.mItemDirection;</span><br><span class="line">        fill(recycler, mLayoutState, state, false);</span><br><span class="line">        startOffset &#x3D; mLayoutState.mOffset;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在onLayoutChildren方法中看到了一个fill(填充)方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">int fill(RecyclerView.Recycler recycler, LayoutState layoutState,</span><br><span class="line">        RecyclerView.State state, boolean stopOnFocusable) &#123;</span><br><span class="line">    ...</span><br><span class="line">    int remainingSpace &#x3D; layoutState.mAvailable + layoutState.mExtra;</span><br><span class="line">    LayoutChunkResult layoutChunkResult &#x3D; new LayoutChunkResult();</span><br><span class="line">    while (...&amp;&amp;layoutState.hasMore(state)) &#123;</span><br><span class="line">        ...</span><br><span class="line">        layoutChunk(recycler, state, layoutState, layoutChunkResult);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        if (...) &#123;</span><br><span class="line">            layoutState.mAvailable -&#x3D; layoutChunkResult.mConsumed;</span><br><span class="line">            remainingSpace -&#x3D; layoutChunkResult.mConsumed;</span><br><span class="line">        &#125;</span><br><span class="line">        if (layoutState.mScrollingOffset !&#x3D; LayoutState.SCOLLING_OFFSET_NaN) &#123;</span><br><span class="line">            layoutState.mScrollingOffset +&#x3D; layoutChunkResult.mConsumed;</span><br><span class="line">            if (layoutState.mAvailable &lt; 0) &#123;</span><br><span class="line">                layoutState.mScrollingOffset +&#x3D; layoutState.mAvailable;</span><br><span class="line">            &#125;</span><br><span class="line">            recycleByLayoutState(recycler, layoutState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中有一个重要的layoutChunk方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void layoutChunk(RecyclerView.Recycler recycler, RecyclerView.State state,</span><br><span class="line">        LayoutState layoutState, LayoutChunkResult result) &#123;</span><br><span class="line">    View view &#x3D; layoutState.next(recycler);</span><br><span class="line">    ...</span><br><span class="line">    if (layoutState.mScrapList &#x3D;&#x3D; null) &#123;</span><br><span class="line">        if (mShouldReverseLayout &#x3D;&#x3D; (layoutState.mLayoutDirection</span><br><span class="line">                &#x3D;&#x3D; LayoutState.LAYOUT_START)) &#123;</span><br><span class="line">            addView(view);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            addView(view, 0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    measureChildWithMargins(view, 0, 0);</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; We calculate everything with View&#39;s bounding box (which includes decor and margins)</span><br><span class="line">    &#x2F;&#x2F; To calculate correct layout position, we subtract margins.</span><br><span class="line">    layoutDecorated(view, left + params.leftMargin, top + params.topMargin,</span><br><span class="line">            right - params.rightMargin, bottom - params.bottomMargin);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个里面是真正的执行了获取子View控件并将子View填充到RecyclerView中.layoutState.next方法就是获取adapter中的子控件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">View next(Recycler recycler) &#123;</span><br><span class="line">      if(this.mScrapList !&#x3D; null) &#123;</span><br><span class="line">        return this.nextViewFromScrapList();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        View view &#x3D; recycler.getViewForPosition(this.mCurrentPosition);</span><br><span class="line">        this.mCurrentPosition +&#x3D; this.mItemDirection;</span><br><span class="line">        return view;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里然后调用了recycler.getViewForPosition和this.tryGetViewHolderForPositionByDeadline。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@NonNull</span><br><span class="line">   public View getViewForPosition(int position) &#123;</span><br><span class="line">     return this.getViewForPosition(position, false);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   View getViewForPosition(int position, boolean dryRun) &#123;</span><br><span class="line">     return this.tryGetViewHolderForPositionByDeadline(position, dryRun, 9223372036854775807L).itemView;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">   RecyclerView.ViewHolder tryGetViewHolderForPositionByDeadline(int position, boolean dryRun, long deadlineNs) &#123;</span><br><span class="line">           holder &#x3D; RecyclerView.this.mAdapter.createViewHolder(RecyclerView.this, type);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在这里看到了非常熟悉的createViewHolder，这个时候就和Adapter关联起来了.获取到了item的View后就将调用addView将它添加到RecyclerView中.<br>获取完view后接着调用了measureChildWithMargins方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void measureChildWithMargins(@NonNull View child, int widthUsed, int heightUsed) &#123;</span><br><span class="line">      RecyclerView.LayoutParams lp &#x3D; (RecyclerView.LayoutParams)child.getLayoutParams();</span><br><span class="line">      Rect insets &#x3D; this.mRecyclerView.getItemDecorInsetsForChild(child);</span><br><span class="line">      widthUsed +&#x3D; insets.left + insets.right;</span><br><span class="line">      heightUsed +&#x3D; insets.top + insets.bottom;</span><br><span class="line">      int widthSpec &#x3D; getChildMeasureSpec(this.getWidth(), this.getWidthMode(), this.getPaddingLeft() + this.getPaddingRight() + lp.leftMargin + lp.rightMargin + widthUsed, lp.width, this.canScrollHorizontally());</span><br><span class="line">      int heightSpec &#x3D; getChildMeasureSpec(this.getHeight(), this.getHeightMode(), this.getPaddingTop() + this.getPaddingBottom() + lp.topMargin + lp.bottomMargin + heightUsed, lp.height, this.canScrollVertically());</span><br><span class="line">      if(this.shouldMeasureChild(child, widthSpec, heightSpec, lp)) &#123;</span><br><span class="line">        child.measure(widthSpec, heightSpec);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中就是测量每个item的大小和分割线的大小.<br>在onMeasure方法中我们测量了recyclerview的大小和item的大小并将其添加到了recyclerview中.<br>接下来看一下RecyclerView的onLayout方法.</p>
<h2 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout"></a>onLayout</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected void onLayout(boolean changed, int l, int t, int r, int b) &#123;</span><br><span class="line">    TraceCompat.beginSection(&quot;RV OnLayout&quot;);</span><br><span class="line">    this.dispatchLayout();</span><br><span class="line">    TraceCompat.endSection();</span><br><span class="line">    this.mFirstLayoutComplete &#x3D; true;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在onLayout中还是调用了dispatchLayout方法，最后还是调用了dispatchLayoutStep2方法.</p>
<h2 id="onDraw"><a href="#onDraw" class="headerlink" title="onDraw"></a>onDraw</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void draw(Canvas c) &#123;</span><br><span class="line">    super.draw(c);</span><br><span class="line"></span><br><span class="line">    final int count &#x3D; mItemDecorations.size();</span><br><span class="line">    for (int i &#x3D; 0; i &lt; count; i++) &#123;</span><br><span class="line">        mItemDecorations.get(i).onDrawOver(c, this, mState);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void onDraw(Canvas c) &#123;</span><br><span class="line">    super.onDraw(c);</span><br><span class="line"></span><br><span class="line">    final int count &#x3D; mItemDecorations.size();</span><br><span class="line">    for (int i &#x3D; 0; i &lt; count; i++) &#123;</span><br><span class="line">        mItemDecorations.get(i).onDraw(c, this, mState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里除了绘制自身以外还绘制了分割线.</p>
<h2 id="滑动"><a href="#滑动" class="headerlink" title="滑动"></a>滑动</h2><p>RecyclerView的滑动有两个过程，一个是手指在屏幕滑动的过程(scroll)，另一个是手指滑动离开屏幕的过程(fling).<br>RecyclerView的滑动是从onTouchEvent开始.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public boolean onTouchEvent(MotionEvent e) &#123;</span><br><span class="line">    ...</span><br><span class="line">    if (mVelocityTracker &#x3D;&#x3D; null) &#123;</span><br><span class="line">        mVelocityTracker &#x3D; VelocityTracker.obtain();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    switch (action) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">            ...</span><br><span class="line">            final int x &#x3D; (int) (MotionEventCompat.getX(e, index) + 0.5f);</span><br><span class="line">            final int y &#x3D; (int) (MotionEventCompat.getY(e, index) + 0.5f);</span><br><span class="line">            int dx &#x3D; mLastTouchX - x;</span><br><span class="line">            int dy &#x3D; mLastTouchY - y;</span><br><span class="line">            ...</span><br><span class="line">            if (mScrollState !&#x3D; SCROLL_STATE_DRAGGING) &#123;</span><br><span class="line">                ...</span><br><span class="line">                if (canScrollVertically &amp;&amp; Math.abs(dy) &gt; mTouchSlop) &#123;</span><br><span class="line">                    if (dy &gt; 0) &#123;</span><br><span class="line">                        dy -&#x3D; mTouchSlop;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        dy +&#x3D; mTouchSlop;</span><br><span class="line">                    &#125;</span><br><span class="line">                    startScroll &#x3D; true;</span><br><span class="line">                &#125;</span><br><span class="line">                if (startScroll) &#123;</span><br><span class="line">                    setScrollState(SCROLL_STATE_DRAGGING);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mScrollState &#x3D;&#x3D; SCROLL_STATE_DRAGGING) &#123;</span><br><span class="line">                mLastTouchX &#x3D; x - mScrollOffset[0];</span><br><span class="line">                mLastTouchY &#x3D; y - mScrollOffset[1];</span><br><span class="line"></span><br><span class="line">                if (scrollByInternal(</span><br><span class="line">                        canScrollHorizontally ? dx : 0,</span><br><span class="line">                        canScrollVertically ? dy : 0,</span><br><span class="line">                        vtev)) &#123;</span><br><span class="line">                    getParent().requestDisallowInterceptTouchEvent(true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; break;</span><br><span class="line">        ...</span><br><span class="line">        case MotionEvent.ACTION_UP: &#123;</span><br><span class="line">            ...</span><br><span class="line">            final float yvel &#x3D; canScrollVertically ?</span><br><span class="line">                    -VelocityTrackerCompat.getYVelocity(mVelocityTracker, mScrollPointerId) : 0;</span><br><span class="line">            if (!((xvel !&#x3D; 0 || yvel !&#x3D; 0) &amp;&amp; fling((int) xvel, (int) yvel))) &#123;</span><br><span class="line">                setScrollState(SCROLL_STATE_IDLE);</span><br><span class="line">            &#125;</span><br><span class="line">            resetTouch();</span><br><span class="line">        &#125; break;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先确定滑动的偏移量大于系统的滑动值，然后就将滑动状态设置为SCROLL_STATE_DRAGGING，然后执行scrollByInternal()方法，而在这个方法里面最终回去调用LinearLayoutManager.scrollBy()，这是RecyclerView滑动的第一阶段.当手指离开屏幕后MotionEvent.ACTION_UP或者MotionAction.Cancel就会执行，在MotionEvent.ACTION_UP中首先会去计算当前滑动的速度，然后调用fling()方法，在这里就是滑动的第二阶段,然后将滑动状态设置为SCROLL_STATE_IDLE.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public boolean fling(int velocityX, int velocityY) &#123;</span><br><span class="line">    ...</span><br><span class="line">    mViewFlinger.fling(velocityX, velocityY);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在fling方法中，又回执行mViewFlinger，而这个mViewFlinger是一个Runnable对象。它的fling方法实现如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void postOnAnimation() &#123;</span><br><span class="line">    if (mEatRunOnAnimationRequest) &#123;</span><br><span class="line">        mReSchedulePostAnimationCallback &#x3D; true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        removeCallbacks(this);</span><br><span class="line">        ViewCompat.postOnAnimation(RecyclerView.this, this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void fling(int velocityX, int velocityY) &#123;</span><br><span class="line">    setScrollState(SCROLL_STATE_SETTLING);</span><br><span class="line">    mLastFlingX &#x3D; mLastFlingY &#x3D; 0;</span><br><span class="line">    mScroller.fling(0, 0, velocityX, velocityY,</span><br><span class="line">            Integer.MIN_VALUE, Integer.MAX_VALUE, Integer.MIN_VALUE, Integer.MAX_VALUE);</span><br><span class="line">    postOnAnimation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里回去调用Scroller的fling方法，然后在postOnAnimation某时刻会去执行我们给定的Runnable对象.<br>mViewFlinger.run()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    ...</span><br><span class="line">    if (scroller.computeScrollOffset()) &#123;</span><br><span class="line">        final int x &#x3D; scroller.getCurrX();</span><br><span class="line">        final int y &#x3D; scroller.getCurrY();</span><br><span class="line">        final int dx &#x3D; x - mLastFlingX;</span><br><span class="line">        final int dy &#x3D; y - mLastFlingY;</span><br><span class="line">        ...</span><br><span class="line">        if (mAdapter !&#x3D; null) &#123;</span><br><span class="line">            ...</span><br><span class="line">            if (dy !&#x3D; 0) &#123;</span><br><span class="line">                vresult &#x3D; mLayout.scrollVerticallyBy(dy, mRecycler, mState);</span><br><span class="line">                overscrollY &#x3D; dy - vresult;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        if (!awakenScrollBars()) &#123;</span><br><span class="line">            invalidate();&#x2F;&#x2F;刷新界面</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        if (scroller.isFinished() || !fullyConsumedAny) &#123;</span><br><span class="line">            setScrollState(SCROLL_STATE_IDLE);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            postOnAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里最后也是调用了mLayout.scrollVerticallyBy方法,最后也是执行到LinearLayoutManager.scrollBy()方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int scrollBy(int dy, RecyclerView.Recycler recycler, RecyclerView.State state) &#123;</span><br><span class="line">    ...</span><br><span class="line">    final int absDy &#x3D; Math.abs(dy);</span><br><span class="line">    updateLayoutState(layoutDirection, absDy, true, state);</span><br><span class="line">    final int consumed &#x3D; mLayoutState.mScrollingOffset</span><br><span class="line">            + fill(recycler, mLayoutState, state, false);</span><br><span class="line">    ...</span><br><span class="line">    final int scrolled &#x3D; absDy &gt; consumed ? layoutDirection * consumed : dy;</span><br><span class="line">    mOrientationHelper.offsetChildren(-scrolled);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在LinearLayoutManager.scrollBy()方法中首先会调用fill()方法将我们需要显示并且要填充的item加入进来，然后计算出一个consumed偏移量，最后调用mOrientationHelper.offsetChildren()方法计算出需要的滑动偏移量,也就是平移item.</p>
<h2 id="RecyclerView回收复用之Recycler"><a href="#RecyclerView回收复用之Recycler" class="headerlink" title="RecyclerView回收复用之Recycler"></a>RecyclerView回收复用之Recycler</h2><p>Recycler是RecyclerView的缓存器</p>
<p><code>public final class Recycler {
        final ArrayList&lt;ViewHolder&gt; mAttachedScrap = new ArrayList&lt;&gt;();
        ArrayList&lt;ViewHolder&gt; mChangedScrap = null;
        final ArrayList&lt;ViewHolder&gt; mCachedViews = new ArrayList&lt;ViewHolder&gt;();
private final List&lt;ViewHolder&gt;
                mUnmodifiableAttachedScrap = Collections.unmodifiableList(mAttachedScrap);
        private int mRequestedCacheMax = DEFAULT_CACHE_SIZE;
        int mViewCacheMax = DEFAULT_CACHE_SIZE;
        RecycledViewPool mRecyclerPool;
        private ViewCacheExtension mViewCacheExtension;}</code><br>这个Recycler的作用就是重用itemview，当然重用的item是从它的缓存中获取到。在上面fill方法中有一个layoutChunk方法在这方法中的View view = layoutState.next(recycler);就是获取itemview的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    ViewHolder tryGetViewHolderForPositionByDeadline(int position,</span><br><span class="line">            boolean dryRun, long deadlineNs) &#123;</span><br><span class="line">           ...</span><br><span class="line">&#x2F;&#x2F; 0) If there is a changed scrap, try to find from there</span><br><span class="line">if (mState.isPreLayout()) &#123;</span><br><span class="line">    holder &#x3D; getChangedScrapViewForPosition(position);</span><br><span class="line">    fromScrap &#x3D; holder !&#x3D; null;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 1) Find from scrap by position</span><br><span class="line">if (holder &#x3D;&#x3D; null) &#123;</span><br><span class="line">    holder &#x3D; getScrapViewForPosition(position, INVALID_TYPE, dryRun);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">if (holder &#x3D;&#x3D; null) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 2) Find from scrap via stable ids, if exists</span><br><span class="line">    if (mAdapter.hasStableIds()) &#123;</span><br><span class="line">        holder &#x3D; getScrapViewForId(mAdapter.getItemId(offsetPosition), type, dryRun);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    if (holder &#x3D;&#x3D; null &amp;&amp; mViewCacheExtension !&#x3D; null) &#123;</span><br><span class="line">        final View view &#x3D; mViewCacheExtension</span><br><span class="line">                .getViewForPositionAndType(this, position, type);</span><br><span class="line">        if (view !&#x3D; null) &#123;</span><br><span class="line">            holder &#x3D; getChildViewHolder(view);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (holder &#x3D;&#x3D; null) &#123;</span><br><span class="line">        ...</span><br><span class="line">        holder &#x3D; getRecycledViewPool().getRecycledView(type);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    if (holder &#x3D;&#x3D; null) &#123;</span><br><span class="line">        holder &#x3D; mAdapter.createViewHolder(RecyclerView.this, type);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">boolean bound &#x3D; false;</span><br><span class="line">if (mState.isPreLayout() &amp;&amp; holder.isBound()) &#123;</span><br><span class="line">    &#x2F;&#x2F; do not update unless we absolutely have to.</span><br><span class="line">    holder.mPreLayoutPosition &#x3D; position;</span><br><span class="line">&#125; else if (!holder.isBound() || holder.needsUpdate() || holder.isInvalid()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    mAdapter.bindViewHolder(holder, offsetPosition);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法会先从Scrap，Cache，Recycled从找需要的itemview如果没有就会调用mAdapter.createViewHolder方法创建一个itemview方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/02/20/2019-02-20-RecyclerView%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ck8tr9s6w000tn29k8gg9gnf5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
          </li>
        
          <li>
            <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
          </li>
        
          <li>
            <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
          </li>
        
          <li>
            <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/page/3/index/" data-id="ckgafe0db00475z9kdb1j44o3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-js/script" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/js/script/" class="article-date">
  <time datetime="2020-10-15T03:18:44.738Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/js/script/">js/script</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        (function($){
  // Search
  var $searchWrap = $('#search-form-wrap'),
    isSearchAnim = false,
    searchAnimDuration = 200;

  var startSearchAnim = function(){
    isSearchAnim = true;
  };

  var stopSearchAnim = function(callback){
    setTimeout(function(){
      isSearchAnim = false;
      callback && callback();
    }, searchAnimDuration);
  };

  $('#nav-search-btn').on('click', function(){
    if (isSearchAnim) return;

    startSearchAnim();
    $searchWrap.addClass('on');
    stopSearchAnim(function(){
      $('.search-form-input').focus();
    });
  });

  $('.search-form-input').on('blur', function(){
    startSearchAnim();
    $searchWrap.removeClass('on');
    stopSearchAnim();
  });

  // Share
  $('body').on('click', function(){
    $('.article-share-box.on').removeClass('on');
  }).on('click', '.article-share-link', function(e){
    e.stopPropagation();

    var $this = $(this),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      id = 'article-share-box-' + $this.attr('data-id'),
      offset = $this.offset();

    if ($('#' + id).length){
      var box = $('#' + id);

      if (box.hasClass('on')){
        box.removeClass('on');
        return;
      }
    } else {
      var html = [
        '<div id="' + id + '" class="article-share-box">',
          '<input class="article-share-input" value="' + url + '">',
          '<div class="article-share-links">',
            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
          '</div>',
        '</div>'
      ].join('');

      var box = $(html);

      $('body').append(box);
    }

    $('.article-share-box.on').hide();

    box.css({
      top: offset.top + 25,
      left: offset.left
    }).addClass('on');
  }).on('click', '.article-share-box', function(e){
    e.stopPropagation();
  }).on('click', '.article-share-box-input', function(){
    $(this).select();
  }).on('click', '.article-share-box-link', function(e){
    e.preventDefault();
    e.stopPropagation();

    window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
  });

  // Caption
  $('.article-entry').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;

      var alt = this.alt;

      if (alt) $(this).after('<span class="caption">' + alt + '</span>');

      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });

    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });

  if ($.fancybox){
    $('.fancybox').fancybox();
  }

  // Mobile nav
  var $container = $('#container'),
    isMobileNavAnim = false,
    mobileNavAnimDuration = 200;

  var startMobileNavAnim = function(){
    isMobileNavAnim = true;
  };

  var stopMobileNavAnim = function(){
    setTimeout(function(){
      isMobileNavAnim = false;
    }, mobileNavAnimDuration);
  }

  $('#main-nav-toggle').on('click', function(){
    if (isMobileNavAnim) return;

    startMobileNavAnim();
    $container.toggleClass('mobile-nav-on');
    stopMobileNavAnim();
  });

  $('#wrap').on('click', function(){
    if (isMobileNavAnim || !$container.hasClass('mobile-nav-on')) return;

    $container.removeClass('mobile-nav-on');
  });
})(jQuery);
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/js/script/" data-id="ckgafe0c400315z9kb4mj86aw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/index/" class="article-date">
  <time datetime="2020-10-15T03:18:44.737Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/index/">index</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-12-31-软引用和弱引用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/" class="article-date">
  <time datetime="2019-12-30T16:00:00.000Z" itemprop="datePublished">2019-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Java开发的一个好处就是我们不用自己管理对象的内存,这样就避免了大量的内存溢出问题,而是交给了JVM去处理。但是有些时候我们的程序还是会报OOM的异常，针对这种情况我们使用软引用或者弱引用对某些对象具备一定的生命周期,从而在JVM内存已满或者执行垃圾回收的时候释放回收当前的对象。</p>
<h1 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h1><p>强引用是在代码中普遍存在的。例如:</p>
        
          <p class="article-more-link">
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/" data-id="ck8tr9s7f0024n29k0wjz9ozc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-12-06-Android TextView源代码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-12-05T16:00:00.000Z" itemprop="datePublished">2019-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h1><p>TextView作为Android开发日常中经常需要的显示文字的控件它提供了对文字的增删改查以及图文混排等功能。这篇文章主要是介绍TextView的绘制结构以及处理文字的流程。</p>
<p>TextView作为一个自定义控件必然也需要继承View并经过onMeasure,onLayout,onDraw这三个过程。</p>
        
          <p class="article-more-link">
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ck8tr9s7d001zn29kb8g2egsf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-11-12-Http请求头Cache-Control机制详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2019-11-11T16:00:00.000Z" itemprop="datePublished">2019-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在Web开发中有些时候为了减轻服务器的压力或者提高用户的体验我们会对请求的资源进行一定的缓存以便不在从服务器获取相同的数据直接从缓存中获取。<br>客户端请求服务器以及服务器发送给客户端的数据都会包含一个请求头信息(headers)和一个请求体(body),客户端和浏览器要做的缓存控制就是在hearder头中通过Cache-Control关键字以它作为key,相应的信息作为value。</p>
<h1 id="Cache-Control-http1-1"><a href="#Cache-Control-http1-1" class="headerlink" title="Cache-Control(http1.1)"></a>Cache-Control(http1.1)</h1><p>缓存的key</p>
<p><img src="/img/in-post/%E8%AF%B7%E6%B1%82%E9%A6%96%E9%83%A8.jpg" alt=""></p>
<p><img src="/img/in-post/%E5%93%8D%E5%BA%94%E9%A6%96%E9%83%A8.jpg" alt=""></p>
<h2 id="no-cache"><a href="#no-cache" class="headerlink" title="no-cache"></a>no-cache</h2><p><strong>Cache-Control: no-cache</strong><br>客户端在请求头中设置no-cache这个字段请求服务器时表示缓存会将此请求发送给服务器(该请求会带有本地缓存相关的验证字段),服务器会根据这个字段验证请求中所描述的缓存是否过期，如果未过期返回304,则缓存才使用本地缓存。<strong>这个其实是一个对比缓存</strong></p>
<h2 id="only-if-cached"><a href="#only-if-cached" class="headerlink" title="only-if-cached"></a>only-if-cached</h2><p><strong>Cache-Control: only-if-cached(从英文名得出:如果有,仅仅使用缓存)</strong><br><strong>前提是这个缓存一定是可用的比如设置了max-age = xxx这个就说明过了xxx秒之后缓存不能用了此时客户端通过only-if-cached是获取不到缓存的数据的因为缓存已经不能用了。</strong><br>如果有匹配项(新的或旧的)，则从缓存中返回。<br>如果没有匹配，浏览器将返回一个错误(504)。</p>
<h2 id="max-age"><a href="#max-age" class="headerlink" title="max-age"></a>max-age</h2><p><strong>Cache-Control: max-age=XXX</strong><br>这个字段表示缓存在XXX时间内都是有效的,当超出了这个时间就从服务器重新请求数据。</p>
<h3 id="对于客户端来说"><a href="#对于客户端来说" class="headerlink" title="对于客户端来说:"></a>对于客户端来说:</h3><ul>
<li>当客户端的XXX时间比服务器端的时间长时,客户端就会获取到缓存的数据,当然前提是服务器端设置的XXX时间内缓存的数据没有过期<br>例如:服务区端设置的时间为max-age=100,客户端设置的时间为max-age=200.这个时候只要服务器端的时间没有过期那么客户端获取的数据就是缓存的数据。</li>
<li>当客户端设置的XXX时间比服务器端的时间少时,这个时候客户端的请求是在设置的时间之内就之间返回缓存的数据否则请求服务器获取.<br>例如:客户端设置的时间为max-age=5,服务器端设置的时间为max-age=10,这个时候当客户端在5s以内所有的请求获取的就是缓存数据,如果超过了5s即使缓存没有过期依然发送请求给服务器重新获取数据。</li>
</ul>
<h3 id="对于服务器端来说"><a href="#对于服务器端来说" class="headerlink" title="对于服务器端来说:"></a>对于服务器端来说:</h3><ul>
<li>当服务器端设置了max-age=XXX就表示过了XXX时间以后缓存失效需要重新请求数据。</li>
</ul>
<h2 id="no-store"><a href="#no-store" class="headerlink" title="no-store"></a>no-store</h2><p><strong>Cache-Control: no-store</strong><br>表示客户端不使用任何的缓存,每次请求都是直接从服务器获取数据。</p>
<h2 id="public"><a href="#public" class="headerlink" title="public"></a>public</h2><p><strong>Cache-Control: public</strong><br>客户端和缓存服务器都可以缓存。</p>
<h1 id="private"><a href="#private" class="headerlink" title="private"></a>private</h1><p><strong>Cache-Control: private</strong><br>只有客户端可以缓存数据,缓存服务器(或者是其他的媒介)不可以缓存。</p>
<h1 id="Pragma-http1-0"><a href="#Pragma-http1-0" class="headerlink" title="Pragma(http1.0)"></a>Pragma(http1.0)</h1><p><strong>Pragma: no-cache</strong><br>这个表示不使用缓存,直接发请求给服务器端。<br>Pragma是http1.0的产物在一些服务器中为了兼容性还保留了这个字段<br>这个字段大于Cache-Control:Pragma的优先级是高于Cache-Control的 Pragma&gt;Cache-Control<br>在请求头里面我们如果设置了Cache-Control最好是removeHeader掉Pragma这个字段</p>
<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ</a><br><a href="https://imweb.io/topic/5795dcb6fb312541492eda8c" target="_blank" rel="noopener">https://imweb.io/topic/5795dcb6fb312541492eda8c</a><br><a href="https://www.cnblogs.com/chenqf/p/6386163.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenqf/p/6386163.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/" data-id="ck8tr9s7h0028n29kh7jchzu0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-11-05-什么是子网掩码和默认网关" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/" class="article-date">
  <time datetime="2019-11-04T16:00:00.000Z" itemprop="datePublished">2019-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h1><p>当我们在配置计算机的网络时,我们需要打开计算机的网络设置界面,如下:</p>
<p><img src="/img/in-post/2005113194521734.jpg" alt=""></p>
<p>在界面中观察到我们需要设置一个叫子网掩码的东西,哪这个东西具体是干什么用的？<br>互联网中要想两个计算机通讯我们需要先确认它们的IP地址是在同一个网段的,而确认两台计算的IP地址的方式就是用子网掩码分别对IP地址做AND运算得出的结果相同则说明它们是在同一个网段上,这个时候可以直接进行通讯</p>
<p><img src="/img/in-post/2005113194521797.jpg" alt=""></p>
<p>所以子网掩码的作用就是用来判断任意的两台计算机的IP地址是否属于同一个网段的。</p>
<h1 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h1><p>A计算机192.168.2.0,B计算机192.168.1.0,显然这个两台计算机是无法通讯的因为通过子网掩码计算得出他们不属于同一个网段。哪怎样将计算机A的包发给计算机B呢？<br>这个时候就需要通过网关。计算机A先将数据包发送给网关(这个网关必须得在A计算机的网段中192.168.2.X)然后再转发给计算机B。<br>网关的IP地址需要具有路由功能。</p>
<h2 id="默认网关"><a href="#默认网关" class="headerlink" title="默认网关"></a>默认网关</h2><p>一台主机可能有多个网关。默认网关就是当我们指定的网关找不到的时候就把数据发给默认网关处理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/" data-id="ck8tr9s7g0026n29k5hlx7bik" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-11-04-计算机中IP地址是怎样分配的" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/" class="article-date">
  <time datetime="2019-11-03T16:00:00.000Z" itemprop="datePublished">2019-11-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="DHCP协议"><a href="#DHCP协议" class="headerlink" title="DHCP协议"></a>DHCP协议</h2><p>DHCP协议也叫动态主机配置协议这个协议主要是用来给计算机动态的分配IP地址。以前我们需要手动设置IP地址这样很不好管理所以它主要是解决计算机动态分配网络IP地址的问题。当计算机需要联网的时候发送一个请求给DHCP服务器要求分配一个IP,用完之后还回去(服务器IP地址是固定的)</p>
<h2 id="DHCP的工作过程"><a href="#DHCP的工作过程" class="headerlink" title="DHCP的工作过程"></a>DHCP的工作过程</h2><p><img src="/img/in-post/20160321233138127" alt=""></p>
<p>如上图所示当我们的计算机加入网络的时候,刚开始是没有IP地址的,只知道自己的MAC地址这个时候它需要发送一个DHCP Discover包给DHCP服务器。<br>当前机器使用IP地址为0.0.0.0发送一个广播包,目的IP地址为255.255.255.255包里面封装了BOOTP,UDP,IP以及自己的MAC地址</p>
<p><img src="/img/in-post/395b304f49559034af34c882bd86f11f.jpg" alt=""></p>
<p>DHCP Server接收到Discover包后,通过发送DHCP Offer包给Client应答,这个时候客户端还没有IP地址</p>
<p><img src="/img/in-post/54ffefbe4f493f0f4a39f45504bd5086.jpg" alt=""></p>
<p>DHCP Offer的内容如上图</p>
<p>客户端接收到了DHCP Offer的数据包之后,然后向网络发送一个DHCP Request数据包告诉所有的DHCP Server它将接收哪一台服务器提供的IP地址,并让其他的DHCP Server(有些时候可能有多个DHCP Server)撤销掉他们分配的IP地址以便提供给其他的请求者。<br>但是现在还没有得到DHCP Server的确认,客户端仍然还是用0.0.0.0的IP,255.255.255.255为目标IP,在BOOTP里面已经附带了客户端接受了哪个DHCP Server分配的地址了。<br>DHCP Server接收到了客户端的 DHCP Request后，会返回给客户端一个DHCP ACK消息包表示已经接受客户机的选择并将IP地址的合法租用期以及其他配置信息再发送给客户端，最后自己广播一下让大家知道。<br>至此客户端终于确认了自己的IP地址现在可以上网了。</p>
<h1 id="IP地址的续租"><a href="#IP地址的续租" class="headerlink" title="IP地址的续租"></a>IP地址的续租</h1><p>当客户端有了IP地址这个IP地址它只是租的,如果客户端不续租的话IP地址将会被收回,所以在一定的时候需要向DHCP Server发送DHCP Request数据包,服务端接收到数据包后发送DHCP ACK包作出回应然后根据包中提供的新的租期信息更新自己的TCP/IP参数等一些配置。这样当前IP又可以继续使用了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/" data-id="ck8tr9s7b001un29k8iv3e35b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-29-网络基础理解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/29/2019-10-29-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%90%86%E8%A7%A3/" class="article-date">
  <time datetime="2019-10-28T16:00:00.000Z" itemprop="datePublished">2019-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/29/2019-10-29-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%90%86%E8%A7%A3/">网络基础理解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>计算机网络作为计算机非常基础也是非常难以理解的知识,对于我们理解计算机网络操作是非常有必要的。计算机网络的学习维持一个月，这是计算机网络的第一篇博客。</p>
<h1 id="网络请求过程"><a href="#网络请求过程" class="headerlink" title="网络请求过程"></a>网络请求过程</h1><ul>
<li><p>当我们从浏览器输入”<a href="http://www.baidu.com&quot;发生了什么？首先我们需要通过DNS解析器将我们的“www.baidu.com”的域名解析成计算机可以识别的内容“220.181.38.150”继续成了我们的IP地址,这个就是我们的门牌号一样。">www.baidu.com&quot;发生了什么？首先我们需要通过DNS解析器将我们的“www.baidu.com”的域名解析成计算机可以识别的内容“220.181.38.150”继续成了我们的IP地址,这个就是我们的门牌号一样。</a></p>
</li>
<li><p>知道了我们的目标IP地址这个时候就可以通过HTTP在我们的应用层封装我们的请求。</p>
<p> <img src="/img/in-post/d8a65ca347ad26acc9f1de49b10320c6.png" alt=""></p>
</li>
<li><p>接下来通过socket将应用层的包交给下一步传输层处理,在这里通过TCP协议封装我们浏览器的监听接口以及电商应用的接口。</p>
<p><img src="/img/in-post/53c753a7d49c9dfe3cfeb26497e47eee.png" alt=""></p>
</li>
<li><p>传输层完成后,下一步就将包发送给网络层。网络层通过IP协议会有目标IP地址和当前机器的IP  </p>
<p>   <img src="/img/in-post/459a421975b27f6187d2aa4673171f1b.png" alt=""></p>
</li>
<li><p>操作系统在启动的时候会被DHCP协议配置IP地址以及默认的网关IP地址“192.168.1.1”。<br>这个时候怎样将数据包发送给网关呢？通过ARP协议找到本地网关,将数据包从IP网络层传输给了MAC层(数据链路层),网卡再将包发送出去，这个时候就通过IP地址找到目标所在地，然后通过MAC地址将数据包具体的传给某台机器。</p>
</li>
<li><p>当目标服务器接收到我们的数据后他会回传信息告知我们他已经接收到信息了。然后服务器通过TCP层的端口号得到HTTP请求的内容交给自己的进程去处理，当一切都处理完成后服务端在发送一个HTTP请求给我们,在重复上述操作最终发送给客户端HTTP请求的内容,所以这个时候我们的浏览器才出来了页面内容。   </p>
</li>
</ul>
<h1 id="为什么有了IP地址还要有MAC地址才能接收到数据"><a href="#为什么有了IP地址还要有MAC地址才能接收到数据" class="headerlink" title="为什么有了IP地址还要有MAC地址才能接收到数据"></a>为什么有了IP地址还要有MAC地址才能接收到数据</h1><p>当我们的以太网数据包发送到目标服务器的网段时,虽然IP地址的前24位是网段后8位是主机部分但是计算机网络没有那么智能他无法知道具体哪个是目标的IP(这个时候数据包还没有目标的MAC地址,当前的MAC地址还是FF:FF:FF:FF)只能以广播的形式发送给网段中的所有机器,这些机器接收到数据包之后用自己的IP与数据包中的IP进行比对如果两者相同都作出回复向对方报告自己的MAC地址。主机的IP地址是随时都可以变化的但是MAC地址是唯一不变的。以太网规定，连入网络的所有设备，都必须具有”网卡”接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。IP地址的主要目的就是区分是否是在同一个网段。</p>
<p> <img src="/img/in-post/v2-bf1edc2a0520375df6e9f7e0f02b0c16_r.jpg" alt=""></p>
<blockquote>
<p><a href="http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html</a><br><a href="http://blog.sciencenet.cn/blog-411071-1037673.html" target="_blank" rel="noopener">http://blog.sciencenet.cn/blog-411071-1037673.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/29/2019-10-29-%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E7%90%86%E8%A7%A3/" data-id="ck8tr9s7e0022n29kfphdfsqw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-25-不变蠢的两个方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/25/2019-10-25-%E4%B8%8D%E5%8F%98%E8%A0%A2%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95/" class="article-date">
  <time datetime="2019-10-24T16:00:00.000Z" itemprop="datePublished">2019-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/25/2019-10-25-%E4%B8%8D%E5%8F%98%E8%A0%A2%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95/">不变蠢的两个方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上篇发了朋友梁先生的遭遇。一个月前，梁先生出租屋突发火情，烧到家徒四壁，起火点是只接了一个台灯的排插，消防局给出的事故认定原因是“电气线路故障”。</p>
<p>尽管火情蹊跷，梁先生还是准备承担责任，把房屋恢复原状，并且在装修期间继续给房东支付房租，大概要花费20万元，是他几年的积蓄。</p>
<p>准备装修的过程中，一位经验丰富的工长发现，房屋电气装修有诸多不合规之处。这件事情让梁先生感到后怕，万一火灾发生在他睡觉的时候，可能得把命搭进去。</p>
<p>房屋的装修，是房东委托中介代办的。房东明确提出装修必须符合国家安全标准。但装修情况并非如此，梁先生因此要求和中介一起发起事故责任鉴定。之所以要一起发起，是如果梁先生单方请人鉴定，证据效力不高。</p>
<p>梁先生的意思是，如果鉴定机构的结论仍然将事故责任归于自己，那么他愿意支付鉴定费用，照样赔偿房东损失。遗憾的是，中介不予配合，还多次谩骂梁先生。</p>
<p>于是，梁先生选择向街道、派出所举报，去法院发起诉讼，也寻求在微博、公众号这样的自媒体曝光。</p>
<p>大概就是这么个事情，大部分人看到，都感到愤慨和可怕，有几位还因为这篇文章开始关注出租屋的电气安全，想找人检查一下。</p>
<p>当然，也有个别智者，对我提出质疑：“你不是支持绝对市场经济和自由主义的吗？这不是没有适当监管的一定程度上的市场经济、自由竞争吗？”</p>
<p>类似的质疑，我在写“奔驰女车主维权事件”的时候完整回应过，但依然无法避免永恒的抬杠：黑中介不是市场经济主体吗？你不是支持市场经济吗？你怎么不支持他呢？你们这些自由主义者不是一向警惕权力吗？怎么也报上警了呢？</p>
<p>最后这个问题就像：你们自由主义者不是说国企效率不如民企吗？怎么还坐高铁呢？怎么还去中石油呢？</p>
<p>要回应这些问题也简单：</p>
<p>我支持市场经济，黑中介是任何市场经济之下都可能存在的事物，他们通过一定程度的欺诈达成交易，不属于自愿交易的市场行为。</p>
<p>再自由的市场，一样会有恶人存在。支持市场，不是因为它完美，而是市场可以低成本、高效率解决或者改善问题。完美的世界，只存在于想象中的天国。</p>
<p>事实上，我的朋友在一切有选择的地方，都想通过协商、给中立机构付费的方式来获得公正。最后，出于无奈，他向居委会、派出所甚至法院寻求帮助，是因为在当前的现实条件下，这就是他仅有的选择。</p>
<p>这个问题不想赘述，有兴趣的可以看前面提到的文章。</p>
<p>更有意思的是名词的异化，以及由此诞生的杠精。</p>
<p>比如“自由”这个词，西方的自由派（liberal）搞了一大堆政治正确，不让说这个不让说那个，要求政府派福利，要保护环境不让穿皮草，多数诉求都是反自由的；而在中国，你要说自己是自由主义者，马上就有杠精跑过来问：“香港现在就很自由，可以当街打砸抢，港府现在就很小政府，你怎么不叫好呢？索马里无政府，弱肉强食，这不就是你们要的绝对自由主义吗？”</p>
<p>为了化解这种尴尬，人们创造了一大堆新名词，比如什么社会自由主义，古典自由主义，自由意志主义，自愿主义…总而言之，大家都想把自己定义的“自由”跟其他人口中的自由区分开来，否则没法对话。</p>
<p>如果不是有志于理论研究，一个人能不能分清这些概念，一点都不重要，事情摆在那里，就事论事就好。</p>
<p>有基本同理心的人，看到梁先生的遭遇，反应大体一致：愤慨、后怕、同情。只有那些学了几个似懂非懂的概念，脑子一团浆糊的人，还没有分寸感的人，才会扑上来抬杠：你不是自由主义者吗？报什么警呢？</p>
<p>这些人对抽象概念的执着和无力，让他们的思想失去了正常的血肉，就像本来会跑步的人，看了几本跑步指南，突然迈步动腿了，这也让我想到罗素的一句名言：人生而无知，但并不愚蠢，是教育使人愚蠢。</p>
<p>不想变蠢的办法倒也有：要么说话前把事情搞清楚；要么保留赤子之心，受灾人哪怕仅仅是陌路人，用朴素的生活经验去看，你也不会有这么下作的疑问。</p>
<p>我越来越觉得，第一种方法很难，因为个体的认知能力极为有限，你在一个领域是专家，在另一个领域可能是白痴。我们在生活中喜欢的那些人，通常是做到了第二点，他们真诚、善意，哪怕偶尔说错，也不招人反感。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/25/2019-10-25-%E4%B8%8D%E5%8F%98%E8%A0%A2%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95/" data-id="ck8tr9s7c001xn29k8yywbnb8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" rel="tag">仓央嘉措菜</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-22-郭敬明的上纲上线和李诚儒的倚老卖老" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/22/2019-10-22-%E9%83%AD%E6%95%AC%E6%98%8E%E7%9A%84%E4%B8%8A%E7%BA%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%9D%8E%E8%AF%9A%E5%84%92%E7%9A%84%E5%80%9A%E8%80%81%E5%8D%96%E8%80%81/" class="article-date">
  <time datetime="2019-10-21T16:00:00.000Z" itemprop="datePublished">2019-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/22/2019-10-22-%E9%83%AD%E6%95%AC%E6%98%8E%E7%9A%84%E4%B8%8A%E7%BA%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%9D%8E%E8%AF%9A%E5%84%92%E7%9A%84%E5%80%9A%E8%80%81%E5%8D%96%E8%80%81/">郭敬明的上纲上线和李诚儒的倚老卖老</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>郭敬明，这个永远跟“抄袭”挂钩的名字，也是倔强和励志的标志性人物。他本人恐怕也不在意外界是否当他是一名作家，他在图书运作上的成就无法否认，如今转行电影，也为自己争到了一把能跟陈凯歌和李少红平起平坐的位置——至少在娱乐节目上是这样的。当然不必太较真，一档综艺节目的考量总是复杂的，郭敬明的话题性比什么都重要。这种搭配是一种要权威性又要眼球的综合结果。</p>
<p>就是这么一档娱乐节目，叫什么我没兴趣，但这个流传开来的片段引起了争议，值得聊一聊。可以先看下这个片段。</p>
<p>简单说郭敬明作为导师的一群年轻人表演了一些片段，校园里的情情爱爱，李诚儒老师作为特邀评委满脸疑惑，坐不住了，“如坐针毡，如芒刺背“，这个不用李诚儒老师亲口说，他脸上写满了厌恶和不屑。</p>
<p>李诚儒的反应一点也不特别，哪怕再年轻个二十岁我也看不进那些破烂玩意，青春戏是一种类型，会永远存在，但不能说这个类型有问题，不管是故事还是表演，必然有好坏之分。李诚儒作为特邀嘉宾，从专业的角度，只点评表演，怎么说都是尽职尽责的表现，批评的话总是难听，虽然可以更温和更含蓄一些。然而问题就出在后面，很快李诚儒老师表达了对影视内容的一种期待，尤其是思想教育方面的期待。</p>
<p>李诚儒老师说难道我们现在的年轻人只看这种高中生谈恋爱，男生女生抱在一起就起哄。家国情怀，忠人义士，值得书写的太多了。诚儒老师语重心长，这样下去，这一辈年轻人能受到什么样的教育呢。</p>
<p>这一幕无法不让人想起十几年前的一场“反三俗”座谈会。一帮德高望重的人民艺术家批评当下的流行文化的媚俗、庸俗、低俗。姜昆老师差不多也是因为这个“反三俗”的高调表现，被半永久地钉在文化的耻辱柱上，供人们在回顾历史时感慨。</p>
<p>李诚儒老师的语气和预期我们都相当熟悉，仿佛老师和家长附体，对偷摸看有害读物进行的严厉批评。用一直以来都比较流行的话，老了之后变成自己年轻时最讨厌的那种人。虽然时代在变，但年轻人的某些特质不会变，叛逆，赶时髦，无病呻吟，冲动，李老师可能忘了自己年轻的时候是什么操行。正好，李诚儒老师也说了，这不畅销书吗。就差直接劈头盖脸质问郭敬明为何那么善于制造垃圾。</p>
<p>郭敬明的成功也恰恰说明了他特别懂年轻人的真实需求。不管是刻意为之还是凑巧水平刚好匹配。所以即便我们认为那些东西都是垃圾，但也很难知道郭敬明是故意制造垃圾，还是刚好只会生产垃圾。这是很难判断的。</p>
<p>纯审美的角度，我大概和李诚儒老师差不多，若在现场脸色不一定会比他好看。但我一点也不担心这一辈年轻人会因为这种“破剧”而带来教育上的坏影响。我十分理解年轻人就喜欢看这些，集齐最优秀团队做出来的审美上高级的青春电影，也无法离开情情爱爱。放眼整个流行音乐，无论水平如何，大体上也都是情情爱爱。</p>
<p>李诚儒老师的讨厌就在于我们常见的倚老卖老，并且喜欢把一切内容都上升到教育层面。题外话，李诚儒老师最广为人知的表演是在《大腕》里最后一幕扮演的精神病患者的独白，不知道李老师如何去定义这部电影的教育意义，年轻人看了《大腕》在精神层面上能得到什么层次的升华？我想这部电影大概也就是图个乐。</p>
<p>郭敬明的回应却赢得了喝彩。然而郭敬明的回应我更厌恶。</p>
<p>如果说李诚儒老师只是挺讨厌的，郭敬明的回应则有点上纲上线了。郭敬明多么聪明啊，先把责任都揽自己身上，显得非常得体，其实本来就是他指导的作品。然乎指出自己的作品并非只有情情爱爱，而是勇敢披露了校园霸凌现象，最高明的当然是最后引用的这句话：你可以永远不喜欢你不喜欢的东西，但请允许它存在；你可以继续讨厌自己讨厌的东西，但请允许别人对它的喜欢。</p>
<p>多么正的价值观啊，值得所有人捍卫。问题是，这话你跟李诚儒老师说得着吗？李诚儒只是一个演员，哪里有任何能力“不允许”他不喜欢东西的存在了。大家心知肚明，只有权力才可以。然而你试想下在那样一个现场，郭敬明说出“如此绝对正确”的话来，等于是说李诚儒成了一个坏人。这是一种极其可恶的诡辩术。</p>
<p>如果有一天郭敬明的电影被有关部门封杀，这时郭敬明祭出这句掷地有声的话，才是完全用对了场合，我们也应该支持自己不喜欢的东西存在，否则有一天你喜欢的东西也会无缘无故被消失。</p>
<p>就郭敬明把一种喜好偷换成权利之后，悄无声息地给李诚儒老师扣上了恶人的帽子，与此同时倒是把自己给打扮得相当宽容和正义，可以心安理得地继续生产垃圾（对不住了，郭敬明的东西确实是垃圾，但支持喜欢的人开心就好），毕竟郭敬明的意思是，你不喜欢是你的事，有人喜欢就行了。这就完全离题了，虽然李诚儒作为评委率先跑偏了。</p>
<p>平日里一些文盲都也喜欢用“上纲上线”这个词，但经常乱用。郭敬明在那样一个语境里说这句口号就叫“上纲上线”。这话很对，但用错场景了，比较恶劣。我经常也遇到过，在谈论我不喜欢的东西，有读者就很着急说，人家有存在的权利。极其令人胸闷，我哪有能力和资格不允许那些丑恶的东西存在了呢，每个人都有自己的喜好，表达喜好还得解释一下？有时我也在想，这些理解不了喜好和权利的和整天跟随官方各种限制声音后面喊打喊杀的到底是不是同一批人？</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/22/2019-10-22-%E9%83%AD%E6%95%AC%E6%98%8E%E7%9A%84%E4%B8%8A%E7%BA%B2%E4%B8%8A%E7%BA%BF%E5%92%8C%E6%9D%8E%E8%AF%9A%E5%84%92%E7%9A%84%E5%80%9A%E8%80%81%E5%8D%96%E8%80%81/" data-id="ck8tr9s7a001pn29kgm8zd7gy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">吴主任的公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-22-深入理解Java的String" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/22/2019-10-22-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%9A%84String/" class="article-date">
  <time datetime="2019-10-21T16:00:00.000Z" itemprop="datePublished">2019-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/22/2019-10-22-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%9A%84String/">深入理解Java的String</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果要想理解String，那么就需要先理解JVM虚拟机以及String在JVM层的解析.</p>
<h1 id="JVM相关"><a href="#JVM相关" class="headerlink" title="JVM相关"></a>JVM相关</h1><ul>
<li>Java栈：这个是用来存放栈帧的,每个方法被执行的时候就会同时创建一个栈帧用于存储局部变量表，操作栈,动态连接等</li>
<li>Java堆：在虚拟机启动创建时，这里的唯一目的就是存放对象的实例,几乎所有的对象实例都在这里创建分配</li>
<li>方法区：存放每个类的结构信息。</li>
<li>常量池：静态常量池存在于Class文件中,运行时常量池存放一些运行时常量数据.</li>
</ul>
<h1 id="字符串常量池"><a href="#字符串常量池" class="headerlink" title="字符串常量池"></a>字符串常量池</h1><p>字符串常量池是存在于运行时常量池中(JDK7之前存在运行时常量池中,JDK7之后转移到了堆中)<br><strong>使用字符串常量池时,每当我们使用字面量(String s = “abc”)创建字符串JVM会首先检查在字符串常量池中是否已经存在”abc”如果存在就将字符串对象的地址赋值给引用s,如果不存在字符串常量池中就会实例化该字符串并将”abc”放入常量池中,并将此字符串对象的地址赋值给引用s</strong></p>
<p><strong>当我们使用关键字new(String s = new String(“abc”))创建字符串时如果“abc”不在字符串常量池中我们就会实例化给字符串并将其放入常量池中,然后在堆中复制一个副本，然后将堆中的对象的地址赋值给s;如果给字符串存在字符串常量中那么就不在再字符串常量池创建”abc”，而是在堆中直接复制一个副本然后将堆中对象的地址赋值给s</strong></p>
<h1 id="String在JVM层解析"><a href="#String在JVM层解析" class="headerlink" title="String在JVM层解析"></a>String在JVM层解析</h1><h3 id="创建字符串的两种形式"><a href="#创建字符串的两种形式" class="headerlink" title="创建字符串的两种形式:"></a>创建字符串的两种形式:</h3><ol>
<li>String s1 = “abc”;</li>
<li>String s2 = new String(“abc”);</li>
</ol>
<p><img src="/img/in-post/20180827123540873.png" alt=""></p>
<p>s1使用字面量创建字符串在编译期的时候判断“abc”是否存在于字符串常量池中如果存在就直接返回对象的引用。<br>s2使用关键字new创建字符串，如果“abc”存在于字符串常量池中我们就在堆中创建一个副本然后将堆中的地址赋值给s2，否则就在字符串常量池中创建“abc”然后在堆中创建副本再将堆中的地址赋值给s2.<br><strong>他们之间的区别就是一个直接将字符串常量池中的引用给s，一个是将堆中的引用赋值给new出来的s2</strong></p>
<h3 id="“-”连接形式创建的字符串"><a href="#“-”连接形式创建的字符串" class="headerlink" title="“+”连接形式创建的字符串"></a>“+”连接形式创建的字符串</h3><ul>
<li>String s = “a”+”b”+”c”</li>
</ul>
<p><img src="/img/in-post/20180827123632152.png" alt=""></p>
<p>这种全是常量的字符串会再编译期间直接录入字符串常量池中，同时还需要判断“abc”是否存在字符串常量池中。</p>
<ul>
<li>String s2 = “1”+”3”+new String(“1”)+”4”</li>
</ul>
<p><img src="/img/in-post/20180827123647339.png" alt=""></p>
<p>因为+号连接符中有new关键字所有我们无法在编译期间无法知道s2的值，因此先处理“1”+“3”的字符串首先拼接然后将其放入字符串常量池中形成“13”，然后接着在字符串常量池中创建“1”然后将“1”的引用指定给堆中的一个String对象，最后在字符串常量池中创建一个“4”。<br>接下来创建new StringBuilder拼接，最后形成一个新的String然后将它的引用指定给s2。<br>String s2=new StringBuilder(“13”).append(new String(“1”)).append(“4”).toString();</p>
<ul>
<li>String s3=new String(“abc”)+new String(“def”);</li>
</ul>
<p><img src="/img/in-post/20180827123737708.png" alt=""></p>
<p>在程序运行期间首先检查字符串常量池中是否有“abc”如果没有就创建一个然后在堆中创建一个String对象指向“abc”，然后再创建“def”也是先检查是否存在，接下来就堆中创建一个String指向”def”，最终我们通过Stringbuilder在堆中将他们拼接起来形成一个新的String然后将这个String的引用指定给s3。</p>
<blockquote>
<p>参考资料： <a href="https://blog.csdn.net/qq_34490018/article/details/82110578" target="_blank" rel="noopener">https://blog.csdn.net/qq_34490018/article/details/82110578</a> </p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/22/2019-10-22-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%9A%84String/" data-id="ck8tr9s7b001sn29k4z26g4pp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-18-你对周杰伦什么评价？" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/18/2019-10-18-%E4%BD%A0%E5%AF%B9%E5%91%A8%E6%9D%B0%E4%BC%A6%E4%BB%80%E4%B9%88%E8%AF%84%E4%BB%B7%EF%BC%9F/" class="article-date">
  <time datetime="2019-10-17T16:00:00.000Z" itemprop="datePublished">2019-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/18/2019-10-18-%E4%BD%A0%E5%AF%B9%E5%91%A8%E6%9D%B0%E4%BC%A6%E4%BB%80%E4%B9%88%E8%AF%84%E4%BB%B7%EF%BC%9F/">你对周杰伦什么评价？</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>罗大佑和周杰伦到底谁更牛逼？</p>
<p>你为什么会「觉得他以前的《以父之名》《龙拳》《稻香》都是经典」？</p>
<p>关于这两个问题有一个你可能意想不到的角度——一个理论可以完美回答你这两个问题！详情请看下面的文章《永远的十四岁》。</p>
<p>周杰伦是上等人还是下等人？</p>
<p>你知道吗，我这几年在微博上陆陆续续嘲笑过的种种「下等人」的行为，比如我说：管马桶叫「坐便器」的都是下等人，或者：「名表」在很多时候的确是一种身份标志——下等人的身份标志，看起来好像很随机没什么联系，但是很大一部分都可以归结为同一种行为：</p>
<p>装逼。</p>
<p>概括地说：</p>
<p>爱「装」的人都是下等人。没错，人分上等人跟下等人。</p>
<p>至于周杰伦到底是上等人还是下等人，说实话我不是很确定，不过下面一篇相关的文章《周杰伦是外宾还是内宾？》说不定可以给你提供一个小参考数据，你看了自己判断吧。</p>
<p>如何「总体上」评价周杰伦？</p>
<p>最后是一篇旧文《如何评价周杰伦？》，那篇文章是我两年多前写的，不管是文中讲的套路还是最后的结论，放在现在好像也很适用。</p>
<p>我就不剧透了，你自己看吧。</p>
<p>全文 5100 字。
　　</p>
<p>永远的十四岁<br>一​</p>
<p>大概是去年五月吧，我去上海梅赛德斯中心听了一场罗大佑老师的演唱会，演唱会的题目是《当年离家的年轻人》。</p>
<p>说真的我对这场演唱会还是相当地期待的——罗大佑老师是我多年的​音乐偶像。</p>
<p>大学的时候谈恋爱，我应该是逼着每一个跟我约会的女生都听过罗大佑，还会没完没了地给人家讲解罗大佑音乐、歌词里的深意、精妙、种种另我感动不已的细节。</p>
<p>有不少这样的「感悟」讲得次数多了成了固定的、精彩的段子，被我当成了泡妞的套路，后来又重复过很多次，但好像每次还是能把我自己感动了。哈哈有几个我到现在还记得，前两年在分答上回答问题还搬出来使用过。</p>
<p>当年原版磁带、 CD 国内不好卖，美籍同学苏立去台湾玩儿，问我有什么要带的东西，我特意让她带了一张罗大佑八四年演唱会的实况《青春舞曲》。一个小细节，那时候台湾的每一张收据上都印着这么一句话：防匪防谍，人人有责。</p>
<p>怎么样，有时代感吧？</p>
<p>后来出国上学、工作，随着年龄越来越大，罗大佑听得少了。经常是把那张《青春舞曲》都拿起来了，结果又放下，换了一张其他的唱片。</p>
<p>你发现没有，音乐有一种神奇的功能，会一下子把你带回以前的某一个时刻、某一种无比真实的情绪中去。等你像我这把年纪了可能会理解，去听年轻时候热爱的音乐有时候需要点儿勇气。</p>
<p>不是不再喜欢，而是不想在忙了一天很累的时候被一下子弄得瞎动感情。</p>
<p>二</p>
<p>好吧不瞎感慨了，用数据说话。</p>
<p>哈佛大学经济学博士谷歌前数据科学家畅销书《Everybody Lies》作者 Seth Stephens-Davidowitz 做过这么一个研究。</p>
<p>他统计、研究了 Spotify（类似于QQ音乐）上某一首歌播放次数和听者年龄的关系，统计包括了从一九六〇年到二〇〇〇年所有Billboard榜单冠军歌曲。惊人的发现是，从统计上看，每个人最喜欢的歌几乎都是他们十四岁那年发行的！</p>
<p>Source: analysis of Spotify data by Seth Stephens-DavidowitzSource: analysis of Spotify data by Seth Stephens-Davidowitz</p>
<p>Source: analysis of Spotify data by Seth Stephens-Davidowitz</p>
<p>​​反思了一下，在我身上这个结果相当准确。罗大佑老师的《青春舞曲》专辑是他一九八四年演唱会实况，那一年你猜我几岁？</p>
<p>十四！</p>
<p>我操太准了。</p>
<p>当然，研究显示男生、女生稍有差别——男生最喜欢十四岁那年发行的歌曲，而女生稍早，十三岁是高峰。再仔细看看上面这张图，如果你是一个男生，你二十四岁那年发行的歌对于你音乐偏好的影响还不到十四岁那年的一半！</p>
<p>好吧，咱们拿这个结果套一套周杰伦。</p>
<p>周杰伦大红大紫的差不多是二〇〇三年，这一年他上了《时代》杂志亚洲版封面，被誉为「新一代亚洲流行天王」，同年发布第四张专辑《叶惠美》。</p>
<p>按照上面的研究结果，周杰伦的「标准」粉丝在二〇〇三年差不多是十三、四岁。也就是说，他们应该生于一九九〇年左右，现在三十。</p>
<p>再看看蔡徐坤。</p>
<p>蔡徐坤大红大紫是二〇一八年初，单曲《I Wanna Get Love》上榜，《偶像练习生》夺冠。按照这个十四岁法则，蔡徐坤的核心粉丝群应该是二〇〇四年出生，今年十五。</p>
<p>周杰伦大红大紫的时候蔡徐坤的粉丝还没出生，这完全就是两代人啊！</p>
<p>三</p>
<p>当然，十四岁法则应用在这儿还没那么简单。</p>
<p>首先，十四岁法则说的是具体一首歌曲的爱好者的年龄分布，要延伸到一个「歌手」粉丝年龄的分布，情况要略复杂。</p>
<p>比如要考虑一个歌手「艺术生涯」的长度。</p>
<p>比如周杰伦吧，就是一个艺术生命相当长的人，上面我说他大红大紫是二〇〇三年是简化了，严格地说，从二〇〇一年第二张专辑《范特西》到二〇一〇年《跨时代》这十年里都算是个歌手。</p>
<p>所以，周杰伦的粉丝应该包括了从一九八七到一九九六年出生这十年的跨度，蔡徐坤刚红，就算他的粉丝再年轻再疯狂，毕竟红的时间有限，在数目上还是拼不过周杰伦。</p>
<p>所以一个推论是：艺术生命越长的歌手，粉丝越多。比如我一直不理解林俊杰好在哪儿了，但是你看看人家的艺术生命——人家拼的是时间——我操简直是老少通吃啊。</p>
<p>还有，十四岁法则涉及具体歌曲而不是歌星，所以，另一个推论就是，同样喜欢周杰伦的人，很肯能彼此并不认同。</p>
<p>比如你是因为喜欢《爱在西元前》、《安静》这些歌爱上周杰伦的，你可能会觉得他后来那些「中国风」很土鳖，《七里香》之后的专辑都没法听。反过来也一样，如果你是后来爱上周杰伦的，你会觉得他以前的歌老土。</p>
<p>同样，我觉得罗大佑后来写的什么《皇后大道东》、《恋曲一九九〇》之类简直没法听。而我认识的另一些罗大佑粉丝，反倒觉得这些才是经典。</p>
<p>十四岁法则的另一个缺陷是，有些音乐我很喜欢，比如 The Beatles 或者 Bob Dylan，可是明摆着这些音乐在我出生之前就已经流行了，至少是远在我十四岁之前，那怎么解释呢？</p>
<p>Seth Stephens-Davidowitz 也想到了这个问题，他的解释是他自己跟大众不同——发育反常。我倒觉得我没那么特殊，有一个更简单的解释：</p>
<p>有一类音乐会成为经典——夸代的经典，The Beatles, Bob Dylan, 崔健也许都属于这一类，你不需要跟这个音乐同时代而喜欢，而被影响。</p>
<p>当然这只是我的一个猜测。</p>
<p>崔健的经典专辑《新长征路上的摇滚》发行于八九年四月，当时老罗十五岁。</p>
<p>四</p>
<p>去年罗大佑的上海演唱会，我是带着一种近乎朝圣的心情去的。</p>
<p>当然，除了带了朝圣的心情，还带了两个九〇后美女。</p>
<p>结果很失望。</p>
<p>那天观众席里净是中年父母带着孩子，我旁边有一对夫妇和一个初中男生，那个初中男生从头到尾在手机上打游戏。他爸妈一开始还提醒他要好好看演唱会，后来干脆不管了，自己自顾自地跟着全场中年人群动情地唱「就在那多愁善感初次回忆的青春」去了。</p>
<p>台上的罗大佑，跟《青春舞曲》封面上那个长发墨镜的叛逆青年判若两人。</p>
<p>我多年保留的泡妞段子最后一个都没讲出口。</p>
<p>五</p>
<p>关于这件事，老罗说得极好：</p>
<p>借用托克维尔的句套子来说一下：中年人似乎热爱周杰伦，其实只是讨厌年轻人。
　　　</p>
<p>周杰伦是外宾还是内宾？<br>说两句他在西安演唱会上骂警察的事儿。</p>
<p>记得我头一回在中国看现场演唱会是好几年前有一次从纽约回北京，正好赶上「纵贯线」在工体首演。我进场一坐下，第一印象就是——我操怎么这么多警察啊？整个内场里几十个警察围着观众席站了一圈，感觉不像个演唱会倒像是要公审什么黑帮团伙似的。</p>
<p>我当时拿出照相机对着警察狂拍了一通，准备发 Facebook 搏眼球。你注意过吗，老外拍的中国照片里特爱出现警察，一个特俗特常见的套路是天安门，前景是一个没表情的武警士兵，背景是天安门城楼上的毛主席像。</p>
<p>总结一下，拍照小技巧：如果你是老外，你拍的街拍照片上出现警察一定加分；如果你是老中，你拍的街拍照片上出现老外一定加分。不管你是老外还是老中，如果街拍照片上出现流浪猫流浪狗再加分。</p>
<p>但是注意，这个套路反过来不行。</p>
<p>如果你是老外，你在中国的街拍照片上出现老外不仅加不了分还会减分——说明你去的地方不够本土不够新奇，全是外国旅游者。如果你是老中，你没事儿不去拍老外净追着警察瞎拍什么啊——没见过警察？装什么外宾啊。</p>
<p>反思一下，那天我在纵贯线演唱会上拍警察就很有装外宾的嫌疑。</p>
<p>所以，怎么看周杰伦在演唱会上骂警察这件事？</p>
<p>道理是一样的——这取决于你认为周杰伦是老外还是老中，是外宾还是内宾。</p>
<p>如果你觉得他是个老外，那在演唱会上看到警察维持秩序觉得新奇、不习惯、甚至愤怒什么的完全可以理解。但如果你觉得他是个老中，这么做就有点大惊小怪，有装逼的嫌疑了。</p>
<p>周杰伦不是特爱说「中文歌才是最屌的」吗？</p>
<p>感觉上他自己还挺爱扮老中的。
　　　　　</p>
<p>如何评价周杰伦？​<br>听我干巴巴地评价周杰伦多没意思，褚老师给你讲一个简单、有效、实用的回答问题的套路吧，这个套路不仅适用于回答对周杰伦如何评价这类问题，还会对你工作、学习、相亲、面试什么的都有用，哎呀太有用了。</p>
<p>二〇〇二年夏天我在北京嘉里中心的一家公司实习，那时候东三环周边还在建设中，财富中心、国贸三期、央视大裤衩之类的地标建筑都没出现，嘉里中心周围是一片工地。</p>
<p>印象深刻的有两件事。</p>
<p>一件是我当年的经理讲的，他说有一天他加班加到很晚决定去楼下街上洗个头放松一下（没错，嘉里中心这样一个现在寸土寸金的地方当年周边还有很多小发廊），他说洗头的服务人员跟他礼貌地寒暄，说：您在附近工作？他说：是啊，我就在嘉里中心上班。然后那个女的很狐疑地说：不对啊，嘉里中心不是已经完工了吗？</p>
<p>这个工种被称为「码农」不是没有道理的。</p>
<p>还有一件，其实也算不上是什么事儿，就是每天上下班经过那些工地在工地围墙上随处可见的一首「诗」，当时我能完整地背下来，现在只记得一句：争做首都文明人，我不随地大小便。</p>
<p>好吧，扯得有点儿远了。</p>
<p>我想说的是有一天我在嘉里中心一楼的大堂里意外地碰上了一个老熟人。这人叫方文嘉，原来在北大附中就认识，比我小一级，后来在波士顿又碰到过，当时她在普林斯顿读计算机方面的博士，她导师跳槽去了哈佛，于是她也就跟着去了波士顿。我本来在伊利诺伊上学，那年夏天正好去波士顿实习，然后我们又都被另一个在哈佛的北大附中的同学胡晓江拉去排话剧，就这么成了熟人。那是一九九九年。</p>
<p>在嘉里中心见到方文嘉之前我已经三年没见过这人了，忽然在北京的同一幢楼里出现绝对是有点吃惊。约了吃午饭。她说她博士毕业之后先是创业了一段，没成，不想干老本行又不知道干什么好于是只好去做咨询，男朋友在国内发展，所以她就跟着回国去了麦肯锡北京办公室——麦肯锡当时也在嘉里中心。</p>
<p>我当时正考虑要不要做咨询，所以问她：</p>
<p>「你后悔了吗？」</p>
<p>她说：</p>
<p>「你问了三个问题：第一个，我转行后没后悔；第二个，我回国后没后悔；第三个，我去麦肯锡后没后悔。」</p>
<p>她回答问题的语气、表情、套路跟三年前比像换了一个人。你瞧，经过麦肯锡这么一家职业忽悠公司锻炼的人感觉就是不一样。</p>
<p>这个套路的第一步就是：</p>
<p>不直接回答原问题。</p>
<p>这一步很关键，被提问者带着走是回答问题的大忌，这样很容易让场面按照别人引导的方向发展甚至落入圈套。不信你可以研究一下牛逼新闻发布会的套路，不管是中国的还是美国的，发言人很少听过问题上来就直接回答，但是好的发言人或者政客也不会子说自话不回答问题，他们会运用套路的第二步：</p>
<p>分解、转化原问题。</p>
<p>这样做的目的不是为了转移话题，而是为了：</p>
<p>（一）把问题清晰化。用自己的解读去重新构造问题，跟听众交代清楚你要回答问题中所隐含的所有条件和假设，避免别人对答案的误读。</p>
<p>（二）把问题结构化，把一个大问题分解成几个小问题，可以让你的思维和答案都更有结构、层次，避免那种想到哪儿说到哪儿「一团意面」类的答案。</p>
<p>（三）把问题立体化，提供对同一个问题几个不同的角度，这样可以增加你思维的空间维度，使得答案变得更有深度。这么做的另一个好处是可以拖时间增加篇幅，别人一句话答案之后就没话说了，而你可以侃侃而谈说上半天。</p>
<p>（四）把让你不舒服的问题变成让你舒服的问题。说白了，就是把你不想回答的问题转化成你想回答的问题，把你不知道答案的问题变成你知道答案的问题。</p>
<p>分解、转化问题好，那么，该分解成几个问题呢？具体情况具体分析？错！这个套路的第三个要点是：</p>
<p>三是神奇的数字。</p>
<p>一个哈佛商学院毕业的朋友说，他们班上有一个同学上课特爱发言，不管什么课什么教授说什么话题什么案例他都得插上几句，而且每次都是用同一个开场白：</p>
<p>Three things come to mind …… 想到三件事 ……</p>
<p>有一回一个教授被弄得有点儿烦了，半开玩笑地说：你原来是麦肯锡的吧？</p>
<p>这人上商学院之前还真是麦肯锡的。</p>
<p>我想说的是啊，三是一个神奇的数字，不管什么问题你永远可以不过脑子地先说有三点，结果往往听起来都挺像那么回事。「想到三件事」是一个不错的套路，更好的是方文嘉用的那个：「你问了三个问题」——听着就很牛逼很唬人。</p>
<p>好，课讲完了，下面是课后练习。</p>
<p>练习一：</p>
<p>你去一家从事手机、高科技的公司面试，面试官问你：</p>
<p>你对苹果什么评价？</p>
<p>你该怎么回答呢？说你对苹果的热爱？说你对乔布斯的崇拜？说你觉得苹果用户体验太差？预测苹果新机的颜色、销量？你要是这么稀里糊涂地开始回答，结果只能是一团糟。套用褚老师刚教你的套路，你可以说：</p>
<p>您问了三个问题：一、我对苹果手机这个产品怎么评价，二、我对苹果公司这家企业怎么评价，三、我对苹果（拥有巨大数目铁粉的）这个现象怎么评价。</p>
<p>怎么样，感觉来了吧？</p>
<p>练习二：</p>
<p>有人问，你对周杰伦什么评价？</p>
<p>套路是一样的，你可以说：</p>
<p>你问了三个问题：一、周杰伦的音乐，二、周杰伦这个人，三、周杰伦流行的这个现象。</p>
<p>褚老师的答案是：一、难听，二、不讨厌，三、中国屌丝多。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/18/2019-10-18-%E4%BD%A0%E5%AF%B9%E5%91%A8%E6%9D%B0%E4%BC%A6%E4%BB%80%E4%B9%88%E8%AF%84%E4%BB%B7%EF%BC%9F/" data-id="ck8tr9s79001nn29k0u721519" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" rel="tag">褚明宇</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
          </li>
        
          <li>
            <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
          </li>
        
          <li>
            <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
          </li>
        
          <li>
            <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/index/" data-id="ckgafe0bn002w5z9khz5ffwye" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fancybox/jquery.fancybox" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/fancybox/jquery.fancybox/" class="article-date">
  <time datetime="2020-10-15T03:18:44.737Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/fancybox/jquery.fancybox/">fancybox/jquery.fancybox</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        /*! fancyBox v2.1.5 fancyapps.com | fancyapps.com/fancybox/#license */
.fancybox-wrap,
.fancybox-skin,
.fancybox-outer,
.fancybox-inner,
.fancybox-image,
.fancybox-wrap iframe,
.fancybox-wrap object,
.fancybox-nav,
.fancybox-nav span,
.fancybox-tmp
{
	padding: 0;
	margin: 0;
	border: 0;
	outline: none;
	vertical-align: top;
}

.fancybox-wrap {
	position: absolute;
	top: 0;
	left: 0;
	z-index: 8020;
}

.fancybox-skin {
	position: relative;
	background: #f9f9f9;
	color: #444;
	text-shadow: none;
	-webkit-border-radius: 4px;
	   -moz-border-radius: 4px;
	        border-radius: 4px;
}

.fancybox-opened {
	z-index: 8030;
}

.fancybox-opened .fancybox-skin {
	-webkit-box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
	   -moz-box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
	        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
}

.fancybox-outer, .fancybox-inner {
	position: relative;
}

.fancybox-inner {
	overflow: hidden;
}

.fancybox-type-iframe .fancybox-inner {
	-webkit-overflow-scrolling: touch;
}

.fancybox-error {
	color: #444;
	font: 14px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
	margin: 0;
	padding: 15px;
	white-space: nowrap;
}

.fancybox-image, .fancybox-iframe {
	display: block;
	width: 100%;
	height: 100%;
}

.fancybox-image {
	max-width: 100%;
	max-height: 100%;
}

#fancybox-loading, .fancybox-close, .fancybox-prev span, .fancybox-next span {
	background-image: url(fancybox_sprite.png);
}

#fancybox-loading {
	position: fixed;
	top: 50%;
	left: 50%;
	margin-top: -22px;
	margin-left: -22px;
	background-position: 0 -108px;
	opacity: 0.8;
	cursor: pointer;
	z-index: 8060;
}

#fancybox-loading div {
	width: 44px;
	height: 44px;
	background: url(fancybox_loading.gif) center center no-repeat;
}

.fancybox-close {
	position: absolute;
	top: -18px;
	right: -18px;
	width: 36px;
	height: 36px;
	cursor: pointer;
	z-index: 8040;
}

.fancybox-nav {
	position: absolute;
	top: 0;
	width: 40%;
	height: 100%;
	cursor: pointer;
	text-decoration: none;
	background: transparent url(blank.gif); /* helps IE */
	-webkit-tap-highlight-color: rgba(0,0,0,0);
	z-index: 8040;
}

.fancybox-prev {
	left: 0;
}

.fancybox-next {
	right: 0;
}

.fancybox-nav span {
	position: absolute;
	top: 50%;
	width: 36px;
	height: 34px;
	margin-top: -18px;
	cursor: pointer;
	z-index: 8040;
	visibility: hidden;
}

.fancybox-prev span {
	left: 10px;
	background-position: 0 -36px;
}

.fancybox-next span {
	right: 10px;
	background-position: 0 -72px;
}

.fancybox-nav:hover span {
	visibility: visible;
}

.fancybox-tmp {
	position: absolute;
	top: -99999px;
	left: -99999px;
	max-width: 99999px;
	max-height: 99999px;
	overflow: visible !important;
}

/* Overlay helper */

.fancybox-lock {
    overflow: visible !important;
    width: auto;
}

.fancybox-lock body {
    overflow: hidden !important;
}

.fancybox-lock-test {
    overflow-y: hidden !important;
}

.fancybox-overlay {
	position: absolute;
	top: 0;
	left: 0;
	overflow: hidden;
	display: none;
	z-index: 8010;
	background: url(fancybox_overlay.png);
}

.fancybox-overlay-fixed {
	position: fixed;
	bottom: 0;
	right: 0;
}

.fancybox-lock .fancybox-overlay {
	overflow: auto;
	overflow-y: scroll;
}

/* Title helper */

.fancybox-title {
	visibility: hidden;
	font: normal 13px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
	position: relative;
	text-shadow: none;
	z-index: 8050;
}

.fancybox-opened .fancybox-title {
	visibility: visible;
}

.fancybox-title-float-wrap {
	position: absolute;
	bottom: 0;
	right: 50%;
	margin-bottom: -35px;
	z-index: 8050;
	text-align: center;
}

.fancybox-title-float-wrap .child {
	display: inline-block;
	margin-right: -100%;
	padding: 2px 20px;
	background: transparent; /* Fallback for web browsers that doesn't support RGBa */
	background: rgba(0, 0, 0, 0.8);
	-webkit-border-radius: 15px;
	   -moz-border-radius: 15px;
	        border-radius: 15px;
	text-shadow: 0 1px 2px #222;
	color: #FFF;
	font-weight: bold;
	line-height: 24px;
	white-space: nowrap;
}

.fancybox-title-outside-wrap {
	position: relative;
	margin-top: 10px;
	color: #fff;
}

.fancybox-title-inside-wrap {
	padding-top: 10px;
}

.fancybox-title-over-wrap {
	position: absolute;
	bottom: 0;
	left: 0;
	color: #fff;
	padding: 10px;
	background: #000;
	background: rgba(0, 0, 0, .8);
}

/*Retina graphics!*/
@media only screen and (-webkit-min-device-pixel-ratio: 1.5),
	   only screen and (min--moz-device-pixel-ratio: 1.5),
	   only screen and (min-device-pixel-ratio: 1.5){

	#fancybox-loading, .fancybox-close, .fancybox-prev span, .fancybox-next span {
		background-image: url(fancybox_sprite@2x.png);
		background-size: 44px 152px; /*The size of the normal image, half the size of the hi-res image*/
	}

	#fancybox-loading div {
		background-image: url(fancybox_loading@2x.gif);
		background-size: 24px 24px; /*The size of the normal image, half the size of the hi-res image*/
	}
}
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/fancybox/jquery.fancybox/" data-id="ckgafe0c2002z5z9k7oah6sb1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fancybox/jquery.fancybox.pack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/fancybox/jquery.fancybox.pack/" class="article-date">
  <time datetime="2020-10-15T03:18:44.737Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/fancybox/jquery.fancybox.pack/">fancybox/jquery.fancybox.pack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        /*! fancyBox v2.1.5 fancyapps.com | fancyapps.com/fancybox/#license */
(function(s,H,f,w){var K=f("html"),q=f(s),p=f(H),b=f.fancybox=function(){b.open.apply(this,arguments)},J=navigator.userAgent.match(/msie/i),C=null,t=H.createTouch!==w,u=function(a){return a&&a.hasOwnProperty&&a instanceof f},r=function(a){return a&&"string"===f.type(a)},F=function(a){return r(a)&&0<a.indexOf("%")},m=function(a,d){var e=parseInt(a,10)||0;d&&F(a)&&(e*=b.getViewport()[d]/100);return Math.ceil(e)},x=function(a,b){return m(a,b)+"px"};f.extend(b,{version:"2.1.5",defaults:{padding:15,margin:20,
width:800,height:600,minWidth:100,minHeight:100,maxWidth:9999,maxHeight:9999,pixelRatio:1,autoSize:!0,autoHeight:!1,autoWidth:!1,autoResize:!0,autoCenter:!t,fitToView:!0,aspectRatio:!1,topRatio:0.5,leftRatio:0.5,scrolling:"auto",wrapCSS:"",arrows:!0,closeBtn:!0,closeClick:!1,nextClick:!1,mouseWheel:!0,autoPlay:!1,playSpeed:3E3,preload:3,modal:!1,loop:!0,ajax:{dataType:"html",headers:{"X-fancyBox":!0}},iframe:{scrolling:"auto",preload:!0},swf:{wmode:"transparent",allowfullscreen:"true",allowscriptaccess:"always"},
keys:{next:{13:"left",34:"up",39:"left",40:"up"},prev:{8:"right",33:"down",37:"right",38:"down"},close:[27],play:[32],toggle:[70]},direction:{next:"left",prev:"right"},scrollOutside:!0,index:0,type:null,href:null,content:null,title:null,tpl:{wrap:'<div class="fancybox-wrap" tabIndex="-1"><div class="fancybox-skin"><div class="fancybox-outer"><div class="fancybox-inner"></div></div></div></div>',image:'<img class="fancybox-image" src="{href}" alt="" />',iframe:'<iframe id="fancybox-frame{rnd}" name="fancybox-frame{rnd}" class="fancybox-iframe" frameborder="0" vspace="0" hspace="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen'+
(J?' allowtransparency="true"':"")+"></iframe>",error:'<p class="fancybox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',closeBtn:'<a title="Close" class="fancybox-item fancybox-close" href="javascript:;"></a>',next:'<a title="Next" class="fancybox-nav fancybox-next" href="javascript:;"><span></span></a>',prev:'<a title="Previous" class="fancybox-nav fancybox-prev" href="javascript:;"><span></span></a>'},openEffect:"fade",openSpeed:250,openEasing:"swing",openOpacity:!0,
openMethod:"zoomIn",closeEffect:"fade",closeSpeed:250,closeEasing:"swing",closeOpacity:!0,closeMethod:"zoomOut",nextEffect:"elastic",nextSpeed:250,nextEasing:"swing",nextMethod:"changeIn",prevEffect:"elastic",prevSpeed:250,prevEasing:"swing",prevMethod:"changeOut",helpers:{overlay:!0,title:!0},onCancel:f.noop,beforeLoad:f.noop,afterLoad:f.noop,beforeShow:f.noop,afterShow:f.noop,beforeChange:f.noop,beforeClose:f.noop,afterClose:f.noop},group:{},opts:{},previous:null,coming:null,current:null,isActive:!1,
isOpen:!1,isOpened:!1,wrap:null,skin:null,outer:null,inner:null,player:{timer:null,isActive:!1},ajaxLoad:null,imgPreload:null,transitions:{},helpers:{},open:function(a,d){if(a&&(f.isPlainObject(d)||(d={}),!1!==b.close(!0)))return f.isArray(a)||(a=u(a)?f(a).get():[a]),f.each(a,function(e,c){var l={},g,h,k,n,m;"object"===f.type(c)&&(c.nodeType&&(c=f(c)),u(c)?(l={href:c.data("fancybox-href")||c.attr("href"),title:f("<div/>").text(c.data("fancybox-title")||c.attr("title")).html(),isDom:!0,element:c},
f.metadata&&f.extend(!0,l,c.metadata())):l=c);g=d.href||l.href||(r(c)?c:null);h=d.title!==w?d.title:l.title||"";n=(k=d.content||l.content)?"html":d.type||l.type;!n&&l.isDom&&(n=c.data("fancybox-type"),n||(n=(n=c.prop("class").match(/fancybox\.(\w+)/))?n[1]:null));r(g)&&(n||(b.isImage(g)?n="image":b.isSWF(g)?n="swf":"#"===g.charAt(0)?n="inline":r(c)&&(n="html",k=c)),"ajax"===n&&(m=g.split(/\s+/,2),g=m.shift(),m=m.shift()));k||("inline"===n?g?k=f(r(g)?g.replace(/.*(?=#[^\s]+$)/,""):g):l.isDom&&(k=c):
"html"===n?k=g:n||g||!l.isDom||(n="inline",k=c));f.extend(l,{href:g,type:n,content:k,title:h,selector:m});a[e]=l}),b.opts=f.extend(!0,{},b.defaults,d),d.keys!==w&&(b.opts.keys=d.keys?f.extend({},b.defaults.keys,d.keys):!1),b.group=a,b._start(b.opts.index)},cancel:function(){var a=b.coming;a&&!1===b.trigger("onCancel")||(b.hideLoading(),a&&(b.ajaxLoad&&b.ajaxLoad.abort(),b.ajaxLoad=null,b.imgPreload&&(b.imgPreload.onload=b.imgPreload.onerror=null),a.wrap&&a.wrap.stop(!0,!0).trigger("onReset").remove(),
b.coming=null,b.current||b._afterZoomOut(a)))},close:function(a){b.cancel();!1!==b.trigger("beforeClose")&&(b.unbindEvents(),b.isActive&&(b.isOpen&&!0!==a?(b.isOpen=b.isOpened=!1,b.isClosing=!0,f(".fancybox-item, .fancybox-nav").remove(),b.wrap.stop(!0,!0).removeClass("fancybox-opened"),b.transitions[b.current.closeMethod]()):(f(".fancybox-wrap").stop(!0).trigger("onReset").remove(),b._afterZoomOut())))},play:function(a){var d=function(){clearTimeout(b.player.timer)},e=function(){d();b.current&&b.player.isActive&&
(b.player.timer=setTimeout(b.next,b.current.playSpeed))},c=function(){d();p.unbind(".player");b.player.isActive=!1;b.trigger("onPlayEnd")};!0===a||!b.player.isActive&&!1!==a?b.current&&(b.current.loop||b.current.index<b.group.length-1)&&(b.player.isActive=!0,p.bind({"onCancel.player beforeClose.player":c,"onUpdate.player":e,"beforeLoad.player":d}),e(),b.trigger("onPlayStart")):c()},next:function(a){var d=b.current;d&&(r(a)||(a=d.direction.next),b.jumpto(d.index+1,a,"next"))},prev:function(a){var d=
b.current;d&&(r(a)||(a=d.direction.prev),b.jumpto(d.index-1,a,"prev"))},jumpto:function(a,d,e){var c=b.current;c&&(a=m(a),b.direction=d||c.direction[a>=c.index?"next":"prev"],b.router=e||"jumpto",c.loop&&(0>a&&(a=c.group.length+a%c.group.length),a%=c.group.length),c.group[a]!==w&&(b.cancel(),b._start(a)))},reposition:function(a,d){var e=b.current,c=e?e.wrap:null,l;c&&(l=b._getPosition(d),a&&"scroll"===a.type?(delete l.position,c.stop(!0,!0).animate(l,200)):(c.css(l),e.pos=f.extend({},e.dim,l)))},
update:function(a){var d=a&&a.originalEvent&&a.originalEvent.type,e=!d||"orientationchange"===d;e&&(clearTimeout(C),C=null);b.isOpen&&!C&&(C=setTimeout(function(){var c=b.current;c&&!b.isClosing&&(b.wrap.removeClass("fancybox-tmp"),(e||"load"===d||"resize"===d&&c.autoResize)&&b._setDimension(),"scroll"===d&&c.canShrink||b.reposition(a),b.trigger("onUpdate"),C=null)},e&&!t?0:300))},toggle:function(a){b.isOpen&&(b.current.fitToView="boolean"===f.type(a)?a:!b.current.fitToView,t&&(b.wrap.removeAttr("style").addClass("fancybox-tmp"),
b.trigger("onUpdate")),b.update())},hideLoading:function(){p.unbind(".loading");f("#fancybox-loading").remove()},showLoading:function(){var a,d;b.hideLoading();a=f('<div id="fancybox-loading"><div></div></div>').click(b.cancel).appendTo("body");p.bind("keydown.loading",function(a){27===(a.which||a.keyCode)&&(a.preventDefault(),b.cancel())});b.defaults.fixed||(d=b.getViewport(),a.css({position:"absolute",top:0.5*d.h+d.y,left:0.5*d.w+d.x}));b.trigger("onLoading")},getViewport:function(){var a=b.current&&
b.current.locked||!1,d={x:q.scrollLeft(),y:q.scrollTop()};a&&a.length?(d.w=a[0].clientWidth,d.h=a[0].clientHeight):(d.w=t&&s.innerWidth?s.innerWidth:q.width(),d.h=t&&s.innerHeight?s.innerHeight:q.height());return d},unbindEvents:function(){b.wrap&&u(b.wrap)&&b.wrap.unbind(".fb");p.unbind(".fb");q.unbind(".fb")},bindEvents:function(){var a=b.current,d;a&&(q.bind("orientationchange.fb"+(t?"":" resize.fb")+(a.autoCenter&&!a.locked?" scroll.fb":""),b.update),(d=a.keys)&&p.bind("keydown.fb",function(e){var c=
e.which||e.keyCode,l=e.target||e.srcElement;if(27===c&&b.coming)return!1;e.ctrlKey||e.altKey||e.shiftKey||e.metaKey||l&&(l.type||f(l).is("[contenteditable]"))||f.each(d,function(d,l){if(1<a.group.length&&l[c]!==w)return b[d](l[c]),e.preventDefault(),!1;if(-1<f.inArray(c,l))return b[d](),e.preventDefault(),!1})}),f.fn.mousewheel&&a.mouseWheel&&b.wrap.bind("mousewheel.fb",function(d,c,l,g){for(var h=f(d.target||null),k=!1;h.length&&!(k||h.is(".fancybox-skin")||h.is(".fancybox-wrap"));)k=h[0]&&!(h[0].style.overflow&&
"hidden"===h[0].style.overflow)&&(h[0].clientWidth&&h[0].scrollWidth>h[0].clientWidth||h[0].clientHeight&&h[0].scrollHeight>h[0].clientHeight),h=f(h).parent();0!==c&&!k&&1<b.group.length&&!a.canShrink&&(0<g||0<l?b.prev(0<g?"down":"left"):(0>g||0>l)&&b.next(0>g?"up":"right"),d.preventDefault())}))},trigger:function(a,d){var e,c=d||b.coming||b.current;if(c){f.isFunction(c[a])&&(e=c[a].apply(c,Array.prototype.slice.call(arguments,1)));if(!1===e)return!1;c.helpers&&f.each(c.helpers,function(d,e){if(e&&
b.helpers[d]&&f.isFunction(b.helpers[d][a]))b.helpers[d][a](f.extend(!0,{},b.helpers[d].defaults,e),c)})}p.trigger(a)},isImage:function(a){return r(a)&&a.match(/(^data:image\/.*,)|(\.(jp(e|g|eg)|gif|png|bmp|webp|svg)((\?|#).*)?$)/i)},isSWF:function(a){return r(a)&&a.match(/\.(swf)((\?|#).*)?$/i)},_start:function(a){var d={},e,c;a=m(a);e=b.group[a]||null;if(!e)return!1;d=f.extend(!0,{},b.opts,e);e=d.margin;c=d.padding;"number"===f.type(e)&&(d.margin=[e,e,e,e]);"number"===f.type(c)&&(d.padding=[c,c,
c,c]);d.modal&&f.extend(!0,d,{closeBtn:!1,closeClick:!1,nextClick:!1,arrows:!1,mouseWheel:!1,keys:null,helpers:{overlay:{closeClick:!1}}});d.autoSize&&(d.autoWidth=d.autoHeight=!0);"auto"===d.width&&(d.autoWidth=!0);"auto"===d.height&&(d.autoHeight=!0);d.group=b.group;d.index=a;b.coming=d;if(!1===b.trigger("beforeLoad"))b.coming=null;else{c=d.type;e=d.href;if(!c)return b.coming=null,b.current&&b.router&&"jumpto"!==b.router?(b.current.index=a,b[b.router](b.direction)):!1;b.isActive=!0;if("image"===
c||"swf"===c)d.autoHeight=d.autoWidth=!1,d.scrolling="visible";"image"===c&&(d.aspectRatio=!0);"iframe"===c&&t&&(d.scrolling="scroll");d.wrap=f(d.tpl.wrap).addClass("fancybox-"+(t?"mobile":"desktop")+" fancybox-type-"+c+" fancybox-tmp "+d.wrapCSS).appendTo(d.parent||"body");f.extend(d,{skin:f(".fancybox-skin",d.wrap),outer:f(".fancybox-outer",d.wrap),inner:f(".fancybox-inner",d.wrap)});f.each(["Top","Right","Bottom","Left"],function(a,b){d.skin.css("padding"+b,x(d.padding[a]))});b.trigger("onReady");
if("inline"===c||"html"===c){if(!d.content||!d.content.length)return b._error("content")}else if(!e)return b._error("href");"image"===c?b._loadImage():"ajax"===c?b._loadAjax():"iframe"===c?b._loadIframe():b._afterLoad()}},_error:function(a){f.extend(b.coming,{type:"html",autoWidth:!0,autoHeight:!0,minWidth:0,minHeight:0,scrolling:"no",hasError:a,content:b.coming.tpl.error});b._afterLoad()},_loadImage:function(){var a=b.imgPreload=new Image;a.onload=function(){this.onload=this.onerror=null;b.coming.width=
this.width/b.opts.pixelRatio;b.coming.height=this.height/b.opts.pixelRatio;b._afterLoad()};a.onerror=function(){this.onload=this.onerror=null;b._error("image")};a.src=b.coming.href;!0!==a.complete&&b.showLoading()},_loadAjax:function(){var a=b.coming;b.showLoading();b.ajaxLoad=f.ajax(f.extend({},a.ajax,{url:a.href,error:function(a,e){b.coming&&"abort"!==e?b._error("ajax",a):b.hideLoading()},success:function(d,e){"success"===e&&(a.content=d,b._afterLoad())}}))},_loadIframe:function(){var a=b.coming,
d=f(a.tpl.iframe.replace(/\{rnd\}/g,(new Date).getTime())).attr("scrolling",t?"auto":a.iframe.scrolling).attr("src",a.href);f(a.wrap).bind("onReset",function(){try{f(this).find("iframe").hide().attr("src","//about:blank").end().empty()}catch(a){}});a.iframe.preload&&(b.showLoading(),d.one("load",function(){f(this).data("ready",1);t||f(this).bind("load.fb",b.update);f(this).parents(".fancybox-wrap").width("100%").removeClass("fancybox-tmp").show();b._afterLoad()}));a.content=d.appendTo(a.inner);a.iframe.preload||
b._afterLoad()},_preloadImages:function(){var a=b.group,d=b.current,e=a.length,c=d.preload?Math.min(d.preload,e-1):0,f,g;for(g=1;g<=c;g+=1)f=a[(d.index+g)%e],"image"===f.type&&f.href&&((new Image).src=f.href)},_afterLoad:function(){var a=b.coming,d=b.current,e,c,l,g,h;b.hideLoading();if(a&&!1!==b.isActive)if(!1===b.trigger("afterLoad",a,d))a.wrap.stop(!0).trigger("onReset").remove(),b.coming=null;else{d&&(b.trigger("beforeChange",d),d.wrap.stop(!0).removeClass("fancybox-opened").find(".fancybox-item, .fancybox-nav").remove());
b.unbindEvents();e=a.content;c=a.type;l=a.scrolling;f.extend(b,{wrap:a.wrap,skin:a.skin,outer:a.outer,inner:a.inner,current:a,previous:d});g=a.href;switch(c){case "inline":case "ajax":case "html":a.selector?e=f("<div>").html(e).find(a.selector):u(e)&&(e.data("fancybox-placeholder")||e.data("fancybox-placeholder",f('<div class="fancybox-placeholder"></div>').insertAfter(e).hide()),e=e.show().detach(),a.wrap.bind("onReset",function(){f(this).find(e).length&&e.hide().replaceAll(e.data("fancybox-placeholder")).data("fancybox-placeholder",
!1)}));break;case "image":e=a.tpl.image.replace(/\{href\}/g,g);break;case "swf":e='<object id="fancybox-swf" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="movie" value="'+g+'"></param>',h="",f.each(a.swf,function(a,b){e+='<param name="'+a+'" value="'+b+'"></param>';h+=" "+a+'="'+b+'"'}),e+='<embed src="'+g+'" type="application/x-shockwave-flash" width="100%" height="100%"'+h+"></embed></object>"}u(e)&&e.parent().is(a.inner)||a.inner.append(e);b.trigger("beforeShow");
a.inner.css("overflow","yes"===l?"scroll":"no"===l?"hidden":l);b._setDimension();b.reposition();b.isOpen=!1;b.coming=null;b.bindEvents();if(!b.isOpened)f(".fancybox-wrap").not(a.wrap).stop(!0).trigger("onReset").remove();else if(d.prevMethod)b.transitions[d.prevMethod]();b.transitions[b.isOpened?a.nextMethod:a.openMethod]();b._preloadImages()}},_setDimension:function(){var a=b.getViewport(),d=0,e=!1,c=!1,e=b.wrap,l=b.skin,g=b.inner,h=b.current,c=h.width,k=h.height,n=h.minWidth,v=h.minHeight,p=h.maxWidth,
q=h.maxHeight,t=h.scrolling,r=h.scrollOutside?h.scrollbarWidth:0,y=h.margin,z=m(y[1]+y[3]),s=m(y[0]+y[2]),w,A,u,D,B,G,C,E,I;e.add(l).add(g).width("auto").height("auto").removeClass("fancybox-tmp");y=m(l.outerWidth(!0)-l.width());w=m(l.outerHeight(!0)-l.height());A=z+y;u=s+w;D=F(c)?(a.w-A)*m(c)/100:c;B=F(k)?(a.h-u)*m(k)/100:k;if("iframe"===h.type){if(I=h.content,h.autoHeight&&1===I.data("ready"))try{I[0].contentWindow.document.location&&(g.width(D).height(9999),G=I.contents().find("body"),r&&G.css("overflow-x",
"hidden"),B=G.outerHeight(!0))}catch(H){}}else if(h.autoWidth||h.autoHeight)g.addClass("fancybox-tmp"),h.autoWidth||g.width(D),h.autoHeight||g.height(B),h.autoWidth&&(D=g.width()),h.autoHeight&&(B=g.height()),g.removeClass("fancybox-tmp");c=m(D);k=m(B);E=D/B;n=m(F(n)?m(n,"w")-A:n);p=m(F(p)?m(p,"w")-A:p);v=m(F(v)?m(v,"h")-u:v);q=m(F(q)?m(q,"h")-u:q);G=p;C=q;h.fitToView&&(p=Math.min(a.w-A,p),q=Math.min(a.h-u,q));A=a.w-z;s=a.h-s;h.aspectRatio?(c>p&&(c=p,k=m(c/E)),k>q&&(k=q,c=m(k*E)),c<n&&(c=n,k=m(c/
E)),k<v&&(k=v,c=m(k*E))):(c=Math.max(n,Math.min(c,p)),h.autoHeight&&"iframe"!==h.type&&(g.width(c),k=g.height()),k=Math.max(v,Math.min(k,q)));if(h.fitToView)if(g.width(c).height(k),e.width(c+y),a=e.width(),z=e.height(),h.aspectRatio)for(;(a>A||z>s)&&c>n&&k>v&&!(19<d++);)k=Math.max(v,Math.min(q,k-10)),c=m(k*E),c<n&&(c=n,k=m(c/E)),c>p&&(c=p,k=m(c/E)),g.width(c).height(k),e.width(c+y),a=e.width(),z=e.height();else c=Math.max(n,Math.min(c,c-(a-A))),k=Math.max(v,Math.min(k,k-(z-s)));r&&"auto"===t&&k<B&&
c+y+r<A&&(c+=r);g.width(c).height(k);e.width(c+y);a=e.width();z=e.height();e=(a>A||z>s)&&c>n&&k>v;c=h.aspectRatio?c<G&&k<C&&c<D&&k<B:(c<G||k<C)&&(c<D||k<B);f.extend(h,{dim:{width:x(a),height:x(z)},origWidth:D,origHeight:B,canShrink:e,canExpand:c,wPadding:y,hPadding:w,wrapSpace:z-l.outerHeight(!0),skinSpace:l.height()-k});!I&&h.autoHeight&&k>v&&k<q&&!c&&g.height("auto")},_getPosition:function(a){var d=b.current,e=b.getViewport(),c=d.margin,f=b.wrap.width()+c[1]+c[3],g=b.wrap.height()+c[0]+c[2],c={position:"absolute",
top:c[0],left:c[3]};d.autoCenter&&d.fixed&&!a&&g<=e.h&&f<=e.w?c.position="fixed":d.locked||(c.top+=e.y,c.left+=e.x);c.top=x(Math.max(c.top,c.top+(e.h-g)*d.topRatio));c.left=x(Math.max(c.left,c.left+(e.w-f)*d.leftRatio));return c},_afterZoomIn:function(){var a=b.current;a&&((b.isOpen=b.isOpened=!0,b.wrap.css("overflow","visible").addClass("fancybox-opened"),b.update(),(a.closeClick||a.nextClick&&1<b.group.length)&&b.inner.css("cursor","pointer").bind("click.fb",function(d){f(d.target).is("a")||f(d.target).parent().is("a")||
(d.preventDefault(),b[a.closeClick?"close":"next"]())}),a.closeBtn&&f(a.tpl.closeBtn).appendTo(b.skin).bind("click.fb",function(a){a.preventDefault();b.close()}),a.arrows&&1<b.group.length&&((a.loop||0<a.index)&&f(a.tpl.prev).appendTo(b.outer).bind("click.fb",b.prev),(a.loop||a.index<b.group.length-1)&&f(a.tpl.next).appendTo(b.outer).bind("click.fb",b.next)),b.trigger("afterShow"),a.loop||a.index!==a.group.length-1)?b.opts.autoPlay&&!b.player.isActive&&(b.opts.autoPlay=!1,b.play(!0)):b.play(!1))},
_afterZoomOut:function(a){a=a||b.current;f(".fancybox-wrap").trigger("onReset").remove();f.extend(b,{group:{},opts:{},router:!1,current:null,isActive:!1,isOpened:!1,isOpen:!1,isClosing:!1,wrap:null,skin:null,outer:null,inner:null});b.trigger("afterClose",a)}});b.transitions={getOrigPosition:function(){var a=b.current,d=a.element,e=a.orig,c={},f=50,g=50,h=a.hPadding,k=a.wPadding,n=b.getViewport();!e&&a.isDom&&d.is(":visible")&&(e=d.find("img:first"),e.length||(e=d));u(e)?(c=e.offset(),e.is("img")&&
(f=e.outerWidth(),g=e.outerHeight())):(c.top=n.y+(n.h-g)*a.topRatio,c.left=n.x+(n.w-f)*a.leftRatio);if("fixed"===b.wrap.css("position")||a.locked)c.top-=n.y,c.left-=n.x;return c={top:x(c.top-h*a.topRatio),left:x(c.left-k*a.leftRatio),width:x(f+k),height:x(g+h)}},step:function(a,d){var e,c,f=d.prop;c=b.current;var g=c.wrapSpace,h=c.skinSpace;if("width"===f||"height"===f)e=d.end===d.start?1:(a-d.start)/(d.end-d.start),b.isClosing&&(e=1-e),c="width"===f?c.wPadding:c.hPadding,c=a-c,b.skin[f](m("width"===
f?c:c-g*e)),b.inner[f](m("width"===f?c:c-g*e-h*e))},zoomIn:function(){var a=b.current,d=a.pos,e=a.openEffect,c="elastic"===e,l=f.extend({opacity:1},d);delete l.position;c?(d=this.getOrigPosition(),a.openOpacity&&(d.opacity=0.1)):"fade"===e&&(d.opacity=0.1);b.wrap.css(d).animate(l,{duration:"none"===e?0:a.openSpeed,easing:a.openEasing,step:c?this.step:null,complete:b._afterZoomIn})},zoomOut:function(){var a=b.current,d=a.closeEffect,e="elastic"===d,c={opacity:0.1};e&&(c=this.getOrigPosition(),a.closeOpacity&&
(c.opacity=0.1));b.wrap.animate(c,{duration:"none"===d?0:a.closeSpeed,easing:a.closeEasing,step:e?this.step:null,complete:b._afterZoomOut})},changeIn:function(){var a=b.current,d=a.nextEffect,e=a.pos,c={opacity:1},f=b.direction,g;e.opacity=0.1;"elastic"===d&&(g="down"===f||"up"===f?"top":"left","down"===f||"right"===f?(e[g]=x(m(e[g])-200),c[g]="+=200px"):(e[g]=x(m(e[g])+200),c[g]="-=200px"));"none"===d?b._afterZoomIn():b.wrap.css(e).animate(c,{duration:a.nextSpeed,easing:a.nextEasing,complete:b._afterZoomIn})},
changeOut:function(){var a=b.previous,d=a.prevEffect,e={opacity:0.1},c=b.direction;"elastic"===d&&(e["down"===c||"up"===c?"top":"left"]=("up"===c||"left"===c?"-":"+")+"=200px");a.wrap.animate(e,{duration:"none"===d?0:a.prevSpeed,easing:a.prevEasing,complete:function(){f(this).trigger("onReset").remove()}})}};b.helpers.overlay={defaults:{closeClick:!0,speedOut:200,showEarly:!0,css:{},locked:!t,fixed:!0},overlay:null,fixed:!1,el:f("html"),create:function(a){var d;a=f.extend({},this.defaults,a);this.overlay&&
this.close();d=b.coming?b.coming.parent:a.parent;this.overlay=f('<div class="fancybox-overlay"></div>').appendTo(d&&d.lenth?d:"body");this.fixed=!1;a.fixed&&b.defaults.fixed&&(this.overlay.addClass("fancybox-overlay-fixed"),this.fixed=!0)},open:function(a){var d=this;a=f.extend({},this.defaults,a);this.overlay?this.overlay.unbind(".overlay").width("auto").height("auto"):this.create(a);this.fixed||(q.bind("resize.overlay",f.proxy(this.update,this)),this.update());a.closeClick&&this.overlay.bind("click.overlay",
function(a){if(f(a.target).hasClass("fancybox-overlay"))return b.isActive?b.close():d.close(),!1});this.overlay.css(a.css).show()},close:function(){q.unbind("resize.overlay");this.el.hasClass("fancybox-lock")&&(f(".fancybox-margin").removeClass("fancybox-margin"),this.el.removeClass("fancybox-lock"),q.scrollTop(this.scrollV).scrollLeft(this.scrollH));f(".fancybox-overlay").remove().hide();f.extend(this,{overlay:null,fixed:!1})},update:function(){var a="100%",b;this.overlay.width(a).height("100%");
J?(b=Math.max(H.documentElement.offsetWidth,H.body.offsetWidth),p.width()>b&&(a=p.width())):p.width()>q.width()&&(a=p.width());this.overlay.width(a).height(p.height())},onReady:function(a,b){var e=this.overlay;f(".fancybox-overlay").stop(!0,!0);e||this.create(a);a.locked&&this.fixed&&b.fixed&&(b.locked=this.overlay.append(b.wrap),b.fixed=!1);!0===a.showEarly&&this.beforeShow.apply(this,arguments)},beforeShow:function(a,b){b.locked&&!this.el.hasClass("fancybox-lock")&&(!1!==this.fixPosition&&f("*").filter(function(){return"fixed"===
f(this).css("position")&&!f(this).hasClass("fancybox-overlay")&&!f(this).hasClass("fancybox-wrap")}).addClass("fancybox-margin"),this.el.addClass("fancybox-margin"),this.scrollV=q.scrollTop(),this.scrollH=q.scrollLeft(),this.el.addClass("fancybox-lock"),q.scrollTop(this.scrollV).scrollLeft(this.scrollH));this.open(a)},onUpdate:function(){this.fixed||this.update()},afterClose:function(a){this.overlay&&!b.coming&&this.overlay.fadeOut(a.speedOut,f.proxy(this.close,this))}};b.helpers.title={defaults:{type:"float",
position:"bottom"},beforeShow:function(a){var d=b.current,e=d.title,c=a.type;f.isFunction(e)&&(e=e.call(d.element,d));if(r(e)&&""!==f.trim(e)){d=f('<div class="fancybox-title fancybox-title-'+c+'-wrap">'+e+"</div>");switch(c){case "inside":c=b.skin;break;case "outside":c=b.wrap;break;case "over":c=b.inner;break;default:c=b.skin,d.appendTo("body"),J&&d.width(d.width()),d.wrapInner('<span class="child"></span>'),b.current.margin[2]+=Math.abs(m(d.css("margin-bottom")))}d["top"===a.position?"prependTo":
"appendTo"](c)}}};f.fn.fancybox=function(a){var d,e=f(this),c=this.selector||"",l=function(g){var h=f(this).blur(),k=d,l,m;g.ctrlKey||g.altKey||g.shiftKey||g.metaKey||h.is(".fancybox-wrap")||(l=a.groupAttr||"data-fancybox-group",m=h.attr(l),m||(l="rel",m=h.get(0)[l]),m&&""!==m&&"nofollow"!==m&&(h=c.length?f(c):e,h=h.filter("["+l+'="'+m+'"]'),k=h.index(this)),a.index=k,!1!==b.open(h,a)&&g.preventDefault())};a=a||{};d=a.index||0;c&&!1!==a.live?p.undelegate(c,"click.fb-start").delegate(c+":not('.fancybox-item, .fancybox-nav')",
"click.fb-start",l):e.unbind("click.fb-start").bind("click.fb-start",l);this.filter("[data-fancybox-start=1]").trigger("click");return this};p.ready(function(){var a,d;f.scrollbarWidth===w&&(f.scrollbarWidth=function(){var a=f('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo("body"),b=a.children(),b=b.innerWidth()-b.height(99).innerWidth();a.remove();return b});f.support.fixedPosition===w&&(f.support.fixedPosition=function(){var a=f('<div style="position:fixed;top:20px;"></div>').appendTo("body"),
b=20===a[0].offsetTop||15===a[0].offsetTop;a.remove();return b}());f.extend(b.defaults,{scrollbarWidth:f.scrollbarWidth(),fixed:f.support.fixedPosition,parent:f("body")});a=f(s).width();K.addClass("fancybox-lock-test");d=f(s).width();K.removeClass("fancybox-lock-test");f("<style type='text/css'>.fancybox-margin{margin-right:"+(d-a)+"px;}</style>").appendTo("head")})})(window,document,jQuery);
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/fancybox/jquery.fancybox.pack/" data-id="ckgafe0c300305z9k41kqhhqg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fancybox/jquery.fancybox" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/fancybox/jquery.fancybox/" class="article-date">
  <time datetime="2020-10-15T03:18:44.737Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/fancybox/jquery.fancybox/">fancybox/jquery.fancybox</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        /*!
 * fancyBox - jQuery Plugin
 * version: 2.1.5 (Fri, 14 Jun 2013)
 * requires jQuery v1.6 or later
 *
 * Examples at http://fancyapps.com/fancybox/
 * License: www.fancyapps.com/fancybox/#license
 *
 * Copyright 2012 Janis Skarnelis - janis@fancyapps.com
 *
 */

;(function (window, document, $, undefined) {
	"use strict";

	var H = $("html"),
		W = $(window),
		D = $(document),
		F = $.fancybox = function () {
			F.open.apply( this, arguments );
		},
		IE =  navigator.userAgent.match(/msie/i),
		didUpdate	= null,
		isTouch		= document.createTouch !== undefined,

		isQuery	= function(obj) {
			return obj && obj.hasOwnProperty && obj instanceof $;
		},
		isString = function(str) {
			return str && $.type(str) === "string";
		},
		isPercentage = function(str) {
			return isString(str) && str.indexOf('%') > 0;
		},
		isScrollable = function(el) {
			return (el && !(el.style.overflow && el.style.overflow === 'hidden') && ((el.clientWidth && el.scrollWidth > el.clientWidth) || (el.clientHeight && el.scrollHeight > el.clientHeight)));
		},
		getScalar = function(orig, dim) {
			var value = parseInt(orig, 10) || 0;

			if (dim && isPercentage(orig)) {
				value = F.getViewport()[ dim ] / 100 * value;
			}

			return Math.ceil(value);
		},
		getValue = function(value, dim) {
			return getScalar(value, dim) + 'px';
		};

	$.extend(F, {
		// The current version of fancyBox
		version: '2.1.5',

		defaults: {
			padding : 15,
			margin  : 20,

			width     : 800,
			height    : 600,
			minWidth  : 100,
			minHeight : 100,
			maxWidth  : 9999,
			maxHeight : 9999,
			pixelRatio: 1, // Set to 2 for retina display support

			autoSize   : true,
			autoHeight : false,
			autoWidth  : false,

			autoResize  : true,
			autoCenter  : !isTouch,
			fitToView   : true,
			aspectRatio : false,
			topRatio    : 0.5,
			leftRatio   : 0.5,

			scrolling : 'auto', // 'auto', 'yes' or 'no'
			wrapCSS   : '',

			arrows     : true,
			closeBtn   : true,
			closeClick : false,
			nextClick  : false,
			mouseWheel : true,
			autoPlay   : false,
			playSpeed  : 3000,
			preload    : 3,
			modal      : false,
			loop       : true,

			ajax  : {
				dataType : 'html',
				headers  : { 'X-fancyBox': true }
			},
			iframe : {
				scrolling : 'auto',
				preload   : true
			},
			swf : {
				wmode: 'transparent',
				allowfullscreen   : 'true',
				allowscriptaccess : 'always'
			},

			keys  : {
				next : {
					13 : 'left', // enter
					34 : 'up',   // page down
					39 : 'left', // right arrow
					40 : 'up'    // down arrow
				},
				prev : {
					8  : 'right',  // backspace
					33 : 'down',   // page up
					37 : 'right',  // left arrow
					38 : 'down'    // up arrow
				},
				close  : [27], // escape key
				play   : [32], // space - start/stop slideshow
				toggle : [70]  // letter "f" - toggle fullscreen
			},

			direction : {
				next : 'left',
				prev : 'right'
			},

			scrollOutside  : true,

			// Override some properties
			index   : 0,
			type    : null,
			href    : null,
			content : null,
			title   : null,

			// HTML templates
			tpl: {
				wrap     : '<div class="fancybox-wrap" tabIndex="-1"><div class="fancybox-skin"><div class="fancybox-outer"><div class="fancybox-inner"></div></div></div></div>',
				image    : '<img class="fancybox-image" src="{href}" alt="" />',
				iframe   : '<iframe id="fancybox-frame{rnd}" name="fancybox-frame{rnd}" class="fancybox-iframe" frameborder="0" vspace="0" hspace="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen' + (IE ? ' allowtransparency="true"' : '') + '></iframe>',
				error    : '<p class="fancybox-error">The requested content cannot be loaded.<br/>Please try again later.</p>',
				closeBtn : '<a title="Close" class="fancybox-item fancybox-close" href="javascript:;"></a>',
				next     : '<a title="Next" class="fancybox-nav fancybox-next" href="javascript:;"><span></span></a>',
				prev     : '<a title="Previous" class="fancybox-nav fancybox-prev" href="javascript:;"><span></span></a>'
			},

			// Properties for each animation type
			// Opening fancyBox
			openEffect  : 'fade', // 'elastic', 'fade' or 'none'
			openSpeed   : 250,
			openEasing  : 'swing',
			openOpacity : true,
			openMethod  : 'zoomIn',

			// Closing fancyBox
			closeEffect  : 'fade', // 'elastic', 'fade' or 'none'
			closeSpeed   : 250,
			closeEasing  : 'swing',
			closeOpacity : true,
			closeMethod  : 'zoomOut',

			// Changing next gallery item
			nextEffect : 'elastic', // 'elastic', 'fade' or 'none'
			nextSpeed  : 250,
			nextEasing : 'swing',
			nextMethod : 'changeIn',

			// Changing previous gallery item
			prevEffect : 'elastic', // 'elastic', 'fade' or 'none'
			prevSpeed  : 250,
			prevEasing : 'swing',
			prevMethod : 'changeOut',

			// Enable default helpers
			helpers : {
				overlay : true,
				title   : true
			},

			// Callbacks
			onCancel     : $.noop, // If canceling
			beforeLoad   : $.noop, // Before loading
			afterLoad    : $.noop, // After loading
			beforeShow   : $.noop, // Before changing in current item
			afterShow    : $.noop, // After opening
			beforeChange : $.noop, // Before changing gallery item
			beforeClose  : $.noop, // Before closing
			afterClose   : $.noop  // After closing
		},

		//Current state
		group    : {}, // Selected group
		opts     : {}, // Group options
		previous : null,  // Previous element
		coming   : null,  // Element being loaded
		current  : null,  // Currently loaded element
		isActive : false, // Is activated
		isOpen   : false, // Is currently open
		isOpened : false, // Have been fully opened at least once

		wrap  : null,
		skin  : null,
		outer : null,
		inner : null,

		player : {
			timer    : null,
			isActive : false
		},

		// Loaders
		ajaxLoad   : null,
		imgPreload : null,

		// Some collections
		transitions : {},
		helpers     : {},

		/*
		 *	Static methods
		 */

		open: function (group, opts) {
			if (!group) {
				return;
			}

			if (!$.isPlainObject(opts)) {
				opts = {};
			}

			// Close if already active
			if (false === F.close(true)) {
				return;
			}

			// Normalize group
			if (!$.isArray(group)) {
				group = isQuery(group) ? $(group).get() : [group];
			}

			// Recheck if the type of each element is `object` and set content type (image, ajax, etc)
			$.each(group, function(i, element) {
				var obj = {},
					href,
					title,
					content,
					type,
					rez,
					hrefParts,
					selector;

				if ($.type(element) === "object") {
					// Check if is DOM element
					if (element.nodeType) {
						element = $(element);
					}

					if (isQuery(element)) {
						obj = {
							href    : element.data('fancybox-href') || element.attr('href'),
							title   : $('<div/>').text( element.data('fancybox-title') || element.attr('title') ).html(),
							isDom   : true,
							element : element
						};

						if ($.metadata) {
							$.extend(true, obj, element.metadata());
						}

					} else {
						obj = element;
					}
				}

				href  = opts.href  || obj.href || (isString(element) ? element : null);
				title = opts.title !== undefined ? opts.title : obj.title || '';

				content = opts.content || obj.content;
				type    = content ? 'html' : (opts.type  || obj.type);

				if (!type && obj.isDom) {
					type = element.data('fancybox-type');

					if (!type) {
						rez  = element.prop('class').match(/fancybox\.(\w+)/);
						type = rez ? rez[1] : null;
					}
				}

				if (isString(href)) {
					// Try to guess the content type
					if (!type) {
						if (F.isImage(href)) {
							type = 'image';

						} else if (F.isSWF(href)) {
							type = 'swf';

						} else if (href.charAt(0) === '#') {
							type = 'inline';

						} else if (isString(element)) {
							type    = 'html';
							content = element;
						}
					}

					// Split url into two pieces with source url and content selector, e.g,
					// "/mypage.html #my_id" will load "/mypage.html" and display element having id "my_id"
					if (type === 'ajax') {
						hrefParts = href.split(/\s+/, 2);
						href      = hrefParts.shift();
						selector  = hrefParts.shift();
					}
				}

				if (!content) {
					if (type === 'inline') {
						if (href) {
							content = $( isString(href) ? href.replace(/.*(?=#[^\s]+$)/, '') : href ); //strip for ie7

						} else if (obj.isDom) {
							content = element;
						}

					} else if (type === 'html') {
						content = href;

					} else if (!type && !href && obj.isDom) {
						type    = 'inline';
						content = element;
					}
				}

				$.extend(obj, {
					href     : href,
					type     : type,
					content  : content,
					title    : title,
					selector : selector
				});

				group[ i ] = obj;
			});

			// Extend the defaults
			F.opts = $.extend(true, {}, F.defaults, opts);

			// All options are merged recursive except keys
			if (opts.keys !== undefined) {
				F.opts.keys = opts.keys ? $.extend({}, F.defaults.keys, opts.keys) : false;
			}

			F.group = group;

			return F._start(F.opts.index);
		},

		// Cancel image loading or abort ajax request
		cancel: function () {
			var coming = F.coming;

			if (coming && false === F.trigger('onCancel')) {
				return;
			}

			F.hideLoading();

			if (!coming) {
				return;
			}

			if (F.ajaxLoad) {
				F.ajaxLoad.abort();
			}

			F.ajaxLoad = null;

			if (F.imgPreload) {
				F.imgPreload.onload = F.imgPreload.onerror = null;
			}

			if (coming.wrap) {
				coming.wrap.stop(true, true).trigger('onReset').remove();
			}

			F.coming = null;

			// If the first item has been canceled, then clear everything
			if (!F.current) {
				F._afterZoomOut( coming );
			}
		},

		// Start closing animation if is open; remove immediately if opening/closing
		close: function (event) {
			F.cancel();

			if (false === F.trigger('beforeClose')) {
				return;
			}

			F.unbindEvents();

			if (!F.isActive) {
				return;
			}

			if (!F.isOpen || event === true) {
				$('.fancybox-wrap').stop(true).trigger('onReset').remove();

				F._afterZoomOut();

			} else {
				F.isOpen = F.isOpened = false;
				F.isClosing = true;

				$('.fancybox-item, .fancybox-nav').remove();

				F.wrap.stop(true, true).removeClass('fancybox-opened');

				F.transitions[ F.current.closeMethod ]();
			}
		},

		// Manage slideshow:
		//   $.fancybox.play(); - toggle slideshow
		//   $.fancybox.play( true ); - start
		//   $.fancybox.play( false ); - stop
		play: function ( action ) {
			var clear = function () {
					clearTimeout(F.player.timer);
				},
				set = function () {
					clear();

					if (F.current && F.player.isActive) {
						F.player.timer = setTimeout(F.next, F.current.playSpeed);
					}
				},
				stop = function () {
					clear();

					D.unbind('.player');

					F.player.isActive = false;

					F.trigger('onPlayEnd');
				},
				start = function () {
					if (F.current && (F.current.loop || F.current.index < F.group.length - 1)) {
						F.player.isActive = true;

						D.bind({
							'onCancel.player beforeClose.player' : stop,
							'onUpdate.player'   : set,
							'beforeLoad.player' : clear
						});

						set();

						F.trigger('onPlayStart');
					}
				};

			if (action === true || (!F.player.isActive && action !== false)) {
				start();
			} else {
				stop();
			}
		},

		// Navigate to next gallery item
		next: function ( direction ) {
			var current = F.current;

			if (current) {
				if (!isString(direction)) {
					direction = current.direction.next;
				}

				F.jumpto(current.index + 1, direction, 'next');
			}
		},

		// Navigate to previous gallery item
		prev: function ( direction ) {
			var current = F.current;

			if (current) {
				if (!isString(direction)) {
					direction = current.direction.prev;
				}

				F.jumpto(current.index - 1, direction, 'prev');
			}
		},

		// Navigate to gallery item by index
		jumpto: function ( index, direction, router ) {
			var current = F.current;

			if (!current) {
				return;
			}

			index = getScalar(index);

			F.direction = direction || current.direction[ (index >= current.index ? 'next' : 'prev') ];
			F.router    = router || 'jumpto';

			if (current.loop) {
				if (index < 0) {
					index = current.group.length + (index % current.group.length);
				}

				index = index % current.group.length;
			}

			if (current.group[ index ] !== undefined) {
				F.cancel();

				F._start(index);
			}
		},

		// Center inside viewport and toggle position type to fixed or absolute if needed
		reposition: function (e, onlyAbsolute) {
			var current = F.current,
				wrap    = current ? current.wrap : null,
				pos;

			if (wrap) {
				pos = F._getPosition(onlyAbsolute);

				if (e && e.type === 'scroll') {
					delete pos.position;

					wrap.stop(true, true).animate(pos, 200);

				} else {
					wrap.css(pos);

					current.pos = $.extend({}, current.dim, pos);
				}
			}
		},

		update: function (e) {
			var type = (e && e.originalEvent && e.originalEvent.type),
				anyway = !type || type === 'orientationchange';

			if (anyway) {
				clearTimeout(didUpdate);

				didUpdate = null;
			}

			if (!F.isOpen || didUpdate) {
				return;
			}

			didUpdate = setTimeout(function() {
				var current = F.current;

				if (!current || F.isClosing) {
					return;
				}

				F.wrap.removeClass('fancybox-tmp');

				if (anyway || type === 'load' || (type === 'resize' && current.autoResize)) {
					F._setDimension();
				}

				if (!(type === 'scroll' && current.canShrink)) {
					F.reposition(e);
				}

				F.trigger('onUpdate');

				didUpdate = null;

			}, (anyway && !isTouch ? 0 : 300));
		},

		// Shrink content to fit inside viewport or restore if resized
		toggle: function ( action ) {
			if (F.isOpen) {
				F.current.fitToView = $.type(action) === "boolean" ? action : !F.current.fitToView;

				// Help browser to restore document dimensions
				if (isTouch) {
					F.wrap.removeAttr('style').addClass('fancybox-tmp');

					F.trigger('onUpdate');
				}

				F.update();
			}
		},

		hideLoading: function () {
			D.unbind('.loading');

			$('#fancybox-loading').remove();
		},

		showLoading: function () {
			var el, viewport;

			F.hideLoading();

			el = $('<div id="fancybox-loading"><div></div></div>').click(F.cancel).appendTo('body');

			// If user will press the escape-button, the request will be canceled
			D.bind('keydown.loading', function(e) {
				if ((e.which || e.keyCode) === 27) {
					e.preventDefault();

					F.cancel();
				}
			});

			if (!F.defaults.fixed) {
				viewport = F.getViewport();

				el.css({
					position : 'absolute',
					top  : (viewport.h * 0.5) + viewport.y,
					left : (viewport.w * 0.5) + viewport.x
				});
			}

			F.trigger('onLoading');
		},

		getViewport: function () {
			var locked = (F.current && F.current.locked) || false,
				rez    = {
					x: W.scrollLeft(),
					y: W.scrollTop()
				};

			if (locked && locked.length) {
				rez.w = locked[0].clientWidth;
				rez.h = locked[0].clientHeight;

			} else {
				// See http://bugs.jquery.com/ticket/6724
				rez.w = isTouch && window.innerWidth  ? window.innerWidth  : W.width();
				rez.h = isTouch && window.innerHeight ? window.innerHeight : W.height();
			}

			return rez;
		},

		// Unbind the keyboard / clicking actions
		unbindEvents: function () {
			if (F.wrap && isQuery(F.wrap)) {
				F.wrap.unbind('.fb');
			}

			D.unbind('.fb');
			W.unbind('.fb');
		},

		bindEvents: function () {
			var current = F.current,
				keys;

			if (!current) {
				return;
			}

			// Changing document height on iOS devices triggers a 'resize' event,
			// that can change document height... repeating infinitely
			W.bind('orientationchange.fb' + (isTouch ? '' : ' resize.fb') + (current.autoCenter && !current.locked ? ' scroll.fb' : ''), F.update);

			keys = current.keys;

			if (keys) {
				D.bind('keydown.fb', function (e) {
					var code   = e.which || e.keyCode,
						target = e.target || e.srcElement;

					// Skip esc key if loading, because showLoading will cancel preloading
					if (code === 27 && F.coming) {
						return false;
					}

					// Ignore key combinations and key events within form elements
					if (!e.ctrlKey && !e.altKey && !e.shiftKey && !e.metaKey && !(target && (target.type || $(target).is('[contenteditable]')))) {
						$.each(keys, function(i, val) {
							if (current.group.length > 1 && val[ code ] !== undefined) {
								F[ i ]( val[ code ] );

								e.preventDefault();
								return false;
							}

							if ($.inArray(code, val) > -1) {
								F[ i ] ();

								e.preventDefault();
								return false;
							}
						});
					}
				});
			}

			if ($.fn.mousewheel && current.mouseWheel) {
				F.wrap.bind('mousewheel.fb', function (e, delta, deltaX, deltaY) {
					var target = e.target || null,
						parent = $(target),
						canScroll = false;

					while (parent.length) {
						if (canScroll || parent.is('.fancybox-skin') || parent.is('.fancybox-wrap')) {
							break;
						}

						canScroll = isScrollable( parent[0] );
						parent    = $(parent).parent();
					}

					if (delta !== 0 && !canScroll) {
						if (F.group.length > 1 && !current.canShrink) {
							if (deltaY > 0 || deltaX > 0) {
								F.prev( deltaY > 0 ? 'down' : 'left' );

							} else if (deltaY < 0 || deltaX < 0) {
								F.next( deltaY < 0 ? 'up' : 'right' );
							}

							e.preventDefault();
						}
					}
				});
			}
		},

		trigger: function (event, o) {
			var ret, obj = o || F.coming || F.current;

			if (obj) {
				if ($.isFunction( obj[event] )) {
					ret = obj[event].apply(obj, Array.prototype.slice.call(arguments, 1));
				}

				if (ret === false) {
					return false;
				}

				if (obj.helpers) {
					$.each(obj.helpers, function (helper, opts) {
						if (opts && F.helpers[helper] && $.isFunction(F.helpers[helper][event])) {
							F.helpers[helper][event]($.extend(true, {}, F.helpers[helper].defaults, opts), obj);
						}
					});
				}
			}

			D.trigger(event);
		},

		isImage: function (str) {
			return isString(str) && str.match(/(^data:image\/.*,)|(\.(jp(e|g|eg)|gif|png|bmp|webp|svg)((\?|#).*)?$)/i);
		},

		isSWF: function (str) {
			return isString(str) && str.match(/\.(swf)((\?|#).*)?$/i);
		},

		_start: function (index) {
			var coming = {},
				obj,
				href,
				type,
				margin,
				padding;

			index = getScalar( index );
			obj   = F.group[ index ] || null;

			if (!obj) {
				return false;
			}

			coming = $.extend(true, {}, F.opts, obj);

			// Convert margin and padding properties to array - top, right, bottom, left
			margin  = coming.margin;
			padding = coming.padding;

			if ($.type(margin) === 'number') {
				coming.margin = [margin, margin, margin, margin];
			}

			if ($.type(padding) === 'number') {
				coming.padding = [padding, padding, padding, padding];
			}

			// 'modal' propery is just a shortcut
			if (coming.modal) {
				$.extend(true, coming, {
					closeBtn   : false,
					closeClick : false,
					nextClick  : false,
					arrows     : false,
					mouseWheel : false,
					keys       : null,
					helpers: {
						overlay : {
							closeClick : false
						}
					}
				});
			}

			// 'autoSize' property is a shortcut, too
			if (coming.autoSize) {
				coming.autoWidth = coming.autoHeight = true;
			}

			if (coming.width === 'auto') {
				coming.autoWidth = true;
			}

			if (coming.height === 'auto') {
				coming.autoHeight = true;
			}

			/*
			 * Add reference to the group, so it`s possible to access from callbacks, example:
			 * afterLoad : function() {
			 *     this.title = 'Image ' + (this.index + 1) + ' of ' + this.group.length + (this.title ? ' - ' + this.title : '');
			 * }
			 */

			coming.group  = F.group;
			coming.index  = index;

			// Give a chance for callback or helpers to update coming item (type, title, etc)
			F.coming = coming;

			if (false === F.trigger('beforeLoad')) {
				F.coming = null;

				return;
			}

			type = coming.type;
			href = coming.href;

			if (!type) {
				F.coming = null;

				//If we can not determine content type then drop silently or display next/prev item if looping through gallery
				if (F.current && F.router && F.router !== 'jumpto') {
					F.current.index = index;

					return F[ F.router ]( F.direction );
				}

				return false;
			}

			F.isActive = true;

			if (type === 'image' || type === 'swf') {
				coming.autoHeight = coming.autoWidth = false;
				coming.scrolling  = 'visible';
			}

			if (type === 'image') {
				coming.aspectRatio = true;
			}

			if (type === 'iframe' && isTouch) {
				coming.scrolling = 'scroll';
			}

			// Build the neccessary markup
			coming.wrap = $(coming.tpl.wrap).addClass('fancybox-' + (isTouch ? 'mobile' : 'desktop') + ' fancybox-type-' + type + ' fancybox-tmp ' + coming.wrapCSS).appendTo( coming.parent || 'body' );

			$.extend(coming, {
				skin  : $('.fancybox-skin',  coming.wrap),
				outer : $('.fancybox-outer', coming.wrap),
				inner : $('.fancybox-inner', coming.wrap)
			});

			$.each(["Top", "Right", "Bottom", "Left"], function(i, v) {
				coming.skin.css('padding' + v, getValue(coming.padding[ i ]));
			});

			F.trigger('onReady');

			// Check before try to load; 'inline' and 'html' types need content, others - href
			if (type === 'inline' || type === 'html') {
				if (!coming.content || !coming.content.length) {
					return F._error( 'content' );
				}

			} else if (!href) {
				return F._error( 'href' );
			}

			if (type === 'image') {
				F._loadImage();

			} else if (type === 'ajax') {
				F._loadAjax();

			} else if (type === 'iframe') {
				F._loadIframe();

			} else {
				F._afterLoad();
			}
		},

		_error: function ( type ) {
			$.extend(F.coming, {
				type       : 'html',
				autoWidth  : true,
				autoHeight : true,
				minWidth   : 0,
				minHeight  : 0,
				scrolling  : 'no',
				hasError   : type,
				content    : F.coming.tpl.error
			});

			F._afterLoad();
		},

		_loadImage: function () {
			// Reset preload image so it is later possible to check "complete" property
			var img = F.imgPreload = new Image();

			img.onload = function () {
				this.onload = this.onerror = null;

				F.coming.width  = this.width / F.opts.pixelRatio;
				F.coming.height = this.height / F.opts.pixelRatio;

				F._afterLoad();
			};

			img.onerror = function () {
				this.onload = this.onerror = null;

				F._error( 'image' );
			};

			img.src = F.coming.href;

			if (img.complete !== true) {
				F.showLoading();
			}
		},

		_loadAjax: function () {
			var coming = F.coming;

			F.showLoading();

			F.ajaxLoad = $.ajax($.extend({}, coming.ajax, {
				url: coming.href,
				error: function (jqXHR, textStatus) {
					if (F.coming && textStatus !== 'abort') {
						F._error( 'ajax', jqXHR );

					} else {
						F.hideLoading();
					}
				},
				success: function (data, textStatus) {
					if (textStatus === 'success') {
						coming.content = data;

						F._afterLoad();
					}
				}
			}));
		},

		_loadIframe: function() {
			var coming = F.coming,
				iframe = $(coming.tpl.iframe.replace(/\{rnd\}/g, new Date().getTime()))
					.attr('scrolling', isTouch ? 'auto' : coming.iframe.scrolling)
					.attr('src', coming.href);

			// This helps IE
			$(coming.wrap).bind('onReset', function () {
				try {
					$(this).find('iframe').hide().attr('src', '//about:blank').end().empty();
				} catch (e) {}
			});

			if (coming.iframe.preload) {
				F.showLoading();

				iframe.one('load', function() {
					$(this).data('ready', 1);

					// iOS will lose scrolling if we resize
					if (!isTouch) {
						$(this).bind('load.fb', F.update);
					}

					// Without this trick:
					//   - iframe won't scroll on iOS devices
					//   - IE7 sometimes displays empty iframe
					$(this).parents('.fancybox-wrap').width('100%').removeClass('fancybox-tmp').show();

					F._afterLoad();
				});
			}

			coming.content = iframe.appendTo( coming.inner );

			if (!coming.iframe.preload) {
				F._afterLoad();
			}
		},

		_preloadImages: function() {
			var group   = F.group,
				current = F.current,
				len     = group.length,
				cnt     = current.preload ? Math.min(current.preload, len - 1) : 0,
				item,
				i;

			for (i = 1; i <= cnt; i += 1) {
				item = group[ (current.index + i ) % len ];

				if (item.type === 'image' && item.href) {
					new Image().src = item.href;
				}
			}
		},

		_afterLoad: function () {
			var coming   = F.coming,
				previous = F.current,
				placeholder = 'fancybox-placeholder',
				current,
				content,
				type,
				scrolling,
				href,
				embed;

			F.hideLoading();

			if (!coming || F.isActive === false) {
				return;
			}

			if (false === F.trigger('afterLoad', coming, previous)) {
				coming.wrap.stop(true).trigger('onReset').remove();

				F.coming = null;

				return;
			}

			if (previous) {
				F.trigger('beforeChange', previous);

				previous.wrap.stop(true).removeClass('fancybox-opened')
					.find('.fancybox-item, .fancybox-nav')
					.remove();
			}

			F.unbindEvents();

			current   = coming;
			content   = coming.content;
			type      = coming.type;
			scrolling = coming.scrolling;

			$.extend(F, {
				wrap  : current.wrap,
				skin  : current.skin,
				outer : current.outer,
				inner : current.inner,
				current  : current,
				previous : previous
			});

			href = current.href;

			switch (type) {
				case 'inline':
				case 'ajax':
				case 'html':
					if (current.selector) {
						content = $('<div>').html(content).find(current.selector);

					} else if (isQuery(content)) {
						if (!content.data(placeholder)) {
							content.data(placeholder, $('<div class="' + placeholder + '"></div>').insertAfter( content ).hide() );
						}

						content = content.show().detach();

						current.wrap.bind('onReset', function () {
							if ($(this).find(content).length) {
								content.hide().replaceAll( content.data(placeholder) ).data(placeholder, false);
							}
						});
					}
				break;

				case 'image':
					content = current.tpl.image.replace(/\{href\}/g, href);
				break;

				case 'swf':
					content = '<object id="fancybox-swf" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="movie" value="' + href + '"></param>';
					embed   = '';

					$.each(current.swf, function(name, val) {
						content += '<param name="' + name + '" value="' + val + '"></param>';
						embed   += ' ' + name + '="' + val + '"';
					});

					content += '<embed src="' + href + '" type="application/x-shockwave-flash" width="100%" height="100%"' + embed + '></embed></object>';
				break;
			}

			if (!(isQuery(content) && content.parent().is(current.inner))) {
				current.inner.append( content );
			}

			// Give a chance for helpers or callbacks to update elements
			F.trigger('beforeShow');

			// Set scrolling before calculating dimensions
			current.inner.css('overflow', scrolling === 'yes' ? 'scroll' : (scrolling === 'no' ? 'hidden' : scrolling));

			// Set initial dimensions and start position
			F._setDimension();

			F.reposition();

			F.isOpen = false;
			F.coming = null;

			F.bindEvents();

			if (!F.isOpened) {
				$('.fancybox-wrap').not( current.wrap ).stop(true).trigger('onReset').remove();

			} else if (previous.prevMethod) {
				F.transitions[ previous.prevMethod ]();
			}

			F.transitions[ F.isOpened ? current.nextMethod : current.openMethod ]();

			F._preloadImages();
		},

		_setDimension: function () {
			var viewport   = F.getViewport(),
				steps      = 0,
				canShrink  = false,
				canExpand  = false,
				wrap       = F.wrap,
				skin       = F.skin,
				inner      = F.inner,
				current    = F.current,
				width      = current.width,
				height     = current.height,
				minWidth   = current.minWidth,
				minHeight  = current.minHeight,
				maxWidth   = current.maxWidth,
				maxHeight  = current.maxHeight,
				scrolling  = current.scrolling,
				scrollOut  = current.scrollOutside ? current.scrollbarWidth : 0,
				margin     = current.margin,
				wMargin    = getScalar(margin[1] + margin[3]),
				hMargin    = getScalar(margin[0] + margin[2]),
				wPadding,
				hPadding,
				wSpace,
				hSpace,
				origWidth,
				origHeight,
				origMaxWidth,
				origMaxHeight,
				ratio,
				width_,
				height_,
				maxWidth_,
				maxHeight_,
				iframe,
				body;

			// Reset dimensions so we could re-check actual size
			wrap.add(skin).add(inner).width('auto').height('auto').removeClass('fancybox-tmp');

			wPadding = getScalar(skin.outerWidth(true)  - skin.width());
			hPadding = getScalar(skin.outerHeight(true) - skin.height());

			// Any space between content and viewport (margin, padding, border, title)
			wSpace = wMargin + wPadding;
			hSpace = hMargin + hPadding;

			origWidth  = isPercentage(width)  ? (viewport.w - wSpace) * getScalar(width)  / 100 : width;
			origHeight = isPercentage(height) ? (viewport.h - hSpace) * getScalar(height) / 100 : height;

			if (current.type === 'iframe') {
				iframe = current.content;

				if (current.autoHeight && iframe.data('ready') === 1) {
					try {
						if (iframe[0].contentWindow.document.location) {
							inner.width( origWidth ).height(9999);

							body = iframe.contents().find('body');

							if (scrollOut) {
								body.css('overflow-x', 'hidden');
							}

							origHeight = body.outerHeight(true);
						}

					} catch (e) {}
				}

			} else if (current.autoWidth || current.autoHeight) {
				inner.addClass( 'fancybox-tmp' );

				// Set width or height in case we need to calculate only one dimension
				if (!current.autoWidth) {
					inner.width( origWidth );
				}

				if (!current.autoHeight) {
					inner.height( origHeight );
				}

				if (current.autoWidth) {
					origWidth = inner.width();
				}

				if (current.autoHeight) {
					origHeight = inner.height();
				}

				inner.removeClass( 'fancybox-tmp' );
			}

			width  = getScalar( origWidth );
			height = getScalar( origHeight );

			ratio  = origWidth / origHeight;

			// Calculations for the content
			minWidth  = getScalar(isPercentage(minWidth) ? getScalar(minWidth, 'w') - wSpace : minWidth);
			maxWidth  = getScalar(isPercentage(maxWidth) ? getScalar(maxWidth, 'w') - wSpace : maxWidth);

			minHeight = getScalar(isPercentage(minHeight) ? getScalar(minHeight, 'h') - hSpace : minHeight);
			maxHeight = getScalar(isPercentage(maxHeight) ? getScalar(maxHeight, 'h') - hSpace : maxHeight);

			// These will be used to determine if wrap can fit in the viewport
			origMaxWidth  = maxWidth;
			origMaxHeight = maxHeight;

			if (current.fitToView) {
				maxWidth  = Math.min(viewport.w - wSpace, maxWidth);
				maxHeight = Math.min(viewport.h - hSpace, maxHeight);
			}

			maxWidth_  = viewport.w - wMargin;
			maxHeight_ = viewport.h - hMargin;

			if (current.aspectRatio) {
				if (width > maxWidth) {
					width  = maxWidth;
					height = getScalar(width / ratio);
				}

				if (height > maxHeight) {
					height = maxHeight;
					width  = getScalar(height * ratio);
				}

				if (width < minWidth) {
					width  = minWidth;
					height = getScalar(width / ratio);
				}

				if (height < minHeight) {
					height = minHeight;
					width  = getScalar(height * ratio);
				}

			} else {
				width = Math.max(minWidth, Math.min(width, maxWidth));

				if (current.autoHeight && current.type !== 'iframe') {
					inner.width( width );

					height = inner.height();
				}

				height = Math.max(minHeight, Math.min(height, maxHeight));
			}

			// Try to fit inside viewport (including the title)
			if (current.fitToView) {
				inner.width( width ).height( height );

				wrap.width( width + wPadding );

				// Real wrap dimensions
				width_  = wrap.width();
				height_ = wrap.height();

				if (current.aspectRatio) {
					while ((width_ > maxWidth_ || height_ > maxHeight_) && width > minWidth && height > minHeight) {
						if (steps++ > 19) {
							break;
						}

						height = Math.max(minHeight, Math.min(maxHeight, height - 10));
						width  = getScalar(height * ratio);

						if (width < minWidth) {
							width  = minWidth;
							height = getScalar(width / ratio);
						}

						if (width > maxWidth) {
							width  = maxWidth;
							height = getScalar(width / ratio);
						}

						inner.width( width ).height( height );

						wrap.width( width + wPadding );

						width_  = wrap.width();
						height_ = wrap.height();
					}

				} else {
					width  = Math.max(minWidth,  Math.min(width,  width  - (width_  - maxWidth_)));
					height = Math.max(minHeight, Math.min(height, height - (height_ - maxHeight_)));
				}
			}

			if (scrollOut && scrolling === 'auto' && height < origHeight && (width + wPadding + scrollOut) < maxWidth_) {
				width += scrollOut;
			}

			inner.width( width ).height( height );

			wrap.width( width + wPadding );

			width_  = wrap.width();
			height_ = wrap.height();

			canShrink = (width_ > maxWidth_ || height_ > maxHeight_) && width > minWidth && height > minHeight;
			canExpand = current.aspectRatio ? (width < origMaxWidth && height < origMaxHeight && width < origWidth && height < origHeight) : ((width < origMaxWidth || height < origMaxHeight) && (width < origWidth || height < origHeight));

			$.extend(current, {
				dim : {
					width	: getValue( width_ ),
					height	: getValue( height_ )
				},
				origWidth  : origWidth,
				origHeight : origHeight,
				canShrink  : canShrink,
				canExpand  : canExpand,
				wPadding   : wPadding,
				hPadding   : hPadding,
				wrapSpace  : height_ - skin.outerHeight(true),
				skinSpace  : skin.height() - height
			});

			if (!iframe && current.autoHeight && height > minHeight && height < maxHeight && !canExpand) {
				inner.height('auto');
			}
		},

		_getPosition: function (onlyAbsolute) {
			var current  = F.current,
				viewport = F.getViewport(),
				margin   = current.margin,
				width    = F.wrap.width()  + margin[1] + margin[3],
				height   = F.wrap.height() + margin[0] + margin[2],
				rez      = {
					position: 'absolute',
					top  : margin[0],
					left : margin[3]
				};

			if (current.autoCenter && current.fixed && !onlyAbsolute && height <= viewport.h && width <= viewport.w) {
				rez.position = 'fixed';

			} else if (!current.locked) {
				rez.top  += viewport.y;
				rez.left += viewport.x;
			}

			rez.top  = getValue(Math.max(rez.top,  rez.top  + ((viewport.h - height) * current.topRatio)));
			rez.left = getValue(Math.max(rez.left, rez.left + ((viewport.w - width)  * current.leftRatio)));

			return rez;
		},

		_afterZoomIn: function () {
			var current = F.current;

			if (!current) {
				return;
			}

			F.isOpen = F.isOpened = true;

			F.wrap.css('overflow', 'visible').addClass('fancybox-opened').hide().show(0);

			F.update();

			// Assign a click event
			if ( current.closeClick || (current.nextClick && F.group.length > 1) ) {
				F.inner.css('cursor', 'pointer').bind('click.fb', function(e) {
					if (!$(e.target).is('a') && !$(e.target).parent().is('a')) {
						e.preventDefault();

						F[ current.closeClick ? 'close' : 'next' ]();
					}
				});
			}

			// Create a close button
			if (current.closeBtn) {
				$(current.tpl.closeBtn).appendTo(F.skin).bind('click.fb', function(e) {
					e.preventDefault();

					F.close();
				});
			}

			// Create navigation arrows
			if (current.arrows && F.group.length > 1) {
				if (current.loop || current.index > 0) {
					$(current.tpl.prev).appendTo(F.outer).bind('click.fb', F.prev);
				}

				if (current.loop || current.index < F.group.length - 1) {
					$(current.tpl.next).appendTo(F.outer).bind('click.fb', F.next);
				}
			}

			F.trigger('afterShow');

			// Stop the slideshow if this is the last item
			if (!current.loop && current.index === current.group.length - 1) {

				F.play( false );

			} else if (F.opts.autoPlay && !F.player.isActive) {
				F.opts.autoPlay = false;

				F.play(true);
			}
		},

		_afterZoomOut: function ( obj ) {
			obj = obj || F.current;

			$('.fancybox-wrap').trigger('onReset').remove();

			$.extend(F, {
				group  : {},
				opts   : {},
				router : false,
				current   : null,
				isActive  : false,
				isOpened  : false,
				isOpen    : false,
				isClosing : false,
				wrap   : null,
				skin   : null,
				outer  : null,
				inner  : null
			});

			F.trigger('afterClose', obj);
		}
	});

	/*
	 *	Default transitions
	 */

	F.transitions = {
		getOrigPosition: function () {
			var current  = F.current,
				element  = current.element,
				orig     = current.orig,
				pos      = {},
				width    = 50,
				height   = 50,
				hPadding = current.hPadding,
				wPadding = current.wPadding,
				viewport = F.getViewport();

			if (!orig && current.isDom && element.is(':visible')) {
				orig = element.find('img:first');

				if (!orig.length) {
					orig = element;
				}
			}

			if (isQuery(orig)) {
				pos = orig.offset();

				if (orig.is('img')) {
					width  = orig.outerWidth();
					height = orig.outerHeight();
				}

			} else {
				pos.top  = viewport.y + (viewport.h - height) * current.topRatio;
				pos.left = viewport.x + (viewport.w - width)  * current.leftRatio;
			}

			if (F.wrap.css('position') === 'fixed' || current.locked) {
				pos.top  -= viewport.y;
				pos.left -= viewport.x;
			}

			pos = {
				top     : getValue(pos.top  - hPadding * current.topRatio),
				left    : getValue(pos.left - wPadding * current.leftRatio),
				width   : getValue(width  + wPadding),
				height  : getValue(height + hPadding)
			};

			return pos;
		},

		step: function (now, fx) {
			var ratio,
				padding,
				value,
				prop       = fx.prop,
				current    = F.current,
				wrapSpace  = current.wrapSpace,
				skinSpace  = current.skinSpace;

			if (prop === 'width' || prop === 'height') {
				ratio = fx.end === fx.start ? 1 : (now - fx.start) / (fx.end - fx.start);

				if (F.isClosing) {
					ratio = 1 - ratio;
				}

				padding = prop === 'width' ? current.wPadding : current.hPadding;
				value   = now - padding;

				F.skin[ prop ](  getScalar( prop === 'width' ?  value : value - (wrapSpace * ratio) ) );
				F.inner[ prop ]( getScalar( prop === 'width' ?  value : value - (wrapSpace * ratio) - (skinSpace * ratio) ) );
			}
		},

		zoomIn: function () {
			var current  = F.current,
				startPos = current.pos,
				effect   = current.openEffect,
				elastic  = effect === 'elastic',
				endPos   = $.extend({opacity : 1}, startPos);

			// Remove "position" property that breaks older IE
			delete endPos.position;

			if (elastic) {
				startPos = this.getOrigPosition();

				if (current.openOpacity) {
					startPos.opacity = 0.1;
				}

			} else if (effect === 'fade') {
				startPos.opacity = 0.1;
			}

			F.wrap.css(startPos).animate(endPos, {
				duration : effect === 'none' ? 0 : current.openSpeed,
				easing   : current.openEasing,
				step     : elastic ? this.step : null,
				complete : F._afterZoomIn
			});
		},

		zoomOut: function () {
			var current  = F.current,
				effect   = current.closeEffect,
				elastic  = effect === 'elastic',
				endPos   = {opacity : 0.1};

			if (elastic) {
				endPos = this.getOrigPosition();

				if (current.closeOpacity) {
					endPos.opacity = 0.1;
				}
			}

			F.wrap.animate(endPos, {
				duration : effect === 'none' ? 0 : current.closeSpeed,
				easing   : current.closeEasing,
				step     : elastic ? this.step : null,
				complete : F._afterZoomOut
			});
		},

		changeIn: function () {
			var current   = F.current,
				effect    = current.nextEffect,
				startPos  = current.pos,
				endPos    = { opacity : 1 },
				direction = F.direction,
				distance  = 200,
				field;

			startPos.opacity = 0.1;

			if (effect === 'elastic') {
				field = direction === 'down' || direction === 'up' ? 'top' : 'left';

				if (direction === 'down' || direction === 'right') {
					startPos[ field ] = getValue(getScalar(startPos[ field ]) - distance);
					endPos[ field ]   = '+=' + distance + 'px';

				} else {
					startPos[ field ] = getValue(getScalar(startPos[ field ]) + distance);
					endPos[ field ]   = '-=' + distance + 'px';
				}
			}

			// Workaround for http://bugs.jquery.com/ticket/12273
			if (effect === 'none') {
				F._afterZoomIn();

			} else {
				F.wrap.css(startPos).animate(endPos, {
					duration : current.nextSpeed,
					easing   : current.nextEasing,
					complete : F._afterZoomIn
				});
			}
		},

		changeOut: function () {
			var previous  = F.previous,
				effect    = previous.prevEffect,
				endPos    = { opacity : 0.1 },
				direction = F.direction,
				distance  = 200;

			if (effect === 'elastic') {
				endPos[ direction === 'down' || direction === 'up' ? 'top' : 'left' ] = ( direction === 'up' || direction === 'left' ? '-' : '+' ) + '=' + distance + 'px';
			}

			previous.wrap.animate(endPos, {
				duration : effect === 'none' ? 0 : previous.prevSpeed,
				easing   : previous.prevEasing,
				complete : function () {
					$(this).trigger('onReset').remove();
				}
			});
		}
	};

	/*
	 *	Overlay helper
	 */

	F.helpers.overlay = {
		defaults : {
			closeClick : true,      // if true, fancyBox will be closed when user clicks on the overlay
			speedOut   : 200,       // duration of fadeOut animation
			showEarly  : true,      // indicates if should be opened immediately or wait until the content is ready
			css        : {},        // custom CSS properties
			locked     : !isTouch,  // if true, the content will be locked into overlay
			fixed      : true       // if false, the overlay CSS position property will not be set to "fixed"
		},

		overlay : null,      // current handle
		fixed   : false,     // indicates if the overlay has position "fixed"
		el      : $('html'), // element that contains "the lock"

		// Public methods
		create : function(opts) {
			var parent;

			opts = $.extend({}, this.defaults, opts);

			if (this.overlay) {
				this.close();
			}

			parent = F.coming ? F.coming.parent : opts.parent;

			this.overlay = $('<div class="fancybox-overlay"></div>').appendTo( parent && parent.lenth ? parent : 'body' );
			this.fixed   = false;

			if (opts.fixed && F.defaults.fixed) {
				this.overlay.addClass('fancybox-overlay-fixed');

				this.fixed = true;
			}
		},

		open : function(opts) {
			var that = this;

			opts = $.extend({}, this.defaults, opts);

			if (this.overlay) {
				this.overlay.unbind('.overlay').width('auto').height('auto');

			} else {
				this.create(opts);
			}

			if (!this.fixed) {
				W.bind('resize.overlay', $.proxy( this.update, this) );

				this.update();
			}

			if (opts.closeClick) {
				this.overlay.bind('click.overlay', function(e) {
					if ($(e.target).hasClass('fancybox-overlay')) {
						if (F.isActive) {
							F.close();
						} else {
							that.close();
						}

						return false;
					}
				});
			}

			this.overlay.css( opts.css ).show();
		},

		close : function() {
			W.unbind('resize.overlay');

			if (this.el.hasClass('fancybox-lock')) {
				$('.fancybox-margin').removeClass('fancybox-margin');

				this.el.removeClass('fancybox-lock');

				W.scrollTop( this.scrollV ).scrollLeft( this.scrollH );
			}

			$('.fancybox-overlay').remove().hide();

			$.extend(this, {
				overlay : null,
				fixed   : false
			});
		},

		// Private, callbacks

		update : function () {
			var width = '100%', offsetWidth;

			// Reset width/height so it will not mess
			this.overlay.width(width).height('100%');

			// jQuery does not return reliable result for IE
			if (IE) {
				offsetWidth = Math.max(document.documentElement.offsetWidth, document.body.offsetWidth);

				if (D.width() > offsetWidth) {
					width = D.width();
				}

			} else if (D.width() > W.width()) {
				width = D.width();
			}

			this.overlay.width(width).height(D.height());
		},

		// This is where we can manipulate DOM, because later it would cause iframes to reload
		onReady : function (opts, obj) {
			var overlay = this.overlay;

			$('.fancybox-overlay').stop(true, true);

			if (!overlay) {
				this.create(opts);
			}

			if (opts.locked && this.fixed && obj.fixed) {
				obj.locked = this.overlay.append( obj.wrap );
				obj.fixed  = false;
			}

			if (opts.showEarly === true) {
				this.beforeShow.apply(this, arguments);
			}
		},

		beforeShow : function(opts, obj) {
			if (obj.locked && !this.el.hasClass('fancybox-lock')) {
				if (this.fixPosition !== false) {
					$('*').filter(function(){
						return ($(this).css('position') === 'fixed' && !$(this).hasClass("fancybox-overlay") && !$(this).hasClass("fancybox-wrap") );
					}).addClass('fancybox-margin');
				}

				this.el.addClass('fancybox-margin');

				this.scrollV = W.scrollTop();
				this.scrollH = W.scrollLeft();

				this.el.addClass('fancybox-lock');

				W.scrollTop( this.scrollV ).scrollLeft( this.scrollH );
			}

			this.open(opts);
		},

		onUpdate : function() {
			if (!this.fixed) {
				this.update();
			}
		},

		afterClose: function (opts) {
			// Remove overlay if exists and fancyBox is not opening
			// (e.g., it is not being open using afterClose callback)
			if (this.overlay && !F.coming) {
				this.overlay.fadeOut(opts.speedOut, $.proxy( this.close, this ));
			}
		}
	};

	/*
	 *	Title helper
	 */

	F.helpers.title = {
		defaults : {
			type     : 'float', // 'float', 'inside', 'outside' or 'over',
			position : 'bottom' // 'top' or 'bottom'
		},

		beforeShow: function (opts) {
			var current = F.current,
				text    = current.title,
				type    = opts.type,
				title,
				target;

			if ($.isFunction(text)) {
				text = text.call(current.element, current);
			}

			if (!isString(text) || $.trim(text) === '') {
				return;
			}

			title = $('<div class="fancybox-title fancybox-title-' + type + '-wrap">' + text + '</div>');

			switch (type) {
				case 'inside':
					target = F.skin;
				break;

				case 'outside':
					target = F.wrap;
				break;

				case 'over':
					target = F.inner;
				break;

				default: // 'float'
					target = F.skin;

					title.appendTo('body');

					if (IE) {
						title.width( title.width() );
					}

					title.wrapInner('<span class="child"></span>');

					//Increase bottom margin so this title will also fit into viewport
					F.current.margin[2] += Math.abs( getScalar(title.css('margin-bottom')) );
				break;
			}

			title[ (opts.position === 'top' ? 'prependTo'  : 'appendTo') ](target);
		}
	};

	// jQuery plugin initialization
	$.fn.fancybox = function (options) {
		var index,
			that     = $(this),
			selector = this.selector || '',
			run      = function(e) {
				var what = $(this).blur(), idx = index, relType, relVal;

				if (!(e.ctrlKey || e.altKey || e.shiftKey || e.metaKey) && !what.is('.fancybox-wrap')) {
					relType = options.groupAttr || 'data-fancybox-group';
					relVal  = what.attr(relType);

					if (!relVal) {
						relType = 'rel';
						relVal  = what.get(0)[ relType ];
					}

					if (relVal && relVal !== '' && relVal !== 'nofollow') {
						what = selector.length ? $(selector) : that;
						what = what.filter('[' + relType + '="' + relVal + '"]');
						idx  = what.index(this);
					}

					options.index = idx;

					// Stop an event from bubbling if everything is fine
					if (F.open(what, options) !== false) {
						e.preventDefault();
					}
				}
			};

		options = options || {};
		index   = options.index || 0;

		if (!selector || options.live === false) {
			that.unbind('click.fb-start').bind('click.fb-start', run);

		} else {
			D.undelegate(selector, 'click.fb-start').delegate(selector + ":not('.fancybox-item, .fancybox-nav')", 'click.fb-start', run);
		}

		this.filter('[data-fancybox-start=1]').trigger('click');

		return this;
	};

	// Tests that need a body at doc ready
	D.ready(function() {
		var w1, w2;

		if ( $.scrollbarWidth === undefined ) {
			// http://benalman.com/projects/jquery-misc-plugins/#scrollbarwidth
			$.scrollbarWidth = function() {
				var parent = $('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo('body'),
					child  = parent.children(),
					width  = child.innerWidth() - child.height( 99 ).innerWidth();

				parent.remove();

				return width;
			};
		}

		if ( $.support.fixedPosition === undefined ) {
			$.support.fixedPosition = (function() {
				var elem  = $('<div style="position:fixed;top:20px;"></div>').appendTo('body'),
					fixed = ( elem[0].offsetTop === 20 || elem[0].offsetTop === 15 );

				elem.remove();

				return fixed;
			}());
		}

		$.extend(F.defaults, {
			scrollbarWidth : $.scrollbarWidth(),
			fixed  : $.support.fixedPosition,
			parent : $('body')
		});

		//Get real width of page scroll-bar
		w1 = $(window).width();

		H.addClass('fancybox-lock-test');

		w2 = $(window).width();

		H.removeClass('fancybox-lock-test');

		$("<style type='text/css'>.fancybox-margin{margin-right:" + (w2 - w1) + "px;}</style>").appendTo("head");
	});

}(window, document, jQuery));
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/fancybox/jquery.fancybox/" data-id="ckgafe0ch00325z9k2zt6d994" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fancybox/helpers/jquery.fancybox-buttons" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/" class="article-date">
  <time datetime="2020-10-15T03:18:44.736Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/">fancybox/helpers/jquery.fancybox-buttons</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        #fancybox-buttons {
	position: fixed;
	left: 0;
	width: 100%;
	z-index: 8050;
}

#fancybox-buttons.top {
	top: 10px;
}

#fancybox-buttons.bottom {
	bottom: 10px;
}

#fancybox-buttons ul {
	display: block;
	width: 166px;
	height: 30px;
	margin: 0 auto;
	padding: 0;
	list-style: none;
	border: 1px solid #111;
	border-radius: 3px;
	-webkit-box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
	   -moz-box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
	        box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
	background: rgb(50,50,50);
	background: -moz-linear-gradient(top, rgb(68,68,68) 0%, rgb(52,52,52) 50%, rgb(41,41,41) 50%, rgb(51,51,51) 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgb(68,68,68)), color-stop(50%,rgb(52,52,52)), color-stop(50%,rgb(41,41,41)), color-stop(100%,rgb(51,51,51)));
	background: -webkit-linear-gradient(top, rgb(68,68,68) 0%,rgb(52,52,52) 50%,rgb(41,41,41) 50%,rgb(51,51,51) 100%);
	background: -o-linear-gradient(top, rgb(68,68,68) 0%,rgb(52,52,52) 50%,rgb(41,41,41) 50%,rgb(51,51,51) 100%);
	background: -ms-linear-gradient(top, rgb(68,68,68) 0%,rgb(52,52,52) 50%,rgb(41,41,41) 50%,rgb(51,51,51) 100%);
	background: linear-gradient(top, rgb(68,68,68) 0%,rgb(52,52,52) 50%,rgb(41,41,41) 50%,rgb(51,51,51) 100%);
	filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#444444', endColorstr='#222222',GradientType=0 );
}

#fancybox-buttons ul li {
	float: left;
	margin: 0;
	padding: 0;
}

#fancybox-buttons a {
	display: block;
	width: 30px;
	height: 30px;
	text-indent: -9999px;
	background-color: transparent;
	background-image: url('fancybox_buttons.png');
	background-repeat: no-repeat;
	outline: none;
	opacity: 0.8;
}

#fancybox-buttons a:hover {
	opacity: 1;
}

#fancybox-buttons a.btnPrev {
	background-position: 5px 0;
}

#fancybox-buttons a.btnNext {
	background-position: -33px 0;
	border-right: 1px solid #3e3e3e;
}

#fancybox-buttons a.btnPlay {
	background-position: 0 -30px;
}

#fancybox-buttons a.btnPlayOn {
	background-position: -30px -30px;
}

#fancybox-buttons a.btnToggle {
	background-position: 3px -60px;
	border-left: 1px solid #111;
	border-right: 1px solid #3e3e3e;
	width: 35px
}

#fancybox-buttons a.btnToggleOn {
	background-position: -27px -60px;
}

#fancybox-buttons a.btnClose {
	border-left: 1px solid #111;
	width: 35px;
	background-position: -56px 0px;
}

#fancybox-buttons a.btnDisabled {
	opacity : 0.4;
	cursor: default;
}
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/" data-id="ckgafe0cn00355z9k4bk4fw17" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-fancybox/helpers/jquery.fancybox-buttons" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/" class="article-date">
  <time datetime="2020-10-15T03:18:44.736Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/">fancybox/helpers/jquery.fancybox-buttons</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         /*!
 * Buttons helper for fancyBox
 * version: 1.0.5 (Mon, 15 Oct 2012)
 * @requires fancyBox v2.0 or later
 *
 * Usage:
 *     $(".fancybox").fancybox({
 *         helpers : {
 *             buttons: {
 *                 position : 'top'
 *             }
 *         }
 *     });
 *
 */
;(function ($) {
	//Shortcut for fancyBox object
	var F = $.fancybox;

	//Add helper object
	F.helpers.buttons = {
		defaults : {
			skipSingle : false, // disables if gallery contains single image
			position   : 'top', // 'top' or 'bottom'
			tpl        : '<div id="fancybox-buttons"><ul><li><a class="btnPrev" title="Previous" href="javascript:;"></a></li><li><a class="btnPlay" title="Start slideshow" href="javascript:;"></a></li><li><a class="btnNext" title="Next" href="javascript:;"></a></li><li><a class="btnToggle" title="Toggle size" href="javascript:;"></a></li><li><a class="btnClose" title="Close" href="javascript:;"></a></li></ul></div>'
		},

		list : null,
		buttons: null,

		beforeLoad: function (opts, obj) {
			//Remove self if gallery do not have at least two items

			if (opts.skipSingle && obj.group.length < 2) {
				obj.helpers.buttons = false;
				obj.closeBtn = true;

				return;
			}

			//Increase top margin to give space for buttons
			obj.margin[ opts.position === 'bottom' ? 2 : 0 ] += 30;
		},

		onPlayStart: function () {
			if (this.buttons) {
				this.buttons.play.attr('title', 'Pause slideshow').addClass('btnPlayOn');
			}
		},

		onPlayEnd: function () {
			if (this.buttons) {
				this.buttons.play.attr('title', 'Start slideshow').removeClass('btnPlayOn');
			}
		},

		afterShow: function (opts, obj) {
			var buttons = this.buttons;

			if (!buttons) {
				this.list = $(opts.tpl).addClass(opts.position).appendTo('body');

				buttons = {
					prev   : this.list.find('.btnPrev').click( F.prev ),
					next   : this.list.find('.btnNext').click( F.next ),
					play   : this.list.find('.btnPlay').click( F.play ),
					toggle : this.list.find('.btnToggle').click( F.toggle ),
					close  : this.list.find('.btnClose').click( F.close )
				}
			}

			//Prev
			if (obj.index > 0 || obj.loop) {
				buttons.prev.removeClass('btnDisabled');
			} else {
				buttons.prev.addClass('btnDisabled');
			}

			//Next / Play
			if (obj.loop || obj.index < obj.group.length - 1) {
				buttons.next.removeClass('btnDisabled');
				buttons.play.removeClass('btnDisabled');

			} else {
				buttons.next.addClass('btnDisabled');
				buttons.play.addClass('btnDisabled');
			}

			this.buttons = buttons;

			this.onUpdate(opts, obj);
		},

		onUpdate: function (opts, obj) {
			var toggle;

			if (!this.buttons) {
				return;
			}

			toggle = this.buttons.toggle.removeClass('btnDisabled btnToggleOn');

			//Size toggle button
			if (obj.canShrink) {
				toggle.addClass('btnToggleOn');

			} else if (!obj.canExpand) {
				toggle.addClass('btnDisabled');
			}
		},

		beforeClose: function () {
			if (this.list) {
				this.list.remove();
			}

			this.list    = null;
			this.buttons = null;
		}
	};

}(jQuery));

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/fancybox/helpers/jquery.fancybox-buttons/" data-id="ckgafe0co00365z9kfon99ifh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/15/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/index/">tags/计算机网络/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/index/">tags/仓央嘉措菜/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/index/">tags/吴主任的公众号/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/Java/index/">tags/Java/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/index/">tags/多线程编程/index</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>