<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>page/2/index | JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="JoshuaYingWhatEgr Blogs                                                                                       JoshuaYingWhatEgr Blogs">
<meta property="og:type" content="article">
<meta property="og:title" content="page&#x2F;2&#x2F;index">
<meta property="og:url" content="https://joshuayingwhategr.github.io/2020/10/15/page/2/index/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:description" content="JoshuaYingWhatEgr Blogs                                                                                       JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-10-15T03:18:44.739Z">
<meta property="article:modified_time" content="2020-10-15T03:18:44.739Z">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-page/2/index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/15/page/2/index/" class="article-date">
  <time datetime="2020-10-15T03:18:44.739Z" itemprop="datePublished">2020-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      page/2/index
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JoshuaYingWhatEgr Blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JoshuaYingWhatEgr Blogs">
<meta property="og:url" content="https://joshuayingwhategr.github.io/page/2/index.html">
<meta property="og:site_name" content="JoshuaYingWhatEgr Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JoshuaYingWhatEgr">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JoshuaYingWhatEgr Blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://joshuayingwhategr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2019-10-17-要么蠢要么坏的思维方式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2019-10-16T16:00:00.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/">要么蠢要么坏的思维方式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>多数人倒也是真的不一味反对市场，只是总有个“但是”。比如上篇文章里的一个读者是这么评论的：</p>
<p>在小地方，供给有限的情况下也确实可能串通涨价，可能一个小镇上只有两三家网吧，七八家理发店，你涨人家也涨，或者你串通一两家涨，其他的也未免不会跟风涨。市场经济的完全自由竞争是好的，但政府相应的监管我觉得也是不可或缺的，只是有时候大家觉得管多了，该管的不管，可是这个度，还真不好拿捏。</p>
<p>这套说辞十分常见，他们也赞同竞争的好处，但同时认为价格监管（至少上篇我们谈的是价格）也是必要的，只不过一个拿捏的问题。首先结论是，价格根本不需要也不应该被干预。在精密的超级计算机都计算不出来什么价格是最优的。这里不仅是动态变化，背后还有人的意志。</p>
<p>另外，很多人喜欢说完全自由竞争，其实也是一句顺口溜。理论上完全自由竞争并不存在，自由的竞争有，只要政府不插手，但完全的竞争，只是一种人脑子里期待的一种无限接近。从不存在完全的竞争，想象下也是存在过一瞬间，但其实是不可描述的状态。</p>
<p>上篇文章是从理发店开始，那我们更极端一点吧，假设一座孤岛上只有一座理发店，这个理发店提供的是一种延年益寿的特殊理发服务，理发养生，独门绝技。没有竞争，连潜在的竞争都没有。这种理发价格应该多少钱呢？正常情况下必然是天价了，人人都想多活几年。</p>
<p>好，那么价格应该多少合适？没有答案不是因为算不出来，而是因为定价权其实是私有财产的一个分支。什么叫定价权，就是我的东西我想卖想扔掉（等于是价格为零）都是我的自由。这是定价权。</p>
<p>如果这个岛上神奇的理发师有一天突然就不想理发了，给多少钱都不，可以吗？实在给不出任何理由。因为人家不欠任何人的。</p>
<p>一个尊重私有产权的社会在制定任何政策的时候都应该小心翼翼避免侵害了他人的财产权。当然，这是我们的期望。因为我相信大部分人都不希望自己的东西被肆意剥夺，在交易的时候价格被各种名义限制，都希望生活在私有财产能得到最大程度保障的社会，那么在思考问题时请尽量从个人权利的角度出发，否则要么是蠢要么就是坏了。</p>
<p>蠢，以为这种侵害不会到自己头上。坏，侵犯别人又不关我的事。</p>
<p>房产税支持，觉得主要是一种度的拿捏，遗产税支持，觉得要均衡好，稳定物价也支持，说这是关乎国计民生，稳定团结。总会找到理由，因为好像跟自己完全无关，贵州的一个县的牛肉粉就应该不让涨价，毕竟卖牛肉粉的不是你嘛。</p>
<p>从权利的角度谈问题很多人都觉得过于简单了，会钻牛角尖，举出各种困境。其实把这些暂且放在一边，只是说，最好需要养成这样的思维习惯，学会从权利的角度先想一遍。这是一个健全社会公民应有的基础思维方式。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/17/2019-10-17-%E8%A6%81%E4%B9%88%E8%A0%A2%E8%A6%81%E4%B9%88%E5%9D%8F%E7%9A%84%E6%80%9D%E7%BB%B4%E6%96%B9%E5%BC%8F/" data-id="ck8tr9s78001ln29kfy0sc7hl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">吴主任的公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-16-遗憾，这些人才是多数" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/" class="article-date">
  <time datetime="2019-10-15T16:00:00.000Z" itemprop="datePublished">2019-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/">遗憾，这些人才是多数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原创： 吴主任  吴主任  今天</p>
<p>贵州黔西县的牛肉粉因为涨价被当地市场监管部门认定为“串通涨价”事件。价格管制的话题我大概聊了有十年了，算上以前工作时做的专题，数量没法统计。所以那篇文章更想分享的是一大串的评论，想让大家知道，你以为的基础常识在很多人的认知里不是。</p>
<p>今天，中国的绝大多数人一边享受着市场经济带来的繁荣，一边又总是在期待有关部门能够把各种价格关起来，当然主要是那些他们觉得贵的，不合理的。</p>
<p>比如有个读者问：但如果一点都不管的话，商贩涨价完全没成本没约束啊，就像洗发店似的，一个比一个贵，去年还都25剪一个，今年蹭蹭蹭都涨到35。即使明天楼下的理发店都涨到50一次，我也没什么办法不是吗？难道每次要坐车去其它地方剪头发？</p>
<p>那就再一次耐心地就这个问题展开聊一聊。</p>
<p>说说我亲历的理发的价格。2009年，榆林市，50块钱。2019年，北京市，5块钱。请注意时间和地点。有些人确实不知道，北京一些广场或者路边那种理发摊位，就5块钱。当然，你随便去一家有托尼总监的店，一两百块钱不要太惊讶。</p>
<p>总体上几十年来的物价上涨非常明显，这个每个人稍微回忆一下都能体会到。也正因此总会有让你惊讶的价格存在。这也是很多人打开拼多多时的感受，但如果去过小地方的批发市场就明白，拼多多不过是把它们搬到网上去了而已。</p>
<p>这些都是竞争，价格也是动态的。说涨价没有约束完全是胡话。按照人们趋利避害的特性，谁卖东西不想卖个天价呢？这种想也就是痴心妄想，因为最大的约束就是市场。理发店也想理个头一千块钱，你去开个理发店试试，看是不是可以随意涨价。或者随便二手市场随便卖个东西，试试就知道了。</p>
<p>所以我们要感谢竞争，因为竞争是最大的监督和约束。商家们本分做事，笑脸相迎，服务到位绝不是吃饱了没事干，只是为了更有竞争力。只有那种被权力挡在门外的领域才可以高枕无忧，商品和服务态度都很恶劣，还活得不错。靠有关部门监督吗？可以，配合一下做做样子，但无法解决根本问题。</p>
<p>很简单的道理，应付监管容易，讨好消费者却非常难。前者不仅是死的，而且可以收买，后者的要求就苛刻了，而且随时在变化。比如说衣服，某种潮流可能过了一季就彻底无人问津了。</p>
<p>价格管制的必然结果就是打击供给，有利可图才会吸引更多人进来。价格严格管制，不仅打击了供给，也会让原本的商品和服务的质量在消费者注意不到的地方偷工减料。</p>
<p>就理发这么小的一件事，价格也是整个经济运转过程慢慢给出的。如果定高了可能就关店了，定低了呢，有些划不来。至于多少钱合适，没有任何可参考的标准，这跟该商品和服务的目标人群定位和所在地的整体经济情况以及整个大环境的物价等息息相关。因此，即便从这一点也可以看出价格管制有多荒谬。市场监管部门里的那些人凭什么知道某个商品多少钱合适？但他们觉得他们知道。</p>
<p>楼下的理发店突然涨到100块钱了，这件事可能发生吗？几乎不可能，除非就是不想干了。因为理发不是生死攸关，也不是整座城市就这一家。总有替代品。</p>
<p>如果有一天你醒来发现整座城市每家理发店剪个头发最少1000块钱，你确认下是不是穿越到二十年后了，然后出门看看楼下的一碗面条是不是差不多也得500块钱，如果都不是，依然是当下的时间和物价。那么，请相信我，大概率是你根本没心思关心发型问题，你和隔壁老王都在着急筹划快速开个理发店。媒体称这一现象为“莫名其妙的时尚保健风引起的理发店泡沫”“退潮了才知道谁在裸泳”……</p>
<p>常去的理发店突然涨价了你受不了，你当然没办法人家，但你可以选择便宜的，或者自己理发，要求管一管有些无耻，人家并没有欠你什么。除非你觉得有天物价局也来限制你的工资上限是合理的。今年你要求月薪五千，明年你希望找个八千的，凭什么呢？也让物价局管一管你的价格啊。不得高于五千！</p>
<p>如此基础枯燥且无聊的话题，聊着聊着就1600多个字了。但不可思议的是居然那么多人支持有关部门管一管贵州牛肉粉的涨价。但我们要直面现实，中国真的好大，地大物博物种丰富，我们国家8亿网民，估计有6亿是希望有关部门管一管各种商品价格的。所以，非常遗憾，现实就是这些人才是多数。也正因此有关部门如鱼得水。恭喜发财。</p>
<p>言归正传，真心希望能有更多人明白这些基础的知识。别人的观念看似与自己无关，但更深入地看，社会是由每个人的观念共同作用下决定了一个大致的方向。因此，不能说重复这些“基础常识”没用，考虑到当下的局面多数人的认知，更多人能明白些正确的且并不难懂理念，长远当然是有利于每个人。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/16/2019-10-16-%E9%81%97%E6%86%BE%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BA%BA%E6%89%8D%E6%98%AF%E5%A4%9A%E6%95%B0/" data-id="ck8tr9s76001gn29kftakakyr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">吴主任的公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-11-Android Gradle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/11/2019-10-11-Android%20Gradle/" class="article-date">
  <time datetime="2019-10-10T16:00:00.000Z" itemprop="datePublished">2019-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/11/2019-10-11-Android%20Gradle/">Android Gradle</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>gradle是作为一个在Android studio中的编译打包工具。<br>关于grale的编译打包流程可以<a href="https://developer.android.com/studio/build" target="_blank" rel="noopener">看图</a></p>
<h1 id="项目编译配置文件"><a href="#项目编译配置文件" class="headerlink" title="项目编译配置文件"></a>项目编译配置文件</h1><p><a href="https://developer.android.com/studio/build" target="_blank" rel="noopener">看图</a><br>在日常我们创建一个Android项目的时候目录就是这样的。</p>
<h2 id="gradle配置文件"><a href="#gradle配置文件" class="headerlink" title="gradle配置文件"></a>gradle配置文件</h2><p>setting.gradle是当我们的项目中需要引入一些jar，arr等第三方库包含到我们的项目中时我们需要在这个gradle中配置。</p>
<h2 id="项目的gradle-—-build-gradle"><a href="#项目的gradle-—-build-gradle" class="headerlink" title="项目的gradle — build.gradle"></a>项目的gradle — build.gradle</h2><p>此编译文件适用于项目中所有模块的编译配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Top-level build file where you can add configuration options common to all sub-projects&#x2F;modules.</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    </span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath &#39;com.android.tools.build:gradle:3.3.1&#39;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; NOTE: Do not place your application dependencies here; they belong</span><br><span class="line">        &#x2F;&#x2F; in the individual module build.gradle files</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123; url &#39;https:&#x2F;&#x2F;jitpack.io&#39; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(type: Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的配置代码中buildscript代码块主要是依赖gradle插件。allprojects代码块可以理解为项目中需要依赖的第三方仓库从google和jcenter以及maven { url ‘<a href="https://jitpack.io&#39;" target="_blank" rel="noopener">https://jitpack.io&#39;</a> }拉取。</p>
<h2 id="配置项目属性"><a href="#配置项目属性" class="headerlink" title="配置项目属性"></a>配置项目属性</h2><p>在项目的build.gradle中我们还可以配置在所有模块build.gradle中共用的属性，因此可以在顶级项目build.gradle中ext代码块中配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;...&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;...&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; This block encapsulates custom properties and makes them available to all</span><br><span class="line">&#x2F;&#x2F; modules in the project.</span><br><span class="line">ext &#123;</span><br><span class="line">    &#x2F;&#x2F; The following are only a few examples of the types of properties you can define.</span><br><span class="line">    compileSdkVersion &#x3D; 28</span><br><span class="line">    &#x2F;&#x2F; You can also create properties to specify versions for dependencies.</span><br><span class="line">    &#x2F;&#x2F; Having consistent versions between modules can avoid conflicts with behavior.</span><br><span class="line">    supportLibVersion &#x3D; &quot;28.0.0&quot;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>然后在模块中引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  &#x2F;&#x2F; Use the following syntax to access properties you defined at the project level:</span><br><span class="line">  &#x2F;&#x2F; rootProject.ext.property_name</span><br><span class="line">  compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation &quot;com.android.support:appcompat-v7:$&#123;rootProject.ext.supportLibVersion&#125;&quot;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="应用级编译模块"><a href="#应用级编译模块" class="headerlink" title="应用级编译模块"></a>应用级编译模块</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * The first line in the build configuration applies the Android plugin for</span><br><span class="line"> * Gradle to this build and makes the android block available to specify</span><br><span class="line"> * Android-specific build options.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">apply plugin: &#39;com.android.application&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The android block is where you configure all your Android-specific</span><br><span class="line"> * build options.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * compileSdkVersion specifies the Android API level Gradle should use to</span><br><span class="line">   * compile your app. This means your app can use the API features included in</span><br><span class="line">   * this API level and lower.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  compileSdkVersion 28</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * buildToolsVersion specifies the version of the SDK build tools, command-line</span><br><span class="line">   * utilities, and compiler that Gradle should use to build your app. You need to</span><br><span class="line">   * download the build tools using the SDK Manager.</span><br><span class="line">   *</span><br><span class="line">   * This property is optional because the plugin uses a recommended version of</span><br><span class="line">   * the build tools by default.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  buildToolsVersion &quot;29.0.0&quot;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The defaultConfig block encapsulates default settings and entries for all</span><br><span class="line">   * build variants, and can override some attributes in main&#x2F;AndroidManifest.xml</span><br><span class="line">   * dynamically from the build system. You can configure product flavors to override</span><br><span class="line">   * these values for different versions of your app.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  defaultConfig &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * applicationId uniquely identifies the package for publishing.</span><br><span class="line">     * However, your source code should still reference the package name</span><br><span class="line">     * defined by the package attribute in the main&#x2F;AndroidManifest.xml file.</span><br><span class="line">     *&#x2F;</span><br><span class="line"></span><br><span class="line">    applicationId &#39;com.example.myapp&#39;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines the minimum API level required to run the app.</span><br><span class="line">    minSdkVersion 15</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Specifies the API level used to test the app.</span><br><span class="line">    targetSdkVersion 28</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines the version number of your app.</span><br><span class="line">    versionCode 1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Defines a user-friendly version name for your app.</span><br><span class="line">    versionName &quot;1.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The buildTypes block is where you can configure multiple build types.</span><br><span class="line">   * By default, the build system defines two build types: debug and release. The</span><br><span class="line">   * debug build type is not explicitly shown in the default build configuration,</span><br><span class="line">   * but it includes debugging tools and is signed with the debug key. The release</span><br><span class="line">   * build type applies Proguard settings and is not signed by default.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  buildTypes &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * By default, Android Studio configures the release build type to enable code</span><br><span class="line">     * shrinking, using minifyEnabled, and specifies the Proguard settings file.</span><br><span class="line">     *&#x2F;</span><br><span class="line"></span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled true &#x2F;&#x2F; Enables code shrinking for the release build type.</span><br><span class="line">        proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The productFlavors block is where you can configure multiple product flavors.</span><br><span class="line">   * This allows you to create different versions of your app that can</span><br><span class="line">   * override the defaultConfig block with their own settings. Product flavors</span><br><span class="line">   * are optional, and the build system does not create them by default.</span><br><span class="line">   *</span><br><span class="line">   * This example creates a free and paid product flavor. Each product flavor</span><br><span class="line">   * then specifies its own application ID, so that they can exist on the Google</span><br><span class="line">   * Play Store, or an Android device, simultaneously.</span><br><span class="line">   *</span><br><span class="line">   * If you declare product flavors, you must also declare flavor dimensions</span><br><span class="line">   * and assign each flavor to a flavor dimension.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  flavorDimensions &quot;tier&quot;</span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    free &#123;</span><br><span class="line">      dimension &quot;tier&quot;</span><br><span class="line">      applicationId &#39;com.example.myapp.free&#39;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paid &#123;</span><br><span class="line">      dimension &quot;tier&quot;</span><br><span class="line">      applicationId &#39;com.example.myapp.paid&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The splits block is where you can configure different APK builds that</span><br><span class="line">   * each contain only code and resources for a supported screen density or</span><br><span class="line">   * ABI. You&#39;ll also need to configure your build so that each APK has a</span><br><span class="line">   * different versionCode.</span><br><span class="line">   *&#x2F;</span><br><span class="line"></span><br><span class="line">  splits &#123;</span><br><span class="line">    &#x2F;&#x2F; Settings to build multiple APKs based on screen density.</span><br><span class="line">    density &#123;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Enable or disable building multiple APKs.</span><br><span class="line">      enable false</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; Exclude these densities when building multiple APKs.</span><br><span class="line">      exclude &quot;ldpi&quot;, &quot;tvdpi&quot;, &quot;xxxhdpi&quot;, &quot;400dpi&quot;, &quot;560dpi&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The dependencies block in the module-level build configuration file</span><br><span class="line"> * specifies dependencies required to build only the module itself.</span><br><span class="line"> * To learn more, go to Add build dependencies.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation project(&quot;:lib&quot;)</span><br><span class="line">    implementation &#39;com.android.support:appcompat-v7:28.0.0&#39;</span><br><span class="line">    implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果当前apk需要打多渠道包的话可以通过productFlavors添加不通的渠道。</p>
<h1 id="gradle-properties"><a href="#gradle-properties" class="headerlink" title="gradle.properties"></a>gradle.properties</h1><p>在这个文件中可以设置gradle。<br>#local.properties<br>当前编译环境的sdk和ndk路径，这个文件里的内容由Androidstudio自动完成。</p>
<h2 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h2><ul>
<li>implementation:只会暴露给直接依赖的模块<br>在项目中我们创建2个moudle,分别命名为Module1和Module2.他们的依赖关系为：<br>app(implementation Module1)—&gt;Module1(implementation Moudle2)—&gt;Module2.<br>这种依赖关系中我们无法在app中使用Module2中的资源。</li>
<li>api:会暴露给间接依赖的模块<br>如上此时app可以调用Module2中的资源。</li>
<li>compileOnly:只在编译期间依赖模块,打包以后运行时不会依赖。<br>如上依赖关系为 app(implementation Module1)—&gt;Module1(compileOnly  Module2)—&gt;Module2.<br>在编译期间app无法引用到Module2,Module1中正常引用，但是打包运行之后会报错，从名称也可以看出仅编译时。</li>
<li>runtimeOnly:只在运行时依赖模块,编译时不依赖 </li>
</ul>
<h2 id="productFlavors"><a href="#productFlavors" class="headerlink" title="productFlavors"></a>productFlavors</h2><h2 id="sourceSets"><a href="#sourceSets" class="headerlink" title="sourceSets"></a>sourceSets</h2><h2 id="怎样生成一个Gradle-Wrapper"><a href="#怎样生成一个Gradle-Wrapper" class="headerlink" title="怎样生成一个Gradle Wrapper"></a>怎样生成一个Gradle Wrapper</h2><p>项目中的gradle wrapper目录文件可以帮助我们统一gradle的版本以免造成程序开发中版本不一构建失败的问题。<br>有些时候我们可以在项目中通过命令的方式在我们的项目目录中生成一个wrapper（包装）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$gradle wrapper</span><br></pre></td></tr></table></figure>
<h2 id="gradle-wrapper-properties"><a href="#gradle-wrapper-properties" class="headerlink" title="gradle-wrapper.properties"></a>gradle-wrapper.properties</h2><p> 这个是在项目中的gradle文件中的gradle配置文件,它里面的内容主要有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Fri Oct 11 22:58:29 CST 2019</span><br><span class="line">distributionBase&#x3D;GRADLE_USER_HOME</span><br><span class="line">distributionPath&#x3D;wrapper&#x2F;dists</span><br><span class="line">zipStoreBase&#x3D;GRADLE_USER_HOME</span><br><span class="line">zipStorePath&#x3D;wrapper&#x2F;dists</span><br><span class="line">distributionUrl&#x3D;https\:&#x2F;&#x2F;services.gradle.org&#x2F;distributions&#x2F;gradle-5.4.1-all.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>distributionBase:这个表示下载后的gradle压缩包解压后存储的主目录</li>
<li>distributionPath:压缩包的路径</li>
<li>zipStoreBase:存放压缩后的zip</li>
<li>zipStorePath:zip压缩包的路径</li>
<li>distributionUrl:gralde的下载地址(这个非常的重要,因为这个会根据URL路径下载对应的gradle版本)</li>
</ul>
<h2 id="自定义Wrapper-Task"><a href="#自定义Wrapper-Task" class="headerlink" title="自定义Wrapper Task"></a>自定义Wrapper Task</h2><p>我们可以在当前根项目中的buidl.gradle脚本文件中创建一个冠以wrapper的task</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line">     * 通过task设置要下载的gradle的版本</span><br><span class="line">     *&#x2F;</span><br><span class="line">    task wrappers(type: Wrapper) &#123;</span><br><span class="line">    gradleVersion &#x3D; &#39;5.6.2&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时也可以添加一些其他的配置，比如上面的一些字段(distributionBase,distributionPath,distributionUrl)</p>
<h2 id="强制刷新依赖"><a href="#强制刷新依赖" class="headerlink" title="强制刷新依赖"></a>强制刷新依赖</h2><p>有些时候我们从maven库中下载的一些第三方依赖由于缓存的原因导致一直无法更新到最新的版本,这个时候我们可以通过一下的命令强制第三方依赖刷新.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle --refresh-dependencies assemble</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/11/2019-10-11-Android%20Gradle/" data-id="ck8tr9s77001in29k3kv3hunm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-10-10-Java反射机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" class="article-date">
  <time datetime="2019-10-09T16:00:00.000Z" itemprop="datePublished">2019-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/">Java反射机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是Java反射机制"><a href="#什么是Java反射机制" class="headerlink" title="什么是Java反射机制"></a>什么是Java反射机制</h1><p>在我们的开发过程中有些时候需要针对一些特定的类需要更改他的内部传参或者方法的调用以达到我们的目的.</p>
<p>#使用反射获取类的基本信息</p>
<h2 id="获取所有变量的信息"><a href="#获取所有变量的信息" class="headerlink" title="获取所有变量的信息"></a>获取所有变量的信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class childClass &#x3D; Child.class;</span><br><span class="line">        &#x2F;&#x2F;fileds方法是获取当前类和继承的父类的所有public变量</span><br><span class="line">        &#x2F;&#x2F;Field[] declaredFields &#x3D; childClass.getFields();</span><br><span class="line">        &#x2F;&#x2F;DeclaredFields是获取当前类的所有方法和成员变量</span><br><span class="line">        Field[] declaredFields &#x3D; childClass.getDeclaredFields();</span><br><span class="line">        for (Field field : declaredFields) &#123;</span><br><span class="line">            System.out.println(field.getType().getName() + &quot; &quot; + field.getName());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取所有方法的信息"><a href="#获取所有方法的信息" class="headerlink" title="获取所有方法的信息"></a>获取所有方法的信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">        * 获取所有方法的信息</span><br><span class="line">        *&#x2F;</span><br><span class="line">       &#x2F;&#x2F;获取当前类和父类的所有public方法</span><br><span class="line">       &#x2F;&#x2F;Method[] method &#x3D; childClass.getMethods();</span><br><span class="line">       &#x2F;&#x2F;获取本类的所有方法(不问访问权限)</span><br><span class="line">       Method[] methods &#x3D; childClass.getDeclaredMethods();</span><br><span class="line">       for (Method method : methods) &#123;</span><br><span class="line">           &#x2F;&#x2F;获取方法的访问权限</span><br><span class="line">           int modifiers &#x3D; method.getModifiers();</span><br><span class="line">           System.out.println(Modifier.toString(modifiers));</span><br><span class="line">           &#x2F;&#x2F;获取并输出方法的返回类型</span><br><span class="line">           Class&lt;?&gt; returnType &#x3D; method.getReturnType();</span><br><span class="line">           System.out.println(returnType.getName() + &quot; &quot; + method.getName() + &quot; &quot;);</span><br><span class="line">           &#x2F;&#x2F;获取并输出所有方法的参数</span><br><span class="line">           Parameter[] parameters &#x3D; method.getParameters();</span><br><span class="line">           for (Parameter parameter : parameters) &#123;</span><br><span class="line">               System.out.println(parameter.getType().getName() + &quot; &quot; + parameter.getName());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>#访问和操作类的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Method declaredMethod &#x3D; null;</span><br><span class="line">       Child child &#x3D; new Child();</span><br><span class="line">       Class&lt;? extends Child&gt; aClass &#x3D; child.getClass();</span><br><span class="line">       try &#123;</span><br><span class="line">           declaredMethod &#x3D; aClass.getDeclaredMethod(&quot;setGender&quot;, String.class);</span><br><span class="line">           &#x2F;&#x2F;这里调用Accessible的意思就是获取私有方法(private)的访问权限</span><br><span class="line">           declaredMethod.setAccessible(true);</span><br><span class="line">           declaredMethod.invoke(child, &quot;man&quot;);</span><br><span class="line">           System.out.println(child.getGender());</span><br><span class="line">       &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>#访问和操作变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">           Field field &#x3D; childClass.getDeclaredField(&quot;MSG&quot;);</span><br><span class="line">           field.setAccessible(true);</span><br><span class="line">           field.set(childClass, &quot;MSG CHANGE&quot;);</span><br><span class="line">           System.out.println(&quot;MSG AFTER:&quot; + new Child().getMsg());</span><br><span class="line">       &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/10/10/2019-10-10-Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" data-id="ck8tr9s730019n29k5da8b9yk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-28-Android事件分发机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/" class="article-date">
  <time datetime="2019-09-27T16:00:00.000Z" itemprop="datePublished">2019-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/">Android事件分发机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>学习Android的事件分发机制，掌握其原理能够处理复杂的事件分发解决滑动冲突编写一个Demo示例，通过查看Blog了解。<br>通常我们在业务开发中会碰到多个View可以同时响应一个事件的情况,但是事件又只能传递给其中的某一个View这个时候怎样让系统按照你的意愿将此事件分发给指定的View处理就需要有事件分发的基础了.<br>在Android的事件分发中当我们按下屏幕时这个点击事件传递的顺序是这样：<br>Activity—&gt;phoneWindow—&gt;DecorView—&gt;ViewGroup—&gt;……—&gt;View。</p>
<h2 id="Activity中的事件分发机制"><a href="#Activity中的事件分发机制" class="headerlink" title="Activity中的事件分发机制"></a>Activity中的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Called to process touch screen events.  You can override this to</span><br><span class="line">   * intercept all touch screen events before they are dispatched to the</span><br><span class="line">   * window.  Be sure to call this implementation for touch screen events</span><br><span class="line">   * that should be handled normally.</span><br><span class="line">   *</span><br><span class="line">   * @param ev The touch screen event.</span><br><span class="line">   *</span><br><span class="line">   * @return boolean Return true if this event was consumed.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public boolean dispatchTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">      if (ev.getAction() &#x3D;&#x3D; MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">          onUserInteraction();</span><br><span class="line">      &#125;</span><br><span class="line">      if (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      return onTouchEvent(ev);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>当前事件首先会在Activity中的dispatchTouchEvent接收,按下的Action先是MotionEvent.ACTION_DOWN然后首先会执行 onUserInteraction()这个方法。<br>接下来分析一下onUserInteraction()这个方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Called whenever a key, touch, or trackball event is dispatched to the</span><br><span class="line">     * activity.  Implement this method if you wish to know that the user has</span><br><span class="line">     * interacted with the device in some way while your activity is running.</span><br><span class="line">     * This callback and &#123;@link #onUserLeaveHint&#125; are intended to help</span><br><span class="line">     * activities manage status bar notifications intelligently; specifically,</span><br><span class="line">     * for helping activities determine the proper time to cancel a notfication.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;All calls to your activity&#39;s &#123;@link #onUserLeaveHint&#125; callback will</span><br><span class="line">     * be accompanied by calls to &#123;@link #onUserInteraction&#125;.  This</span><br><span class="line">     * ensures that your activity will be told of relevant user activity such</span><br><span class="line">     * as pulling down the notification pane and touching an item there.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;Note that this callback will be invoked for the touch down action</span><br><span class="line">     * that begins a touch gesture, but may not be invoked for the touch-moved</span><br><span class="line">     * and touch-up actions that follow.</span><br><span class="line">     *</span><br><span class="line">     * @see #onUserLeaveHint()</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void onUserInteraction() &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此方法是一个空方法，当此Activity在栈顶时,触屏点击按home，back，menu键都会触发此方法.<br>接下来分析第二个if语句：getWindow().superDispatchTouchEvent(ev)。<br>getWindow是一个Window它是一个抽象类具体实现是phoneWindow。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">       return mDecor.superDispatchTouchEvent(event);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里将会调用DecorView中的superDispatchTouchEvent。然后在superDispatchTouchEvent中接着调用ViewGroup中的dispatchTouchEvent。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        return super.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最终事件就传递到了我们的ViewGroup中.<br>如果此时getWindow().superDispatchTouchEvent(ev)返回的是true该点击事件将停止往下传递，事件传递结束。否则继续往下调用onTouchEvent(ev)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * Called when a touch screen event was not handled by any of the views</span><br><span class="line">     * under it.  This is most useful to process touch events that happen</span><br><span class="line">     * outside of your window bounds, where there is no view to receive it.</span><br><span class="line">     *</span><br><span class="line">     * @param event The touch screen event being processed.</span><br><span class="line">     *</span><br><span class="line">     * @return Return true if you have consumed the event, false if you haven&#39;t.</span><br><span class="line">     * The default implementation always returns false.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">        if (mWindow.shouldCloseOnTouch(this, event)) &#123;</span><br><span class="line">            finish();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>执行到onTouchEven中的mWindow.shouldCloseOnTouch(this, event)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean shouldCloseOnTouch(Context context, MotionEvent event) &#123;</span><br><span class="line">       final boolean isOutside &#x3D;</span><br><span class="line">               event.getAction() &#x3D;&#x3D; MotionEvent.ACTION_DOWN &amp;&amp; isOutOfBounds(context, event)</span><br><span class="line">               || event.getAction() &#x3D;&#x3D; MotionEvent.ACTION_OUTSIDE;</span><br><span class="line">       if (mCloseOnTouchOutside &amp;&amp; peekDecorView() !&#x3D; null &amp;&amp; isOutside) &#123;</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br><span class="line">       return false;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>返回ture说明事件在边界外,消费了该事件；false未消费此事件(默认).<br>最终onTouchEvent返回的是false(在事件的边界范围内时,默认返回false)，Activity的dispatchTouchEvent执行结束.</p>
<h2 id="ViewGroup的事件分发机制"><a href="#ViewGroup的事件分发机制" class="headerlink" title="ViewGroup的事件分发机制"></a>ViewGroup的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;**</span><br><span class="line">  * 源码分析：ViewGroup.dispatchTouchEvent（）</span><br><span class="line">  *&#x2F; </span><br><span class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123; </span><br><span class="line"></span><br><span class="line">    ... &#x2F;&#x2F; 仅贴出关键代码</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析1：ViewGroup每次事件分发时，都需调用onInterceptTouchEvent()询问是否拦截事件</span><br><span class="line">            if (disallowIntercept || !onInterceptTouchEvent(ev)) &#123;  </span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 判断值1：disallowIntercept &#x3D; 是否禁用事件拦截的功能(默认是false)，可通过调用requestDisallowInterceptTouchEvent（）修改</span><br><span class="line">            &#x2F;&#x2F; 判断值2： !onInterceptTouchEvent(ev) &#x3D; 对onInterceptTouchEvent()返回值取反</span><br><span class="line">                    &#x2F;&#x2F; a. 若在onInterceptTouchEvent()中返回false（即不拦截事件），就会让第二个值为true，从而进入到条件判断的内部</span><br><span class="line">                    &#x2F;&#x2F; b. 若在onInterceptTouchEvent()中返回true（即拦截事件），就会让第二个值为false，从而跳出了这个条件判断</span><br><span class="line">                    &#x2F;&#x2F; c. 关于onInterceptTouchEvent() -&gt;&gt;分析1</span><br><span class="line"></span><br><span class="line">                ev.setAction(MotionEvent.ACTION_DOWN);  </span><br><span class="line">                final int scrolledXInt &#x3D; (int) scrolledXFloat;  </span><br><span class="line">                final int scrolledYInt &#x3D; (int) scrolledYFloat;  </span><br><span class="line">                final View[] children &#x3D; mChildren;  </span><br><span class="line">                final int count &#x3D; mChildrenCount;  </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析2</span><br><span class="line">            &#x2F;&#x2F; 通过for循环，遍历了当前ViewGroup下的所有子View</span><br><span class="line">            for (int i &#x3D; count - 1; i &gt;&#x3D; 0; i--) &#123;  </span><br><span class="line">                final View child &#x3D; children[i];  </span><br><span class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) &#x3D;&#x3D; VISIBLE  </span><br><span class="line">                        || child.getAnimation() !&#x3D; null) &#123;  </span><br><span class="line">                    child.getHitRect(frame);  </span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; 判断当前遍历的View是不是正在点击的View，从而找到当前被点击的View</span><br><span class="line">                    &#x2F;&#x2F; 若是，则进入条件判断内部</span><br><span class="line">                    if (frame.contains(scrolledXInt, scrolledYInt)) &#123;  </span><br><span class="line">                        final float xc &#x3D; scrolledXFloat - child.mLeft;  </span><br><span class="line">                        final float yc &#x3D; scrolledYFloat - child.mTop;  </span><br><span class="line">                        ev.setLocation(xc, yc);  </span><br><span class="line">                        child.mPrivateFlags &amp;&#x3D; ~CANCEL_NEXT_UP_EVENT;  </span><br><span class="line"></span><br><span class="line">                        &#x2F;&#x2F; 条件判断的内部调用了该View的dispatchTouchEvent()</span><br><span class="line">                        &#x2F;&#x2F; 即 实现了点击事件从ViewGroup到子View的传递（具体请看下面的View事件分发机制）</span><br><span class="line">                        if (child.dispatchTouchEvent(ev))  &#123; </span><br><span class="line"></span><br><span class="line">                        mMotionTarget &#x3D; child;  </span><br><span class="line">                        return true; </span><br><span class="line">                        &#x2F;&#x2F; 调用子View的dispatchTouchEvent后是有返回值的</span><br><span class="line">                        &#x2F;&#x2F; 若该控件可点击，那么点击时，dispatchTouchEvent的返回值必定是true，因此会导致条件判断成立</span><br><span class="line">                        &#x2F;&#x2F; 于是给ViewGroup的dispatchTouchEvent（）直接返回了true，即直接跳出</span><br><span class="line">                        &#x2F;&#x2F; 即把ViewGroup的点击事件拦截掉</span><br><span class="line"></span><br><span class="line">                                &#125;  </span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            boolean isUpOrCancel &#x3D; (action &#x3D;&#x3D; MotionEvent.ACTION_UP) ||  </span><br><span class="line">                    (action &#x3D;&#x3D; MotionEvent.ACTION_CANCEL);  </span><br><span class="line">            if (isUpOrCancel) &#123;  </span><br><span class="line">                mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;  </span><br><span class="line">            &#125;  </span><br><span class="line">            final View target &#x3D; mMotionTarget;  </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 重点分析3</span><br><span class="line">        &#x2F;&#x2F; 若点击的是空白处（即无任何View接收事件） &#x2F; 拦截事件（手动复写onInterceptTouchEvent（），从而让其返回true）</span><br><span class="line">        if (target &#x3D;&#x3D; null) &#123;  </span><br><span class="line">            ev.setLocation(xf, yf);  </span><br><span class="line">            if ((mPrivateFlags &amp; CANCEL_NEXT_UP_EVENT) !&#x3D; 0) &#123;  </span><br><span class="line">                ev.setAction(MotionEvent.ACTION_CANCEL);  </span><br><span class="line">                mPrivateFlags &amp;&#x3D; ~CANCEL_NEXT_UP_EVENT;  </span><br><span class="line">            &#125;  </span><br><span class="line">            </span><br><span class="line">            return super.dispatchTouchEvent(ev);</span><br><span class="line">            &#x2F;&#x2F; 调用ViewGroup父类的dispatchTouchEvent()，即View.dispatchTouchEvent()</span><br><span class="line">            &#x2F;&#x2F; 因此会执行ViewGroup的onTouch() -&gt;&gt; onTouchEvent() -&gt;&gt; performClick（） -&gt;&gt; onClick()，即自己处理该事件，事件不会往下传递（具体请参考View事件的分发机制中的View.dispatchTouchEvent（））</span><br><span class="line">            &#x2F;&#x2F; 此处需与上面区别：子View的dispatchTouchEvent（）</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        ... </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**</span><br><span class="line">  * 分析1：ViewGroup.onInterceptTouchEvent()</span><br><span class="line">  * 作用：是否拦截事件</span><br><span class="line">  * 说明：</span><br><span class="line">  *     a. 返回true &#x3D; 拦截，即事件停止往下传递（需手动设置，即复写onInterceptTouchEvent（），从而让其返回true）</span><br><span class="line">  *     b. 返回false &#x3D; 不拦截（默认）</span><br><span class="line">  *&#x2F;</span><br><span class="line">  public boolean onInterceptTouchEvent(MotionEvent ev) &#123;  </span><br><span class="line">    </span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line">  &#x2F;&#x2F; 回到调用原处</span><br></pre></td></tr></table></figure>
<p>ViewGroup每次分发事件时都会调用intercepted询问是否需要拦截事件。对intercepted中的值进行取反。<br>如果intercepted=false就会到ViewGroup中的逻辑，进入newTouchTarget == null &amp;&amp; childrenCount != 0循环遍历找到当前被点击的View。如是进入条件判断的内部，然后调用该View的dispatchTouchEvent如果子View处理了点击事件则返回true直接跳出当前逻辑，否则执行super.dispatchTouchEvent(ev)。接着就会执行View中的onTouch—&gt;onTouchEvent—&gt;performClick。因此ViewGroup中的onTouchEvnet就执行自己处理此事件。</p>
<h2 id="View的事件分发机制"><a href="#View的事件分发机制" class="headerlink" title="View的事件分发机制"></a>View的事件分发机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">  * Pass the touch screen motion event down to the target view, or this</span><br><span class="line">  * view if it is the target.</span><br><span class="line">  *</span><br><span class="line">  * @param event The motion event to be dispatched.</span><br><span class="line">  * @return True if the event was handled by the view, false otherwise.</span><br><span class="line">  *&#x2F;</span><br><span class="line"> public boolean dispatchTouchEvent(MotionEvent event) &#123;</span><br><span class="line">     &#x2F;&#x2F; If the event should be handled by accessibility focus first.</span><br><span class="line">     if (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">         if ((mViewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line">         &#x2F;&#x2F;noinspection SimplifiableIfStatement</span><br><span class="line">         ListenerInfo li &#x3D; mListenerInfo;</span><br><span class="line">         if (li !&#x3D; null &amp;&amp; li.mOnTouchListener !&#x3D; null</span><br><span class="line">                 &amp;&amp; (mViewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; ENABLED</span><br><span class="line">                 &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">             result &#x3D; true;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>当li就是onTouchListener为空时或者onTouchListener.onTouch=false就会执行onTouchEvent方法,否则直接返回true.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Implement this method to handle touch screen motion events.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * If this method is used to detect click actions, it is recommended that</span><br><span class="line"> * the actions be performed by implementing and calling</span><br><span class="line"> * &#123;@link #performClick()&#125;. This will ensure consistent system behavior,</span><br><span class="line"> * including:</span><br><span class="line"> * &lt;ul&gt;</span><br><span class="line"> * &lt;li&gt;obeying click sound preferences</span><br><span class="line"> * &lt;li&gt;dispatching OnClickListener calls</span><br><span class="line"> * &lt;li&gt;handling &#123;@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</span><br><span class="line"> * accessibility features are enabled</span><br><span class="line"> * &lt;&#x2F;ul&gt;</span><br><span class="line"> *</span><br><span class="line"> * @param event The motion event.</span><br><span class="line"> * @return True if the event was handled, false otherwise.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public boolean onTouchEvent(MotionEvent event) &#123;</span><br><span class="line">    final float x &#x3D; event.getX();</span><br><span class="line">    final float y &#x3D; event.getY();</span><br><span class="line">    final int viewFlags &#x3D; mViewFlags;</span><br><span class="line">    final int action &#x3D; event.getAction();</span><br><span class="line"></span><br><span class="line">    final boolean clickable &#x3D; ((viewFlags &amp; CLICKABLE) &#x3D;&#x3D; CLICKABLE</span><br><span class="line">            || (viewFlags &amp; LONG_CLICKABLE) &#x3D;&#x3D; LONG_CLICKABLE)</span><br><span class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) &#x3D;&#x3D; CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">    if ((viewFlags &amp; ENABLED_MASK) &#x3D;&#x3D; DISABLED) &#123;</span><br><span class="line">        if (action &#x3D;&#x3D; MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0) &#123;</span><br><span class="line">            setPressed(false);</span><br><span class="line">        &#125;</span><br><span class="line">        mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">        &#x2F;&#x2F; A disabled view that is clickable still consumes the touch</span><br><span class="line">        &#x2F;&#x2F; events, it just doesn&#39;t respond to them.</span><br><span class="line">        return clickable;</span><br><span class="line">    &#125;</span><br><span class="line">    if (mTouchDelegate !&#x3D; null) &#123;</span><br><span class="line">        if (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (clickable || (viewFlags &amp; TOOLTIP) &#x3D;&#x3D; TOOLTIP) &#123;</span><br><span class="line">        switch (action) &#123;</span><br><span class="line">            case MotionEvent.ACTION_UP:</span><br><span class="line">                mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                if ((viewFlags &amp; TOOLTIP) &#x3D;&#x3D; TOOLTIP) &#123;</span><br><span class="line">                    handleTooltipUp();</span><br><span class="line">                &#125;</span><br><span class="line">                if (!clickable) &#123;</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    mInContextButtonPress &#x3D; false;</span><br><span class="line">                    mHasPerformedLongPress &#x3D; false;</span><br><span class="line">                    mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                boolean prepressed &#x3D; (mPrivateFlags &amp; PFLAG_PREPRESSED) !&#x3D; 0;</span><br><span class="line">                if ((mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0 || prepressed) &#123;</span><br><span class="line">                    &#x2F;&#x2F; take focus if we don&#39;t have it already and we should in</span><br><span class="line">                    &#x2F;&#x2F; touch mode.</span><br><span class="line">                    boolean focusTaken &#x3D; false;</span><br><span class="line">                    if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                        focusTaken &#x3D; requestFocus();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (prepressed) &#123;</span><br><span class="line">                        &#x2F;&#x2F; The button is being released before we actually</span><br><span class="line">                        &#x2F;&#x2F; showed it as pressed.  Make it show the pressed</span><br><span class="line">                        &#x2F;&#x2F; state now (before scheduling the click) to ensure</span><br><span class="line">                        &#x2F;&#x2F; the user sees it.</span><br><span class="line">                        setPressed(true, x, y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                        &#x2F;&#x2F; This is a tap, so remove the longpress check</span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                        &#x2F;&#x2F; Only perform take click actions if we were in the pressed state</span><br><span class="line">                        if (!focusTaken) &#123;</span><br><span class="line">                            &#x2F;&#x2F; Use a Runnable and post this rather than calling</span><br><span class="line">                            &#x2F;&#x2F; performClick directly. This lets other visual state</span><br><span class="line">                            &#x2F;&#x2F; of the view update before click actions start.</span><br><span class="line">                            if (mPerformClick &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                mPerformClick &#x3D; new PerformClick();</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (!post(mPerformClick)) &#123;</span><br><span class="line">                                performClickInternal();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (mUnsetPressedState &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mUnsetPressedState &#x3D; new UnsetPressedState();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (prepressed) &#123;</span><br><span class="line">                        postDelayed(mUnsetPressedState,</span><br><span class="line">                                ViewConfiguration.getPressedStateDuration());</span><br><span class="line">                    &#125; else if (!post(mUnsetPressedState)) &#123;</span><br><span class="line">                        &#x2F;&#x2F; If the post failed, unpress right now</span><br><span class="line">                        mUnsetPressedState.run();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                &#125;</span><br><span class="line">                mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_DOWN:</span><br><span class="line">                if (event.getSource() &#x3D;&#x3D; InputDevice.SOURCE_TOUCHSCREEN) &#123;</span><br><span class="line">                    mPrivateFlags3 |&#x3D; PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                mHasPerformedLongPress &#x3D; false;</span><br><span class="line"></span><br><span class="line">                if (!clickable) &#123;</span><br><span class="line">                    checkForLongClick(0, x, y);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Walk up the hierarchy to determine if we&#39;re inside a scrolling container.</span><br><span class="line">                boolean isInScrollingContainer &#x3D; isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; For views inside a scrolling container, delay the pressed feedback for</span><br><span class="line">                &#x2F;&#x2F; a short period in case this is a scroll.</span><br><span class="line">                if (isInScrollingContainer) &#123;</span><br><span class="line">                    mPrivateFlags |&#x3D; PFLAG_PREPRESSED;</span><br><span class="line">                    if (mPendingCheckForTap &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mPendingCheckForTap &#x3D; new CheckForTap();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPendingCheckForTap.x &#x3D; event.getX();</span><br><span class="line">                    mPendingCheckForTap.y &#x3D; event.getY();</span><br><span class="line">                    postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Not inside a scrolling container, so show the feedback right away</span><br><span class="line">                    setPressed(true, x, y);</span><br><span class="line">                    checkForLongClick(0, x, y);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_CANCEL:</span><br><span class="line">                if (clickable) &#123;</span><br><span class="line">                    setPressed(false);</span><br><span class="line">                &#125;</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                mInContextButtonPress &#x3D; false;</span><br><span class="line">                mHasPerformedLongPress &#x3D; false;</span><br><span class="line">                mIgnoreNextUpEvent &#x3D; false;</span><br><span class="line">                mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case MotionEvent.ACTION_MOVE:</span><br><span class="line">                if (clickable) &#123;</span><br><span class="line">                    drawableHotspotChanged(x, y);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; Be lenient about moving outside of buttons</span><br><span class="line">                if (!pointInView(x, y, mTouchSlop)) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Outside button</span><br><span class="line">                    &#x2F;&#x2F; Remove any future long press&#x2F;tap checks</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    if ((mPrivateFlags &amp; PFLAG_PRESSED) !&#x3D; 0) &#123;</span><br><span class="line">                        setPressed(false);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPrivateFlags3 &amp;&#x3D; ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果控件可以点击clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP则进入switch判断如果当前事件的action=MotionEvent.ACTION_UP就会执行performClick。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean performClick() &#123;  </span><br><span class="line">       if (mOnClickListener !&#x3D; null) &#123;  </span><br><span class="line">           playSoundEffect(SoundEffectConstants.CLICK);  </span><br><span class="line">           mOnClickListener.onClick(this);  </span><br><span class="line">           return true;  </span><br><span class="line">           &#x2F;&#x2F; 只要我们通过setOnClickListener（）为控件View注册1个点击事件</span><br><span class="line">           &#x2F;&#x2F; 那么就会给mOnClickListener变量赋值（即不为空）</span><br><span class="line">           &#x2F;&#x2F; 则会往下回调onClick（） &amp; performClick（）返回true</span><br><span class="line">       &#125;  </span><br><span class="line">       return false;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>最终如果控件可点击返回true，否则返回false。</p>
<h2 id="requestDisallowInterceptTouchEvent的用法"><a href="#requestDisallowInterceptTouchEvent的用法" class="headerlink" title="requestDisallowInterceptTouchEvent的用法"></a>requestDisallowInterceptTouchEvent的用法</h2><p>先上代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Called when a child does not want this parent and its ancestors to</span><br><span class="line">   * intercept touch events with</span><br><span class="line">   * &#123;@link ViewGroup#onInterceptTouchEvent(MotionEvent)&#125;.</span><br><span class="line">   *</span><br><span class="line">   * &lt;p&gt;This parent should pass this call onto its parents. This parent must obey</span><br><span class="line">   * this request for the duration of the touch (that is, only clear the flag</span><br><span class="line">   * after this parent has received an up or a cancel.&lt;&#x2F;p&gt;</span><br><span class="line">   * </span><br><span class="line">   * @param disallowIntercept True if the child does not want the parent to</span><br><span class="line">   *            intercept touch events.</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public void requestDisallowInterceptTouchEvent(boolean disallowIntercept);</span><br></pre></td></tr></table></figure>
<p>从上面的英文注释我们知道当requestDisallowInterceptTouchEvent返回true表示子view不想父view拦截事件;当requestDisallowInterceptTouchEvent返回false则表示父view想自己处理当前事件(其实就相当于控制了父view是否会执行自己的onInterceptTouchEvent拦截事件方法).<br>requestDisallowInterceptTouchEvent可以用作处理滑动冲突的内部拦截法的一种方式。</p>
<ul>
<li>在内部拦截法中为什么需要在ACTION_DOWN中设置requestDisallowInterceptTouchEvent(true)?</li>
</ul>
<p>requestDisallowInterceptTouchEvent在ViewGroup中的具体实现:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) &#123;</span><br><span class="line"></span><br><span class="line">    if (disallowIntercept &#x3D;&#x3D; ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0)) &#123;</span><br><span class="line">        &#x2F;&#x2F; We&#39;re already in this state, assume our ancestors are too</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (disallowIntercept) &#123;</span><br><span class="line">        mGroupFlags |&#x3D; FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Pass it up to our parent</span><br><span class="line">    if (mParent !&#x3D; null) &#123;</span><br><span class="line">        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当disallowIntercept传入true或者false时都是对mGroupFlags产生影响.当事件发生时最先接收到的是父view中的dispatchTouchEvent。</p>
<figure class="highlight plain"><figcaption><span>Handle an initial down.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">if (actionMasked &#x3D;&#x3D; MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">    &#x2F;&#x2F; Throw away all previous state when starting a new touch gesture.</span><br><span class="line">    &#x2F;&#x2F; The framework may have dropped the up or cancel event for the previous gesture</span><br><span class="line">    &#x2F;&#x2F; due to an app switch, ANR, or some other state change.</span><br><span class="line">    cancelAndClearTouchTargets(ev);</span><br><span class="line">    resetTouchState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Check for interception.</span><br><span class="line">final boolean intercepted;</span><br><span class="line">if (actionMasked &#x3D;&#x3D; MotionEvent.ACTION_DOWN</span><br><span class="line">        || mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">    final boolean disallowIntercept &#x3D; (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0;</span><br><span class="line">    if (!disallowIntercept) &#123;</span><br><span class="line">        intercepted &#x3D; onInterceptTouchEvent(ev);</span><br><span class="line">        ev.setAction(action); &#x2F;&#x2F; restore action in case it was changed</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        intercepted &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; There are no touch targets and this action is not an initial down</span><br><span class="line">    &#x2F;&#x2F; so this view group continues to intercept touches.</span><br><span class="line">    intercepted &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里接收到的第一个事件就是MotionEvent.ACTION_DOWN事件,在这里做了两个判断执行一个是cancelAndClearTouchTargets和resetTouchState,另一个就是actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null。<br>首先看第一个判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Cancels and clears all touch targets.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void cancelAndClearTouchTargets(MotionEvent event) &#123;</span><br><span class="line">       if (mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">       ...</span><br><span class="line">       clearTouchTargets();</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">    &#x2F;**</span><br><span class="line">    * Clears all touch targets.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void clearTouchTargets() &#123;</span><br><span class="line">       ...</span><br><span class="line">       mFirstTouchTarget &#x3D; null;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里主要是将mFirstTouchTarget设置为null；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Resets all touch state in preparation for a new cycle.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private void resetTouchState() &#123;</span><br><span class="line">       clearTouchTargets();</span><br><span class="line">       resetCancelNextUpFlag(this);</span><br><span class="line">       mGroupFlags &amp;&#x3D; ~FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">       mNestedScrollAxes &#x3D; SCROLL_AXIS_NONE;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>同时将mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;中的数值取反重置.这里也就是最重要的为什么我们需要在子view中的ACTION_DOWN中首先设置requestDisallowInterceptTouchEvent(true)的原因.如果我们不设置这句代码当程序执行到第二个ACTION_DOWN时就进入了if判断中:</p>
<figure class="highlight plain"><figcaption><span>(actionMasked </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">        || mFirstTouchTarget !&#x3D; null) &#123;</span><br><span class="line">    final boolean disallowIntercept &#x3D; (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) !&#x3D; 0;</span><br><span class="line">    if (!disallowIntercept) &#123;</span><br><span class="line">        intercepted &#x3D; onInterceptTouchEvent(ev);</span><br><span class="line">        ev.setAction(action); &#x2F;&#x2F; restore action in case it was changed</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        intercepted &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; There are no touch targets and this action is not an initial down</span><br><span class="line">    &#x2F;&#x2F; so this view group continues to intercept touches.</span><br><span class="line">    intercepted &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候因为mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT之前被重置了所以disallowIntercept=false这个时候就会执行intercepted = onInterceptTouchEvent(ev)这条方法如果父view拦截了那么后续的ACTION_MOVE和ACTION_UP就都不会被子view接收到。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/28/2019-09-28-Android%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6/" data-id="ck8tr9s75001dn29k41wl27ho" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-05-Android Fragment基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-09-04T16:00:00.000Z" itemprop="datePublished">2019-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/">Android Fragment基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android Fragment中文翻译为片段。从字面意思可以知道这个就是应用中的一个UI片段，它有自己的生命周期和创建方式。Fragment的出现最初主要是为了实现在大屏幕上 例如：平板的显示提供更加灵活的支持。<br><strong>Fragment必须要基于Activity出现，它不能单独实现自己所以它的生命周期受宿主Activity的影响,当Activity暂停时Fragment也会暂停，当Activity被销毁时Fragment也会被销毁</strong></p>
<h2 id="创建Fragment"><a href="#创建Fragment" class="headerlink" title="创建Fragment"></a>创建Fragment</h2><p>Fragment的创建可以通过两种方式创建一种是在Activity的xml布局文件中编写xml代码，另外一种方式就是通过代码的方式创建.</p>
<ul>
<li>通过xml布局的方式创建Fragment：<br>1.首先创建Fragment的实现类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MyFragment extends Fragment &#123;</span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.my_fragment, container, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在onCreateView中调用了inflater的inflate方法里面有三个参数，第一个是当前Fragment的布局文件，第二个是一个viewGroup，这里的ViewGroup就是与它关联的Activity，而第三个参数是一个boolean值，设置的是一个false.它的意思是当前布局不与container关联，因为我们在事务transaction中会调用add方法进行关联,如果这里设置为true那么就会关联两次就会有两个重复的布局抛出异常:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalStateException: The specified child already has a parent. You must call removeView() on the child&#39;s parent first.</span><br></pre></td></tr></table></figure>

<p>2.然后在Activity的xml布局中引用这个MyFragment:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout</span><br><span class="line">    android:id&#x3D;&quot;@+id&#x2F;add_fragment&quot;</span><br><span class="line">    android:layout_width&#x3D;&quot;match_parent&quot;</span><br><span class="line">    android:layout_height&#x3D;&quot;match_parent&quot;</span><br><span class="line">    android:orientation&#x3D;&quot;vertical&quot;&gt;</span><br><span class="line">    &lt;fragment</span><br><span class="line">        android:layout_width&#x3D;&quot;match_parent&quot;</span><br><span class="line">        android:layout_height&#x3D;&quot;match_parent&quot;</span><br><span class="line">        android:name&#x3D;&quot;com.example.myapplication.MyFragment&quot;</span><br><span class="line">        &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>然后运行程序，这个Fragment就加载到Activity中了.</p>
<ul>
<li>通过代码的方式添加Fragment:</li>
</ul>
<p>1.首先需要创建一个Fragment的类:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MyFragment extends Fragment &#123;</span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.my_fragment, container, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.然后在Activity中创建一个transaction事务，然后再创建Fragment对象，最后通过add的方式将这个Fragment提交.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">transaction &#x3D; getSupportFragmentManager().beginTransaction();</span><br><span class="line">        if (myFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">            myFragment &#x3D; new MyFragment();</span><br><span class="line">            transaction.add(R.id.add_fragment, myFragment).commit();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>在transaction中看到需要两个参数，第一个参数就是一个id而这个id就是在Activity的xml布局文件中指定的id，第二个参数就是Fragment对象，这个的意思就是将这个Fragment的对象添加到我们指定的id布局中，最后要commit提交这样一个Fragment才正式被添加到了Activity中.</p>
<h2 id="Fragment与Activity之间的通讯"><a href="#Fragment与Activity之间的通讯" class="headerlink" title="Fragment与Activity之间的通讯"></a>Fragment与Activity之间的通讯</h2><ul>
<li>Activity与Fragment通讯:</li>
</ul>
<p>1.Fragment中有一个onAttach方法：、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onAttach(Context context) &#123;</span><br><span class="line">    super.onAttach(context);</span><br><span class="line">    context &#x3D; (MainActivity) context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们可以将context强制转换成MainActivity,然后就可以调用我们在Activiy中定义的方法了.<br>2.通过Bundle方式<br>当我们在Activity创建Fragment对象后可以通过调用Bundle传递数据(Bundle只能put基本数据类型或序列化数据)到Fragment中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (myFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">           myFragment &#x3D; new MyFragment();</span><br><span class="line">           Bundle bundle &#x3D; new Bundle();</span><br><span class="line">           bundle.putString(&quot;key&quot;,&quot;value&quot;);</span><br><span class="line">           myFragment.setArguments(bundle);</span><br><span class="line">           transaction.add(R.id.add_fragment, myFragment).commit();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>这样就将一个数据发送给了Fragment.</p>
<ul>
<li>Fragment与Activity通讯：<br>在Fragment中编写一个接口,然后对外提供一个方法。在Activity中调用这个方法实现这个接口.</li>
</ul>
<h2 id="Fragment的生命周期"><a href="#Fragment的生命周期" class="headerlink" title="Fragment的生命周期"></a>Fragment的生命周期</h2><p>1.onAttach:Fragment和Activity关联时会被调用,在这个方法中我们可以获取Activity的引用，通过getArgument方法获取Activity传过来的数据.</p>
<p>2.onCreate:Fragment被创建时调用.</p>
<p>3.onCreateView:创建Fragment的布局</p>
<p>4.onActivityCreated:当Activity完成onCreate时调用</p>
<p>5.onStart：当Fragment可见时调用</p>
<p>6.onResume:当Fragment可见并且可交互时调用</p>
<p>7.onPause:当Fragment可见但不可交互时调用</p>
<p>8.onStop：当Fragment不可见时调用</p>
<p>9.onDestoryView：当Fragment的UI从视图结构中移除时调用</p>
<p>10.onDestory:销毁Fragment时调用</p>
<p>11.onDetach:当Fragment和Activity解除关联时调用</p>
<p>上述方法中除了onCreateView不需要super方法外，其他方法都需要</p>
<h2 id="Fragment回退栈BackStack"><a href="#Fragment回退栈BackStack" class="headerlink" title="Fragment回退栈BackStack"></a>Fragment回退栈BackStack</h2><p>Fragment有自己的回退栈，给一个Fragment添加回退栈则可以掉用：addToBackStack(“”).<br>如果加入了回退栈当用户点击返回按键时会回滚Fragment事务，如果没有加入回退栈按返回键则直接将Activity出栈。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transaction.add(R.id.add_fragment, myFragment).addToBackStack(&quot;myfragment&quot;).commit();</span><br></pre></td></tr></table></figure>
<p>addToBackStack:将Fragment添加到回退栈中.<br>popBackstack:清除栈顶中的Fragment<br>popBackStack(String tag,int i): 如果i=0,回退到该tag所对应的Fragment层;如果i=FragmentManager.POP_BACK_STACK_INCLUSIVE,回退到该tag所对应的Fragment的上一层<br>popBackStackImmediate:立即清除回退栈中栈顶的Fragment.<br>getBackStackEntryCount:获取回退栈中Fragment的个数.<br>getBackStackEntryAt(int index):获取回退栈中该索引值下的Fragment.<br><strong>示例：</strong><br>模拟京东的回退栈效果，当点击了其他的Fragment时按返回键退出到第一个Fragment.<br>##Fragment回退栈出现的问题<br>当我们将Fragment加入到回退栈时,这个时候按返回键进行操作回到第一个Fragment然后继续点击其他的Fragment时这个时候当前的Fragment的view会remove掉,f.mContainer.removeView(f.mView).<br>原因:当我们是以add方式入栈的时候，此时Fragment的状态为RESUMED，则moveToState将不进行操作；当我们以replace方式入栈，Fragment的状态为INITIALIZING，此时在moveToState中又会重新将此Fragment创建一次，重新走一遍创建时的生命周期。</p>
<h2 id="DialogFragment"><a href="#DialogFragment" class="headerlink" title="DialogFragment"></a>DialogFragment</h2><p>DialogFragment是专门用于处理对话框逻辑的功能，它与AlertDialog和Dialog的区别就是当用户旋转屏幕了之后AlertDialog和Dialog会销毁掉同时如果有数据输入的话数据也会销毁，而DialogFragment则不会同时也可以很好的管理其生命周期.<br>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot;</span><br><span class="line">    android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">    android:background&#x3D;&quot;@color&#x2F;colorPrimary&quot;</span><br><span class="line">    android:layout_height&#x3D;&quot;wrap_content&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width&#x3D;&quot;300dp&quot;</span><br><span class="line">        android:layout_height&#x3D;&quot;300dp&quot;</span><br><span class="line">        android:layout_centerInParent&#x3D;&quot;true&quot;</span><br><span class="line">        android:text&#x3D;&quot;DialogFragment&quot;</span><br><span class="line">        android:textStyle&#x3D;&quot;bold&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;RelativeLayout&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class DialogFragment extends android.support.v4.app.DialogFragment &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Nullable</span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        return inflater.inflate(R.layout.fragment_dialog_view,container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">    public void onClick(View v) &#123;</span><br><span class="line">        DialogFragment dialogFragment &#x3D; new DialogFragment();</span><br><span class="line">        dialogFragment.show(getSupportFragmentManager(),&quot;dialog_fragment&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>有些时候我们在设置DialogFragment固定布局的时候不是想要的效果,这个时候可以通过Fragment的onStart方法设置解决这个问题.具体使用方式如下:<br>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onStart() &#123;</span><br><span class="line">    super.onStart();</span><br><span class="line">    Dialog dialog &#x3D; getDialog();</span><br><span class="line">    if (dialog !&#x3D; null) &#123;</span><br><span class="line">        Window window &#x3D; dialog.getWindow();</span><br><span class="line">        WindowManager.LayoutParams attributes &#x3D; window.getAttributes();</span><br><span class="line">        attributes.width &#x3D; getResources().getDimensionPixelSize(R.dimen.width_400);</span><br><span class="line">        attributes.height &#x3D; getResources().getDimensionPixelSize(R.dimen.height_500);</span><br><span class="line">        window.setAttributes(attributes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##为什么需要在onStart后修改Dialog布局才有效<br>只有dialogFragment执行到onStart之后才会调用mDialog.show()显示弹框，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void onStart() &#123;</span><br><span class="line">       super.onStart();</span><br><span class="line">       if (mDialog !&#x3D; null) &#123;</span><br><span class="line">           mViewDestroyed &#x3D; false;</span><br><span class="line">           mDialog.show();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>接下来看一看dialog.show的源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void show() &#123;</span><br><span class="line">        if (mShowing) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!mCreated) &#123;</span><br><span class="line">            dispatchOnCreate(null);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    mWindowManager.addView(mDecor, l);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中如果dialog还没有创建就执行dispatchOnCreate(null)方法来创建dialog布局</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> void dispatchOnCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        if (!mCreated) &#123;</span><br><span class="line">            mDialog.setContentView(selectContentView());</span><br><span class="line">            mCreated &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;获取相应的布局样式</span><br><span class="line">    private int selectContentView() &#123;</span><br><span class="line">        if (mButtonPanelSideLayout &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return mAlertDialogLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        if (mButtonPanelLayoutHint &#x3D;&#x3D; AlertDialog.LAYOUT_HINT_SIDE) &#123;</span><br><span class="line">            recaiturn mButtonPanelSideLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        return mAlertDialogLayout;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里mDialog会通过selectContentView获取系统布局然后设置到setContentView中，所以在show之前如果我们自定义了dialog的宽高都是无效的，最后还是会在show中被覆盖成系统自带的格式。<br><strong>所以只有在show后面改变布局的属性才会有效</strong></p>
<h2 id="Fragment懒加载"><a href="#Fragment懒加载" class="headerlink" title="Fragment懒加载"></a>Fragment懒加载</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author joshuayingwhat</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class BaseLazyFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    protected boolean isViewCreated;</span><br><span class="line"></span><br><span class="line">    protected boolean isVisibleToUser;</span><br><span class="line"></span><br><span class="line">    protected boolean isDataInited;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onAttach(Context context) &#123;</span><br><span class="line">        super.onAttach(context);</span><br><span class="line">        Log.e(&quot;Tag&quot;, &quot;------onAttach------&quot; + (isViewCreated));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(view, savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityCreated(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onActivityCreated(savedInstanceState);</span><br><span class="line">        isViewCreated &#x3D; true;</span><br><span class="line">        prepareFetchData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void prepareFetchData() &#123;</span><br><span class="line">        prepareFetchData(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @param fetchdata</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void prepareFetchData(boolean fetchdata) &#123;</span><br><span class="line">        &#x2F;&#x2F;每次都加载数据</span><br><span class="line">        if (isVisibleToUser &amp;&amp; isViewCreated &amp;&amp; (!isDataInited || fetchdata)) &#123;</span><br><span class="line">            fetchdata();</span><br><span class="line">            isDataInited &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract void fetchdata();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setUserVisibleHint(boolean isVisibleToUser) &#123;</span><br><span class="line">        super.setUserVisibleHint(isVisibleToUser);</span><br><span class="line">        this.isVisibleToUser &#x3D; isVisibleToUser;</span><br><span class="line">        prepareFetchData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fragment中<strong>setUserVisibleHint</strong>方法表示是否显示,当Fragment是否显示或者不显示通过isVisibleToUser表示。<br>当Fragment UI被创建时，同时isVisibleToUser Fragment已经显示，这个时候执行加载数据的操作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/05/2019-09-05-Android%20Fragment%E5%9F%BA%E7%A1%80/" data-id="ck8tr9s74001bn29k6rjygwri" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-01-16-HandlerThread简单使用和原理分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-09-02T16:00:00.000Z" itemprop="datePublished">2019-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">HandlerThread简单使用和原理分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HandlerThread的简单使用"><a href="#HandlerThread的简单使用" class="headerlink" title="HandlerThread的简单使用"></a>HandlerThread的简单使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stock_data_update &#x3D; new HandlerThread(&quot;stock_data_update&quot;);</span><br><span class="line">    stock_data_update.start();</span><br><span class="line">    stockHandler &#x3D; new Handler(stock_data_update.getLooper()) &#123;</span><br><span class="line">      @Override public void handleMessage(Message msg) &#123;</span><br><span class="line">        super.handleMessage(msg);</span><br><span class="line">        if (msg.what &#x3D;&#x3D; 100) &#123;</span><br><span class="line">          update();</span><br><span class="line">          stockHandler.sendEmptyMessage(100);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">     private void update() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      Thread.sleep(1000);</span><br><span class="line">      mHandler.post(new Runnable() &#123;</span><br><span class="line">        @Override public void run() &#123;</span><br><span class="line">          stockTv.setText(&quot;当前大盘实时数据：&quot; + (Math.random() * 3000 + 1000));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最在任务已经处理完成后要在合适的位置退出掉这个线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stock_data_update.quit();</span><br></pre></td></tr></table></figure>
<h2 id="HandlerThread的源码"><a href="#HandlerThread的源码" class="headerlink" title="HandlerThread的源码"></a>HandlerThread的源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Handy class for starting a new thread that has a looper. The looper can then be </span><br><span class="line"> * used to create handler classes. Note that start() must still be called.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class HandlerThread extends Thread &#123;</span><br><span class="line">    int mPriority;</span><br><span class="line">    int mTid &#x3D; -1;</span><br><span class="line">    Looper mLooper;</span><br><span class="line">    private @Nullable Handler mHandler;</span><br><span class="line"></span><br><span class="line">    public HandlerThread(String name) &#123;</span><br><span class="line">        super(name);</span><br><span class="line">        mPriority &#x3D; Process.THREAD_PRIORITY_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Constructs a HandlerThread.</span><br><span class="line">     * @param name</span><br><span class="line">     * @param priority The priority to run the thread at. The value supplied must be from </span><br><span class="line">     * &#123;@link android.os.Process&#125; and not from java.lang.Thread.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public HandlerThread(String name, int priority) &#123;</span><br><span class="line">        super(name);</span><br><span class="line">        mPriority &#x3D; priority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Call back method that can be explicitly overridden if needed to execute some</span><br><span class="line">     * setup before Looper loops.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected void onLooperPrepared() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        mTid &#x3D; Process.myTid();</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            mLooper &#x3D; Looper.myLooper();</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">        onLooperPrepared();</span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid &#x3D; -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * This method returns the Looper associated with this thread. If this thread not been started</span><br><span class="line">     * or for any reason isAlive() returns false, this method will return null. If this thread</span><br><span class="line">     * has been started, this method will block until the looper has been initialized.  </span><br><span class="line">     * @return The looper.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public Looper getLooper() &#123;</span><br><span class="line">        if (!isAlive()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; If the thread has been started, wait until the looper has been created.</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            while (isAlive() &amp;&amp; mLooper &#x3D;&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return mLooper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @return a shared &#123;@link Handler&#125; associated with this thread</span><br><span class="line">     * @hide</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @NonNull</span><br><span class="line">    public Handler getThreadHandler() &#123;</span><br><span class="line">        if (mHandler &#x3D;&#x3D; null) &#123;</span><br><span class="line">            mHandler &#x3D; new Handler(getLooper());</span><br><span class="line">        &#125;</span><br><span class="line">        return mHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Quits the handler thread&#39;s looper.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * Causes the handler thread&#39;s looper to terminate without processing any</span><br><span class="line">     * more messages in the message queue.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</span><br><span class="line">     * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p class&#x3D;&quot;note&quot;&gt;</span><br><span class="line">     * Using this method may be unsafe because some messages may not be delivered</span><br><span class="line">     * before the looper terminates.  Consider using &#123;@link #quitSafely&#125; instead to ensure</span><br><span class="line">     * that all pending work is completed in an orderly manner.</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * @return True if the looper looper has been asked to quit or false if the</span><br><span class="line">     * thread had not yet started running.</span><br><span class="line">     *</span><br><span class="line">     * @see #quitSafely</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean quit() &#123;</span><br><span class="line">        Looper looper &#x3D; getLooper();</span><br><span class="line">        if (looper !&#x3D; null) &#123;</span><br><span class="line">            looper.quit();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Quits the handler thread&#39;s looper safely.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * Causes the handler thread&#39;s looper to terminate as soon as all remaining messages</span><br><span class="line">     * in the message queue that are already due to be delivered have been handled.</span><br><span class="line">     * Pending delayed messages with due times in the future will not be delivered.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</span><br><span class="line">     * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false.</span><br><span class="line">     * &lt;&#x2F;p&gt;&lt;p&gt;</span><br><span class="line">     * If the thread has not been started or has finished (that is if</span><br><span class="line">     * &#123;@link #getLooper&#125; returns null), then false is returned.</span><br><span class="line">     * Otherwise the looper is asked to quit and true is returned.</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * @return True if the looper looper has been asked to quit or false if the</span><br><span class="line">     * thread had not yet started running.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public boolean quitSafely() &#123;</span><br><span class="line">        Looper looper &#x3D; getLooper();</span><br><span class="line">        if (looper !&#x3D; null) &#123;</span><br><span class="line">            looper.quitSafely();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Returns the identifier of this thread. See Process.myTid().</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public int getThreadId() &#123;</span><br><span class="line">        return mTid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从源码看出HandlerThread继承了Thread类,所以它是一个线程只不过它的内部用了handler。创建一个HandlerThread对象后需要调用start方法启动它.然后它的run方法就执行了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    mTid &#x3D; Process.myTid();</span><br><span class="line">    Looper.prepare();</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        mLooper &#x3D; Looper.myLooper();</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(mPriority);</span><br><span class="line">    onLooperPrepared();</span><br><span class="line">    Looper.loop();</span><br><span class="line">    mTid &#x3D; -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里通过Looper开启无限循环,同时在onLooperPrepared方法中做一些初始化的工作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * Call back method that can be explicitly overridden if needed to execute some</span><br><span class="line">    * setup before Looper loops.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   protected void onLooperPrepared() &#123;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/03/2019-01-16-HandlerThread%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" data-id="ck8tr9s6v000pn29k2ggvgexy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-09-03-Fragment加载过程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-09-02T16:00:00.000Z" itemprop="datePublished">2019-09-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">Fragment加载过程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>将一个布局添加到指定的容器中我们只要在activity中添加这样一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fragmentTransaction.add(R.id.fragment_container, fragment, &quot;fragment&quot;).addToBackStack(fragment.getClass().getName());</span><br></pre></td></tr></table></figure>
<p>这样就将fragment的布局载入到了指定的container布局中。</p>
<p>##源代码分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FragmentTransaction fragmentTransaction &#x3D; supportFragmentManager.beginTransaction();</span><br></pre></td></tr></table></figure>
<p>通过获取fragment事务得到BackStackRecord的对象，fragment的所有add，replce，show，hide等操作都是通过BackStackRecord执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public FragmentTransaction beginTransaction() &#123;</span><br><span class="line">        return new BackStackRecord(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着执行到add方法；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public FragmentTransaction add(int containerViewId, Fragment fragment, String tag) &#123;</span><br><span class="line">    doAddOp(containerViewId, fragment, tag, OP_ADD);</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将容器ID，fragment，以及add的标记传入了doAddOp方法中，同时doAddOp方法写入了一个OP_ADD的标记.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void doAddOp(int containerViewId, Fragment fragment, String tag, int opcmd) &#123; </span><br><span class="line">        fragment.mFragmentManager &#x3D; mManager; </span><br><span class="line">  if (tag !&#x3D; null) &#123; </span><br><span class="line">            if (fragment.mTag !&#x3D; null &amp;&amp; !tag.equals(fragment.mTag)) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Can&#39;t change tag of fragment &quot; </span><br><span class="line">                        + fragment + &quot;: was &quot; + fragment.mTag </span><br><span class="line">                        + &quot; now &quot; + tag); </span><br><span class="line">            &#125; </span><br><span class="line">            fragment.mTag &#x3D; tag; </span><br><span class="line">        &#125; </span><br><span class="line"> if (containerViewId !&#x3D; 0) &#123; </span><br><span class="line">            if (fragment.mFragmentId !&#x3D; 0 &amp;&amp; fragment.mFragmentId !&#x3D; containerViewId) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Can&#39;t change container ID of fragment &quot; </span><br><span class="line">                        + fragment + &quot;: was &quot; + fragment.mFragmentId </span><br><span class="line">                        + &quot; now &quot; + containerViewId); </span><br><span class="line">            &#125; </span><br><span class="line">            fragment.mContainerId &#x3D; fragment.mFragmentId &#x3D; containerViewId; </span><br><span class="line">        &#125; </span><br><span class="line"> Op op &#x3D; new Op(); </span><br><span class="line">        op.cmd &#x3D; opcmd; </span><br><span class="line">        op.fragment &#x3D; fragment; </span><br><span class="line">        addOp(op); </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>设置fragment的tag，容器的id，以及创建一个Op类的对象(Op类内部维护的是一个栈),同时将fragment和OP_ADD赋值给op成员变量。接着执行addOp(op)方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void addOp(Op op) &#123; </span><br><span class="line">        if (mHead &#x3D;&#x3D; null) &#123; </span><br><span class="line">            mHead &#x3D; mTail &#x3D; op; </span><br><span class="line">        &#125; else &#123; </span><br><span class="line">            op.prev &#x3D; mTail; </span><br><span class="line">            mTail.next &#x3D; op; </span><br><span class="line">            mTail &#x3D; op; </span><br><span class="line">        &#125; </span><br><span class="line">        op.enterAnim &#x3D; mEnterAnim; </span><br><span class="line">        op.exitAnim &#x3D; mExitAnim; </span><br><span class="line">        op.popEnterAnim &#x3D; mPopEnterAnim; </span><br><span class="line">        op.popExitAnim &#x3D; mPopExitAnim; </span><br><span class="line">        mNumOp++; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里将设置的动画加入op中。</p>
<p>接下来执行commit方法,commit方法也是在BackStackRecord类中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public int commit() &#123; </span><br><span class="line">        return commitInternal(false); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int commitInternal(boolean allowStateLoss) &#123; </span><br><span class="line">        if (mCommitted) throw new IllegalStateException(&quot;commit already called&quot;); </span><br><span class="line">        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Commit: &quot; + this); </span><br><span class="line">        mCommitted &#x3D; true; </span><br><span class="line">        if (mAddToBackStack) &#123; </span><br><span class="line">            mIndex &#x3D; mManager.allocBackStackIndex(this); </span><br><span class="line">        &#125; else &#123; </span><br><span class="line">            mIndex &#x3D; -1; </span><br><span class="line">        &#125; </span><br><span class="line">        mManager.enqueueAction(this, allowStateLoss); </span><br><span class="line">        return mIndex; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在这个类只如果设置了addToBackStack回退栈方法这里的mAddToBackStack就会被执行到。<br>mManager是FragmentManagerImpl的对象，最终调用了enqueueAction方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void enqueueAction(Runnable action, boolean allowStateLoss) &#123; </span><br><span class="line">        if (!allowStateLoss) &#123; </span><br><span class="line">            checkStateLoss(); </span><br><span class="line">        &#125; </span><br><span class="line">        synchronized (this) &#123; </span><br><span class="line">            if (mActivity &#x3D;&#x3D; null) &#123; </span><br><span class="line">                throw new IllegalStateException(&quot;Activity has been destroyed&quot;); </span><br><span class="line">            &#125; </span><br><span class="line">            if (mPendingActions &#x3D;&#x3D; null) &#123; </span><br><span class="line">                mPendingActions &#x3D; new ArrayList&lt;Runnable&gt;(); </span><br><span class="line">            &#125; </span><br><span class="line">            mPendingActions.add(action); </span><br><span class="line">            if (mPendingActions.size() &#x3D;&#x3D; 1) &#123; </span><br><span class="line">                mActivity.mHandler.removeCallbacks(mExecCommit); </span><br><span class="line">                mActivity.mHandler.post(mExecCommit); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>其中allowStateLoss为true是不执行checkStateLoss，如果为false就执行checkStateLoss。这对应着我们选择commit(false)还是commitAllowingStateLoss(true).接着是一个同步方法将BackStackRecord方法装入mPendingActions中，最后在主线程中执行了mExecCommit。在mExecCommit的runnable方法中调用了execPendingActions。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public boolean execPendingActions() &#123; </span><br><span class="line">        if (mExecutingActions) &#123; </span><br><span class="line">            throw new IllegalStateException(&quot;Recursive entry to executePendingTransactions&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">        if (Looper.myLooper() !&#x3D; mActivity.mHandler.getLooper()) &#123; </span><br><span class="line">            throw new IllegalStateException(&quot;Must be called from main thread of process&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">  boolean didSomething &#x3D; false;</span><br><span class="line">  while (true) &#123;</span><br><span class="line">            int numActions; </span><br><span class="line">             </span><br><span class="line">            synchronized (this) &#123; </span><br><span class="line">                if (mPendingActions &#x3D;&#x3D; null || mPendingActions.size() &#x3D;&#x3D; 0) &#123; </span><br><span class="line">                    break; </span><br><span class="line">                &#125; </span><br><span class="line">                 </span><br><span class="line">                numActions &#x3D; mPendingActions.size(); </span><br><span class="line">                if (mTmpActions &#x3D;&#x3D; null || mTmpActions.length &lt; numActions) &#123; </span><br><span class="line">                    mTmpActions &#x3D; new Runnable[numActions]; </span><br><span class="line">                &#125; </span><br><span class="line">                mPendingActions.toArray(mTmpActions); </span><br><span class="line">                mPendingActions.clear(); </span><br><span class="line">                mActivity.mHandler.removeCallbacks(mExecCommit); </span><br><span class="line">            &#125; </span><br><span class="line">             </span><br><span class="line">            mExecutingActions &#x3D; true; </span><br><span class="line">            for (int i&#x3D;0; i&lt;numActions; i++) &#123; </span><br><span class="line">                mTmpActions[i].run(); </span><br><span class="line">                mTmpActions[i] &#x3D; null; </span><br><span class="line">            &#125; </span><br><span class="line">            mExecutingActions &#x3D; false; </span><br><span class="line">            didSomething &#x3D; true; </span><br><span class="line">        &#125; </span><br><span class="line"> if (mHavePendingDeferredStart) &#123;</span><br><span class="line">            boolean loadersRunning &#x3D; false; </span><br><span class="line">            for (int i&#x3D;0; i&lt;mActive.size(); i++) &#123; </span><br><span class="line">                Fragment f &#x3D; mActive.get(i); </span><br><span class="line">                if (f !&#x3D; null &amp;&amp; f.mLoaderManager !&#x3D; null) &#123; </span><br><span class="line">                    loadersRunning |&#x3D; f.mLoaderManager.hasRunningLoaders(); </span><br><span class="line">                &#125; </span><br><span class="line">            &#125; </span><br><span class="line">            if (!loadersRunning) &#123; </span><br><span class="line">                mHavePendingDeferredStart &#x3D; false; </span><br><span class="line">                startPendingDeferredFragments(); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        return didSomething; </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个里面用了一个while(true)循环对象对mPendingActions进行操作 mPendingActions中还是一个BackStackRecord对象，然后执行mPendingActions中的run方法，最终还是回到了BackStackRecord类中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Run: &quot; + this);</span><br><span class="line">        if (mAddToBackStack) &#123;</span><br><span class="line">            if (mIndex &lt; 0) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;addToBackStack() called after commit()&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bumpBackStackNesting(1);</span><br><span class="line">        Op op &#x3D; mHead;</span><br><span class="line">        while (op !&#x3D; null) &#123;</span><br><span class="line">            switch (op.cmd) &#123;</span><br><span class="line">                case OP_ADD: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.addFragment(f, false);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_REPLACE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    if (mManager.mAdded !&#x3D; null) &#123;</span><br><span class="line">                        for (int i&#x3D;0; i&lt;mManager.mAdded.size(); i++) &#123;</span><br><span class="line">                            Fragment old &#x3D; mManager.mAdded.get(i);</span><br><span class="line">                            if (FragmentManagerImpl.DEBUG) Log.v(TAG,</span><br><span class="line">                                    &quot;OP_REPLACE: adding&#x3D;&quot; + f + &quot; old&#x3D;&quot; + old);</span><br><span class="line">                            if (f &#x3D;&#x3D; null || old.mContainerId &#x3D;&#x3D; f.mContainerId) &#123;</span><br><span class="line">                                if (old &#x3D;&#x3D; f) &#123;</span><br><span class="line">                                    op.fragment &#x3D; f &#x3D; null;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    if (op.removed &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                        op.removed &#x3D; new ArrayList&lt;Fragment&gt;();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    op.removed.add(old);</span><br><span class="line">                                    old.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                                    if (mAddToBackStack) &#123;</span><br><span class="line">                                        old.mBackStackNesting +&#x3D; 1;</span><br><span class="line">                                        if (FragmentManagerImpl.DEBUG) Log.v(TAG, &quot;Bump nesting of &quot;</span><br><span class="line">                                                + old + &quot; to &quot; + old.mBackStackNesting);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    mManager.removeFragment(old, mTransition, mTransitionStyle);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (f !&#x3D; null) &#123;</span><br><span class="line">                        f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                        mManager.addFragment(f, false);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_REMOVE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.removeFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_HIDE: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.hideFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_SHOW: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.showFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_DETACH: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.exitAnim;</span><br><span class="line">                    mManager.detachFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                case OP_ATTACH: &#123;</span><br><span class="line">                    Fragment f &#x3D; op.fragment;</span><br><span class="line">                    f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">                    mManager.attachFragment(f, mTransition, mTransitionStyle);</span><br><span class="line">                &#125; break;</span><br><span class="line">                default: &#123;</span><br><span class="line">                    throw new IllegalArgumentException(&quot;Unknown cmd: &quot; + op.cmd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            op &#x3D; op.next;</span><br><span class="line">        &#125;</span><br><span class="line">        mManager.moveToState(mManager.mCurState, mTransition,</span><br><span class="line">                mTransitionStyle, true);</span><br><span class="line">        if (mAddToBackStack) &#123;</span><br><span class="line">            mManager.addBackStackState(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个里面也是一个while(true)的循环判断，最终不断的轮训op类，每个op类的实例都包装了一个Fragment实例，方法内部对不同的实例用switch执行，由于上面的代码中我们用了add来添加一个Fragment，op的cmd标记设置为了OP_ADD因此接下来会执行到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Fragment f &#x3D; op.fragment;</span><br><span class="line">f.mNextAnim &#x3D; op.enterAnim;</span><br><span class="line">mManager.addFragment(f, false);</span><br></pre></td></tr></table></figure>
<p>这里通过FragmentManager的管理类addFragment，将fragment加入一个叫做mAdded的成员变量中，类型是ArrayList。接着执行FragmentManager的moveToState方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void moveToState(int newState, int transit, int transitStyle, boolean always) &#123;</span><br><span class="line">        if (mActivity &#x3D;&#x3D; null &amp;&amp; newState !&#x3D; Fragment.INITIALIZING) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;No activity&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        if (!always &amp;&amp; mCurState &#x3D;&#x3D; newState) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        mCurState &#x3D; newState;</span><br><span class="line">        if (mActive !&#x3D; null) &#123;</span><br><span class="line">            boolean loadersRunning &#x3D; false;</span><br><span class="line">            for (int i&#x3D;0; i&lt;mActive.size(); i++) &#123;</span><br><span class="line">                Fragment f &#x3D; mActive.get(i);</span><br><span class="line">                if (f !&#x3D; null) &#123;</span><br><span class="line">                    moveToState(f, newState, transit, transitStyle, false);</span><br><span class="line">                    if (f.mLoaderManager !&#x3D; null) &#123;</span><br><span class="line">                        loadersRunning |&#x3D; f.mLoaderManager.hasRunningLoaders();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!loadersRunning) &#123;</span><br><span class="line">                startPendingDeferredFragments();</span><br><span class="line">            &#125;</span><br><span class="line">            if (mNeedMenuInvalidate &amp;&amp; mActivity !&#x3D; null &amp;&amp; mCurState &#x3D;&#x3D; Fragment.RESUMED) &#123;</span><br><span class="line">                mActivity.invalidateOptionsMenu();</span><br><span class="line">                mNeedMenuInvalidate &#x3D; false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在当前方法中通过for循环获取fragment，然后调用5个参数的moveToState。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">void moveToState(Fragment f, int newState, int transit, int transitionStyle,</span><br><span class="line">            boolean keepActive) &#123;</span><br><span class="line">        &#x2F;&#x2F; Fragments that are not currently added will sit in the onCreate() state.</span><br><span class="line">        if ((!f.mAdded || f.mDetached) &amp;&amp; newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">            newState &#x3D; Fragment.CREATED;</span><br><span class="line">        &#125;</span><br><span class="line">        if (f.mRemoving &amp;&amp; newState &gt; f.mState) &#123;</span><br><span class="line">            &#x2F;&#x2F; While removing a fragment, we can&#39;t change it to a higher state.</span><br><span class="line">            newState &#x3D; f.mState;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; Defer start if requested; don&#39;t allow it to move to STARTED or higher</span><br><span class="line">        &#x2F;&#x2F; if it&#39;s not already started.</span><br><span class="line">        if (f.mDeferStart &amp;&amp; f.mState &lt; Fragment.STARTED &amp;&amp; newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">            newState &#x3D; Fragment.STOPPED;</span><br><span class="line">        &#125;</span><br><span class="line">        if (f.mState &lt; newState) &#123;</span><br><span class="line">            &#x2F;&#x2F; For fragments that are created from a layout, when restoring from</span><br><span class="line">            &#x2F;&#x2F; state we don&#39;t want to allow them to be created until they are</span><br><span class="line">            &#x2F;&#x2F; being reloaded from the layout.</span><br><span class="line">            if (f.mFromLayout &amp;&amp; !f.mInLayout) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; The fragment is currently being animated... but! Now we</span><br><span class="line">                &#x2F;&#x2F; want to move our state back up. Give up on waiting for the</span><br><span class="line">                &#x2F;&#x2F; animation, move to whatever the final state should be once</span><br><span class="line">                &#x2F;&#x2F; the animation is done, and then we can proceed from there.</span><br><span class="line">                f.mAnimatingAway &#x3D; null;</span><br><span class="line">                moveToState(f, f.mStateAfterAnimating, 0, 0, true);</span><br><span class="line">            &#125;</span><br><span class="line">            switch (f.mState) &#123;</span><br><span class="line">                case Fragment.INITIALIZING:</span><br><span class="line">                    if (DEBUG) Log.v(TAG, &quot;moveto CREATED: &quot; + f);</span><br><span class="line">                    if (f.mSavedFragmentState !&#x3D; null) &#123;</span><br><span class="line">                        f.mSavedViewState &#x3D; f.mSavedFragmentState.getSparseParcelableArray(</span><br><span class="line">                                FragmentManagerImpl.VIEW_STATE_TAG);</span><br><span class="line">                        f.mTarget &#x3D; getFragment(f.mSavedFragmentState,</span><br><span class="line">                                FragmentManagerImpl.TARGET_STATE_TAG);</span><br><span class="line">                        if (f.mTarget !&#x3D; null) &#123;</span><br><span class="line">                            f.mTargetRequestCode &#x3D; f.mSavedFragmentState.getInt(</span><br><span class="line">                                    FragmentManagerImpl.TARGET_REQUEST_CODE_STATE_TAG, 0);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mUserVisibleHint &#x3D; f.mSavedFragmentState.getBoolean(</span><br><span class="line">                                FragmentManagerImpl.USER_VISIBLE_HINT_TAG, true);</span><br><span class="line">                        if (!f.mUserVisibleHint) &#123;</span><br><span class="line">                            f.mDeferStart &#x3D; true;</span><br><span class="line">                            if (newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">                                newState &#x3D; Fragment.STOPPED;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    f.mActivity &#x3D; mActivity;</span><br><span class="line">                    f.mParentFragment &#x3D; mParent;</span><br><span class="line">                    f.mFragmentManager &#x3D; mParent !&#x3D; null</span><br><span class="line">                            ? mParent.mChildFragmentManager : mActivity.mFragments;</span><br><span class="line">                    f.mCalled &#x3D; false;</span><br><span class="line">                    f.onAttach(mActivity);</span><br><span class="line">                    if (!f.mCalled) &#123;</span><br><span class="line">                        throw new SuperNotCalledException(&quot;Fragment &quot; + f</span><br><span class="line">                                + &quot; did not call through to super.onAttach()&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (f.mParentFragment &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        mActivity.onAttachFragment(f);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!f.mRetaining) &#123;</span><br><span class="line">                        f.performCreate(f.mSavedFragmentState);</span><br><span class="line">                    &#125;</span><br><span class="line">                    f.mRetaining &#x3D; false;</span><br><span class="line">                    if (f.mFromLayout) &#123;</span><br><span class="line">                        &#x2F;&#x2F; For fragments that are part of the content view</span><br><span class="line">                        &#x2F;&#x2F; layout, we need to instantiate the view immediately</span><br><span class="line">                        &#x2F;&#x2F; and the inflater will take care of adding it.</span><br><span class="line">                        f.mView &#x3D; f.performCreateView(f.getLayoutInflater(</span><br><span class="line">                                f.mSavedFragmentState), null, f.mSavedFragmentState);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            f.mInnerView &#x3D; f.mView;</span><br><span class="line">                            f.mView &#x3D; NoSaveStateFrameLayout.wrap(f.mView);</span><br><span class="line">                            if (f.mHidden) f.mView.setVisibility(View.GONE);</span><br><span class="line">                            f.onViewCreated(f.mView, f.mSavedFragmentState);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            f.mInnerView &#x3D; null;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.CREATED:</span><br><span class="line">                    if (newState &gt; Fragment.CREATED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto ACTIVITY_CREATED: &quot; + f);</span><br><span class="line">                        if (!f.mFromLayout) &#123;</span><br><span class="line">                            ViewGroup container &#x3D; null;</span><br><span class="line">                            if (f.mContainerId !&#x3D; 0) &#123;</span><br><span class="line">                                container &#x3D; (ViewGroup)mContainer.findViewById(f.mContainerId);</span><br><span class="line">                                if (container &#x3D;&#x3D; null &amp;&amp; !f.mRestored) &#123;</span><br><span class="line">                                    throwException(new IllegalArgumentException(</span><br><span class="line">                                            &quot;No view found for id 0x&quot;</span><br><span class="line">                                            + Integer.toHexString(f.mContainerId) + &quot; (&quot;</span><br><span class="line">                                            + f.getResources().getResourceName(f.mContainerId)</span><br><span class="line">                                            + &quot;) for fragment &quot; + f));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mContainer &#x3D; container;</span><br><span class="line">                            f.mView &#x3D; f.performCreateView(f.getLayoutInflater(</span><br><span class="line">                                    f.mSavedFragmentState), container, f.mSavedFragmentState);</span><br><span class="line">                            if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                                f.mInnerView &#x3D; f.mView;</span><br><span class="line">                                f.mView &#x3D; NoSaveStateFrameLayout.wrap(f.mView);</span><br><span class="line">                                if (container !&#x3D; null) &#123;</span><br><span class="line">                                    Animation anim &#x3D; loadAnimation(f, transit, true,</span><br><span class="line">                                            transitionStyle);</span><br><span class="line">                                    if (anim !&#x3D; null) &#123;</span><br><span class="line">                                        f.mView.startAnimation(anim);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    container.addView(f.mView);</span><br><span class="line">                                &#125;</span><br><span class="line">                                if (f.mHidden) f.mView.setVisibility(View.GONE);</span><br><span class="line">                                f.onViewCreated(f.mView, f.mSavedFragmentState);</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                f.mInnerView &#x3D; null;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.performActivityCreated(f.mSavedFragmentState);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            f.restoreViewState(f.mSavedFragmentState);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mSavedFragmentState &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.ACTIVITY_CREATED:</span><br><span class="line">                case Fragment.STOPPED:</span><br><span class="line">                    if (newState &gt; Fragment.STOPPED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto STARTED: &quot; + f);</span><br><span class="line">                        f.performStart();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STARTED:</span><br><span class="line">                    if (newState &gt; Fragment.STARTED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;moveto RESUMED: &quot; + f);</span><br><span class="line">                        f.mResumed &#x3D; true;</span><br><span class="line">                        f.performResume();</span><br><span class="line">                        f.mSavedFragmentState &#x3D; null;</span><br><span class="line">                        f.mSavedViewState &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (f.mState &gt; newState) &#123;</span><br><span class="line">            switch (f.mState) &#123;</span><br><span class="line">                case Fragment.RESUMED:</span><br><span class="line">                    if (newState &lt; Fragment.RESUMED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom RESUMED: &quot; + f);</span><br><span class="line">                        f.performPause();</span><br><span class="line">                        f.mResumed &#x3D; false;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STARTED:</span><br><span class="line">                    if (newState &lt; Fragment.STARTED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom STARTED: &quot; + f);</span><br><span class="line">                        f.performStop();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.STOPPED:</span><br><span class="line">                    if (newState &lt; Fragment.STOPPED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom STOPPED: &quot; + f);</span><br><span class="line">                        f.performReallyStop();</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.ACTIVITY_CREATED:</span><br><span class="line">                    if (newState &lt; Fragment.ACTIVITY_CREATED) &#123;</span><br><span class="line">                        if (DEBUG) Log.v(TAG, &quot;movefrom ACTIVITY_CREATED: &quot; + f);</span><br><span class="line">                        if (f.mView !&#x3D; null) &#123;</span><br><span class="line">                            &#x2F;&#x2F; Need to save the current view state if not</span><br><span class="line">                            &#x2F;&#x2F; done already.</span><br><span class="line">                            if (!mActivity.isFinishing() &amp;&amp; f.mSavedViewState &#x3D;&#x3D; null) &#123;</span><br><span class="line">                                saveFragmentViewState(f);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.performDestroyView();</span><br><span class="line">                        if (f.mView !&#x3D; null &amp;&amp; f.mContainer !&#x3D; null) &#123;</span><br><span class="line">                            Animation anim &#x3D; null;</span><br><span class="line">                            if (mCurState &gt; Fragment.INITIALIZING &amp;&amp; !mDestroyed) &#123;</span><br><span class="line">                                anim &#x3D; loadAnimation(f, transit, false,</span><br><span class="line">                                        transitionStyle);</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (anim !&#x3D; null) &#123;</span><br><span class="line">                                final Fragment fragment &#x3D; f;</span><br><span class="line">                                f.mAnimatingAway &#x3D; f.mView;</span><br><span class="line">                                f.mStateAfterAnimating &#x3D; newState;</span><br><span class="line">                                anim.setAnimationListener(new AnimationListener() &#123;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationEnd(Animation animation) &#123;</span><br><span class="line">                                        if (fragment.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                                            fragment.mAnimatingAway &#x3D; null;</span><br><span class="line">                                            moveToState(fragment, fragment.mStateAfterAnimating,</span><br><span class="line">                                                    0, 0, false);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationRepeat(Animation animation) &#123;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    public void onAnimationStart(Animation animation) &#123;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                                f.mView.startAnimation(anim);</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mContainer.removeView(f.mView);</span><br><span class="line">                        &#125;</span><br><span class="line">                        f.mContainer &#x3D; null;</span><br><span class="line">                        f.mView &#x3D; null;</span><br><span class="line">                        f.mInnerView &#x3D; null;</span><br><span class="line">                    &#125;</span><br><span class="line">                case Fragment.CREATED:</span><br><span class="line">                    if (newState &lt; Fragment.CREATED) &#123;</span><br><span class="line">                        if (mDestroyed) &#123;</span><br><span class="line">                            if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                                &#x2F;&#x2F; The fragment&#39;s containing activity is</span><br><span class="line">                                &#x2F;&#x2F; being destroyed, but this fragment is</span><br><span class="line">                                &#x2F;&#x2F; currently animating away. Stop the</span><br><span class="line">                                &#x2F;&#x2F; animation right now -- it is not needed,</span><br><span class="line">                                &#x2F;&#x2F; and we can&#39;t wait any more on destroying</span><br><span class="line">                                &#x2F;&#x2F; the fragment.</span><br><span class="line">                                View v &#x3D; f.mAnimatingAway;</span><br><span class="line">                                f.mAnimatingAway &#x3D; null;</span><br><span class="line">                                v.clearAnimation();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (f.mAnimatingAway !&#x3D; null) &#123;</span><br><span class="line">                            &#x2F;&#x2F; We are waiting for the fragment&#39;s view to finish</span><br><span class="line">                            &#x2F;&#x2F; animating away. Just make a note of the state</span><br><span class="line">                            &#x2F;&#x2F; the fragment now should move to once the animation</span><br><span class="line">                            &#x2F;&#x2F; is done.</span><br><span class="line">                            f.mStateAfterAnimating &#x3D; newState;</span><br><span class="line">                            newState &#x3D; Fragment.CREATED;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            if (DEBUG) Log.v(TAG, &quot;movefrom CREATED: &quot; + f);</span><br><span class="line">                            if (!f.mRetaining) &#123;</span><br><span class="line">                                f.performDestroy();</span><br><span class="line">                            &#125;</span><br><span class="line">                            f.mCalled &#x3D; false;</span><br><span class="line">                            f.onDetach();</span><br><span class="line">                            if (!f.mCalled) &#123;</span><br><span class="line">                                throw new SuperNotCalledException(&quot;Fragment &quot; + f</span><br><span class="line">                                        + &quot; did not call through to super.onDetach()&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (!keepActive) &#123;</span><br><span class="line">                                if (!f.mRetaining) &#123;</span><br><span class="line">                                    makeInactive(f);</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    f.mActivity &#x3D; null;</span><br><span class="line">                                    f.mFragmentManager &#x3D; null;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        f.mState &#x3D; newState;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法中会依次执行INITIALIZING，CREATED，ACTIVITY_CREATED代码片段，最终在CREATED语句中通过container.addView(f.mView);加载fragment布局。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/09/03/2019-09-03-Fragment%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" data-id="ck8tr9s710012n29k1uj5gopq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-08-28-Java中的自动装箱和拆箱" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/" class="article-date">
  <time datetime="2019-08-27T16:00:00.000Z" itemprop="datePublished">2019-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/">Java中的自动装箱和拆箱</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#为什么要有自动装箱和拆箱</p>
<ol>
<li>将一个数值转换成一个类，可以使这个类有多种可以调用的方法。</li>
<li>基本类型的数据不是对象需要装箱才能和其他Object类型的子类共用同一个接口。</li>
</ol>
<p>#什么是装箱拆箱<br>从JavaSE5就提供了自动装箱的操作，如果生成一个数值为10的Integer对象只要这样操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer value &#x3D; 10;</span><br></pre></td></tr></table></figure>
<p>这个过程就会自动的将10这个int类型的数据转换成Object对象类型.<br>现在如果要将value这个Object类型的数据转换成int类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int n &#x3D; value</span><br></pre></td></tr></table></figure>
<p>这样就将value转换成了int类型，完成了自动拆箱的操作.<br>基本类型包装成Object类型有这些</p>
<ol>
<li>int—&gt;Integer</li>
<li>byte–&gt;Byte</li>
<li>short-&gt;Short</li>
<li>char–&gt;Character</li>
<li>long–&gt;Long</li>
<li>double-&gt;Double</li>
<li>float–&gt;Float</li>
<li>boolean-&gt;Boolean</li>
</ol>
<p>#常见问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Integer i1 &#x3D; 100;</span><br><span class="line">        Integer i2 &#x3D; 100;</span><br><span class="line">        Integer i3 &#x3D; 200;</span><br><span class="line">        Integer i4 &#x3D; 200;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段程序输出怎样的结果?第一段代码输出 true;第二段代码输出 false;这段代码当执行到Integer i1 = 100时,内部执行的是Integer i1 = Integer.valueOf(100).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static Integer valueOf(int i) &#123;</span><br><span class="line">        if (i &gt;&#x3D; IntegerCache.low &amp;&amp; i &lt;&#x3D; IntegerCache.high)</span><br><span class="line">            return IntegerCache.cache[i + (-IntegerCache.low)];</span><br><span class="line">        return new Integer(i);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从源代码中可以看出当我们传入的值在IntegerCache.low和IntegerCache.high之间(也就是-127～128)就直接从缓存中返回数据,否则就重新创建一个对象，执行new Integer(i)。<br>因此上面的代码中100在-127～128之间，但是200不在这个区间就会重新创建对象，由于不是同一个对象了所以返回false。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Double i1 &#x3D; 100.0;</span><br><span class="line">        Double i2 &#x3D; 100.0;</span><br><span class="line">        Double i3 &#x3D; 200.0;</span><br><span class="line">        Double i4 &#x3D; 200.0;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码都会输出false。从下面的源码可以看出都会new一个double类型的数据；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Double valueOf(double d) &#123;</span><br><span class="line">        return new Double(d);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         </span><br><span class="line">        Boolean i1 &#x3D; false;</span><br><span class="line">        Boolean i2 &#x3D; false;</span><br><span class="line">        Boolean i3 &#x3D; true;</span><br><span class="line">        Boolean i4 &#x3D; true;</span><br><span class="line">         </span><br><span class="line">        System.out.println(i1&#x3D;&#x3D;i2);</span><br><span class="line">        System.out.println(i3&#x3D;&#x3D;i4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码都会输出true。我们查看一下源代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Boolean valueOf(boolean b) &#123;</span><br><span class="line">        return (b ? TRUE : FALSE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而其中的TRUE和FALSE,他们都是一个静态的常量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * The &#123;@code Boolean&#125; object corresponding to the primitive</span><br><span class="line"> * value &#123;@code true&#125;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static final Boolean TRUE &#x3D; new Boolean(true);</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The &#123;@code Boolean&#125; object corresponding to the primitive</span><br><span class="line"> * value &#123;@code false&#125;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static final Boolean FALSE &#x3D; new Boolean(false);</span><br></pre></td></tr></table></figure>

<p>参考文章:<br><a href="https://www.cnblogs.com/dolphin0520/p/3780005.html" target="_blank" rel="noopener">https://www.cnblogs.com/dolphin0520/p/3780005.html</a>;<br><a href="https://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/" target="_blank" rel="noopener">https://droidyue.com/blog/2015/04/07/autoboxing-and-autounboxing-in-java/</a>    </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/08/28/2019-08-28-Java%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E7%AE%B1%E5%92%8C%E6%8B%86%E7%AE%B1/" data-id="ck8tr9s720014n29kdsmk557j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2019-7-17-理解LayoutInflate.inflater的三个参数含义" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/" class="article-date">
  <time datetime="2019-07-16T16:00:00.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/">理解LayoutInflate.inflater的三个参数含义</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有些时候我们可以通过代码来添加一个布局到我们的应用中,这个时候就需要用到LayoutInflate.inflate了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</span><br></pre></td></tr></table></figure>
<ol>
<li>resource:这个参数表示要添加的布局结构；</li>
<li>root:表示要添加的布局结构需要依赖的根布局;</li>
<li>attachToRoot:表示布局是否要添加到根布局。</li>
</ol>
<h2 id="root-null-attachToRoot-true"><a href="#root-null-attachToRoot-true" class="headerlink" title="root != null,attachToRoot = true"></a>root != null,attachToRoot = true</h2><p>当root不为空,attachToRoot为true时表示将resource布局添加到root中,resource的各个节点都是有效的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LinearLayout ll &#x3D; (LinearLayout) findViewById(R.id.ll);</span><br><span class="line">LayoutInflater inflater &#x3D; LayoutInflater.from(this);</span><br><span class="line">View view &#x3D; inflater.inflate(R.layout.linearlayout, ll, true);</span><br></pre></td></tr></table></figure>
<p>如果这个时候我们添加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll.addView(view);</span><br></pre></td></tr></table></figure>
<p>那么这个时候就会报重复添加的错误.</p>
<h2 id="root-null-attachToRoot-false"><a href="#root-null-attachToRoot-false" class="headerlink" title="root != null,attachToRoot = false"></a>root != null,attachToRoot = false</h2><p>当root不为空,attachToRoot为false时表示将resource布局不添加到root中。这种情况表示我们想要resource的各个节点有效但是又不想将这个resource和root关联，这个时候如果需要添加到root中需要手动调用addview。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LinearLayout ll &#x3D; (LinearLayout) findViewById(R.id.ll);</span><br><span class="line">LayoutInflater inflater &#x3D; LayoutInflater.from(this);</span><br><span class="line">View view &#x3D; inflater.inflate(R.layout.linearlayout, ll, true);</span><br><span class="line">ll.addView(view);&#x2F;&#x2F;在这里需要手动添加</span><br></pre></td></tr></table></figure>
<h2 id="root-null-attachToRoot-true-false"><a href="#root-null-attachToRoot-true-false" class="headerlink" title="root = null,attachToRoot = true | false"></a>root = null,attachToRoot = true | false</h2><p>这个时候由于我们的root为空所以我们的resource布局的根节点的宽高就会失效布局样式就不会是我们编写的效果,无论attachToRoot为true还是false.</p>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</span><br></pre></td></tr></table></figure>
<p>这个代码最终都会执行到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">        synchronized (mConstructorArgs) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;inflate&quot;);</span><br><span class="line"></span><br><span class="line">            final Context inflaterContext &#x3D; mContext;</span><br><span class="line">            final AttributeSet attrs &#x3D; Xml.asAttributeSet(parser);</span><br><span class="line">            Context lastContext &#x3D; (Context) mConstructorArgs[0];</span><br><span class="line">            mConstructorArgs[0] &#x3D; inflaterContext;</span><br><span class="line">            View result &#x3D; root;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; Look for the root node.</span><br><span class="line">                int type;</span><br><span class="line">                while ((type &#x3D; parser.next()) !&#x3D; XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">                        type !&#x3D; XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Empty</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (type !&#x3D; XmlPullParser.START_TAG) &#123;</span><br><span class="line">                    throw new InflateException(parser.getPositionDescription()</span><br><span class="line">                            + &quot;: No start tag found!&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                final String name &#x3D; parser.getName();</span><br><span class="line"></span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                    System.out.println(&quot;Creating root view: &quot;</span><br><span class="line">                            + name);</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">                    if (root &#x3D;&#x3D; null || !attachToRoot) &#123;</span><br><span class="line">                        throw new InflateException(&quot;&lt;merge &#x2F;&gt; can be used only with a valid &quot;</span><br><span class="line">                                + &quot;ViewGroup root and attachToRoot&#x3D;true&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;初始化所有的子控件，加载xml内view,并添加到temp中</span><br><span class="line">                    rInflate(parser, root, inflaterContext, attrs, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Temp is the root view that was found in the xml</span><br><span class="line">                    final View temp &#x3D; createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class="line"></span><br><span class="line">                    ViewGroup.LayoutParams params &#x3D; null;</span><br><span class="line"></span><br><span class="line">                    if (root !&#x3D; null) &#123;</span><br><span class="line">                        if (DEBUG) &#123;</span><br><span class="line">                            System.out.println(&quot;Creating params from root: &quot; +</span><br><span class="line">                                    root);</span><br><span class="line">                        &#125;</span><br><span class="line">                        &#x2F;&#x2F; Create layout params that match root, if supplied</span><br><span class="line">                        params &#x3D; root.generateLayoutParams(attrs);&#x2F;&#x2F;1</span><br><span class="line">                        if (!attachToRoot) &#123;&#x2F;&#x2F;3</span><br><span class="line">                            &#x2F;&#x2F; Set the layout params for temp if we are not</span><br><span class="line">                            &#x2F;&#x2F; attaching. (If we are, we use addView, below)</span><br><span class="line">                            temp.setLayoutParams(params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; start inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; Inflate all children under temp against its context.</span><br><span class="line">                    rInflateChildren(parser, temp, attrs, true);</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; done inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; We are supposed to attach all the views we found (int temp)</span><br><span class="line">                    &#x2F;&#x2F; to root. Do that now.</span><br><span class="line">                    if (root !&#x3D; null &amp;&amp; attachToRoot) &#123;&#x2F;&#x2F;2</span><br><span class="line">                        root.addView(temp, params);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F; Decide whether to return the root that was passed in or the</span><br><span class="line">                    &#x2F;&#x2F; top view found in xml.</span><br><span class="line">                    if (root &#x3D;&#x3D; null || !attachToRoot) &#123;&#x2F;&#x2F;4</span><br><span class="line">                        result &#x3D; temp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; catch (XmlPullParserException e) &#123;</span><br><span class="line">                final InflateException ie &#x3D; new InflateException(e.getMessage(), e);</span><br><span class="line">                ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">                throw ie;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                final InflateException ie &#x3D; new InflateException(parser.getPositionDescription()</span><br><span class="line">                        + &quot;: &quot; + e.getMessage(), e);</span><br><span class="line">                ie.setStackTrace(EMPTY_STACK_TRACE);</span><br><span class="line">                throw ie;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                &#x2F;&#x2F; Don&#39;t retain static reference on context.</span><br><span class="line">                mConstructorArgs[0] &#x3D; lastContext;</span><br><span class="line">                mConstructorArgs[1] &#x3D; null;</span><br><span class="line"></span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>当root!=null时我们会先找出根节点的布局参数(1):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params &#x3D; root.generateLayoutParams(attrs);</span><br></pre></td></tr></table></figure>
<p>然后判断当root!=null,attachToRoot=true就会执行(2):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (root !&#x3D; null &amp;&amp; attachToRoot) &#123;&#x2F;&#x2F;2</span><br><span class="line">                        root.addView(temp, params);</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>
<p>所以如果我们在代码中又重复调用addView的话就会报重复添加view的错误.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!attachToRoot) &#123;&#x2F;&#x2F;3</span><br><span class="line">                            &#x2F;&#x2F; Set the layout params for temp if we are not</span><br><span class="line">                            &#x2F;&#x2F; attaching. (If we are, we use addView, below)</span><br><span class="line">                            temp.setLayoutParams(params);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>
<p>如果root!=null同时attachToRoot为false这时候就会将刚刚生成的params设置到temp中.<br>如果指定root=null(4)，那么无论attachToRoot为true或者false都会将temp赋值给result.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2019/07/17/2019-7-17-%E7%90%86%E8%A7%A3LayoutInflate.inflater%E7%9A%84%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89/" data-id="ck8tr9s7o002on29k5ss2511n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/31/2019-12-31-%E8%BD%AF%E5%BC%95%E7%94%A8%E5%92%8C%E5%BC%B1%E5%BC%95%E7%94%A8/">软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2019/12/06/2019-12-06-Android%20TextView%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Android TextView源代码分析</a>
          </li>
        
          <li>
            <a href="/2019/11/12/2019-11-12-Http%E8%AF%B7%E6%B1%82%E5%A4%B4Cache-Control%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">Http请求头Cache-Control机制详解</a>
          </li>
        
          <li>
            <a href="/2019/11/05/2019-11-05-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E5%92%8C%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3/">什么是子网掩码和默认网关</a>
          </li>
        
          <li>
            <a href="/2019/11/04/2019-11-04-%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%ADIP%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E6%A0%B7%E5%88%86%E9%85%8D%E7%9A%84/">计算机中IP地址是怎样分配的</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://joshuayingwhategr.github.io/2020/10/15/page/2/index/" data-id="ckgaf74jw0046279k2f3b9y43" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/10/15/page/4/index/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          page/4/index
        
      </div>
    </a>
  
  
    <a href="/2020/10/15/page/3/index/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">page/3/index</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/" style="font-size: 12.5px;">仓央嘉措菜</a> <a href="/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 15px;">吴主任的公众号</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">多线程编程</a> <a href="/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/" style="font-size: 10px;">褚明宇</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 17.5px;">计算机网络</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/15/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/index/">tags/计算机网络/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/Java/index/">tags/Java/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E5%90%B4%E4%B8%BB%E4%BB%BB%E7%9A%84%E5%85%AC%E4%BC%97%E5%8F%B7/index/">tags/吴主任的公众号/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E4%BB%93%E5%A4%AE%E5%98%89%E6%8E%AA%E8%8F%9C/index/">tags/仓央嘉措菜/index</a>
          </li>
        
          <li>
            <a href="/2020/10/15/tags/%E8%A4%9A%E6%98%8E%E5%AE%87/index/">tags/褚明宇/index</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 JoshuaYingWhatEgr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>